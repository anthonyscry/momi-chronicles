---
phase: 08-combo-system
plan: 02
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - ui/hud/combo_counter.gd (NEW)
  - ui/hud/combo_counter.tscn (NEW)
  - ui/hud/game_hud.tscn
  - ui/hud/game_hud.gd
  - autoloads/effects_manager.gd
autonomous: true

must_haves:
  truths:
    - "Combo counter appears during combos"
    - "Screen shake increases with combo hits"
    - "Visual feedback distinct per combo hit"
  artifacts:
    - path: "ui/hud/combo_counter.tscn"
      provides: "Combo counter UI element"
    - path: "ui/hud/combo_counter.gd"
      provides: "Combo display logic"
  key_links:
    - from: "combo_counter.gd"
      to: "Events.combo_changed"
      via: "signal connection"
---

<objective>
Add visual feedback for combo system: counter UI and escalating effects.

Purpose: Make combos feel impactful and satisfying
Output: Combo counter HUD element + enhanced hit effects per combo stage
</objective>

<context>
@ui/hud/game_hud.gd (existing HUD)
@ui/hud/game_hud.tscn (HUD scene)
@autoloads/effects_manager.gd (screen shake, damage numbers)
@autoloads/events.gd (combo signals from 08-01)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Combo Counter UI</name>
  <files>ui/hud/combo_counter.gd, ui/hud/combo_counter.tscn</files>
  <action>
Create combo counter that shows current hit in chain:

**combo_counter.tscn structure:**
```
ComboCounter (Control)
├── HitIndicators (HBoxContainer) - centered
│   ├── Hit1 (Label) - "1"
│   ├── Hit2 (Label) - "2"  
│   └── Hit3 (Label) - "3"
└── ComboText (Label) - "COMBO!" (shown on hit 3)
```

**combo_counter.gd:**
```gdscript
extends Control
class_name ComboCounter

@onready var hit1: Label = $HitIndicators/Hit1
@onready var hit2: Label = $HitIndicators/Hit2
@onready var hit3: Label = $HitIndicators/Hit3
@onready var combo_text: Label = $ComboText

const COLORS = [
    Color(1, 1, 1),      # Hit 1: White
    Color(1, 0.9, 0.3),  # Hit 2: Yellow
    Color(1, 0.4, 0.2)   # Hit 3: Orange-red
]

var fade_tween: Tween

func _ready() -> void:
    Events.combo_changed.connect(_on_combo_changed)
    Events.combo_dropped.connect(_on_combo_dropped)
    _reset_display()

func _on_combo_changed(count: int) -> void:
    if count == 0:
        _reset_display()
        return
    
    # Show and highlight current hit
    visible = true
    _reset_display()
    
    var labels = [hit1, hit2, hit3]
    for i in range(count):
        if i < labels.size():
            labels[i].modulate = COLORS[i]
            labels[i].add_theme_font_size_override("font_size", 24 + i * 4)
    
    # Pulse animation on current hit
    if count > 0 and count <= 3:
        var current_label = labels[count - 1]
        _pulse_label(current_label)
    
    # Show COMBO! on hit 3
    combo_text.visible = (count == 3)
    if count == 3:
        _pulse_label(combo_text)

func _pulse_label(label: Label) -> void:
    var tween = create_tween()
    tween.tween_property(label, "scale", Vector2(1.3, 1.3), 0.1)
    tween.tween_property(label, "scale", Vector2(1.0, 1.0), 0.15)

func _on_combo_dropped() -> void:
    # Fade out
    if fade_tween:
        fade_tween.kill()
    fade_tween = create_tween()
    fade_tween.tween_property(self, "modulate:a", 0.0, 0.3)
    fade_tween.tween_callback(_reset_display)

func _reset_display() -> void:
    modulate.a = 1.0
    hit1.modulate = Color(0.5, 0.5, 0.5)
    hit2.modulate = Color(0.5, 0.5, 0.5)
    hit3.modulate = Color(0.5, 0.5, 0.5)
    hit1.scale = Vector2.ONE
    hit2.scale = Vector2.ONE
    hit3.scale = Vector2.ONE
    combo_text.visible = false
```

Position at top-center of screen, below health bar.
  </action>
  <verify>combo_counter.tscn and .gd exist</verify>
  <done>Combo counter UI component created</done>
</task>

<task type="auto">
  <name>Task 2: Integrate Combo Counter into HUD</name>
  <files>ui/hud/game_hud.tscn, ui/hud/game_hud.gd</files>
  <action>
1. In game_hud.tscn:
   - Instance combo_counter.tscn as child
   - Position at top-center (anchor preset)
   - Offset Y: 40 (below health bar)

2. In game_hud.gd, ensure combo counter initializes:
   - No additional code needed if signals are global
   - Optionally add reference: `@onready var combo_counter = $ComboCounter`
  </action>
  <verify>Run game, HUD shows combo counter area</verify>
  <done>Combo counter integrated into game HUD</done>
</task>

<task type="auto">
  <name>Task 3: Escalating Screen Shake per Combo Hit</name>
  <files>autoloads/effects_manager.gd</files>
  <action>
Update EffectsManager to support combo-scaled shake:

```gdscript
# Add combo shake scaling
const COMBO_SHAKE_MULTIPLIERS = [1.0, 1.5, 2.5]

func _ready() -> void:
    # ... existing code ...
    Events.combo_changed.connect(_on_combo_hit)

func _on_combo_hit(combo_count: int) -> void:
    if combo_count == 0:
        return
    # Shake intensity increases with combo
    var multiplier = COMBO_SHAKE_MULTIPLIERS[mini(combo_count - 1, 2)]
    screen_shake(4.0 * multiplier, 0.15)
    
    # Hit 3 gets extra punch
    if combo_count == 3:
        # Brief time slow for impact
        Engine.time_scale = 0.7
        await get_tree().create_timer(0.08 * 0.7).timeout  # Account for time scale
        Engine.time_scale = 1.0
```

This gives:
- Hit 1: Normal shake (4.0 intensity)
- Hit 2: Medium shake (6.0 intensity)  
- Hit 3: Big shake (10.0 intensity) + hitstop effect
  </action>
  <verify>Attack enemy 3 times, shake should escalate, hit 3 has brief slowdown</verify>
  <done>Screen shake scales with combo hits</done>
</task>

</tasks>

<verification>
1. Run game with F5
2. Find enemy, perform 3-hit combo
3. Combo counter should:
   - Show 1-2-3 indicators lighting up
   - Show "COMBO!" text on hit 3
   - Fade out after combo ends
4. Screen shake should increase with each hit
5. Hit 3 should have brief hitstop/slowdown
</verification>

<success_criteria>
- Combo counter visible and updating during combat
- Visual distinction between hit 1, 2, 3
- Screen shake escalates properly
- Hitstop on final combo hit feels impactful
</success_criteria>

<output>
After completion, create `.planning/phases/08-combo-system/08-02-SUMMARY.md`
</output>
