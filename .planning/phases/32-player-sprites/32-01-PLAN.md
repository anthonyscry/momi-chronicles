---
phase: 32-player-sprites
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - characters/player/player.tscn
  - characters/player/player.gd
  - characters/player/states/idle.gd
  - characters/player/states/walk.gd
  - characters/player/states/run.gd
  - characters/player/states/attack.gd
  - characters/player/states/combo_attack.gd
  - characters/player/states/charge_attack.gd
  - characters/player/states/special_attack.gd
  - characters/player/states/ground_pound.gd
  - characters/player/states/dodge.gd
  - characters/player/states/block.gd
  - characters/player/states/hurt.gd
  - characters/player/states/death.gd
autonomous: true

must_haves:
  truths:
    - "Momi displays as pixel art sprite in all gameplay states"
    - "Sprite faces correct direction based on movement"
    - "All combat mechanics work identically to before (combo, charge, ground pound, block/parry, dodge)"
    - "Visual feedback (damage flash, dodge afterimage) still visible"
    - "No Polygon2D placeholder visible during any player state"
  artifacts:
    - path: "characters/player/player.tscn"
      provides: "AnimatedSprite2D node with SpriteFrames for all states"
      contains: "AnimatedSprite2D"
    - path: "characters/player/player.gd"
      provides: "Sprite reference updated to AnimatedSprite2D"
      contains: "AnimatedSprite2D"
  key_links:
    - from: "characters/player/states/*.gd"
      to: "AnimatedSprite2D"
      via: "owner.sprite.play() calls in enter()"
      pattern: "sprite\\.play\\("
    - from: "characters/player/player.gd"
      to: "art/generated/characters/momi_*.png"
      via: "SpriteFrames texture loading"
---

<objective>
Replace Momi's Polygon2D placeholder with AnimatedSprite2D using generated pixel art, wire all 12 state machine states to play correct animations, and verify all combat mechanics remain functional.

Purpose: Momi is the player character — the most visible entity. This establishes the Polygon2D → AnimatedSprite2D conversion pattern that all subsequent phases follow.
Output: Fully animated player character with sprite-based visuals across all states.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@characters/player/player.tscn
@characters/player/player.gd
@autoloads/effects_manager.gd
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace Polygon2D with AnimatedSprite2D and set up SpriteFrames</name>
  <files>
    characters/player/player.tscn
    characters/player/player.gd
  </files>
  <action>
  **In player.tscn:**
  1. Remove the `Polygon2D` node named `Sprite2D` (the 16x16 tan square)
  2. Remove the `GlowOutline` Polygon2D node (glow will be handled differently or omitted for now)
  3. Add an `AnimatedSprite2D` node named `Sprite2D` in the same position (so all `$Sprite2D` refs still work)
  4. Create a `SpriteFrames` resource on the AnimatedSprite2D with these animations:
     - `idle` — load `art/generated/characters/momi_idle.png`
     - `walk` — load `art/generated/characters/momi_walk.png`
     - `run` — load `art/generated/characters/momi_run.png`
     - `attack` — load `art/generated/characters/momi_attack.png`
     - `charge` — load `art/generated/characters/momi_charge.png`
     - `ground_pound` — load `art/generated/characters/momi_ground_pound.png`
     - `dodge` — load `art/generated/characters/momi_dodge.png`
     - `block` — load `art/generated/characters/momi_block.png`
     - `hurt` — load `art/generated/characters/momi_hurt.png`
     - `death` — load `art/generated/characters/momi_death.png`
     - `combo_attack` — reuse `momi_attack.png` (same visual as basic attack)
     - `special_attack` — reuse `momi_charge.png` (charge visual)
  5. Each animation: 1 frame, FPS=1, no loop (static poses that change on state transition)
  6. Set `centered = true`, `offset = Vector2(0, 0)`, `z_index = 0`

  **Sizing:** The generated PNGs from rip_sprites.py are already downscaled to 32x32 for characters. If they're larger, check `art/rip_sprites.py` SIZE_CONFIG for the character target size.

  **In player.gd:**
  1. Change `@onready var sprite: Polygon2D = $Sprite2D` to `@onready var sprite: AnimatedSprite2D = $Sprite2D`
  2. Change facing logic from `sprite.scale.x = -1` to `sprite.flip_h = true` (and `sprite.scale.x = 1` to `sprite.flip_h = false`)
  3. Replace any `sprite.color = ...` calls with `sprite.modulate = ...` (AnimatedSprite2D doesn't have .color)
  4. In `_ready()` or wherever the sprite is initialized: call `sprite.play("idle")`

  **Collision adjustment:**
  - Check if the CapsuleShape2D (r=6, h=16) still fits the sprite dimensions
  - If the sprite is 32x32, the collision should be roughly centered in the lower half
  - Adjust Hitbox RectangleShape2D (14x12) and Hurtbox CapsuleShape2D (r=7, h=18) if needed
  </action>
  <verify>
  - Open `player.tscn` in Godot editor (or read the file) — confirm AnimatedSprite2D node exists with SpriteFrames containing all animations
  - Grep player.gd for `Polygon2D` — should return zero matches
  - Grep player.tscn for `Polygon2D` — should return zero matches
  </verify>
  <done>player.tscn has AnimatedSprite2D with 12 animations loaded from generated PNGs, player.gd references AnimatedSprite2D type, no Polygon2D references remain</done>
</task>

<task type="auto">
  <name>Task 2: Wire all state scripts to play animations and fix visual feedback</name>
  <files>
    characters/player/states/idle.gd
    characters/player/states/walk.gd
    characters/player/states/run.gd
    characters/player/states/attack.gd
    characters/player/states/combo_attack.gd
    characters/player/states/charge_attack.gd
    characters/player/states/special_attack.gd
    characters/player/states/ground_pound.gd
    characters/player/states/dodge.gd
    characters/player/states/block.gd
    characters/player/states/hurt.gd
    characters/player/states/death.gd
  </files>
  <action>
  **For EACH state script**, add animation play call in `enter()`:

  ```gdscript
  # In each state's enter() function, add at the top:
  owner.sprite.play("state_name")
  ```

  Mapping:
  - `idle.gd` → `owner.sprite.play("idle")`
  - `walk.gd` → `owner.sprite.play("walk")`
  - `run.gd` → `owner.sprite.play("run")`
  - `attack.gd` → `owner.sprite.play("attack")`
  - `combo_attack.gd` → `owner.sprite.play("combo_attack")`
  - `charge_attack.gd` → `owner.sprite.play("charge")`
  - `special_attack.gd` → `owner.sprite.play("special_attack")`
  - `ground_pound.gd` → `owner.sprite.play("ground_pound")`
  - `dodge.gd` → `owner.sprite.play("dodge")`
  - `block.gd` → `owner.sprite.play("block")`
  - `hurt.gd` → `owner.sprite.play("hurt")`
  - `death.gd` → `owner.sprite.play("death")`

  **Visual feedback fixes across ALL files:**
  - Find any `sprite.color = Color(...)` and replace with `sprite.modulate = Color(...)`
  - Find any `sprite.scale.x = -1` (facing) and replace with `sprite.flip_h = true`
  - Find any `sprite.scale.x = 1` (facing) and replace with `sprite.flip_h = false`
  - If a state modifies `sprite.scale` for pop effects (e.g., knockback), keep the scale tween but ensure it doesn't conflict with flip

  **EffectsManager dodge afterimage fix:**
  In `autoloads/effects_manager.gd`, the dodge afterimage function `_create_dodge_afterimages()` clones the player's Polygon2D. Since the player is now AnimatedSprite2D:
  - Change the afterimage creation to duplicate the sprite texture instead of polygon
  - Create a `Sprite2D` (not Polygon2D) for each afterimage, set its texture to the current frame of the AnimatedSprite2D
  - Pattern: `var frame_texture = player.sprite.sprite_frames.get_frame_texture(player.sprite.animation, player.sprite.frame)`

  **Do NOT change:**
  - State machine transition logic (conditions, signals)
  - Combat damage values, hitbox timings, cooldowns
  - Input handling
  </action>
  <verify>
  - Run the game, confirm Momi shows as a sprite (not a colored square)
  - Walk around — sprite should flip horizontally when changing direction
  - Attack — sprite should change to attack pose
  - Get hit — sprite should change to hurt pose
  - Dodge — sprite should change to dodge pose (afterimages work)
  - Block — sprite should change to block pose
  - Die — sprite should change to death pose
  - Grep all state scripts for `\.color\s*=` — should return zero matches (all converted to .modulate)
  </verify>
  <done>All 12 state scripts play correct animations on enter(), visual feedback uses modulate instead of color, dodge afterimages work with new sprite type, facing uses flip_h</done>
</task>

</tasks>

<verification>
1. Open the game and play as Momi — pixel art sprite visible in all states
2. Run through all combat: basic attack, combo chain, charge attack, ground pound, block, parry, dodge, get hit, die
3. Sprite faces correct direction when moving left/right
4. No Polygon2D nodes visible (no colored squares anywhere on Momi)
5. `grep -r "Polygon2D" characters/player/` returns zero matches in .gd files
</verification>

<success_criteria>
- Momi displays as animated pixel art in all 8+ gameplay states
- Sprite transitions match state machine transitions (no stuck poses)
- All combat mechanics function identically (no gameplay regression)
- Facing direction correct (flip_h)
- Zero Polygon2D references in player scene/scripts
</success_criteria>

<output>
After completion, create `.planning/phases/32-player-sprites/32-01-SUMMARY.md`
</output>
