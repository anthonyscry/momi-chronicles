---
phase: 21-save-persistence
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - autoloads/save_manager.gd
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Equipment persists across save/load cycles"
    - "Inventory items persist across save/load cycles"
    - "Party state persists across save/load cycles"
    - "Old v2 saves load without crashing (backward compat)"
  artifacts:
    - path: "autoloads/save_manager.gd"
      provides: "Full game state persistence including equipment, inventory, party"
      contains: "equipment_manager.get_save_data"
  key_links:
    - from: "autoloads/save_manager.gd"
      to: "systems/equipment/equipment_manager.gd"
      via: "GameManager.equipment_manager.get_save_data() and load_save_data()"
      pattern: "equipment_manager\\.get_save_data\\(\\)"
    - from: "autoloads/save_manager.gd"
      to: "systems/inventory/inventory.gd"
      via: "GameManager.inventory.get_save_data() and load_save_data()"
      pattern: "inventory\\.get_save_data\\(\\)"
    - from: "autoloads/save_manager.gd"
      to: "systems/party/party_manager.gd"
      via: "GameManager.party_manager.get_save_data() and load_save_data()"
      pattern: "party_manager\\.get_save_data\\(\\)"
---

<objective>
Wire SaveManager to persist equipment, inventory, and party data using the existing helper methods that EquipmentManager, Inventory, and PartyManager already provide.

Purpose: Fix the only medium-severity tech debt from v1.3 audit — currently equipment and inventory revert to defaults on every load because SaveManager never calls the sub-system save/load helpers.

Output: Updated save_manager.gd with full persistence (save version bumped v2→v3, backward-compatible with v2 saves)
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@autoloads/save_manager.gd
@systems/equipment/equipment_manager.gd
@systems/inventory/inventory.gd
@systems/party/party_manager.gd
@autoloads/game_manager.gd
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire sub-system save data into SaveManager gather/apply</name>
  <files>autoloads/save_manager.gd</files>
  <action>
  Update save_manager.gd to persist equipment, inventory, and party state:

  1. **Bump save version** (Line 10):
     Change `const SAVE_VERSION: int = 2` to `const SAVE_VERSION: int = 3`

  2. **Update _get_default_data()** (after line 30, before "timestamp"):
     Add default keys for the three sub-systems:
     ```gdscript
     "equipment": {},
     "inventory": {},
     "party": {},
     ```

  3. **Update _gather_save_data()** (after line 81, before line 82 `data.timestamp`):
     Add calls to existing helper methods:
     ```gdscript
     # Get sub-system state (helpers already exist on each manager)
     data.equipment = GameManager.equipment_manager.get_save_data()
     data.inventory = GameManager.inventory.get_save_data()
     data.party = GameManager.party_manager.get_save_data()
     ```

  4. **Update _apply_save_data()** (after line 105, before the "Store zone" comment at line 107):
     Add calls to restore sub-system state, using .get() for v2 backward compat:
     ```gdscript
     # Restore sub-system state (v3+, graceful fallback for v2 saves)
     var equipment_data = data.get("equipment", {})
     if not equipment_data.is_empty():
         GameManager.equipment_manager.load_save_data(equipment_data)

     var inventory_data = data.get("inventory", {})
     if not inventory_data.is_empty():
         GameManager.inventory.load_save_data(inventory_data)

     var party_data = data.get("party", {})
     if not party_data.is_empty():
         GameManager.party_manager.load_save_data(party_data)
     ```

  5. **Version compatibility**: The `_apply_save_data()` already checks `data.version > SAVE_VERSION` on line 92. Old v2 saves will simply have empty dicts for these keys (via .get() defaults), so no crash. The version check prevents loading v3 saves in old game builds.

  IMPORTANT: Do NOT modify equipment_manager.gd, inventory.gd, or party_manager.gd — their get_save_data() and load_save_data() methods already exist and work correctly.
  </action>
  <verify>
  1. Open save_manager.gd and confirm:
     - SAVE_VERSION is 3
     - _get_default_data() has "equipment", "inventory", "party" keys
     - _gather_save_data() calls all three .get_save_data() methods
     - _apply_save_data() calls all three .load_save_data() methods with .get() fallbacks
  2. Grep for the three key patterns:
     - `equipment_manager.get_save_data()`
     - `inventory.get_save_data()`
     - `party_manager.get_save_data()`
  </verify>
  <done>SaveManager gathers and restores equipment, inventory, and party data. Old v2 saves load without error (empty dict fallback). Save version is 3.</done>
</task>

<task type="auto">
  <name>Task 2: Add sub-system data to _on_zone_entered_after_load</name>
  <files>autoloads/save_manager.gd</files>
  <action>
  The current _on_zone_entered_after_load() (line 128) restores player progression after zone loads. Equipment and inventory restoration via load_save_data() in Task 1 happens BEFORE zone load (line 119), which is correct — GameManager's sub-systems are singletons that persist across zone transitions.

  However, verify that _apply_save_data() ordering is safe:
  1. Sub-system restore (equipment, inventory, party) happens at lines ~106-118 (BEFORE zone load)
  2. Zone load happens at line 119 (GameManager.load_zone)
  3. Player progression restore happens in _on_zone_entered_after_load (AFTER zone load)

  This ordering is correct because:
  - EquipmentManager, Inventory, PartyManager are autoload children — they survive zone transitions
  - Player progression must wait for player node to spawn in the new zone

  If this ordering is already correct (it should be), no changes needed in this task. Just verify by reading the final file and confirming the execution order is:
  1. Restore coins, boss flags, mini-boss flags (existing)
  2. Restore equipment, inventory, party (new from Task 1)
  3. Load zone (existing)
  4. After zone loads → restore player level/exp (existing callback)

  If ordering needs adjustment, move the sub-system restore calls to ensure they happen before load_zone().
  </action>
  <verify>
  Read the final save_manager.gd and trace the execution order:
  1. _apply_save_data() restores global state + sub-systems
  2. load_zone() transitions
  3. _on_zone_entered_after_load() restores player progression
  Confirm no race condition or ordering issue.
  </verify>
  <done>Save/load execution order is verified safe — sub-systems restore before zone load, player progression restores after zone load via callback.</done>
</task>

</tasks>

<verification>
1. Grep save_manager.gd for `get_save_data` — should appear 3 times (equipment, inventory, party)
2. Grep save_manager.gd for `load_save_data` — should appear 3 times
3. Verify SAVE_VERSION == 3
4. Verify _get_default_data() includes all new keys
5. Verify .get() fallbacks for backward compatibility
</verification>

<success_criteria>
- SaveManager persists equipment, inventory, and party state
- Old v2 saves load without crashes (graceful .get() fallback)
- Save version bumped to 3
- No modifications to equipment_manager.gd, inventory.gd, or party_manager.gd (their helpers are already correct)
</success_criteria>

<output>
After completion, create `.planning/phases/21-save-persistence/21-01-SUMMARY.md`
</output>
