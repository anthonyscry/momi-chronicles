---
phase: 19-sewers-zone
plan: 02
type: execute
wave: 2
depends_on: ["19-01"]
files_modified:
  - world/zones/sewers.gd
  - world/zones/sewers.tscn
autonomous: true

must_haves:
  truths:
    - "Player spawns in the sewers zone near the entrance"
    - "The zone is dark — CanvasModulate makes everything near-black, PointLight2D on player reveals nearby area"
    - "Linear main corridor path winds from entrance (left) to boss door (right) with 3-4 side rooms branching off"
    - "Corridors are 3-4 tiles wide (48-64px), creating a snug dungeon feel"
    - "Flowing water channels run along main corridor edges providing directional sense"
    - "Stagnant water pools appear in side rooms"
    - "Decorations include pipes, grates, dripping points along walls"
    - "Pre-boss area has warning signs: bone decorations, scratch marks, and a health pickup"
    - "No grass spawns in the sewers zone"
  artifacts:
    - path: "world/zones/sewers.gd"
      provides: "Sewers zone script extending BaseZone with darkness system and no-grass override"
      exports: ["zone_size", "zone_id"]
    - path: "world/zones/sewers.tscn"
      provides: "Complete sewers zone scene with layout, darkness, water, decorations, and zone structure"
  key_links:
    - from: "world/zones/sewers.gd"
      to: "world/zones/base_zone.gd"
      via: "extends BaseZone — inherits camera, respawn, companion systems"
      pattern: "extends BaseZone"
    - from: "world/zones/sewers.gd"
      to: "autoloads/game_manager.gd"
      via: "GameManager.get_pending_spawn() for spawn point selection"
      pattern: "GameManager.get_pending_spawn"
    - from: "world/zones/sewers.gd"
      to: "Player node"
      via: "PointLight2D added as child of player for darkness visibility"
      pattern: "PointLight2D"
---

<objective>
Create the complete sewers dungeon zone — script, scene layout, darkness system, water channels, decorations, and atmospheric elements.

Purpose: The sewers is the game's first proper dungeon — a darker, tighter, more atmospheric zone that contrasts with the open Neighborhood and Backyard. This plan builds the physical space that will be populated with enemies and hazards in Plan 19-03.

Output: sewers.gd (zone script) and sewers.tscn (zone scene with full dungeon layout).
</objective>

<execution_context>
@~/.config/Claude/get-shit-done/workflows/execute-plan.md
@~/.config/Claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-sewers-zone/19-CONTEXT.md
@.planning/phases/19-sewers-zone/19-RESEARCH.md
@.planning/phases/19-sewers-zone/19-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create sewers.gd zone script with darkness system</name>
  <files>world/zones/sewers.gd</files>
  <action>
Create `world/zones/sewers.gd` extending BaseZone. Follow the exact pattern from neighborhood.gd and backyard.gd.

**Structure:**

```gdscript
extends BaseZone

# Spawn points for zone entry
var spawn_points: Dictionary = {
    "default": Vector2(60, 324),
    "from_neighborhood": Vector2(60, 324),
}

func _setup_zone() -> void:
    zone_id = "sewers"
    
    # Handle pending spawn from zone transition
    var pending_spawn = GameManager.get_pending_spawn()
    if not pending_spawn.is_empty() and spawn_points.has(pending_spawn):
        spawn_player_at(spawn_points[pending_spawn])
    elif spawn_points.has("default"):
        spawn_player_at(spawn_points["default"])
    
    # Set up player light for dark zone
    _setup_player_light()

func _setup_player_light() -> void:
    if not player:
        return
    
    var light = PointLight2D.new()
    light.name = "SewerLight"
    
    # Create radial gradient texture programmatically
    # (avoids needing a separate .tres file)
    var gradient = Gradient.new()
    gradient.set_offset(0, 0.0)
    gradient.set_color(0, Color.WHITE)
    gradient.add_point(0.7, Color(1, 1, 1, 0.3))
    gradient.set_offset(gradient.get_point_count() - 1, 1.0)
    gradient.set_color(gradient.get_point_count() - 1, Color(1, 1, 1, 0.0))
    
    var texture = GradientTexture2D.new()
    texture.gradient = gradient
    texture.width = 256
    texture.height = 256
    texture.fill = GradientTexture2D.FILL_RADIAL
    texture.fill_from = Vector2(0.5, 0.5)
    texture.fill_to = Vector2(0.5, 0.0)
    
    light.texture = texture
    light.texture_scale = 3.5  # ~80px effective radius at viewport scale
    light.energy = 1.2
    light.color = Color(0.7, 0.75, 0.9)  # Cool blue-white
    
    player.add_child(light)

## Override: No grass in sewers — spawn moss/fungi patches instead
func _spawn_grass() -> void:
    # Spawn a few moss patches instead of grass
    var moss_count = randi_range(5, 8)
    var margin = 40
    
    for i in range(moss_count):
        var moss = ColorRect.new()
        moss.size = Vector2(randf_range(4, 8), randf_range(3, 5))
        moss.color = Color(0.15, 0.3, 0.12, randf_range(0.3, 0.5))  # Dark green moss
        
        var x = randf_range(margin, zone_size.x - margin)
        var y = randf_range(margin, zone_size.y - margin)
        moss.position = Vector2(x, y)
        moss.z_index = 1  # Just above floor
        
        add_child(moss)
```

**Key implementation details:**
- Use `GradientTexture2D` created programmatically in `_setup_player_light()` — this avoids needing a separate .tres asset file. Set fill = FILL_RADIAL, white center fading to transparent edge, 256x256 px.
- The gradient needs at least 3 stops: white at 0.0, dim at 0.7, transparent at 1.0 — gives a nice soft-edged light
- `texture_scale = 3.5` provides roughly 80px effective light radius at viewport scale — player can see ~2-3 tiles ahead
- `_spawn_grass()` override replaces grass with small moss ColorRects in dark green — subtle, fits underground
- Spawn points: entrance is at left side (x=60) vertically centered (y=324 at ~half of 648 zone height)

Do NOT use class_name. Follow path-based extends pattern.
  </action>
  <verify>File exists at world/zones/sewers.gd. Contains: extends BaseZone, spawn_points dict, _setup_zone with zone_id="sewers", _setup_player_light with PointLight2D and GradientTexture2D, _spawn_grass override.</verify>
  <done>Sewers zone script ready with BaseZone extension, spawn points, darkness system (programmatic PointLight2D with radial gradient), and moss-instead-of-grass override.</done>
</task>

<task type="auto">
  <name>Task 2: Build sewers.tscn zone scene — complete dungeon layout</name>
  <files>world/zones/sewers.tscn</files>
  <action>
Create `world/zones/sewers.tscn` — the complete zone scene. Since this project builds all visuals programmatically using ColorRect/Polygon2D/StaticBody2D (no imported art), build the entire dungeon layout as scene nodes.

**Zone size:** 1152 x 648 pixels (3x the standard 384x216 viewport)

**Scene tree structure:**

```
Sewers (Node2D) [script: sewers.gd, zone_size = Vector2(1152, 648)]
├── Background (ColorRect)
│   color = Color(0.06, 0.04, 0.1), size = Vector2(1152, 648)
│
├── Darkness (CanvasModulate)
│   color = Color(0.08, 0.06, 0.12)  # Near-black blue-purple
│
├── Corridors (Node2D)  # Floor sections — walkable areas
│   ├── [ColorRect floor tiles forming the main path + side rooms]
│   └── Floor color: Color(0.18, 0.16, 0.22) — dark grey-purple
│
├── Walls (Node2D)  # StaticBody2D walls bordering corridors
│   ├── [StaticBody2D+CollisionShape2D+ColorRect for each wall segment]
│   └── Wall color: Color(0.1, 0.08, 0.14) — darker than floor
│
├── WaterChannels (Node2D)  # Water visuals
│   ├── [ColorRect for flowing channel along main corridor edge]
│   │   Color(0.15, 0.2, 0.35, 0.7) — blue tinted, semi-transparent
│   └── [ColorRect for stagnant pools in side rooms]
│       Color(0.1, 0.15, 0.2, 0.5) — darker, more opaque
│
├── Decorations (Node2D)  # Pipes, grates, drips, pre-boss elements
│   ├── [Polygon2D pipes along walls — grey rectangles]
│   ├── [ColorRect grates — small dark grid patterns]
│   ├── [Drip points — positioned at "ceiling" spots for ambient feel]
│   ├── PreBossArea (Node2D)
│   │   ├── [Polygon2D bones — small white/cream L-shapes and lines]
│   │   ├── [Line2D scratch marks — short dark lines on walls]
│   │   └── [Health pickup instance near boss door]
│   └── [General atmosphere pieces: cracks, stains as ColorRect]
│
├── Boundaries (StaticBody2D)  # Invisible zone boundary
│   └── CollisionShape2D (RectangleShape2D) — perimeter walls, Layer 1
│   NOTE: Use 4 thin StaticBody2D walls around the perimeter instead of one shape
│
├── Player (instance: res://characters/player/player.tscn)
│   position = Vector2(60, 324)  # Near entrance
│
├── Enemies (Node2D)  # Enemy instances — populated here
│   ├── # EARLY SECTION (near entrance): Rat-heavy
│   │   ├── RatPack1 — 3-4 SewerRat instances with pack_id=0 near (200, 300)
│   │   └── RatPack2 — 3-4 SewerRat instances with pack_id=1 near (350, 250)
│   ├── # MID SECTION: Mixed
│   │   ├── RatPack3 — 2-3 SewerRat instances with pack_id=2
│   │   └── ShadowCreature1 — 1 Shadow Creature instance
│   └── # DEEP SECTION (near boss): Shadow-heavy
│       ├── ShadowCreature2
│       └── ShadowCreature3
│   # Side room enemies: Place 1-2 rats or 1 shadow creature in ambush rooms
│
├── Hazards (Node2D)  # Toxic puddles
│   ├── # Obvious puddles in main corridors (4-6)
│   │   ├── ToxicPuddle1 (is_camouflaged=false) — in early corridor
│   │   ├── ToxicPuddle2 (is_camouflaged=false) — near mid corridor
│   │   ├── ToxicPuddle3 (is_camouflaged=false) — in side room entrance
│   │   └── ToxicPuddle4 (is_camouflaged=false) — deep section
│   └── # Camouflaged puddles in side rooms/hidden spots (2-3)
│       ├── ToxicPuddle5 (is_camouflaged=true) — side room floor
│       └── ToxicPuddle6 (is_camouflaged=true) — narrow corridor
│
└── ZoneExits (Node2D)
    ├── ToNeighborhood (ZoneExit instance)
    │   position near entrance, exit_id="to_neighborhood"
    │   target_zone="neighborhood", target_spawn="from_sewers"
    └── ToBossRoom (ZoneExit instance)
        position at end of main path, exit_id="to_boss_room"
        target_zone="boss_arena_sewers", target_spawn="default"
        require_interaction=true
        # This door leads to the Phase 20 Rat King arena
        # Add visual: large dark door ColorRect with skull/warning decoration
```

**Dungeon layout design guidelines (Claude's discretion on exact positions):**

The main corridor should wind from left to right with at least 2-3 turns, creating an S-curve or zigzag path. This prevents the player from seeing the end from the entrance.

Corridor width: 48-64px (3-4 tiles at 16px/tile). The corridors should feel snug compared to open zones.

Side rooms: 3-4 total, branching off the main corridor at different points:
- Room 1 (early): Small alcove with coin pickups — easy treasure
- Room 2 (mid): Ambush room — enemies placed inside with regular detection range. When player enters, they encounter the enemies naturally (no special trigger needed — just being close enough triggers chase)
- Room 3 (mid-deep): Another treasure/hazard room with camouflaged toxic puddle + coins
- Room 4 (deep): Ambush room with shadow creature — harder encounter, better loot

Pre-boss area: The final stretch before the boss door should be a wider corridor with:
- Bone Polygon2Ds scattered on floor (small white/cream shapes)
- Scratch marks on walls (Line2D or thin ColorRect)
- 1 health pickup instance positioned conspicuously as "mercy" before boss
- The boss door itself (ToBossRoom ZoneExit + large door visual)

**Building the scene:** Since creating a full .tscn by hand is impractical at this scale, build the layout programmatically in sewers.gd's `_ready()` or `_setup_zone()`. Add methods like:
- `_build_corridors()` — creates floor ColorRects for main path + rooms
- `_build_walls()` — creates StaticBody2D walls along corridor edges
- `_build_water()` — creates water channel ColorRects
- `_build_decorations()` — creates pipes, grates, bones, etc.
- `_build_boundaries()` — creates perimeter walls

The .tscn file just needs the root Sewers node with script, zone_size export, Player instance, and container Node2Ds (Enemies, Hazards, ZoneExits, etc.). The actual layout geometry is built in code.

**IMPORTANT: Do NOT leave this as placeholder/TODO.** Build the actual dungeon geometry with specific positions. Use the zone_size (1152x648) as your canvas. The entrance is at the left edge, the boss door at the right edge.

**Enemy placement reference:**
- SewerRat scene: `res://characters/enemies/sewer_rat.tscn`
- ShadowCreature scene: `res://characters/enemies/shadow_creature.tscn`
- Enemy instances go under the Enemies node
- Set `pack_id` property on SewerRat instances that should swarm together

**Hazard placement:**
- ToxicPuddle: use `res://components/hazards/toxic_puddle.gd` script on Area2D nodes
- Set `is_camouflaged` property for hidden puddles

**ZoneExit reference:**
- ZoneExit scene: `res://components/zone_exit/zone_exit.tscn`
- Export properties: exit_id, target_zone, target_spawn, require_interaction
  </action>
  <verify>
Scene loads without errors (no crash when scene is loaded by GameManager). Zone has:
- Background + CanvasModulate darkness
- Walkable corridor floor connecting entrance to boss door
- Walls blocking movement outside corridors
- Water channels along main path
- At least 3 side rooms branching off main corridor
- Decorations (pipes, grates, pre-boss bones)
- Enemy instances in Enemies container (rats early, shadows deep)
- Toxic puddle instances in Hazards container (mix of obvious and camouflaged)
- ZoneExit to neighborhood near entrance
- ZoneExit to boss room at end with require_interaction
- Player instance at spawn point
  </verify>
  <done>Complete sewers dungeon zone scene with winding main corridor, 3-4 side rooms, darkness system, water channels, enemy placements (rats→shadows escalation), toxic puddle hazards (obvious + camouflaged), decorations, pre-boss area with warning signs and health pickup, and zone exits for both neighborhood return and future boss room.</done>
</task>

</tasks>

<verification>
- [ ] sewers.gd extends BaseZone with zone_id = "sewers"
- [ ] PointLight2D attached to player with programmatic GradientTexture2D
- [ ] CanvasModulate creates darkness effect (dark blue-purple)
- [ ] Zone has linear main corridor from entrance to boss door
- [ ] 3-4 side rooms branch off main corridor
- [ ] Corridors are 48-64px wide (3-4 tiles)
- [ ] Water channels provide directional sense along main path
- [ ] Enemy escalation: rats early → shadows deep
- [ ] Toxic puddles placed: 4-6 obvious, 2-3 camouflaged
- [ ] Pre-boss area has bones, scratches, health pickup
- [ ] Both ZoneExits exist (to_neighborhood, to_boss_room)
- [ ] Boss door requires interaction (require_interaction=true)
- [ ] No grass spawns — moss patches instead
- [ ] Zone size is 1152x648
</verification>

<success_criteria>
- The sewers zone loads without errors
- Darkness is visually impactful — most of the screen is dark, only area near player is lit
- Dungeon layout has a clear path from entrance to boss door with optional exploration
- Enemy placement creates escalating difficulty (rats early, shadows late)
- Water channel on main path gives directional sense
- Pre-boss area signals "something big ahead" with atmospheric decorations
- Zone feels like a proper 5-7 minute dungeon exploration
</success_criteria>

<output>
After completion, create `.planning/phases/19-sewers-zone/19-02-SUMMARY.md`
</output>
