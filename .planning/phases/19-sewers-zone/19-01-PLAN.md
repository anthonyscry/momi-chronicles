---
phase: 19-sewers-zone
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - components/hazards/toxic_puddle.gd
  - autoloads/game_manager.gd
  - autoloads/audio_manager.gd
  - components/effects/ambient_particles.gd
  - autoloads/effects_manager.gd
autonomous: true

must_haves:
  truths:
    - "ToxicPuddle component applies poison DoT when player steps on it"
    - "GameManager recognizes 'sewers' as a valid zone for scene transitions"
    - "AudioManager plays sewer-specific music when entering the zone"
    - "AmbientParticles has a SEWER_DRIPS style that spawns dripping water particles"
  artifacts:
    - path: "components/hazards/toxic_puddle.gd"
      provides: "Reusable environmental hazard — Area2D that poisons player on overlap"
    - path: "autoloads/game_manager.gd"
      provides: "Zone registry with 'sewers' entry"
    - path: "autoloads/audio_manager.gd"
      provides: "Sewer zone music track registration"
    - path: "components/effects/ambient_particles.gd"
      provides: "SEWER_DRIPS ambient particle style"
  key_links:
    - from: "components/hazards/toxic_puddle.gd"
      to: "components/health/health_component.gd"
      via: "apply_poison(damage, duration) call on player's HealthComponent"
      pattern: "apply_poison"
    - from: "autoloads/game_manager.gd"
      to: "world/zones/sewers.tscn"
      via: "zone_scenes dict entry mapping 'sewers' to scene path"
      pattern: "sewers.*res://world/zones/sewers"
    - from: "components/effects/ambient_particles.gd"
      to: "autoloads/effects_manager.gd"
      via: "SEWER_DRIPS style selected when zone_id is 'sewers'"
      pattern: "SEWER_DRIPS"
---

<objective>
Create the toxic puddle environmental hazard component and register the sewers zone across all autoload systems.

Purpose: Shared components and autoload registrations must exist before the sewers zone scene can be built. The toxic puddle is a reusable hazard component. Zone registration ensures transitions, music, and ambient effects work automatically.

Output: ToxicPuddle component script, updated GameManager/AudioManager/AmbientParticles/EffectsManager with sewers support.
</objective>

<execution_context>
@~/.config/Claude/get-shit-done/workflows/execute-plan.md
@~/.config/Claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-sewers-zone/19-CONTEXT.md
@.planning/phases/19-sewers-zone/19-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ToxicPuddle environmental hazard component</name>
  <files>components/hazards/toxic_puddle.gd</files>
  <action>
Create `components/hazards/` directory if it doesn't exist. Create `toxic_puddle.gd` extending Area2D.

**Exports:**
- `poison_damage: int = 2` — damage per poison tick
- `poison_duration: float = 3.0` — how long poison lasts after leaving
- `reapply_interval: float = 1.5` — re-poison cooldown while standing in puddle
- `is_camouflaged: bool = false` — obvious (bright green) vs hidden (dark subtle)
- `puddle_size: Vector2 = Vector2(24, 16)` — size of the puddle area

**Variables:**
- `_reapply_timer: float = 0.0`
- `_player_in_puddle: bool = false`

**_ready():**
- Set `collision_layer = 0`, `collision_mask = 2` (Player layer)
- Connect `body_entered` to `_on_body_entered`
- Connect `body_exited` to `_on_body_exited`
- Call `_setup_visuals()`

**_setup_visuals():**
- Create CollisionShape2D child with RectangleShape2D sized to `puddle_size`
- Create ColorRect child for visual:
  - If NOT camouflaged: Color(0.3, 0.8, 0.2, 0.6) — bright green glow
  - If camouflaged: Color(0.15, 0.25, 0.12, 0.4) — subtle dark green
  - Size = puddle_size, position = -puddle_size / 2 (centered)
- If NOT camouflaged: add bubbling animation — tween that oscillates the ColorRect modulate alpha between 0.5 and 0.8 every 0.8s (looping). This makes obvious puddles visually "bubble"

**_process(delta):**
- If `_player_in_puddle`: increment `_reapply_timer` by delta. If >= `reapply_interval`, reset timer and call `_apply_poison()` on the player node (get from tree group "player")

**_on_body_entered(body):**
- Check `body.is_in_group("player")`. If so: set `_player_in_puddle = true`, reset timer, call `_apply_poison(body)`

**_on_body_exited(body):**
- Check `body.is_in_group("player")`. If so: set `_player_in_puddle = false`

**_apply_poison(body):**
- Get HealthComponent: `body.get_node_or_null("HealthComponent")`
- If exists and has `apply_poison` method: call `health_comp.apply_poison(poison_damage, poison_duration)`

Do NOT use `class_name` — follow the project pattern of path-based extends to avoid autoload scope issues.
  </action>
  <verify>File exists at components/hazards/toxic_puddle.gd. Contains: extends Area2D, apply_poison call, collision_mask = 2, is_camouflaged export, _setup_visuals method, bubbling tween.</verify>
  <done>ToxicPuddle component can be instanced in any zone scene. Obvious puddles glow bright green with bubbling. Camouflaged puddles are subtle dark green. Both apply poison DoT when player steps on them and periodically reapply while player remains standing in them.</done>
</task>

<task type="auto">
  <name>Task 2: Register sewers zone in autoloads and create ambient particle style</name>
  <files>autoloads/game_manager.gd, autoloads/audio_manager.gd, components/effects/ambient_particles.gd, autoloads/effects_manager.gd</files>
  <action>
**Read each file first**, then make targeted additions:

**1. GameManager (autoloads/game_manager.gd):**
- Find the `zone_scenes` dictionary (should be near the top or in _ready)
- Add entry: `"sewers": "res://world/zones/sewers.tscn"`
- This ensures GameManager can load the sewers zone on transition

**2. AudioManager (autoloads/audio_manager.gd):**
- Find `music_tracks` dictionary — add: `"sewers": "res://assets/audio/music/sewers.wav"` (placeholder path, same pattern as other zones)
- Find `_get_zone_track()` function — add `"sewers":` case that returns `"sewers"`
- Find `_on_zone_entered()` function (if it has a match/case) — add `"sewers":` case setting `zone_base_track = "sewers"`
- Follow the exact pattern of existing zone entries (look at "neighborhood", "backyard" for reference)

**3. AmbientParticles (components/effects/ambient_particles.gd):**
- Find the `ParticleStyle` enum — add `SEWER_DRIPS` as a new value
- Find `set_style_for_zone()` or equivalent method — add `"sewers":` case that sets style to `SEWER_DRIPS`
- Implement `_spawn_sewer_drip()` method following the pattern of `_spawn_dust_mote()` / `_spawn_leaf()`:
  - Create small ColorRect (2x3 px) with blue-grey color Color(0.3, 0.4, 0.5, randf_range(0.2, 0.5))
  - Set z_index = 45
  - Spawn above viewport at random x position
  - Tween: fall straight down (dripping water effect) over 1.0-2.0s, fade out in last 30% of fall
  - Queue_free after tween completes
  - Add to _active_particles array, erase on free
- In the spawn dispatch (where style determines which _spawn method to call), add: when SEWER_DRIPS → call _spawn_sewer_drip()

**4. EffectsManager (autoloads/effects_manager.gd):**
- Find `_on_zone_entered_particles()` or equivalent that auto-spawns AmbientParticles on zone entry
- Ensure "sewers" zone is handled — may just need adding "sewers" to a match case or it may already work generically (check the logic). If it uses AmbientParticles.set_style_for_zone() which we already updated, it may work automatically.
- Only modify if there's a hardcoded zone list that would exclude sewers.

**IMPORTANT:** Read each file carefully before editing. Match exact patterns (indentation, style, naming) of existing entries. Do NOT restructure existing code — only add the minimum needed.
  </action>
  <verify>
Run these checks:
- `grep -n "sewers" autoloads/game_manager.gd` — should show zone_scenes entry
- `grep -n "sewers" autoloads/audio_manager.gd` — should show music track and zone cases
- `grep -n "SEWER_DRIPS" components/effects/ambient_particles.gd` — should show enum value, spawn method, style dispatch
- `grep -n "sewers" autoloads/effects_manager.gd` — should show zone handling (or confirm generic handling works)
  </verify>
  <done>All autoloads recognize "sewers" zone: GameManager can transition to it, AudioManager plays sewer music, AmbientParticles spawns SEWER_DRIPS dripping water particles, EffectsManager triggers particles on zone entry.</done>
</task>

</tasks>

<verification>
- [ ] components/hazards/toxic_puddle.gd exists and extends Area2D
- [ ] ToxicPuddle uses HealthComponent.apply_poison() — not a custom DoT
- [ ] ToxicPuddle has obvious (bright green, bubbling) and camouflaged (dark, subtle) variants
- [ ] GameManager.zone_scenes has "sewers" entry
- [ ] AudioManager handles "sewers" zone for music
- [ ] AmbientParticles has SEWER_DRIPS style with dripping water particles
- [ ] No existing functionality broken by additions
</verification>

<success_criteria>
- ToxicPuddle component script complete with poison DoT on player overlap
- All 4 autoloads updated with sewers zone support
- SEWER_DRIPS ambient particle style implemented with falling water drops
- All additions follow existing code patterns exactly
</success_criteria>

<output>
After completion, create `.planning/phases/19-sewers-zone/19-01-SUMMARY.md`
</output>
