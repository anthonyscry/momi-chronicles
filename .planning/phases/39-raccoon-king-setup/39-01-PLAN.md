---
phase: 39-raccoon-king-setup
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [world/zones/sewers.gd]
autonomous: true

must_haves:
  truths:
    - "Player cannot enter boss arena without defeating at least 2 mini-bosses"
    - "Boss door shows how many mini-bosses are defeated vs required"
    - "Boss door visual changes when requirements are met (locked → unlocked)"
  artifacts:
    - path: "world/zones/sewers.gd"
      provides: "Boss door gating with mini-boss defeat requirements"
      contains: "_check_boss_door_requirements"
  key_links:
    - from: "world/zones/sewers.gd"
      to: "GameManager.mini_bosses_defeated"
      via: "checks defeated count before allowing boss door interaction"
      pattern: "mini_bosses_defeated"
---

<objective>
Gate the boss arena entrance in the Sewers zone behind mini-boss defeats. Players must defeat at least 2 of the 4 mini-bosses before the boss door opens, creating a clear progression requirement.

Purpose: Without gating, players can walk straight to the Raccoon King at any time. Requiring mini-boss defeats ensures players have explored the world, gained equipment, and are strong enough for the final fight.

Output: Updated sewers.gd with boss door gating, visual status indicator, and locked/unlocked state.
</objective>

<context>
@docs/PROJECT.md
@world/zones/sewers.gd
@autoloads/game_manager.gd
</context>

<tasks>

<task type="auto">
  <name>Task 1: Boss Door Progression Gating</name>
  <files>world/zones/sewers.gd</files>
  <action>
  Modify the sewers zone to gate the boss door behind mini-boss defeats:

  1. **Add a constant** near the top of the file (with other constants):
     ```
     const MINI_BOSSES_REQUIRED: int = 2  # Must defeat 2 of 4 mini-bosses to enter
     ```

  2. **Add a helper function `_count_mini_bosses_defeated()`:**
     ```
     func _count_mini_bosses_defeated() -> int:
         var count: int = 0
         for key in GameManager.mini_bosses_defeated:
             if GameManager.mini_bosses_defeated[key]:
                 count += 1
         return count
     ```

  3. **Modify `_build_boss_door()`** to show requirement status.
     After the existing "DANGER!" warning label (line ~754), add a status label:
     ```
     # Mini-boss defeat status
     var defeated_count = _count_mini_bosses_defeated()
     var is_unlocked = defeated_count >= MINI_BOSSES_REQUIRED

     var status_label = Label.new()
     status_label.name = "BossGateStatus"
     status_label.position = frame_pos + Vector2(-30, -34)
     status_label.add_theme_font_size_override("font_size", 7)

     if is_unlocked:
         status_label.text = "ENTER..."
         status_label.add_theme_color_override("font_color", Color(0.3, 1.0, 0.3, 0.8))
         # Door glows green when unlocked
         door.color = Color(0.35, 0.25, 0.15)  # Slightly brighter
     else:
         status_label.text = "%d/%d BOSSES" % [defeated_count, MINI_BOSSES_REQUIRED]
         status_label.add_theme_color_override("font_color", Color(1.0, 0.6, 0.2, 0.8))
         # Door stays dark when locked
         door.color = Color(0.15, 0.1, 0.08)  # Darker, clearly locked

     boss_door_container.add_child(status_label)
     ```

  4. **Modify `_build_zone_exits()`** to conditionally add the boss room exit.
     Change the boss room exit section (lines ~775-783) to only create the exit if requirements are met:
     ```
     # Exit to boss room (at the boss door) — only if mini-boss gate met
     if _count_mini_bosses_defeated() >= MINI_BOSSES_REQUIRED:
         var to_boss = ZONE_EXIT_SCENE.instantiate()
         to_boss.name = "ToBossRoom"
         to_boss.position = Vector2(1020, 340)
         to_boss.exit_id = "to_boss_room"
         to_boss.target_zone = "boss_arena"
         to_boss.target_spawn = "default"
         to_boss.require_interaction = true
         exits_container.add_child(to_boss)
     ```
     When requirements aren't met, the ZoneExit simply doesn't exist — player can walk to the door but pressing interact does nothing.

  Important:
  - Use tabs for indentation (match existing file)
  - Use DebugLogger.log_zone() for any logging
  - Do NOT modify any other functions in sewers.gd
  - The gate reads from GameManager.mini_bosses_defeated (already populated)
  - MINI_BOSSES_REQUIRED = 2 means defeating any 2 of: alpha_raccoon, crow_matriarch, rat_king, pigeon_king
  </action>
  <verify>
  - `rg -n "MINI_BOSSES_REQUIRED" world/zones/sewers.gd` shows constant and usage
  - `rg -n "_count_mini_bosses_defeated" world/zones/sewers.gd` shows helper function
  - `rg -n "BossGateStatus" world/zones/sewers.gd` shows status label
  - `rg -n "mini_bosses_defeated" world/zones/sewers.gd` shows GameManager reference
  </verify>
  <done>
  Boss door in Sewers shows "X/2 BOSSES" status. Door is visually locked (dark) until 2+ mini-bosses are defeated. ZoneExit only spawns when gate is met. Players must explore and defeat mini-bosses before the final fight.
  </done>
</task>

</tasks>

<verification>
- `rg -n "MINI_BOSSES_REQUIRED|_count_mini_bosses_defeated|BossGateStatus" world/zones/sewers.gd` shows all gating code
- Boss door exit only created when requirements met
- Visual indicator changes between locked and unlocked states
</verification>

<success_criteria>
Players cannot enter boss_arena without defeating at least 2 mini-bosses. Boss door shows clear visual feedback about progress. Gate reads from existing GameManager.mini_bosses_defeated dictionary.
</success_criteria>

<output>
After completion, create `.planning/phases/39-raccoon-king-setup/39-01-SUMMARY.md`
</output>
