---
phase: 39-raccoon-king-setup
plan: 02
type: execute
wave: 1
depends_on: []
files_modified: [world/zones/boss_arena.gd, autoloads/game_manager.gd]
autonomous: true

must_haves:
  truths:
    - "Defeating the Raccoon King shows a victory overlay with player stats"
    - "Victory screen offers Continue Playing or Return to Title options"
    - "Boss does not respawn if already defeated (re-entering shows empty arena)"
    - "Game completion is saved persistently"
  artifacts:
    - path: "world/zones/boss_arena.gd"
      provides: "Victory screen overlay, re-entry check"
      contains: "_show_victory_screen"
    - path: "autoloads/game_manager.gd"
      provides: "game_complete flag for save persistence"
      contains: "game_complete"
  key_links:
    - from: "world/zones/boss_arena.gd"
      to: "autoloads/game_manager.gd"
      via: "sets game_complete = true on boss defeat"
      pattern: "game_complete"
---

<objective>
Add a victory screen after defeating the Raccoon King and prevent boss respawn on re-entry. Create a satisfying endgame moment with player stats display and completion persistence.

Purpose: Currently defeating the boss just spawns an exit. Players need a proper victory moment — stats, congratulations, and a clear "you won!" signal. Re-entry prevention avoids the awkwardness of fighting the boss again.

Output: Updated boss_arena.gd with victory screen and re-entry check. Updated game_manager.gd with game_complete flag.
</objective>

<context>
@docs/PROJECT.md
@world/zones/boss_arena.gd
@autoloads/game_manager.gd
</context>

<tasks>

<task type="auto">
  <name>Task 1: Game Complete Flag in GameManager</name>
  <files>autoloads/game_manager.gd</files>
  <action>
  Add a `game_complete` flag to GameManager for save persistence:

  1. **Add variable** after `boss_defeated` (line ~34):
     ```
     var game_complete: bool = false
     ```

  2. **Reset it in `reset_game()`** (after `boss_defeated = false`, line ~348):
     ```
     game_complete = false
     ```

  That's it — minimal change. The save system already persists all GameManager vars via SaveManager.
  Boss_arena.gd will set this to true on Raccoon King defeat.

  Important: Use tabs. Do NOT modify any other GameManager functions.
  </action>
  <verify>
  - `rg -n "game_complete" autoloads/game_manager.gd` shows declaration and reset
  </verify>
  <done>GameManager has game_complete flag that persists across saves and resets on new game.</done>
</task>

<task type="auto">
  <name>Task 2: Boss Re-entry Check + Victory Screen</name>
  <files>world/zones/boss_arena.gd</files>
  <action>
  Modify boss_arena.gd with re-entry prevention and a victory overlay:

  1. **Fix bare print() on line 118** — change to DebugLogger:
     ```
     DebugLogger.log_zone("Victory exit spawned — walk south to leave!")
     ```

  2. **Add re-entry check in `_ready()`.**
     After the player positioning code (line ~36), before `_spawn_boss()`, add:
     ```
     # Don't respawn boss if already defeated
     if GameManager.boss_defeated:
         _show_empty_arena()
         return
     ```

  3. **Implement `_show_empty_arena()`:**
     ```
     func _show_empty_arena() -> void:
         # Boss already defeated — show peaceful arena with exit
         _unlock_doors()

         # Spawn exit immediately
         _spawn_victory_exit()

         # Show completion message
         var label = Label.new()
         label.name = "CompletionMsg"
         label.text = "The Raccoon King has been defeated.\nThe neighborhood is safe."
         label.add_theme_font_size_override("font_size", 10)
         label.add_theme_color_override("font_color", Color(0.8, 0.85, 0.6))
         label.horizontal_alignment = HORIZONTAL_ALIGNMENT_CENTER
         label.position = Vector2(92, 70)
         label.size = Vector2(200, 40)
         add_child(label)

         if AudioManager:
             AudioManager.play_music("victory")

         Events.zone_entered.emit(zone_name)
         DebugLogger.log_zone("Boss arena re-entered — boss already defeated")
     ```

  4. **Modify `_on_boss_defeated()` to set game_complete and show victory screen.**
     Replace the existing `_on_boss_defeated` function with:
     ```
     func _on_boss_defeated(_boss: Node) -> void:
         boss_defeated = true
         GameManager.game_complete = true

         # Dramatic pause
         Engine.time_scale = 0.3
         await get_tree().create_timer(0.5 * 0.3).timeout
         Engine.time_scale = 1.0

         # Unlock doors
         _unlock_doors()

         # Victory music
         if AudioManager:
             AudioManager.play_music("victory")

         # Spawn rewards
         _spawn_victory_rewards()

         # Show victory screen after a beat
         await get_tree().create_timer(1.5).timeout
         _show_victory_screen()
     ```

  5. **Implement `_show_victory_screen()`** — programmatic UI overlay:
     ```
     func _show_victory_screen() -> void:
         # Create CanvasLayer so it renders above everything
         var canvas = CanvasLayer.new()
         canvas.name = "VictoryScreen"
         canvas.layer = 10
         add_child(canvas)

         # Semi-transparent black background
         var bg = ColorRect.new()
         bg.name = "VictoryBG"
         bg.anchor_right = 1.0
         bg.anchor_bottom = 1.0
         bg.color = Color(0, 0, 0, 0.0)
         canvas.add_child(bg)

         # Fade in background
         var bg_tween = create_tween()
         bg_tween.tween_property(bg, "color:a", 0.75, 0.8)

         # Container for all victory content
         var container = VBoxContainer.new()
         container.name = "VictoryContent"
         container.position = Vector2(42, 20)
         container.size = Vector2(300, 176)
         container.alignment = BoxContainer.ALIGNMENT_CENTER
         container.modulate.a = 0.0
         canvas.add_child(container)

         # Title
         var title = Label.new()
         title.text = "THE NEIGHBORHOOD IS SAFE!"
         title.add_theme_font_size_override("font_size", 14)
         title.add_theme_color_override("font_color", Color(1.0, 0.85, 0.3))
         title.horizontal_alignment = HORIZONTAL_ALIGNMENT_CENTER
         container.add_child(title)

         # Spacer
         var spacer1 = Control.new()
         spacer1.custom_minimum_size = Vector2(0, 8)
         container.add_child(spacer1)

         # Stats
         var player = get_tree().get_first_node_in_group("player")
         var level_text = "Level %d" % player.get_current_level() if player and player.has_method("get_current_level") else "Level ?"
         var coins_text = "%d Coins" % GameManager.coins

         var mini_boss_count: int = 0
         for key in GameManager.mini_bosses_defeated:
             if GameManager.mini_bosses_defeated[key]:
                 mini_boss_count += 1

         var stats_text = "%s  •  %s  •  %d/4 Mini-Bosses" % [level_text, coins_text, mini_boss_count]
         var stats = Label.new()
         stats.text = stats_text
         stats.add_theme_font_size_override("font_size", 8)
         stats.add_theme_color_override("font_color", Color(0.8, 0.8, 0.9))
         stats.horizontal_alignment = HORIZONTAL_ALIGNMENT_CENTER
         container.add_child(stats)

         # Spacer
         var spacer2 = Control.new()
         spacer2.custom_minimum_size = Vector2(0, 6)
         container.add_child(spacer2)

         # "Momi and the Bulldog Squad protected their neighborhood."
         var flavor = Label.new()
         flavor.text = "Momi and the Bulldog Squad\nprotected their neighborhood."
         flavor.add_theme_font_size_override("font_size", 8)
         flavor.add_theme_color_override("font_color", Color(0.7, 0.75, 0.65))
         flavor.horizontal_alignment = HORIZONTAL_ALIGNMENT_CENTER
         container.add_child(flavor)

         # Spacer
         var spacer3 = Control.new()
         spacer3.custom_minimum_size = Vector2(0, 12)
         container.add_child(spacer3)

         # Buttons container
         var btn_container = HBoxContainer.new()
         btn_container.alignment = BoxContainer.ALIGNMENT_CENTER
         container.add_child(btn_container)

         # Continue Playing button
         var continue_btn = Button.new()
         continue_btn.text = "Continue Playing"
         continue_btn.add_theme_font_size_override("font_size", 8)
         continue_btn.pressed.connect(_on_victory_continue)
         btn_container.add_child(continue_btn)

         # Spacer between buttons
         var btn_spacer = Control.new()
         btn_spacer.custom_minimum_size = Vector2(16, 0)
         btn_container.add_child(btn_spacer)

         # Return to Title button
         var title_btn = Button.new()
         title_btn.text = "Title Screen"
         title_btn.add_theme_font_size_override("font_size", 8)
         title_btn.pressed.connect(_on_victory_title)
         btn_container.add_child(title_btn)

         # Fade in content
         await get_tree().create_timer(0.5).timeout
         var content_tween = create_tween()
         content_tween.tween_property(container, "modulate:a", 1.0, 0.6)

         DebugLogger.log_zone("Victory screen displayed")


     func _on_victory_continue() -> void:
         # Save and return to neighborhood
         SaveManager.save_game()
         var victory_screen = get_node_or_null("VictoryScreen")
         if victory_screen:
             victory_screen.queue_free()
         _spawn_victory_exit()
         DebugLogger.log_zone("Player chose: Continue Playing")


     func _on_victory_title() -> void:
         # Save and return to title screen
         SaveManager.save_game()
         get_tree().change_scene_to_file("res://ui/title_screen/title_screen.tscn")
         DebugLogger.log_zone("Player chose: Title Screen")
     ```

  6. **Remove the old `_spawn_victory_exit()` call from `_on_boss_defeated`** — it's now handled
     by the victory screen buttons. The `_spawn_victory_exit()` function itself stays (used by
     `_show_empty_arena()` and `_on_victory_continue()`).

  Important conventions:
  - Use tabs for indentation (match existing file)
  - Use DebugLogger.log_zone() instead of print()
  - Build UI programmatically in code (match ring menu pattern)
  - Do NOT remove the class_name (that's tech debt for later, not this phase)
  - The victory screen is a CanvasLayer so it renders above the game world
  - Button font size 8 matches pixel art aesthetic (384x216 resolution)
  </action>
  <verify>
  - `rg -n "_show_victory_screen|_show_empty_arena|game_complete|_on_victory_" world/zones/boss_arena.gd` shows all new functions
  - `rg -n "print\b" world/zones/boss_arena.gd` returns NO results (bare print removed)
  - `rg -n "game_complete" autoloads/game_manager.gd` shows flag
  - `rg -n "GameManager.boss_defeated" world/zones/boss_arena.gd` shows re-entry check
  </verify>
  <done>
  Boss arena prevents respawn on re-entry (shows peaceful message + exit). Defeating the Raccoon King shows victory overlay with title, stats (level, coins, mini-bosses), flavor text, and two buttons (Continue Playing, Title Screen). Game completion is saved. No bare print() calls remain.
  </done>
</task>

</tasks>

<verification>
- `rg -n "_show_victory_screen|_show_empty_arena|game_complete" world/zones/boss_arena.gd` shows victory and re-entry code
- `rg -n "game_complete" autoloads/game_manager.gd` shows flag and reset
- `rg "print\(" world/zones/boss_arena.gd` returns NO results
- Boss arena handles both first-time fight and re-entry gracefully
</verification>

<success_criteria>
Defeating the Raccoon King triggers a victory screen with stats and two clear options. Re-entering a cleared boss arena shows a peaceful message. Game completion persists across saves. All bare print() calls replaced with DebugLogger.
</success_criteria>

<output>
After completion, create `.planning/phases/39-raccoon-king-setup/39-02-SUMMARY.md`
</output>
