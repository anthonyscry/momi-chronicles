---
phase: 16-ring-menu
plan: 03
type: execute
wave: 2
depends_on: ["16-01"]
files_modified:
  - systems/equipment/equipment_database.gd
  - systems/equipment/equipment_manager.gd
  - ui/ring_menu/ring_menu.gd
  - characters/player/player.gd
  - autoloads/game_manager.gd
  - autoloads/events.gd
autonomous: true

must_haves:
  truths:
    - "Player can equip items to 5 slots (Collar, Harness, Leash, Coat, Hat)"
    - "Equipment provides stat bonuses when equipped"
    - "Equipment ring shows currently equipped items"
    - "Selecting equipment instantly equips it"
    - "Only one item per slot at a time"
    - "Stats update immediately on equip/unequip"
  artifacts:
    - path: "systems/equipment/equipment_database.gd"
      provides: "Equipment definitions for all 5 slots"
      exports: ["EquipmentDatabase"]
    - path: "systems/equipment/equipment_manager.gd"
      provides: "Equipment slot management and stat calculation"
      exports: ["EquipmentManager"]
  key_links:
    - from: "ring_menu.gd"
      to: "equipment_manager.gd"
      via: "_equip_item calls equipment manager"
      pattern: "equipment_manager\\.equip"
    - from: "equipment_manager.gd"
      to: "player.gd"
      via: "stat bonuses applied"
      pattern: "get_equipment_bonus"
---

<objective>
Create the equipment system with 5 dog-themed slots for stat customization.

Purpose: Allow players to find and equip gear that provides stat bonuses
Output: Working equipment system with 5 slots accessible from ring menu
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/16-ring-menu/16-CONTEXT.md
@.planning/phases/16-ring-menu/16-01-SUMMARY.md
@ui/ring_menu/ring_menu.gd
@characters/player/player.gd
@autoloads/game_manager.gd
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Equipment Database</name>
  <files>
    systems/equipment/equipment_database.gd
  </files>
  <action>
Create equipment definitions with 5 slot types reflecting real dog accessories:

```gdscript
extends Node
class_name EquipmentDatabase

## Equipment slot types (5 slots as per CONTEXT.md)
enum Slot {
    COLLAR,     # Neck - primary accessory
    HARNESS,    # Body harness for stats
    LEASH,      # Held item / tether
    COAT,       # Coat/Jacket/Shirt - body covering
    HAT,        # Head accessory
}

## Stat types that equipment can modify
enum StatType {
    MAX_HEALTH,
    ATTACK_DAMAGE,
    MOVE_SPEED,
    DEFENSE,        # Damage reduction %
    GUARD_REGEN,    # Guard meter regen rate
    EXP_BONUS,      # Bonus EXP %
}

## Slot display names
const SLOT_NAMES: Dictionary = {
    Slot.COLLAR: "Collar",
    Slot.HARNESS: "Harness",
    Slot.LEASH: "Leash",
    Slot.COAT: "Coat",
    Slot.HAT: "Hat",
}

## All equipment definitions
const EQUIPMENT: Dictionary = {
    # === COLLARS ===
    "basic_collar": {
        "id": "basic_collar",
        "name": "Basic Collar",
        "desc": "A simple collar. +5 Max HP",
        "type": "equipment",
        "slot": Slot.COLLAR,
        "stats": {StatType.MAX_HEALTH: 5},
        "color": Color(0.8, 0.4, 0.2),  # Brown leather
    },
    "spiked_collar": {
        "id": "spiked_collar",
        "name": "Spiked Collar",
        "desc": "Intimidating spikes. +3 Attack",
        "type": "equipment",
        "slot": Slot.COLLAR,
        "stats": {StatType.ATTACK_DAMAGE: 3},
        "color": Color(0.3, 0.3, 0.3),  # Dark metal
    },
    "lucky_collar": {
        "id": "lucky_collar",
        "name": "Lucky Collar",
        "desc": "Brings good fortune. +10% EXP",
        "type": "equipment",
        "slot": Slot.COLLAR,
        "stats": {StatType.EXP_BONUS: 10},
        "color": Color(1.0, 0.84, 0.0),  # Gold
    },
    
    # === HARNESSES ===
    "training_harness": {
        "id": "training_harness",
        "name": "Training Harness",
        "desc": "Sturdy training gear. +10 Max HP",
        "type": "equipment",
        "slot": Slot.HARNESS,
        "stats": {StatType.MAX_HEALTH: 10},
        "color": Color(0.2, 0.5, 0.8),  # Blue
    },
    "tactical_harness": {
        "id": "tactical_harness",
        "name": "Tactical Harness",
        "desc": "Military grade. +5 Attack, +5 HP",
        "type": "equipment",
        "slot": Slot.HARNESS,
        "stats": {StatType.ATTACK_DAMAGE: 5, StatType.MAX_HEALTH: 5},
        "color": Color(0.3, 0.35, 0.3),  # Olive
    },
    "padded_harness": {
        "id": "padded_harness",
        "name": "Padded Harness",
        "desc": "Extra padding. +10% Defense",
        "type": "equipment",
        "slot": Slot.HARNESS,
        "stats": {StatType.DEFENSE: 10},
        "color": Color(0.6, 0.4, 0.6),  # Purple
    },
    
    # === LEASHES ===
    "retractable_leash": {
        "id": "retractable_leash",
        "name": "Retractable Leash",
        "desc": "Freedom to roam. +5 Speed",
        "type": "equipment",
        "slot": Slot.LEASH,
        "stats": {StatType.MOVE_SPEED: 5},
        "color": Color(0.9, 0.1, 0.1),  # Red
    },
    "chain_leash": {
        "id": "chain_leash",
        "name": "Chain Leash",
        "desc": "Heavy duty chain. +5 Attack",
        "type": "equipment",
        "slot": Slot.LEASH,
        "stats": {StatType.ATTACK_DAMAGE: 5},
        "color": Color(0.7, 0.7, 0.75),  # Silver
    },
    "bungee_leash": {
        "id": "bungee_leash",
        "name": "Bungee Leash",
        "desc": "Springy and fun. +8 Speed",
        "type": "equipment",
        "slot": Slot.LEASH,
        "stats": {StatType.MOVE_SPEED: 8},
        "color": Color(0.0, 0.8, 0.4),  # Green
    },
    
    # === COATS ===
    "raincoat": {
        "id": "raincoat",
        "name": "Raincoat",
        "desc": "Keeps you dry. +15 Max HP",
        "type": "equipment",
        "slot": Slot.COAT,
        "stats": {StatType.MAX_HEALTH: 15},
        "color": Color(1.0, 0.9, 0.2),  # Yellow
    },
    "sweater": {
        "id": "sweater",
        "name": "Cozy Sweater",
        "desc": "Warm and comfy. +5% Defense, +5 HP",
        "type": "equipment",
        "slot": Slot.COAT,
        "stats": {StatType.DEFENSE: 5, StatType.MAX_HEALTH: 5},
        "color": Color(0.9, 0.5, 0.5),  # Pink
    },
    "leather_jacket": {
        "id": "leather_jacket",
        "name": "Leather Jacket",
        "desc": "Cool and tough. +8 Attack",
        "type": "equipment",
        "slot": Slot.COAT,
        "stats": {StatType.ATTACK_DAMAGE: 8},
        "color": Color(0.15, 0.1, 0.1),  # Black
    },
    
    # === HATS ===
    "baseball_cap": {
        "id": "baseball_cap",
        "name": "Baseball Cap",
        "desc": "Sporty style. +3 Speed",
        "type": "equipment",
        "slot": Slot.HAT,
        "stats": {StatType.MOVE_SPEED: 3},
        "color": Color(0.8, 0.2, 0.2),  # Red
    },
    "bandana": {
        "id": "bandana",
        "name": "Bandana",
        "desc": "Stylish headwear. +2 Attack, +2 Speed",
        "type": "equipment",
        "slot": Slot.HAT,
        "stats": {StatType.ATTACK_DAMAGE: 2, StatType.MOVE_SPEED: 2},
        "color": Color(0.1, 0.3, 0.6),  # Navy
    },
    "guard_helmet": {
        "id": "guard_helmet",
        "name": "Guard Helmet",
        "desc": "Protective headgear. +10% Defense, +Guard Regen",
        "type": "equipment",
        "slot": Slot.HAT,
        "stats": {StatType.DEFENSE: 10, StatType.GUARD_REGEN: 5},
        "color": Color(0.5, 0.5, 0.55),  # Steel
    },
}

## Get equipment data by ID
static func get_equipment(equip_id: String) -> Dictionary:
    if EQUIPMENT.has(equip_id):
        return EQUIPMENT[equip_id].duplicate(true)
    push_error("Unknown equipment: %s" % equip_id)
    return {}

## Get all equipment for a specific slot
static func get_equipment_for_slot(slot: Slot) -> Array:
    var result = []
    for id in EQUIPMENT:
        if EQUIPMENT[id].slot == slot:
            result.append(EQUIPMENT[id].duplicate(true))
    return result

## Get slot name
static func get_slot_name(slot: Slot) -> String:
    return SLOT_NAMES.get(slot, "Unknown")
```
  </action>
  <verify>
EquipmentDatabase.get_equipment("basic_collar") returns valid data
All 5 slots have at least 2 equipment options
Equipment has id, name, slot, and stats fields
  </verify>
  <done>Equipment database with 15 items across 5 dog-themed slots</done>
</task>

<task type="auto">
  <name>Task 2: Create Equipment Manager</name>
  <files>
    systems/equipment/equipment_manager.gd
    autoloads/game_manager.gd
    autoloads/events.gd
  </files>
  <action>
Create equipment management system:

```gdscript
extends Node
class_name EquipmentManager

signal equipment_changed(slot: int, equipment_id: String)
signal stats_recalculated

## Currently equipped items: {Slot: equipment_id or ""}
var equipped: Dictionary = {
    EquipmentDatabase.Slot.COLLAR: "",
    EquipmentDatabase.Slot.HARNESS: "",
    EquipmentDatabase.Slot.LEASH: "",
    EquipmentDatabase.Slot.COAT: "",
    EquipmentDatabase.Slot.HAT: "",
}

## Inventory of unequipped equipment: {equipment_id: quantity}
var equipment_inventory: Dictionary = {}

func _ready() -> void:
    # Give starting equipment
    add_equipment("basic_collar")
    add_equipment("training_harness")
    add_equipment("retractable_leash")

# =============================================================================
# EQUIPMENT INVENTORY
# =============================================================================

## Add equipment to inventory
func add_equipment(equip_id: String) -> bool:
    var equip_data = EquipmentDatabase.get_equipment(equip_id)
    if equip_data.is_empty():
        return false
    
    # Equipment doesn't stack - each is unique
    if equipment_inventory.has(equip_id):
        return false  # Already have this
    
    equipment_inventory[equip_id] = 1
    return true

## Remove equipment from inventory
func remove_equipment(equip_id: String) -> bool:
    if not equipment_inventory.has(equip_id):
        return false
    equipment_inventory.erase(equip_id)
    return true

## Check if player owns equipment
func has_equipment(equip_id: String) -> bool:
    return equipment_inventory.has(equip_id) or is_equipped(equip_id)

## Check if specific equipment is currently equipped
func is_equipped(equip_id: String) -> bool:
    for slot in equipped:
        if equipped[slot] == equip_id:
            return true
    return false

# =============================================================================
# EQUIPPING
# =============================================================================

## Equip an item (instant swap as per CONTEXT.md)
func equip(equip_id: String) -> bool:
    var equip_data = EquipmentDatabase.get_equipment(equip_id)
    if equip_data.is_empty():
        return false
    
    var slot = equip_data.slot
    
    # Check ownership (must be in inventory OR already equipped elsewhere)
    if not has_equipment(equip_id):
        return false
    
    # Unequip current item in slot (if any)
    var current = equipped[slot]
    if current != "":
        # Return current to inventory
        equipment_inventory[current] = 1
    
    # Remove from inventory if it was there
    if equipment_inventory.has(equip_id):
        equipment_inventory.erase(equip_id)
    
    # Equip new item
    equipped[slot] = equip_id
    
    equipment_changed.emit(slot, equip_id)
    stats_recalculated.emit()
    Events.equipment_changed.emit(slot, equip_id)
    
    AudioManager.play_sfx("item_equip")
    return true

## Unequip an item from slot
func unequip(slot: int) -> bool:
    var current = equipped[slot]
    if current == "":
        return false
    
    # Return to inventory
    equipment_inventory[current] = 1
    equipped[slot] = ""
    
    equipment_changed.emit(slot, "")
    stats_recalculated.emit()
    Events.equipment_changed.emit(slot, "")
    return true

## Get currently equipped item in slot
func get_equipped(slot: int) -> String:
    return equipped.get(slot, "")

## Get data for equipped item in slot
func get_equipped_data(slot: int) -> Dictionary:
    var equip_id = equipped.get(slot, "")
    if equip_id == "":
        return {}
    return EquipmentDatabase.get_equipment(equip_id)

# =============================================================================
# STAT CALCULATION
# =============================================================================

## Get total bonus for a stat type from all equipment
func get_stat_bonus(stat_type: int) -> float:
    var total: float = 0.0
    
    for slot in equipped:
        var equip_id = equipped[slot]
        if equip_id == "":
            continue
        
        var equip_data = EquipmentDatabase.get_equipment(equip_id)
        if equip_data.has("stats") and equip_data.stats.has(stat_type):
            total += equip_data.stats[stat_type]
    
    return total

## Get all stat bonuses as dictionary
func get_all_stat_bonuses() -> Dictionary:
    var bonuses = {}
    
    for stat_type in EquipmentDatabase.StatType.values():
        var bonus = get_stat_bonus(stat_type)
        if bonus != 0:
            bonuses[stat_type] = bonus
    
    return bonuses

# =============================================================================
# RING MENU INTEGRATION
# =============================================================================

## Get all equipment for ring menu display (equipped + inventory, grouped by slot)
func get_equipment_for_ring() -> Array[Dictionary]:
    var result: Array[Dictionary] = []
    
    # Show equipped items first (with equipped indicator)
    for slot in EquipmentDatabase.Slot.values():
        var equip_id = equipped[slot]
        if equip_id != "":
            var data = EquipmentDatabase.get_equipment(equip_id)
            data["equipped"] = true
            data["slot_name"] = EquipmentDatabase.get_slot_name(slot)
            result.append(data)
    
    # Then show unequipped inventory
    for equip_id in equipment_inventory:
        var data = EquipmentDatabase.get_equipment(equip_id)
        data["equipped"] = false
        data["slot_name"] = EquipmentDatabase.get_slot_name(data.slot)
        result.append(data)
    
    return result
```

Add to GameManager:
```gdscript
# In game_manager.gd
var equipment_manager: EquipmentManager = null

func _ready() -> void:
    # ... existing code ...
    equipment_manager = EquipmentManager.new()
    add_child(equipment_manager)
```

Add signal to Events:
```gdscript
# Ring Menu/Equipment signals
signal equipment_changed(slot: int, equipment_id: String)
```

Create placeholder equip sound (or reuse existing):
```gdscript
# In audio_manager.gd, add if not exists:
"item_equip": preload("res://assets/audio/sfx/item_use.wav"),  # Reuse item sound
```
  </action>
  <verify>
GameManager.equipment_manager exists
Can equip/unequip items
get_stat_bonus returns correct totals
get_equipment_for_ring returns equipped + inventory items
  </verify>
  <done>Equipment manager handles slots, equipping, and stat calculations</done>
</task>

<task type="auto">
  <name>Task 3: Connect Ring Menu and Player Stats</name>
  <files>
    ui/ring_menu/ring_menu.gd
    characters/player/player.gd
  </files>
  <action>
Update RingMenu to handle equipment:

```gdscript
# In ring_menu.gd - Update _refresh_ring
func _refresh_ring() -> void:
    # Populate rings from game systems
    match current_ring:
        RingType.ITEMS:
            rings[RingType.ITEMS] = _get_inventory_items()
        RingType.EQUIPMENT:
            rings[RingType.EQUIPMENT] = _get_equipment_items()
    
    var items = rings[current_ring]
    # ... rest of existing _refresh_ring code ...

func _get_equipment_items() -> Array:
    if not GameManager.equipment_manager:
        return []
    return GameManager.equipment_manager.get_equipment_for_ring()

# Update _equip_item to actually equip
func _equip_item(item: Dictionary) -> void:
    var equip_id = item.get("id", "")
    if equip_id.is_empty():
        return
    
    # If already equipped, unequip it
    if item.get("equipped", false):
        var slot = item.get("slot", 0)
        GameManager.equipment_manager.unequip(slot)
    else:
        # Equip the item (instant swap)
        GameManager.equipment_manager.equip(equip_id)
    
    # Refresh ring to show updated equipped status
    _refresh_ring()
    _update_selection()
```

Update Player to use equipment bonuses:

```gdscript
# In player.gd - Modify stat methods to include equipment

## Get effective walk speed (with level + equipment bonus)
func get_effective_walk_speed() -> float:
    var level_bonus = 0
    if progression:
        level_bonus = progression.get_stat_bonus("move_speed")
    
    var equip_bonus = 0.0
    if GameManager.equipment_manager:
        equip_bonus = GameManager.equipment_manager.get_stat_bonus(
            EquipmentDatabase.StatType.MOVE_SPEED
        )
    
    return BASE_WALK_SPEED + level_bonus + equip_bonus

## Get effective run speed (with level + equipment bonus)
func get_effective_run_speed() -> float:
    var level_bonus = 0
    if progression:
        level_bonus = progression.get_stat_bonus("move_speed")
    
    var equip_bonus = 0.0
    if GameManager.equipment_manager:
        equip_bonus = GameManager.equipment_manager.get_stat_bonus(
            EquipmentDatabase.StatType.MOVE_SPEED
        )
    
    return BASE_RUN_SPEED + (level_bonus + equip_bonus) * 1.5

## Apply stats from level AND equipment
func _apply_level_stats() -> void:
    if not progression:
        return
    
    # Calculate health with equipment bonus
    var health_level_bonus = progression.get_stat_bonus("max_health")
    var health_equip_bonus = 0
    if GameManager.equipment_manager:
        health_equip_bonus = int(GameManager.equipment_manager.get_stat_bonus(
            EquipmentDatabase.StatType.MAX_HEALTH
        ))
    
    if health:
        var new_max = BASE_MAX_HEALTH + health_level_bonus + health_equip_bonus
        var heal_amount = new_max - health.max_health
        health.max_health = new_max
        if heal_amount > 0:
            health.heal(heal_amount)
    
    # Calculate attack with equipment bonus
    var damage_level_bonus = progression.get_stat_bonus("attack_damage")
    var damage_equip_bonus = 0
    if GameManager.equipment_manager:
        damage_equip_bonus = int(GameManager.equipment_manager.get_stat_bonus(
            EquipmentDatabase.StatType.ATTACK_DAMAGE
        ))
    
    if hitbox:
        hitbox.damage = BASE_ATTACK_DAMAGE + damage_level_bonus + damage_equip_bonus
    
    Events.stats_updated.emit("all", progression.get_level())

# Connect to equipment changes
func _ready() -> void:
    # ... existing code ...
    
    # Re-apply stats when equipment changes
    if GameManager.equipment_manager:
        GameManager.equipment_manager.stats_recalculated.connect(_apply_level_stats)
```

Also update RingItem to show equipped indicator:
```gdscript
# In ring_item.gd - Update setup()
func setup(data: Dictionary) -> void:
    # ... existing code ...
    
    # Show equipped indicator (small checkmark or border)
    if data.get("equipped", false):
        # Add visual indicator - could be border color or icon overlay
        if glow:
            glow.color = Color(0.3, 1.0, 0.3, 0.5)  # Green tint for equipped
            glow.visible = true
    
    # Show slot name in label if equipment
    if label and data.has("slot_name"):
        label.text = "%s\n%s" % [data.get("name", "???"), data.slot_name]
```
  </action>
  <verify>
Equipment ring shows all owned equipment
Equipped items have visual indicator
Selecting equipped item unequips it
Selecting unequipped item equips it instantly
Player stats update when equipment changes
  </verify>
  <done>Ring menu equipment tab functional with instant equip/unequip</done>
</task>

</tasks>

<verification>
1. Start game - player has starting equipment (collar, harness, leash)
2. Open ring menu (Tab), switch to Equipment ring (Up/Down)
3. See equipped items with green indicator
4. See unequipped items in inventory
5. Select an equipped item - it unequips (indicator removed)
6. Select an unequipped item - it equips instantly
7. Check player stats changed (HP bar if max health changed)
8. Equip Spiked Collar - attack damage should increase
9. Equip Retractable Leash - movement should be faster
</verification>

<success_criteria>
- EquipmentDatabase defines 15+ items across 5 slots
- 5 slot types: Collar, Harness, Leash, Coat, Hat
- Each slot accepts only matching equipment
- Equipment provides stat bonuses (HP, Attack, Speed, Defense, Guard, EXP)
- Instant equip/unequip from ring menu (no confirmation)
- Equipped items visually distinct in ring
- Player stats update immediately on equip change
- Equipment persists (future: save system integration)
</success_criteria>

<output>
After completion, create `.planning/phases/16-ring-menu/16-03-SUMMARY.md`
</output>
