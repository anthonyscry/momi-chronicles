---
phase: 16-ring-menu
plan: 03
type: execute
wave: 2
depends_on: ["16-01"]
files_modified:
  - systems/equipment/equipment_database.gd
  - systems/equipment/equipment_manager.gd
  - components/equipment/equipment_slot.gd
  - characters/player/player.gd
  - ui/ring_menu/ring_menu.gd
autonomous: true

must_haves:
  truths:
    - "Player has equipment slots (collar, charm)"
    - "Equipment provides stat bonuses"
    - "Equipping item from ring menu applies stats"
    - "Can swap equipment freely"
    - "Equipment bonuses reflected in combat"
    - "Visual indicator of equipped items"
  artifacts:
    - path: "systems/equipment/equipment_database.gd"
      provides: "Equipment definitions"
    - path: "systems/equipment/equipment_manager.gd"
      provides: "Equipment management"
  key_links:
    - from: "ring_menu.gd"
      to: "equipment_manager.gd"
      via: "equip_item call"
      pattern: "equipment_manager\\.equip"
    - from: "equipment_manager.gd"
      to: "player.gd"
      via: "stat modifications"
      pattern: "player\\.get_equipment_bonus"
---

<objective>
Create equipment system with collars and charms for stat bonuses.

Purpose: Add RPG depth with equippable accessories that modify stats
Output: Working equipment system with collars accessible from ring menu
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/16-ring-menu/16-01-SUMMARY.md
@ui/ring_menu/ring_menu.gd
@characters/player/player.gd
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Equipment Database</name>
  <files>
    systems/equipment/equipment_database.gd
  </files>
  <action>
Create equipment definitions:

```gdscript
extends Node
class_name EquipmentDatabase

## Equipment slot types
enum SlotType {
    COLLAR,    # Main accessory - usually stat bonuses
    CHARM,     # Secondary - usually special effects
}

## Stat types that can be modified
enum StatType {
    MAX_HEALTH,
    ATTACK,
    DEFENSE,
    SPEED,
    CRIT_CHANCE,
    EXP_BONUS,
    COIN_BONUS,
}

## All equipment definitions
const EQUIPMENT: Dictionary = {
    # === COLLARS (Main stat bonuses) ===
    "leather_collar": {
        "id": "leather_collar",
        "name": "Leather Collar",
        "desc": "A simple collar. +10 Max HP",
        "type": "equipment",
        "slot": SlotType.COLLAR,
        "stats": {StatType.MAX_HEALTH: 10},
        "color": Color(0.6, 0.4, 0.2),
    },
    "iron_collar": {
        "id": "iron_collar",
        "name": "Iron Collar",
        "desc": "Sturdy protection. +20 Max HP, +5 Defense",
        "type": "equipment",
        "slot": SlotType.COLLAR,
        "stats": {StatType.MAX_HEALTH: 20, StatType.DEFENSE: 5},
        "color": Color(0.5, 0.5, 0.6),
    },
    "spiked_collar": {
        "id": "spiked_collar",
        "name": "Spiked Collar",
        "desc": "Intimidating! +15 Attack",
        "type": "equipment",
        "slot": SlotType.COLLAR,
        "stats": {StatType.ATTACK: 15},
        "color": Color(0.3, 0.3, 0.3),
    },
    "golden_collar": {
        "id": "golden_collar",
        "name": "Golden Collar",
        "desc": "Fit for royalty. +10 HP, +10 Attack, +10 Defense",
        "type": "equipment",
        "slot": SlotType.COLLAR,
        "stats": {StatType.MAX_HEALTH: 10, StatType.ATTACK: 10, StatType.DEFENSE: 10},
        "color": Color(1.0, 0.85, 0.2),
    },
    "swift_collar": {
        "id": "swift_collar",
        "name": "Swift Collar",
        "desc": "Light as air. +20 Speed",
        "type": "equipment",
        "slot": SlotType.COLLAR,
        "stats": {StatType.SPEED: 20},
        "color": Color(0.7, 0.9, 1.0),
    },
    
    # === CHARMS (Special effects) ===
    "lucky_charm": {
        "id": "lucky_charm",
        "name": "Lucky Charm",
        "desc": "Fortune favors the bold. +20% Coin drops",
        "type": "equipment",
        "slot": SlotType.CHARM,
        "stats": {StatType.COIN_BONUS: 20},
        "color": Color(0.2, 0.8, 0.2),
    },
    "scholar_charm": {
        "id": "scholar_charm",
        "name": "Scholar's Charm",
        "desc": "Learn from every battle. +15% EXP",
        "type": "equipment",
        "slot": SlotType.CHARM,
        "stats": {StatType.EXP_BONUS: 15},
        "color": Color(0.4, 0.4, 0.9),
    },
    "critical_charm": {
        "id": "critical_charm",
        "name": "Critical Charm",
        "desc": "Strike true. +10% Crit Chance",
        "type": "equipment",
        "slot": SlotType.CHARM,
        "stats": {StatType.CRIT_CHANCE: 10},
        "color": Color(0.9, 0.2, 0.2),
    },
    "guardian_charm": {
        "id": "guardian_charm",
        "name": "Guardian Charm",
        "desc": "Protection from harm. +15 Defense, +10 HP",
        "type": "equipment",
        "slot": SlotType.CHARM,
        "stats": {StatType.DEFENSE: 15, StatType.MAX_HEALTH: 10},
        "color": Color(0.3, 0.6, 0.9),
    },
    "berserker_charm": {
        "id": "berserker_charm",
        "name": "Berserker Charm",
        "desc": "Power at a cost. +25 Attack, -10 Defense",
        "type": "equipment",
        "slot": SlotType.CHARM,
        "stats": {StatType.ATTACK: 25, StatType.DEFENSE: -10},
        "color": Color(0.8, 0.1, 0.1),
    },
}

static func get_equipment(equip_id: String) -> Dictionary:
    if EQUIPMENT.has(equip_id):
        return EQUIPMENT[equip_id].duplicate(true)
    return {}

static func get_all_collars() -> Array:
    return _get_by_slot(SlotType.COLLAR)

static func get_all_charms() -> Array:
    return _get_by_slot(SlotType.CHARM)

static func _get_by_slot(slot: SlotType) -> Array:
    var result = []
    for id in EQUIPMENT:
        if EQUIPMENT[id].slot == slot:
            result.append(EQUIPMENT[id].duplicate(true))
    return result

static func get_stat_name(stat: StatType) -> String:
    match stat:
        StatType.MAX_HEALTH: return "Max HP"
        StatType.ATTACK: return "Attack"
        StatType.DEFENSE: return "Defense"
        StatType.SPEED: return "Speed"
        StatType.CRIT_CHANCE: return "Crit %"
        StatType.EXP_BONUS: return "EXP %"
        StatType.COIN_BONUS: return "Coin %"
    return "???"
```
  </action>
  <verify>
EquipmentDatabase.get_equipment("leather_collar") returns data
Collars and charms properly categorized
Stats defined correctly
  </verify>
  <done>Equipment database with collars and charms defined</done>
</task>

<task type="auto">
  <name>Task 2: Create Equipment Manager</name>
  <files>
    systems/equipment/equipment_manager.gd
    autoloads/game_manager.gd
  </files>
  <action>
Create equipment management system:

```gdscript
extends Node
class_name EquipmentManager

signal equipment_changed(slot: int, old_equip: Dictionary, new_equip: Dictionary)
signal stats_recalculated

## Currently equipped items by slot
var equipped: Dictionary = {
    EquipmentDatabase.SlotType.COLLAR: {},
    EquipmentDatabase.SlotType.CHARM: {},
}

## Owned equipment (not consumed on equip)
var owned_equipment: Array[String] = []

func _ready() -> void:
    # Start with basic collar
    give_equipment("leather_collar")
    equip("leather_collar")

# =============================================================================
# EQUIPMENT OWNERSHIP
# =============================================================================

func give_equipment(equip_id: String) -> void:
    if equip_id not in owned_equipment:
        owned_equipment.append(equip_id)
        Events.equipment_obtained.emit(equip_id)

func has_equipment(equip_id: String) -> bool:
    return equip_id in owned_equipment

func get_owned_equipment() -> Array[Dictionary]:
    var result: Array[Dictionary] = []
    for equip_id in owned_equipment:
        var data = EquipmentDatabase.get_equipment(equip_id)
        if not data.is_empty():
            # Mark if currently equipped
            data["equipped"] = is_equipped(equip_id)
            result.append(data)
    return result

func get_owned_by_slot(slot: int) -> Array[Dictionary]:
    var result: Array[Dictionary] = []
    for equip_id in owned_equipment:
        var data = EquipmentDatabase.get_equipment(equip_id)
        if not data.is_empty() and data.slot == slot:
            data["equipped"] = is_equipped(equip_id)
            result.append(data)
    return result

# =============================================================================
# EQUIPPING
# =============================================================================

func equip(equip_id: String) -> bool:
    if not has_equipment(equip_id):
        return false
    
    var data = EquipmentDatabase.get_equipment(equip_id)
    if data.is_empty():
        return false
    
    var slot = data.slot
    var old_equip = equipped[slot]
    
    equipped[slot] = data
    
    equipment_changed.emit(slot, old_equip, data)
    _recalculate_stats()
    
    AudioManager.play_sfx("equip")
    return true

func unequip(slot: int) -> Dictionary:
    var old_equip = equipped[slot]
    equipped[slot] = {}
    
    equipment_changed.emit(slot, old_equip, {})
    _recalculate_stats()
    
    return old_equip

func is_equipped(equip_id: String) -> bool:
    for slot in equipped:
        if equipped[slot].get("id") == equip_id:
            return true
    return false

func get_equipped(slot: int) -> Dictionary:
    return equipped.get(slot, {})

# =============================================================================
# STAT CALCULATIONS
# =============================================================================

func _recalculate_stats() -> void:
    stats_recalculated.emit()

## Get total bonus for a stat type from all equipment
func get_stat_bonus(stat_type: int) -> int:
    var total = 0
    for slot in equipped:
        var equip = equipped[slot]
        if equip.has("stats") and equip.stats.has(stat_type):
            total += equip.stats[stat_type]
    return total

## Get formatted stat summary
func get_stat_summary() -> String:
    var lines = []
    for stat in EquipmentDatabase.StatType.values():
        var bonus = get_stat_bonus(stat)
        if bonus != 0:
            var sign = "+" if bonus > 0 else ""
            lines.append("%s%d %s" % [sign, bonus, EquipmentDatabase.get_stat_name(stat)])
    return "\n".join(lines) if lines.size() > 0 else "No bonuses"
```

Add to GameManager:
```gdscript
var equipment: EquipmentManager = null

func _ready() -> void:
    # ... existing code ...
    equipment = EquipmentManager.new()
    add_child(equipment)
```

Add signal to Events:
```gdscript
signal equipment_obtained(equip_id: String)
```

Add equip sound to AudioManager.
  </action>
  <verify>
GameManager.equipment exists
Can equip/unequip items
get_stat_bonus returns correct totals
equipment_changed signal fires
  </verify>
  <done>Equipment manager handles equipping and stat calculations</done>
</task>

<task type="auto">
  <name>Task 3: Integrate with Player and Ring Menu</name>
  <files>
    characters/player/player.gd
    ui/ring_menu/ring_menu.gd
  </files>
  <action>
Update player to use equipment bonuses:

```gdscript
# Add to player.gd

## Get equipment stat bonus
func get_equipment_bonus(stat_type: int) -> int:
    if GameManager.equipment:
        return GameManager.equipment.get_stat_bonus(stat_type)
    return 0

## Update _apply_level_stats to include equipment
func _apply_level_stats() -> void:
    if not progression:
        return
    
    # Base + level + equipment bonuses
    var level_hp_bonus = progression.get_stat_bonus("max_health")
    var equip_hp_bonus = get_equipment_bonus(EquipmentDatabase.StatType.MAX_HEALTH)
    
    if health:
        var new_max = BASE_MAX_HEALTH + level_hp_bonus + equip_hp_bonus
        var heal_amount = new_max - health.max_health
        health.max_health = new_max
        if heal_amount > 0:
            health.heal(heal_amount)
    
    # Attack
    var level_atk_bonus = progression.get_stat_bonus("attack_damage")
    var equip_atk_bonus = get_equipment_bonus(EquipmentDatabase.StatType.ATTACK)
    if hitbox:
        hitbox.damage = BASE_ATTACK_DAMAGE + level_atk_bonus + equip_atk_bonus
    
    Events.stats_updated.emit("all", progression.get_level())

## Get effective walk speed (level + equipment)
func get_effective_walk_speed() -> float:
    var level_bonus = 0
    if progression:
        level_bonus = progression.get_stat_bonus("move_speed")
    var equip_bonus = get_equipment_bonus(EquipmentDatabase.StatType.SPEED)
    return BASE_WALK_SPEED + level_bonus + equip_bonus

## Get effective run speed
func get_effective_run_speed() -> float:
    var level_bonus = 0
    if progression:
        level_bonus = progression.get_stat_bonus("move_speed")
    var equip_bonus = get_equipment_bonus(EquipmentDatabase.StatType.SPEED)
    return BASE_RUN_SPEED + (level_bonus + equip_bonus) * 1.5
```

Connect equipment changes to player:
```gdscript
# In player _ready()
if GameManager.equipment:
    GameManager.equipment.stats_recalculated.connect(_apply_level_stats)
```

Update Ring Menu equipment handling:
```gdscript
# In ring_menu.gd

func _refresh_ring() -> void:
    match current_ring:
        RingType.ITEMS:
            rings[RingType.ITEMS] = _get_inventory_items()
        RingType.EQUIPMENT:
            rings[RingType.EQUIPMENT] = _get_equipment_items()
    
    # ... rest of refresh code ...

func _get_equipment_items() -> Array:
    if not GameManager.equipment:
        return []
    return GameManager.equipment.get_owned_equipment()

func _equip_item(item: Dictionary) -> void:
    var equip_id = item.get("id", "")
    if equip_id.is_empty():
        return
    
    if GameManager.equipment.equip(equip_id):
        # Successfully equipped
        _refresh_ring()
        _update_selection()
    else:
        AudioManager.play_sfx("menu_error")

# Update ring item display to show equipped status
# In _refresh_ring, mark equipped items:
func _refresh_ring() -> void:
    # ... get items ...
    
    for i in visible_count:
        ring_items[i].visible = true
        ring_items[i].setup(items[i])
        
        # Show equipped indicator
        if items[i].get("equipped", false):
            ring_items[i].show_equipped_indicator()
```

Add to RingItem:
```gdscript
func show_equipped_indicator() -> void:
    # Add "E" badge or border to show equipped
    if has_node("EquippedBadge"):
        $EquippedBadge.visible = true
```
  </action>
  <verify>
Equipping collar increases player stats
Ring menu shows owned equipment
Equipped items marked in ring
Stats update immediately on equip
  </verify>
  <done>Equipment integrated with player stats and ring menu</done>
</task>

</tasks>

<verification>
1. Start game - player has Leather Collar equipped
2. Open ring menu, go to Equipment ring
3. See Leather Collar with "equipped" indicator
4. Find new equipment (or use debug to add)
5. Equip different collar - stats change
6. Equip Spiked Collar - attack increases visibly
7. Equip Swift Collar - movement faster
8. Can swap freely between owned equipment
</verification>

<success_criteria>
- 5+ collars with varied stat bonuses
- 5+ charms with special effects
- Equipment manager tracks owned/equipped
- Equipping applies stat bonuses immediately
- Player movement/attack reflects equipment stats
- Ring menu shows all owned equipment
- Equipped items visually marked
- Equip sound plays on change
- Can have one collar + one charm equipped
</success_criteria>

<output>
After completion, create `.planning/phases/16-ring-menu/16-03-SUMMARY.md`
</output>
