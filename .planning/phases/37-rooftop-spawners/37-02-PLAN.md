---
phase: 37-rooftop-spawners
plan: 02
type: execute
wave: 2
depends_on: ["37-01"]
files_modified:
  - world/zones/rooftops.gd
  - characters/enemies/pigeon_king.gd
  - characters/enemies/pigeon_king.tscn
  - characters/enemies/states/pigeon_king_swoop_dive.gd
  - characters/enemies/states/pigeon_king_reinforcement.gd
autonomous: true

must_haves:
  truths:
    - "Pigeon flocks patrol and attack player on rooftops"
    - "Garden Gnomes throw bombs from sentry positions"
    - "Roof Rats ambush from near chimney walls"
    - "Pigeon King mini-boss triggers in Boss Overlook area"
    - "Pigeon King cycles between swoop dive and reinforcement call attacks"
    - "Defeating Pigeon King is tracked in save system"
  artifacts:
    - path: "world/zones/rooftops.gd"
      provides: "_build_enemies() and _build_mini_boss_trigger() methods"
      contains: "_build_enemies"
    - path: "characters/enemies/pigeon_king.gd"
      provides: "Pigeon King mini-boss extending mini_boss_base"
      min_lines: 40
    - path: "characters/enemies/pigeon_king.tscn"
      provides: "Pigeon King scene file"
    - path: "characters/enemies/states/pigeon_king_swoop_dive.gd"
      provides: "Aerial dive attack state"
      min_lines: 40
    - path: "characters/enemies/states/pigeon_king_reinforcement.gd"
      provides: "Pigeon flock summoning state"
      min_lines: 40
  key_links:
    - from: "world/zones/rooftops.gd"
      to: "characters/enemies/pigeon.tscn"
      via: "Events.create_pigeon_flock() in _build_enemies()"
      pattern: "create_pigeon_flock"
    - from: "world/zones/rooftops.gd"
      to: "characters/enemies/gnome.tscn"
      via: "preload + instantiate in _build_enemies()"
      pattern: "GNOME_SCENE"
    - from: "world/zones/rooftops.gd"
      to: "characters/enemies/roof_rat.tscn"
      via: "preload + instantiate in _build_enemies()"
      pattern: "ROOF_RAT_SCENE"
    - from: "characters/enemies/pigeon_king.gd"
      to: "characters/enemies/mini_boss_base.gd"
      via: "extends path"
      pattern: 'extends.*mini_boss_base'
    - from: "world/zones/rooftops.gd"
      to: "characters/enemies/pigeon_king.tscn"
      via: "preload in _build_mini_boss_trigger()"
      pattern: "PIGEON_KING_SCENE"
---

<objective>
Populate the Rooftops zone with all three enemy types and the Pigeon King mini-boss.

Purpose: Make the Rooftops zone a combat-ready area with enemy encounters that leverage the pigeon flock system, gnome sentries, roof rat ambushers, and a climactic mini-boss fight.
Output: Rooftops zone with placed enemies + Pigeon King mini-boss with two attack patterns.
</objective>

<context>
@world/zones/rooftops.gd                  — Zone we're adding enemies to (created in Plan 37-01)
@world/zones/sewers.gd                    — Reference for _build_enemies() and _build_mini_boss_trigger() patterns
@characters/enemies/pigeon.gd             — Pigeon enemy (flock member)
@characters/enemies/gnome.gd              — Garden Gnome (stationary turret)
@characters/enemies/roof_rat.gd           — Roof Rat (wall-running ambusher)
@characters/enemies/mini_boss_base.gd     — Mini-boss base class (attack patterns, defeat tracking, loot)
@characters/enemies/crow_matriarch.gd     — Reference mini-boss implementation (~50 lines)
@characters/enemies/states/crow_swarm_summon.gd — Reference for reinforcement-summoning state
@characters/enemies/states/crow_dive_bomb.gd    — Reference for dive attack state
@autoloads/events.gd                      — Events.create_pigeon_flock() + pigeon/gnome/rat signals
</context>

<tasks>

<task type="auto">
  <name>Task 1: Place enemies in Rooftops zone</name>
  <files>
    world/zones/rooftops.gd
  </files>
  <action>
Add enemy spawning to rooftops.gd. Follow the sewers.gd `_build_enemies()` pattern.

**Add preload constants at top of file:**
```gdscript
const GNOME_SCENE = preload("res://characters/enemies/gnome.tscn")
const ROOF_RAT_SCENE = preload("res://characters/enemies/roof_rat.tscn")
const PIGEON_KING_SCENE = preload("res://characters/enemies/pigeon_king.tscn")
```
Note: Pigeon flocks use `Events.create_pigeon_flock()` which internally loads pigeon.tscn — no preload needed.

**Call `_build_enemies()` in `_setup_zone()`** after `_build_decorations()` and before `_build_zone_exits()`.

**Implement `_build_enemies()`:**

Get or create Enemies container (follow sewers pattern):
```gdscript
var enemies_cont: Node2D
if has_node("Enemies"):
    enemies_cont = $Enemies
else:
    enemies_cont = Node2D.new()
    enemies_cont.name = "Enemies"
    add_child(enemies_cont)
```

**Entry Platform enemies (easier, introductory):**
- 1 pigeon flock of 3 at perch Vector2(100, 420). Use `Events.create_pigeon_flock(Vector2(100, 420), 3)`, then add each member to enemies_cont.
- 1 roof rat near Entry chimney at Vector2(160, 430).

**Central Rooftop enemies (moderate difficulty):**
- 1 pigeon flock of 5 at Vector2(400, 340). Larger flock — main encounter area.
- 1 garden gnome at Vector2(350, 310) — watching the walkway from Entry.
- 1 garden gnome at Vector2(500, 380) — covering the bridge to Sentry Ridge.
- 2 roof rats near Central chimneys: Vector2(320, 360), Vector2(480, 330).

**Sentry Ridge enemies (harder, gnome-heavy):**
- 2 garden gnomes at elevated positions: Vector2(700, 230), Vector2(820, 260). These create crossfire.
- 1 pigeon flock of 4 at Vector2(750, 280). Patrols the ridge.
- 1 roof rat at Vector2(870, 240). Near bridge to Boss Overlook.

**Boss Overlook (minimal — cleared before mini-boss):**
- 1 roof rat at Vector2(980, 310). Light guard, easily dispatched.
- NO pigeon flocks or gnomes — boss area should feel eerily empty.

**For pigeon flocks:** Use `Events.create_pigeon_flock(position, size)` which returns an Array of pigeon instances. Add each to enemies_cont:
```gdscript
var flock = Events.create_pigeon_flock(Vector2(100, 420), 3)
for pigeon in flock:
    enemies_cont.add_child(pigeon)
```

**For gnomes and roof rats:** Standard instantiate pattern:
```gdscript
var gnome = GNOME_SCENE.instantiate()
gnome.name = "Gnome_central_1"
gnome.position = Vector2(350, 310)
enemies_cont.add_child(gnome)
```

Total enemy count: ~20 enemies (9 pigeons across 3 flocks, 4 gnomes, 5 roof rats, 1 guard rat).
  </action>
  <verify>
    Run the game, transition to Rooftops.
    Verify: Pigeon flocks visible and flying in flock formation.
    Verify: Gnomes stationary at sentry positions, throw bombs when player approaches.
    Verify: Roof rats near chimneys, stealth alpha visible, ambush when player is close.
    Verify: Boss Overlook area has minimal enemies (1 rat).
    No errors in console about missing scenes or invalid nodes.
  </verify>
  <done>
    All three enemy types placed across 4 platform areas with escalating difficulty. Enemies function correctly (attack, take damage, die, drop loot). Pigeon flocks coordinate via flock system.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Pigeon King mini-boss with attack states and trigger</name>
  <files>
    characters/enemies/pigeon_king.gd
    characters/enemies/pigeon_king.tscn
    characters/enemies/states/pigeon_king_swoop_dive.gd
    characters/enemies/states/pigeon_king_reinforcement.gd
    world/zones/rooftops.gd
  </files>
  <action>
**1. Create `characters/enemies/pigeon_king.gd`:**

Extend mini_boss_base.gd (follow crow_matriarch.gd pattern exactly):

```gdscript
extends "res://characters/enemies/mini_boss_base.gd"
```

Do NOT add `class_name` — path-based extends only (project convention).

Stats (set BEFORE super._ready()):
- `patrol_speed = 60.0`
- `chase_speed = 100.0`
- `detection_range = 180.0`
- `attack_range = 40.0`
- `lose_interest_range = 300.0`
- `attack_damage = 20`
- `attack_cooldown = 1.0`
- `knockback_force = 40.0` — mini-boss, reduced knockback
- `exp_value = 100`

Mini-boss config:
- `boss_name = "PIGEON KING"`
- `is_defeated_key = "pigeon_king"`
- `loot_equipment_id = "pigeon_crown"` — reward equipment (may not exist in EquipmentDatabase yet, that's fine — _grant_loot handles missing gracefully)
- `attack_patterns = ["PigeonKingSwoopDive", "PigeonKingReinforcement"]`

Override health AFTER super._ready():
- `health.max_health = 120`
- `health.current_health = 120`

Larger sprite (1.8x scale). Purple-gold tint: `sprite.modulate = Color(0.85, 0.75, 1.1)`.

Drop table:
- 100% coins (5-10), 100% health pickups (2-3)

**2. Create `characters/enemies/pigeon_king.tscn`:**

Scene file for the Pigeon King. Structure matching other mini-boss .tscn files:
- Root: CharacterBody2D (script: pigeon_king.gd)
- AnimatedSprite2D named "Sprite2D" — use placeholder frames (colored rectangles if no art exists). Scale 1.8x.
- CollisionShape2D — CircleShape2D radius 12
- AnimationPlayer
- HealthComponent (Node with health_component.gd)
- Hitbox (Area2D with hitbox.gd)
- Hurtbox (Area2D with hurtbox.gd)
- DetectionArea (Area2D with CircleShape2D radius 180)
- StateMachine (Node with state_machine.gd) containing child states:
  - MiniBossIdle (mini_boss_idle.gd)
  - PigeonKingSwoopDive (pigeon_king_swoop_dive.gd)
  - PigeonKingReinforcement (pigeon_king_reinforcement.gd)
  - Hurt (enemy_hurt.gd)
  - Death (enemy_death.gd)

**3. Create `characters/enemies/states/pigeon_king_swoop_dive.gd`:**

Follow crow_dive_bomb.gd pattern. Phases: TELEGRAPH -> ASCEND -> DIVE -> RECOVERY.

```
extends State
```

Constants:
- TELEGRAPH_TIME = 0.6 (king flashes, screams)
- ASCEND_TIME = 0.4 (rises up)
- DIVE_SPEED = 250.0 (faster than regular pigeon swoop)
- DIVE_DAMAGE = 25.0
- RECOVERY_TIME = 0.5
- ASCEND_HEIGHT = 60.0

Logic:
- TELEGRAPH: Flash sprite gold, shake slightly. Record player position as dive_target.
- ASCEND: Move upward by ASCEND_HEIGHT, shrink sprite slightly (rising into sky illusion).
- DIVE: Move toward dive_target at DIVE_SPEED. Enable hitbox. Spawn target indicator (red circle) at dive_target.
- On reaching target or timeout: disable hitbox, enter RECOVERY.
- RECOVERY: Brief pause, then transition to "MiniBossIdle".

On dive impact near player, deal DIVE_DAMAGE and apply knockback. Use screen_shake(5.0, 0.2).

**4. Create `characters/enemies/states/pigeon_king_reinforcement.gd`:**

Follow crow_swarm_summon.gd pattern. Phases: CHARGE -> SUMMON -> RECOVERY.

Constants:
- CHARGE_TIME = 0.8 (king coos/calls, purple glow)
- RECOVERY_TIME = 0.6
- PIGEON_COUNT = 3
- MAX_REINFORCEMENTS = 6

Logic:
- CHARGE: Sprite gold glow, screen shake 2.0. Stop moving.
- SUMMON: Use `Events.create_pigeon_flock(player.global_position + Vector2(0, -40), PIGEON_COUNT)` to spawn a flock above the boss. Add each pigeon to parent scene AND track in `player.spawned_minions` for cleanup on boss death. Count existing spawned_minions and cap at MAX_REINFORCEMENTS.
- RECOVERY: Restore sprite color, transition to "MiniBossIdle".

**5. Add mini-boss trigger to `world/zones/rooftops.gd`:**

Add `_build_mini_boss_trigger()` call in `_setup_zone()` (before `_build_enemies()`).

Follow the backyard.gd / sewers.gd pattern exactly:
- Check `GameManager.mini_bosses_defeated.get("pigeon_king", false)` — skip if defeated
- Trigger position: Vector2(1040, 350) — center of Boss Overlook
- Warning decor: Polygon2D octagon with Color(0.6, 0.5, 0.2, 0.3) — faint gold circle
- Trigger Area2D: collision_layer 0, collision_mask 2 (player), RectangleShape2D size Vector2(80, 60)
- On body_entered (player):
  - Set `_pigeon_king_spawned = true`
  - Instantiate PIGEON_KING_SCENE at Vector2(1040, 320) (slightly above trigger)
  - Add to scene
  - Remove trigger + fade warning
  - Play boss music: `AudioManager.play_music("boss_fight_b")`

Add tracking var at class level: `var _pigeon_king_spawned: bool = false`
  </action>
  <verify>
    Run the game, navigate to Rooftops -> Boss Overlook area.
    Verify: Warning marker visible on ground.
    Verify: Walking into trigger spawns Pigeon King with "PIGEON KING" health bar.
    Verify: Pigeon King cycles between swoop dive and reinforcement call.
    Verify: Swoop dive targets player position, deals damage on hit.
    Verify: Reinforcement call spawns pigeon flock (up to 6 total reinforcements).
    Verify: Defeating Pigeon King plays death sequence, drops loot, marks as defeated.
    Verify: Re-entering zone after defeat does NOT spawn Pigeon King again.
  </verify>
  <done>
    Pigeon King mini-boss fully functional with two attack patterns. Trigger area in Boss Overlook. Defeat tracked in GameManager.mini_bosses_defeated. Reinforcement pigeons cleaned up on boss death.
  </done>
</task>

</tasks>

<verification>
1. All three enemy types active in Rooftops (pigeons flock, gnomes throw bombs, rats ambush)
2. Pigeon King triggers and fights with swoop dive + reinforcement patterns
3. Defeating Pigeon King tracked persistently
4. Enemy difficulty escalates: Entry (easy) -> Central (moderate) -> Sentry Ridge (hard) -> Boss Overlook (mini-boss)
5. Total ~20 enemies + 1 mini-boss in the zone
6. All enemies respect respawn system from BaseZone
7. No console errors
</verification>

<success_criteria>
- Player can fight through all 4 areas of Rooftops encountering all enemy types
- Pigeon King mini-boss is a challenging fight with visible attack patterns
- Defeated enemies drop loot and can respawn
- Mini-boss defeat is saved and doesn't re-trigger
</success_criteria>

<output>
After completion, create `.planning/phases/37-rooftop-spawners/37-02-SUMMARY.md`
</output>
