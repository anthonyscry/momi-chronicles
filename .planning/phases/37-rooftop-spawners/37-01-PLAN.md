---
phase: 37-rooftop-spawners
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - world/zones/rooftops.gd
  - world/zones/rooftops.tscn
  - autoloads/game_manager.gd
  - world/zones/neighborhood.gd
autonomous: true

must_haves:
  truths:
    - "Rooftops zone loads without errors when transitioning from Neighborhood"
    - "Player can climb ladder in Neighborhood to reach Rooftops"
    - "Player can return from Rooftops to Neighborhood"
    - "Rooftops has nighttime moonlit atmosphere with chimney obstacles"
    - "Zone has walkable platforms connected by bridges/walkways"
  artifacts:
    - path: "world/zones/rooftops.gd"
      provides: "Rooftops zone script with layout, atmosphere, boundaries"
      min_lines: 300
    - path: "world/zones/rooftops.tscn"
      provides: "Rooftops zone scene file"
    - path: "autoloads/game_manager.gd"
      provides: "Updated zone_scenes dict with rooftops entry"
      contains: '"rooftops"'
  key_links:
    - from: "autoloads/game_manager.gd"
      to: "world/zones/rooftops.tscn"
      via: "zone_scenes dictionary"
      pattern: '"rooftops".*rooftops.tscn'
    - from: "world/zones/neighborhood.gd"
      to: "rooftops"
      via: "ZoneExit with target_zone rooftops"
      pattern: 'target_zone.*rooftops'
    - from: "world/zones/rooftops.gd"
      to: "neighborhood"
      via: "ZoneExit with target_zone neighborhood"
      pattern: 'target_zone.*neighborhood'
---

<objective>
Create the Rooftops zone with full layout, nighttime atmosphere, and bidirectional zone transitions.

Purpose: Establish the physical zone (the 5th explorable area) so enemies and encounters can be placed in Plan 37-02.
Output: Playable rooftops zone with atmosphere, platforms, chimneys, walkways, boundaries, and working zone transitions to/from Neighborhood.
</objective>

<context>
@world/zones/sewers.gd            — Reference pattern for programmatic zone building (corridors, walls, atmosphere, decorations, boundaries, zone exits)
@world/zones/base_zone.gd         — BaseZone class we extend (spawn points, camera, respawn system, companions, grass)
@world/zones/neighborhood.gd      — Zone we add ladder transition to
@autoloads/game_manager.gd        — Register new zone in zone_scenes dict + mini_bosses_defeated
@components/zone_exit/zone_exit.gd — ZoneExit component for transitions
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Rooftops zone script, scene, and GameManager registration</name>
  <files>
    world/zones/rooftops.gd
    world/zones/rooftops.tscn
    autoloads/game_manager.gd
  </files>
  <action>
Create `world/zones/rooftops.gd` extending BaseZone. Follow the sewers.gd pattern closely — all layout built programmatically in `_setup_zone()`.

**Zone identity:**
- `zone_id = "rooftops"`
- `zone_size = Vector2(1200, 700)` — large multi-area zone (wider than sewers)
- Nighttime atmosphere using CanvasModulate (dark blue-purple tint, brighter than sewers)

**Layout — 4 connected rooftop platforms:**
Define as Array[Rect2] (like sewers corridor_segments):
1. **Entry Platform** (left) — Rect2(20, 400, 200, 120) — where player arrives via ladder. Relatively safe, a few chimney obstacles.
2. **Central Rooftop** — Rect2(280, 300, 300, 180) — main area, wide open for flock encounters. Connected to Entry via walkway Rect2(220, 440, 60, 40).
3. **Sentry Ridge** — Rect2(640, 200, 250, 140) — elevated narrow platform. Connected to Central via bridge Rect2(580, 350, 60, 40). Gnome territory.
4. **Boss Overlook** — Rect2(940, 280, 220, 160) — wide platform for Pigeon King fight. Connected to Sentry Ridge via walkway Rect2(890, 310, 50, 40).

**Builders to implement (follow sewers.gd pattern):**
- `_build_background()` — dark night sky ColorRect
- `_build_moonlight()` — CanvasModulate with Color(0.15, 0.13, 0.25) for moonlit night. Add a moon visual (pale yellow Polygon2D circle) in upper-right corner.
- `_build_platforms()` — floor rects for each platform + connecting walkways. Use roof-colored floor: Color(0.28, 0.22, 0.18) for shingles.
- `_build_walls()` — StaticBody2D walls along platform edges (like sewers _add_wall pattern). Wall color Color(0.2, 0.16, 0.14).
- `_build_chimneys()` — 6-8 chimney obstacles as StaticBody2D+ColorRect. Place on Entry (2), Central (3), Sentry Ridge (2), Boss Overlook (1). Chimney size ~Vector2(16, 24). Color: Color(0.35, 0.25, 0.2). Each chimney has a cap ColorRect 2px wider.
- `_build_decorations()` — Antenna poles (thin vertical ColorRects), satellite dishes (small circles), weathervanes, clotheslines (thin horizontal lines between chimneys). Keep minimal — this is a rooftop.
- `_build_boundaries()` — StaticBody2D boundary walls around full zone_size (copy sewers pattern exactly)
- `_build_zone_exits()` — One ZoneExit back to neighborhood at the ladder position (left side of Entry Platform). Use `require_interaction = true` for the ladder.

**Spawn points dictionary:**
```gdscript
var spawn_points: Dictionary = {
    "default": Vector2(60, 460),
    "from_neighborhood": Vector2(60, 460),
    "boss_area": Vector2(980, 340),
}
```

**Atmosphere extras (like sewers drip points):**
- Subtle star twinkle: 8-12 small ColorRects with alpha pulse tweens
- Moonlight glow: PointLight2D on player (like sewers player light, but cooler blue-white tone, larger scale 4.0)
- Wind particle hints: optional, keep simple

**Override `_spawn_grass()`** — no grass on rooftops. Instead, spawn 6-10 small debris ColorRects (gray/brown, small 3x2 to 6x3) scattered on platforms. Call it "rooftop debris."

**Color constants at top of file:**
```gdscript
const COLOR_SKY := Color(0.04, 0.03, 0.08)
const COLOR_PLATFORM := Color(0.28, 0.22, 0.18)
const COLOR_PLATFORM_LIGHT := Color(0.32, 0.26, 0.22)
const COLOR_WALL := Color(0.2, 0.16, 0.14)
const COLOR_CHIMNEY := Color(0.35, 0.25, 0.2)
const COLOR_CHIMNEY_CAP := Color(0.4, 0.3, 0.25)
const COLOR_ANTENNA := Color(0.3, 0.3, 0.35)
const COLOR_MOON := Color(0.95, 0.92, 0.75)
```

**Create `world/zones/rooftops.tscn`** — Minimal scene file. Node2D root with:
- Player child node (like other zone .tscn files)
- GroundTileMap and WallTileMap (can be empty TileMaps)
- Enemies container (Node2D named "Enemies")

**Register in GameManager:**
1. Add `"rooftops": "res://world/zones/rooftops.tscn"` to `zone_scenes` dict
2. Add `"pigeon_king": false` to `mini_bosses_defeated` dict

Important: Do NOT use `class_name` in rooftops.gd — use path-based extends. Do NOT use bare `print()` — use DebugLogger. Use `preload()` for scene references where possible, or cache `load()` calls in consts.
  </action>
  <verify>
    Run `godot --path . --headless --quit-after 2` — should exit without parse errors.
    Grep for "rooftops" in game_manager.gd to confirm registration.
    Verify rooftops.gd has _setup_zone, _build_platforms, _build_chimneys, _build_zone_exits methods.
  </verify>
  <done>
    Rooftops zone script exists with full layout. Zone registered in GameManager. Scene file exists with required child nodes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add ladder transition from Neighborhood to Rooftops</name>
  <files>
    world/zones/neighborhood.gd
  </files>
  <action>
Add a ladder visual + ZoneExit in Neighborhood that takes the player to Rooftops.

**In neighborhood.gd:**

1. Add spawn point: `"from_rooftops": Vector2(680, 180)` to spawn_points dict (east side of neighborhood, near a building).

2. Add `_build_rooftop_ladder()` call in `_setup_zone()` (after `_build_manhole()`).

3. Implement `_build_rooftop_ladder()` — follow the `_build_manhole()` pattern:
   - Position: `Vector2(680, 180)` — on side of a building, east area
   - Visual: Vertical ladder made of ColorRects
     - Two side rails: ColorRect(2, 30) in brown Color(0.45, 0.35, 0.2)
     - 5 rungs: ColorRect(10, 2) spaced evenly between rails
   - Label "ROOFTOPS" above ladder: Label with font_size 8, Color(0.7, 0.7, 0.8, 0.6)
   - ZoneExit: Instantiate zone_exit.tscn
     - `exit_id = "to_rooftops"`
     - `target_zone = "rooftops"`
     - `target_spawn = "from_neighborhood"`
     - `require_interaction = true` — press E to climb

The ladder should be visually clear (a distinct vertical element against the building). Use `z_index = 2` for the ladder visuals so they render above building background.

Important: preload the zone_exit scene like the manhole does: `preload("res://components/zone_exit/zone_exit.tscn")`
  </action>
  <verify>
    Run the game, navigate to east side of Neighborhood. Verify ladder is visible.
    Press E near ladder — should transition to Rooftops zone.
    In Rooftops, walk to left edge zone exit, press E — should return to Neighborhood at from_rooftops spawn point.
  </verify>
  <done>
    Bidirectional zone transition works: Neighborhood ladder -> Rooftops entry, Rooftops exit -> Neighborhood from_rooftops spawn. Both require interaction (press E).
  </done>
</task>

</tasks>

<verification>
1. Game launches without errors (no GDScript parse failures)
2. Can transition Neighborhood -> Rooftops via ladder
3. Can transition Rooftops -> Neighborhood via zone exit
4. Rooftops zone has visible platforms, chimneys, moonlit atmosphere
5. Camera limits work correctly for zone_size
6. Companions spawn and follow player in Rooftops
7. Boundaries prevent player from walking off rooftops
</verification>

<success_criteria>
- Rooftops zone loads and is playable (walk around all 4 platforms)
- Zone transitions work bidirectionally
- Atmosphere feels like nighttime rooftops (dark, moonlit)
- No errors in console/logs
</success_criteria>

<output>
After completion, create `.planning/phases/37-rooftop-spawners/37-01-SUMMARY.md`
</output>
