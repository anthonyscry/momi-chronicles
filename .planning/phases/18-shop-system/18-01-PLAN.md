---
phase: 18-shop-system
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - systems/shop/shop_catalog.gd
  - characters/npcs/shop_npc.gd
  - characters/npcs/shop_npc.tscn
  - world/zones/neighborhood.tscn
autonomous: true

must_haves:
  truths:
    - "Nutkin the Squirrel NPC is visible in the neighborhood zone"
    - "Player can walk up to Nutkin and see an interaction prompt"
    - "Pressing E near Nutkin emits a signal to open the shop"
    - "A shop catalog defines prices for all items and equipment"
  artifacts:
    - path: "systems/shop/shop_catalog.gd"
      provides: "Price catalog for all buyable items and equipment"
      contains: "SHOP_ITEMS"
    - path: "characters/npcs/shop_npc.gd"
      provides: "NPC with interaction area and prompt"
      contains: "shop_interact_requested"
    - path: "characters/npcs/shop_npc.tscn"
      provides: "Nutkin scene with collision, sprite, interaction area"
    - path: "world/zones/neighborhood.tscn"
      provides: "Shop NPC placed in neighborhood zone"
  key_links:
    - from: "characters/npcs/shop_npc.gd"
      to: "Events signal bus"
      via: "shop_interact_requested signal on Events"
      pattern: "Events\\.shop_interact_requested\\.emit"
    - from: "characters/npcs/shop_npc.gd"
      to: "interact input action"
      via: "_unhandled_input with is_action_pressed('interact')"
      pattern: "is_action_pressed.*interact"
---

<objective>
Create the Shop NPC (Nutkin the Squirrel) and price catalog system for the shop.

Purpose: Provides the physical shopkeeper in the game world and the data layer that defines what can be bought/sold and at what price. This is the foundation that the shop UI (Plan 02) will consume.

Output: Shop NPC placed in neighborhood zone with interaction prompt, plus a shop catalog autoload with all item/equipment prices.
</objective>

<execution_context>
@~/.config/Claude/get-shit-done/workflows/execute-plan.md
@~/.config/Claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@autoloads/game_manager.gd
@autoloads/events.gd
@systems/inventory/item_database.gd
@systems/equipment/equipment_database.gd
@components/zone_exit/zone_exit.gd
@world/zones/neighborhood.gd
@world/zones/base_zone.gd
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create shop catalog and shop NPC with interaction</name>
  <files>
    systems/shop/shop_catalog.gd
    characters/npcs/shop_npc.gd
    characters/npcs/shop_npc.tscn
    autoloads/events.gd
    project.godot
  </files>
  <action>
**1. Add shop signals to Events (autoloads/events.gd):**
Add a new section `# SHOP SIGNALS` with:
- `signal shop_interact_requested` — emitted when player presses E near shop NPC
- `signal shop_closed` — emitted when shop UI closes

**2. Create `systems/shop/shop_catalog.gd`:**
This is an autoload (add to project.godot autoloads as `ShopCatalog`). Do NOT use class_name.

Define a const dictionary `SHOP_ITEMS` mapping item_id to buy_price:
```
"acorn": 5,
"health_potion": 25,
"mega_potion": 80,
"full_heal": 200,
"power_treat": 40,
"speed_treat": 35,
"tough_treat": 35,
"guard_snack": 20,
"revival_bone": 100,
"bird_seed": 3,
```

Define a const dictionary `SHOP_EQUIPMENT` mapping equipment_id to buy_price:
```
"basic_collar": 30,
"spiked_collar": 60,
"lucky_collar": 150,
"training_harness": 50,
"tactical_harness": 120,
"padded_harness": 80,
"retractable_leash": 40,
"chain_leash": 75,
"bungee_leash": 90,
"raincoat": 70,
"sweater": 65,
"leather_jacket": 130,
"baseball_cap": 35,
"bandana": 55,
"guard_helmet": 140,
```

Define `SELL_MULTIPLIER: float = 0.5` (sell back at 50%).

Functions:
- `get_buy_price(item_id: String) -> int` — returns price from SHOP_ITEMS or SHOP_EQUIPMENT, -1 if not found
- `get_sell_price(item_id: String) -> int` — returns floor(buy_price * SELL_MULTIPLIER), -1 if not found
- `can_afford(item_id: String) -> bool` — checks GameManager.coins >= buy_price
- `get_all_shop_items() -> Array[Dictionary]` — returns array of item data dicts with "buy_price" added, from ItemDatabase
- `get_all_shop_equipment() -> Array[Dictionary]` — returns array of equipment data dicts with "buy_price" added, from EquipmentDatabase
- `is_item(item_id: String) -> bool` — true if in SHOP_ITEMS
- `is_equipment(item_id: String) -> bool` — true if in SHOP_EQUIPMENT

**3. Register ShopCatalog autoload in project.godot:**
Add line after the UITester autoload:
`ShopCatalog="*res://systems/shop/shop_catalog.gd"`

**4. Create `characters/npcs/shop_npc.gd`:**
Extends `Area2D`. This is NOT an autoload, so it CAN use class_name ShopNPC.

Properties:
- `@export var npc_name: String = "Nutkin"` 
- `var player_in_range: bool = false`
- `var prompt_label: Label` — "Press E to Shop" floating text

Setup:
- `collision_layer = 0`, `collision_mask = 2` (detects player, same pattern as ZoneExit)
- Connect `body_entered` / `body_exited` signals
- Create the NPC visually using a Polygon2D (squirrel shape — bushy tail, orange-brown body, lighter belly). Size approximately 12x16px (similar scale to other characters).
- Add a small idle animation via `_process()`: gentle bobbing up/down by 1px at 0.5Hz
- Create floating name label "Nutkin" above sprite (small font, yellow/gold color)
- Create prompt label "Press [E] to Shop" that appears/disappears when player is in range

Input handling:
- In `_unhandled_input(event)`: if `player_in_range` and `event.is_action_pressed("interact")`, emit `Events.shop_interact_requested.emit()` and call `get_viewport().set_input_as_handled()`

Signals on body_entered/exited:
- Show/hide prompt label
- Set player_in_range

**5. Create `characters/npcs/shop_npc.tscn`:**
Scene tree:
- ShopNPC (Area2D) with shop_npc.gd script
  - CollisionShape2D: RectangleShape2D (16x16 interaction area)
  - Sprite (Polygon2D): Squirrel visual
  - NameLabel (Label): "Nutkin" text above sprite
  - PromptLabel (Label): "[E] Shop" below sprite, initially hidden

Since the project uses programmatic polygon sprites (not texture-based), create the squirrel as a polygon in code in `_ready()` or in the scene — follow the same pattern as enemies which use Polygon2D for their visuals.
  </action>
  <verify>
    Open Godot editor — verify ShopCatalog appears in autoloads list. Verify `characters/npcs/shop_npc.tscn` opens without errors. Check `ShopCatalog.get_buy_price("health_potion")` returns 25 in a test print.
  </verify>
  <done>
    ShopCatalog autoload exists with all item/equipment prices. ShopNPC scene exists with interaction area, visual, and prompt. Events has shop signals.
  </done>
</task>

<task type="auto">
  <name>Task 2: Place Nutkin in neighborhood zone</name>
  <files>
    world/zones/neighborhood.tscn
    world/zones/neighborhood.gd
  </files>
  <action>
**1. Add Nutkin to neighborhood.tscn:**
Add a ShopNPC instance as a child of the root node (NOT under Enemies — NPCs are separate).
- Position: Vector2(400, 350) — near the stores area, visible and accessible
- Name the node "Nutkin"

**2. Update neighborhood.gd spawn points:**
Add a new spawn point:
```gdscript
"shop": Vector2(380, 350),  # Near Nutkin's shop
```

**3. Test interaction:**
The NPC should be visible when the neighborhood zone loads. Walking near it should show the prompt. Pressing E should print a debug message (Events.shop_interact_requested is emitted but no UI listens yet — that's Plan 02).

Add a temporary debug print in `_setup_zone()`:
```gdscript
Events.shop_interact_requested.connect(func(): print("[Shop] NPC interaction triggered!"))
```
This temporary connection will be removed when Plan 02 adds the actual shop UI listener.
  </action>
  <verify>
    Run the game, load neighborhood zone. Walk to position ~(400, 350). Verify Nutkin is visible (orange-brown squirrel polygon). Verify "[E] Shop" prompt appears when near. Press E — verify console prints "[Shop] NPC interaction triggered!".
  </verify>
  <done>
    Nutkin is placed in the neighborhood zone. Player can approach and interact. Debug print confirms signal emission.
  </done>
</task>

</tasks>

<verification>
- [ ] ShopCatalog autoload registered in project.godot
- [ ] ShopCatalog has prices for all 10 items and 15 equipment pieces
- [ ] ShopNPC scene loads without errors
- [ ] Nutkin visible in neighborhood zone
- [ ] Interaction prompt appears/disappears based on player proximity
- [ ] E key press emits Events.shop_interact_requested
- [ ] Events.gd has shop_interact_requested and shop_closed signals
</verification>

<success_criteria>
Player can walk up to Nutkin in the neighborhood zone, see the interaction prompt, and press E to trigger the shop signal. Shop catalog contains correct prices for all items and equipment.
</success_criteria>

<output>
After completion, create `.planning/phases/18-shop-system/18-01-SUMMARY.md`
</output>
