---
phase: 18-shop-system
plan: 02
type: execute
wave: 2
depends_on: ["18-01"]
files_modified:
  - ui/shop/shop_ui.gd
  - ui/shop/shop_ui.tscn
  - project.godot
autonomous: true

must_haves:
  truths:
    - "Pressing E near Nutkin opens the shop UI panel"
    - "Player can see items and equipment listed with names, descriptions, and prices"
    - "Player can browse items using keyboard navigation (up/down to select, left/right to switch Buy/Sell tabs)"
    - "Player can buy an item when they have enough coins (coins deducted, item added to inventory)"
    - "Player cannot buy an item when they lack coins (visual feedback, no transaction)"
    - "Player can close the shop with ESC or E"
    - "Current coin balance is displayed in the shop UI"
  artifacts:
    - path: "ui/shop/shop_ui.gd"
      provides: "Full shop UI with buy functionality and keyboard navigation"
      contains: "shop_interact_requested"
    - path: "ui/shop/shop_ui.tscn"
      provides: "Shop UI scene with panel, item list, detail pane, and coin display"
  key_links:
    - from: "ui/shop/shop_ui.gd"
      to: "Events.shop_interact_requested"
      via: "signal connection in _ready()"
      pattern: "Events\\.shop_interact_requested\\.connect"
    - from: "ui/shop/shop_ui.gd"
      to: "GameManager.spend_coins"
      via: "buy transaction"
      pattern: "GameManager\\.spend_coins"
    - from: "ui/shop/shop_ui.gd"
      to: "GameManager.inventory.add_item"
      via: "add purchased item"
      pattern: "GameManager\\.inventory\\.add_item"
    - from: "ui/shop/shop_ui.gd"
      to: "GameManager.equipment_manager.add_equipment"
      via: "add purchased equipment"
      pattern: "GameManager\\.equipment_manager\\.add_equipment"
    - from: "ui/shop/shop_ui.gd"
      to: "ShopCatalog"
      via: "get item/equipment lists and prices"
      pattern: "ShopCatalog\\.get_all_shop"
---

<objective>
Create the shop UI panel that opens when interacting with Nutkin. Supports browsing items/equipment and buying with coins.

Purpose: This is the core shop experience — the player's primary way to spend accumulated coins on useful items and gear. Without this, the shop NPC from Plan 01 has no function.

Output: A fully functional shop UI with buy tab (items + equipment), keyboard navigation, coin display, and purchase transactions.
</objective>

<execution_context>
@~/.config/Claude/get-shit-done/workflows/execute-plan.md
@~/.config/Claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-shop-system/18-01-SUMMARY.md
@systems/shop/shop_catalog.gd
@autoloads/events.gd
@autoloads/game_manager.gd
@systems/inventory/inventory.gd
@systems/inventory/item_database.gd
@systems/equipment/equipment_database.gd
@systems/equipment/equipment_manager.gd
@ui/ring_menu/ring_menu.gd
@ui/theme/menu_theme.tres
@ui/hud/game_hud.gd
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create shop UI scene and script with buy functionality</name>
  <files>
    ui/shop/shop_ui.gd
    ui/shop/shop_ui.tscn
    project.godot
  </files>
  <action>
**1. Create `ui/shop/shop_ui.gd` as a CanvasLayer autoload:**

This is an autoload (register in project.godot as `ShopUI`). Do NOT use class_name. Use `process_mode = Node.PROCESS_MODE_ALWAYS` so it works while paused.

**Layout Design (pixel art style, 384x216 viewport):**
The shop UI is a centered panel (~280x160px) with:
- **Title bar**: "Nutkin's Shop" centered at top, gold text
- **Tab indicator**: "BUY | SELL" at top-right (current tab highlighted in green). Left/Right arrows switch tabs. Plan 02 only implements BUY tab; SELL tab shows "Coming soon" placeholder.
- **Category buttons**: "Items" and "Equipment" sub-tabs below title, toggled with Q key
- **Item list (left ~60%)**: Scrollable list of items. Each row shows:
  - Color swatch (small 6x6 rect matching item color)
  - Item name (truncated if too long)
  - Price (right-aligned, gold color if affordable, red if too expensive)
  - Quantity owned (small, gray, e.g., "x3")
- **Detail pane (right ~40%)**: Shows selected item details:
  - Item name (larger font)
  - Description text
  - Price with coin icon (gold text)
  - Stats (for equipment: list stat bonuses)
  - "[Z] Buy" button prompt at bottom (or "Owned" for equipment the player already has)
- **Coin display**: Bottom-left shows current coin count with a coin icon
- **Navigation hints**: Bottom shows "[↑↓] Select  [←→] Tab  [Q] Category  [Z] Buy  [Esc] Close"

**Color palette** (matching menu_theme.tres):
- Panel bg: Color(0.08, 0.12, 0.08, 0.95) — dark green
- Border: Color(0.25, 0.4, 0.25, 1) — medium green  
- Text: Color(0.9, 0.95, 0.85, 1) — cream
- Price affordable: Color(1.0, 0.84, 0.0) — gold
- Price too expensive: Color(0.8, 0.3, 0.3) — red
- Selected row highlight: Color(0.18, 0.28, 0.18, 0.98) — slightly lighter green
- Tab active: Color(0.5, 0.8, 0.4, 1) — bright green
- Tab inactive: Color(0.5, 0.55, 0.5, 0.7) — gray

**Script structure:**

```
State vars:
  var is_open: bool = false
  var current_tab: int = 0  # 0=BUY, 1=SELL
  var current_category: int = 0  # 0=Items, 1=Equipment
  var selected_index: int = 0
  var current_list: Array = []  # Current displayable items

Node refs (created in _ready()):
  var panel: Panel
  var title_label: Label
  var tab_label: Label
  var category_label: Label
  var item_list_container: VBoxContainer  # Item rows
  var detail_name: Label
  var detail_desc: Label
  var detail_price: Label
  var detail_stats: Label
  var detail_action: Label
  var coin_label: Label
  var nav_hints: Label
  var item_rows: Array  # Pre-created row Controls (pool of ~8)
  var scroll_offset: int = 0
  const VISIBLE_ROWS: int = 7
```

**_ready():**
- Set layer = 100 (above HUD, below fade overlay)
- Set visible = false
- Build UI programmatically (ALL nodes created in code — no .tscn dependencies needed beyond the scene root)
- Connect `Events.shop_interact_requested` to `open_shop()`
- Connect `Events.coins_changed` to `_update_coin_display()`

**open_shop():**
- Set is_open = true, visible = true
- Pause game via GameManager.pause_game()
- Reset to BUY tab, Items category, index 0
- Populate item list from ShopCatalog.get_all_shop_items()
- Animate open: scale from 0.8 to 1.0 + fade in (0.15s, EASE_OUT + TRANS_BACK)
- Play "menu_select" sfx

**close_shop():**
- Set is_open = false
- Animate close: scale to 0.8 + fade out (0.1s)
- Resume game via GameManager.resume_game()
- Emit Events.shop_closed
- Play "menu_navigate" sfx

**_unhandled_input(event):** (only when is_open)
- Up/Down (ui_up/ui_down or move_up/move_down): Navigate item list (change selected_index, scroll if needed)
- Left/Right (ui_left/ui_right or move_left/move_right): Switch BUY/SELL tab
- Q key: Toggle Items/Equipment category
- Z key or attack action: Buy selected item
- Escape or interact (E): Close shop
- Play "menu_navigate" sfx on navigation
- Call `get_viewport().set_input_as_handled()` for ALL handled inputs

**_refresh_list():**
- If BUY tab + Items category: `current_list = ShopCatalog.get_all_shop_items()`
- If BUY tab + Equipment category: `current_list = ShopCatalog.get_all_shop_equipment()`
- If SELL tab: show placeholder "Coming soon" (Plan 03 adds this)
- Clamp selected_index
- Update all row displays
- Update detail pane for selected item

**_update_rows():**
- For each visible row (up to VISIBLE_ROWS):
  - Get item from current_list at (scroll_offset + row_index)
  - Set color swatch to item.color
  - Set name text
  - Set price text (gold if affordable, red if not)
  - Set quantity text (for items: show "x{qty}" of owned. For equipment: show "Owned" if already has)
  - Highlight selected row with brighter background

**_update_detail(item: Dictionary):**
- Set name, description, price
- For equipment: show stat bonuses (e.g., "+5 Max HP, +3 Attack")
- For items: show effect description
- Action prompt: 
  - "[Z] Buy" if affordable and (for equipment) not already owned
  - "Not enough coins" in red if can't afford
  - "Already owned" in gray for equipment already in inventory

**_buy_selected():**
- Get selected item from current_list
- Check if it's equipment and already owned → show "Already owned" feedback, return
- Check GameManager.spend_coins(price) → if false, show "Not enough!" red flash feedback, play error sound, return
- If item: call GameManager.inventory.add_item(item.id)
- If equipment: call GameManager.equipment_manager.add_equipment(item.id)
- Play "health_pickup" sfx (reuse as purchase sound)
- Flash detail pane green briefly (tween)
- Refresh list (update quantities and affordability colors)
- Print "[Shop] Bought: {item_name} for {price} coins"

**_update_coin_display():**
- Set coin_label.text = "Coins: %d" % GameManager.coins

**Buy feedback animations:**
- Success: Brief green flash on the item row + coin count pulses
- Failure (not enough coins): Brief red flash + coin count shakes horizontally
- Already owned (equipment): Brief gray flash + "Already owned" text blink

**2. Create `ui/shop/shop_ui.tscn`:**
Minimal scene — just the CanvasLayer root node with the script attached. All child nodes are created programmatically in `_ready()`.

**3. Register ShopUI autoload in project.godot:**
Add after ShopCatalog:
`ShopUI="*res://ui/shop/shop_ui.tscn"`

**4. Remove temporary debug connection from neighborhood.gd:**
In Plan 01, a temporary `Events.shop_interact_requested.connect(func(): print(...))` was added to `_setup_zone()`. Remove it — the ShopUI autoload now handles the signal.
  </action>
  <verify>
    Run the game. Walk to Nutkin, press E. Verify shop UI opens with items listed. Navigate up/down — verify selection moves and detail pane updates. Press Q — verify category switches to Equipment. Press Z on an affordable item — verify coins deducted and item added (check console output). Press Z on an expensive item — verify red flash and no purchase. Press Escape — verify shop closes and game resumes. Check that coin counter in HUD reflects purchases.
  </verify>
  <done>
    Shop UI opens on NPC interaction, displays items/equipment with prices, player can buy items with coins (coins deducted, inventory updated), can't buy when broke, can navigate and close. Buy tab fully functional. Sell tab shows placeholder.
  </done>
</task>

</tasks>

<verification>
- [ ] Shop UI opens when pressing E near Nutkin
- [ ] Items tab shows all 10 items with prices from ShopCatalog
- [ ] Equipment tab shows all 15 equipment pieces with prices
- [ ] Up/Down navigates item list
- [ ] Left/Right switches Buy/Sell tabs
- [ ] Q toggles Items/Equipment category
- [ ] Z key purchases selected item (coins deducted, item/equipment added)
- [ ] Can't buy if insufficient coins (red feedback)
- [ ] Can't buy equipment already owned (gray feedback)
- [ ] Coin display shows current balance
- [ ] ESC or E closes shop and resumes game
- [ ] Sound effects play on navigation, purchase, and close
</verification>

<success_criteria>
Player can open Nutkin's shop, browse items and equipment, and purchase them with coins. Buy transactions correctly deduct coins and add items to inventory. UI provides clear feedback for successful and failed purchases.
</success_criteria>

<output>
After completion, create `.planning/phases/18-shop-system/18-02-SUMMARY.md`
</output>
