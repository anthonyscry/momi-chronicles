---
phase: 24-zone-awareness
plan: 02
type: execute
wave: 2
depends_on: ["24-01"]
files_modified:
  - autoloads/auto_bot.gd
autonomous: true

must_haves:
  truths:
    - "Bot detects ToxicPuddle Area2D nodes and steers away from them"
    - "Bot avoids wandering into toxic puddles during patrol"
    - "Bot recognizes sewers darkness and adjusts behavior (shorter wander, closer pursuit)"
    - "Bot generates corridor-aware patrol points in sewers instead of grid points in walls"
  artifacts:
    - path: "autoloads/auto_bot.gd"
      provides: "Hazard avoidance steering and environment awareness"
      contains: "_update_hazard_awareness"
  key_links:
    - from: "autoloads/auto_bot.gd"
      to: "components/hazards/toxic_puddle.gd"
      via: "Scanning for ToxicPuddle nodes by class check or name pattern"
      pattern: "ToxicPuddle"
    - from: "autoloads/auto_bot.gd"
      to: "world/zones/sewers.gd"
      via: "Reading corridor_segments for walkable space, checking for CanvasModulate darkness"
      pattern: "corridor_segments|CanvasModulate"
---

<objective>
Add hazard avoidance (ToxicPuddle steering) and sewers environment awareness (darkness detection, corridor-constrained patrol) to the AutoBot.

Purpose: In the sewers zone, the bot currently ignores toxic puddles and would generate patrol points inside walls (the sewers is a winding corridor system, not an open rectangle). The bot needs to detect hazards and navigate the corridor layout intelligently.

Output: auto_bot.gd with hazard avoidance steering and sewers-specific corridor-aware navigation.
</objective>

<execution_context>
@~/.config/Claude/get-shit-done/workflows/execute-plan.md
@~/.config/Claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/24-zone-awareness/24-01-SUMMARY.md

Key source files:
@autoloads/auto_bot.gd — The bot with dynamic zone_size from Plan 01
@components/hazards/toxic_puddle.gd — Area2D with puddle_size export, collision_mask=2 (player layer). 6 puddles in sewers (4 obvious + 2 camouflaged).
@world/zones/sewers.gd — Has `corridor_segments: Array[Rect2]` (8 corridors) and `side_rooms: Array[Dictionary]` defining walkable space. Has CanvasModulate "Darkness" node. Zone size 1152x648.
@world/zones/base_zone.gd — BaseZone class, zone_id identifies which zone we're in.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add ToxicPuddle hazard detection and avoidance steering</name>
  <files>autoloads/auto_bot.gd</files>
  <action>
  **Add hazard awareness configuration in the CONFIGURATION section** (after the crowd control settings, around line ~82):
  ```gdscript
  ## Hazard avoidance settings
  const HAZARD_DETECTION_RANGE: float = 120.0   # How far to detect hazards
  const HAZARD_AVOIDANCE_STRENGTH: float = 0.8  # How strongly to steer away (0-1)
  const HAZARD_AVOID_RADIUS: float = 50.0       # Extra padding around hazards
  ```

  **Add hazard state variables in the STATE section** (after the crowd awareness block, around line ~136):
  ```gdscript
  # Hazard awareness
  var nearby_hazards: Array[Node] = []
  var hazard_avoidance_vector: Vector2 = Vector2.ZERO
  var is_in_dark_zone: bool = false
  ```

  **Add `_update_hazard_awareness()` function** in the HELPERS section (after `_update_crowd_awareness()`):
  ```gdscript
  func _update_hazard_awareness() -> void:
      if player_ref == null:
          return
      
      var player_pos = player_ref.global_position
      nearby_hazards.clear()
      hazard_avoidance_vector = Vector2.ZERO
      
      # Scan for toxic puddles — they are Area2D children named "ToxicPuddle_*"
      # in the zone's Hazards container
      var hazard_repulsion = Vector2.ZERO
      var hazard_count = 0
      
      # Find hazards via zone tree (more reliable than groups since puddles aren't in a group)
      if is_instance_valid(current_zone_ref) and current_zone_ref.has_node("Hazards"):
          var hazards_node = current_zone_ref.get_node("Hazards")
          for hazard in hazards_node.get_children():
              var dist = player_pos.distance_to(hazard.global_position)
              if dist < HAZARD_DETECTION_RANGE:
                  nearby_hazards.append(hazard)
                  # Stronger repulsion when closer (inverse distance weighting)
                  var strength = 1.0 - (dist / HAZARD_DETECTION_RANGE)
                  var away_dir = (player_pos - hazard.global_position).normalized()
                  hazard_repulsion += away_dir * strength
                  hazard_count += 1
      
      # Also check if player is currently poisoned (reactive avoidance)
      if player_ref.has_node("HealthComponent"):
          var health = player_ref.get_node("HealthComponent")
          if health.is_poisoned and hazard_count > 0:
              # Amplify avoidance when already poisoned
              hazard_repulsion *= 1.5
      
      if hazard_count > 0:
          hazard_avoidance_vector = (hazard_repulsion / hazard_count).normalized() * HAZARD_AVOIDANCE_STRENGTH
      
      # Detect darkness zones (sewers has CanvasModulate named "Darkness")
      is_in_dark_zone = false
      if is_instance_valid(current_zone_ref):
          is_in_dark_zone = current_zone_ref.has_node("Darkness")
  ```

  **Call `_update_hazard_awareness()` in `_physics_process()`** — add right after `_update_crowd_awareness()` call (around line ~220):
  ```gdscript
  # Update hazard awareness
  _update_hazard_awareness()
  ```

  **Integrate hazard avoidance into movement** — modify `_apply_boundary_avoidance()` to also apply hazard steering. After the existing boundary push logic (after line ~561), add:
  ```gdscript
  # Apply hazard avoidance steering
  if hazard_avoidance_vector != Vector2.ZERO:
      adjusted += hazard_avoidance_vector
      adjusted = adjusted.normalized()
  ```

  **Integrate hazard avoidance into `_pick_wander_direction()`** — after the patrol point navigation sets `desired_direction` (around line ~884), add hazard awareness:
  After the line `desired_direction = to_target.rotated(randf_range(-0.2, 0.2))`, add:
  ```gdscript
  # Avoid hazards during patrol
  if hazard_avoidance_vector != Vector2.ZERO:
      desired_direction = (desired_direction + hazard_avoidance_vector).normalized()
  ```

  **Important:** The toxic_puddle.gd is an Area2D with puddle_size export. The puddles are NOT in a group — they are children of a "Hazards" Node2D container inside the zone scene. The `current_zone_ref` from Plan 01 gives us the zone node to search.
  </action>
  <verify>
  - Search auto_bot.gd for `_update_hazard_awareness` — function exists
  - Search for `hazard_avoidance_vector` — used in boundary avoidance and wander direction
  - Search for `nearby_hazards` — populated by scanning Hazards container
  - Search for `is_in_dark_zone` — set by checking for Darkness node
  - Run game, enter sewers — console should NOT show poisoned messages if bot is working (bot steers away from puddles)
  </verify>
  <done>
  - Bot detects ToxicPuddle nodes within 120px via zone Hazards container scan
  - Hazard repulsion vector steers bot away from puddles (inverse distance weighted)
  - Poisoned state amplifies avoidance (reactive learning)
  - Avoidance integrated into both boundary steering and patrol navigation
  - Darkness zone detected via CanvasModulate presence
  </done>
</task>

<task type="auto">
  <name>Task 2: Add sewers corridor-aware patrol and darkness behavior</name>
  <files>autoloads/auto_bot.gd</files>
  <action>
  **Override patrol point generation for corridor-based zones.** Modify `_generate_patrol_points()` (created in Plan 01) to detect sewers and generate corridor-based points:

  Replace the `_generate_patrol_points()` function with:
  ```gdscript
  func _generate_patrol_points() -> Array[Vector2]:
      # For corridor-based zones (sewers), generate points along walkable corridors
      if is_instance_valid(current_zone_ref) and current_zone_ref.has_method("get") == false:
          # Check if zone has corridor_segments (sewers-style layout)
          if "corridor_segments" in current_zone_ref:
              return _generate_corridor_patrol_points()
      
      # Default: grid-based patrol for open zones
      var zs = current_zone_size
      var pad = ZONE_PADDING * 2
      var points: Array[Vector2] = []
      
      var cols = 3
      var rows = 2
      for row in range(rows):
          for col in range(cols):
              var x = pad + (zs.x - pad * 2) * (float(col) / float(cols - 1)) if cols > 1 else zs.x / 2.0
              var y = pad + (zs.y - pad * 2) * (float(row) / float(rows - 1)) if rows > 1 else zs.y / 2.0
              points.append(Vector2(x, y))
      
      points.append(Vector2(zs.x / 2.0, zs.y / 2.0))
      return points
  
  
  func _generate_corridor_patrol_points() -> Array[Vector2]:
      var points: Array[Vector2] = []
      
      # Sample center points from each corridor segment
      var segments: Array = current_zone_ref.corridor_segments
      for seg in segments:
          # Center of each corridor segment
          var center = seg.position + seg.size / 2.0
          points.append(center)
      
      # Also sample side room centers (exploration)
      if "side_rooms" in current_zone_ref:
          var rooms: Array = current_zone_ref.side_rooms
          for room in rooms:
              var rect: Rect2 = room.rect
              points.append(rect.position + rect.size / 2.0)
      
      return points
  ```

  This generates patrol points at the center of each corridor segment (8 points) and each side room (4 points) = 12 total patrol points, all within walkable space.

  **Add darkness zone behavior adjustments.** Modify `_pick_wander_direction()` to adjust behavior in dark zones. After the patrol points are generated and before the patrol point selection logic, add:
  ```gdscript
  # In dark zones, reduce wander duration (stay alert, move more purposefully)
  if is_in_dark_zone:
      direction_timer = DIRECTION_CHANGE_TIME * 0.6  # Shorter wander legs in darkness
  ```

  **Add darkness-aware enemy pursuit.** In the enemy hunting section of `_pick_wander_direction()` (around lines 857-865), modify the aggression for dark zones. After `if closest_enemy != null and randf() < 0.7:`, change the hunt behavior:
  
  Find this block:
  ```gdscript
  if closest_enemy != null and randf() < 0.7:
      var dir_to_enemy = (closest_enemy.global_position - pos).normalized()
      desired_direction = dir_to_enemy.rotated(randf_range(-0.2, 0.2))
      var run_chance = 0.5 if living_enemy_count > 3 else 0.8
      player_ref.bot_running = randf() < run_chance
      return
  ```
  
  Replace with:
  ```gdscript
  # Hunt threshold: more aggressive in dark zones (always hunt if visible)
  var hunt_chance = 0.85 if is_in_dark_zone else 0.7
  if closest_enemy != null and randf() < hunt_chance:
      var dir_to_enemy = (closest_enemy.global_position - pos).normalized()
      # Less aim variance in dark (focused) vs open zones (casual)
      var aim_var = 0.1 if is_in_dark_zone else 0.2
      desired_direction = dir_to_enemy.rotated(randf_range(-aim_var, aim_var))
      var run_chance = 0.5 if living_enemy_count > 3 else 0.8
      # Always run in dark zones (dangerous environment)
      if is_in_dark_zone:
          run_chance = 0.9
      player_ref.bot_running = randf() < run_chance
      return
  ```

  **Important architectural notes:**
  - The sewers zone has `corridor_segments: Array[Rect2]` as a public variable (NOT a method) — access it directly via `current_zone_ref.corridor_segments`
  - The `"corridor_segments" in current_zone_ref` check uses GDScript's `in` operator which works on object properties
  - Water channels are ColorRect visuals only (no collision) — bot doesn't need to avoid them
  - Walls are StaticBody2D with collision_layer=1 — the player's collision already handles wall blocking, bot just needs to not pick patrol points inside walls
  </action>
  <verify>
  - Search auto_bot.gd for `_generate_corridor_patrol_points` — function exists
  - Search for `corridor_segments` — referenced in corridor detection
  - Search for `is_in_dark_zone` — used in wander and hunt behavior
  - Run game, enter sewers — bot should patrol along corridor centers, not wander into walls
  - Run game, enter neighborhood — bot should still use grid-based patrol (unchanged behavior)
  - Run game, enter sewers — bot should be more aggressive (higher hunt chance, always runs)
  </verify>
  <done>
  - Sewers corridor_segments detected via property check on zone ref
  - Corridor patrol points generated at center of each segment + side room
  - Grid patrol preserved for open zones (neighborhood, backyard)
  - Dark zone behavior: shorter wander, higher hunt aggression, always run, tighter aim
  - Water channels ignored (visual only, no collision concern)
  </done>
</task>

</tasks>

<verification>
1. `grep -n "_update_hazard_awareness\|_generate_corridor_patrol_points" autoloads/auto_bot.gd` — both functions exist
2. `grep -n "hazard_avoidance_vector\|nearby_hazards\|is_in_dark_zone" autoloads/auto_bot.gd` — state variables present
3. `grep -n "HAZARD_DETECTION_RANGE\|HAZARD_AVOIDANCE_STRENGTH" autoloads/auto_bot.gd` — constants present
4. `grep -n "corridor_segments" autoloads/auto_bot.gd` — corridor awareness present
5. Run game, enter sewers — bot navigates corridors without getting stuck in walls
6. Run game, enter sewers — bot avoids toxic puddles (no constant poisoning)
7. Run game, enter neighborhood — bot behavior unchanged (grid patrol, normal aggression)
8. Run game, toggle between zones — bot adapts patrol style per zone type
</verification>

<success_criteria>
- ToxicPuddle avoidance: bot steers away from puddles within 120px detection range
- Corridor patrol: sewers generates 12 patrol points (8 corridor centers + 4 room centers)
- Grid patrol: non-corridor zones generate proportional 7-point grid
- Darkness awareness: bot is more aggressive, focused, and mobile in dark zones
- No wall-stuck behavior in sewers (corridor points are all within walkable Rect2 regions)
- Poison amplifies avoidance (bot learns from being poisoned)
</success_criteria>

<output>
After completion, create `.planning/phases/24-zone-awareness/24-02-SUMMARY.md`
</output>
