---
phase: 15-ui-testing
plan: 02
type: execute
wave: 2
depends_on: ["15-01"]
files_modified:
  - autoloads/ui_tester.gd
autonomous: true

must_haves:
  truths:
    - "Full game flow test runs automatically"
    - "Title screen buttons verified"
    - "Pause menu opens and closes correctly"
    - "HUD elements update properly"
    - "Game over flow works"
    - "Test report shows all results"
  artifacts:
    - path: "autoloads/ui_tester.gd"
      provides: "Complete test scenarios"
      contains: "run_all_tests"
  key_links:
    - from: "ui_tester.gd"
      to: "title_screen"
      via: "click StartButton"
      pattern: "click_button.*StartButton"
    - from: "ui_tester.gd"
      to: "pause_menu"
      via: "ESC key simulation"
      pattern: "press_key.*KEY_ESCAPE"
---

<objective>
Create comprehensive test scenarios that verify all UI flows.

Purpose: Automated smoke tests for the entire game UI
Output: Runnable test suite covering title → gameplay → pause → game over
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/15-ui-testing/15-01-SUMMARY.md
@autoloads/ui_tester.gd
@ui/menus/title_screen.gd
@ui/menus/pause_menu.gd
@ui/menus/game_over.gd
@ui/hud/game_hud.gd
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create test scenarios</name>
  <files>
    autoloads/ui_tester.gd
  </files>
  <action>
Add test scenario methods to UITester:

```gdscript
# =============================================================================
# TEST SCENARIOS
# =============================================================================

## Run all test scenarios
func run_all_tests() -> void:
    start_tests()
    log_info("Running all UI test scenarios...")
    
    # Determine starting point based on current scene
    var current = get_tree().current_scene
    if current and "title" in current.name.to_lower():
        await test_title_screen()
        await test_gameplay_start()
    elif current:
        await test_gameplay_hud()
    
    await test_pause_menu()
    await test_hud_updates()
    
    stop_tests()

## Test title screen UI
func test_title_screen() -> void:
    log_info("--- TEST: Title Screen ---")
    
    # Verify title screen elements exist
    verify_exists("TitleScreen", "title_screen:exists")
    verify_visible("StartButton", "title_screen:start_visible")
    verify_visible("QuitButton", "title_screen:quit_visible")
    verify_button_enabled("StartButton", "title_screen:start_enabled")
    verify_button_enabled("QuitButton", "title_screen:quit_enabled")
    
    # Verify StartButton has focus (should be grabbed on ready)
    var start_btn = find_button("StartButton")
    if start_btn and start_btn.has_focus():
        log_pass("title_screen:start_has_focus")
    else:
        log_fail("title_screen:start_has_focus", "StartButton should have focus")
    
    await wait_seconds(0.5)

## Test starting the game from title screen
func test_gameplay_start() -> void:
    log_info("--- TEST: Gameplay Start ---")
    
    # Click start button
    if click_button("StartButton"):
        log_pass("gameplay:click_start")
    else:
        log_fail("gameplay:click_start", "Could not click StartButton")
        return
    
    # Wait for scene transition
    await wait_seconds(1.0)
    
    # Verify we're in gameplay
    verify_scene("neighborhood", "gameplay:scene_loaded")
    verify_exists("Player", "gameplay:player_exists")
    verify_visible("GameHUD", "gameplay:hud_visible")
    verify_visible("HealthBar", "gameplay:health_bar_visible")

## Test HUD elements in gameplay
func test_gameplay_hud() -> void:
    log_info("--- TEST: Gameplay HUD ---")
    
    # Verify core HUD elements
    verify_visible("GameHUD", "hud:visible")
    verify_visible("HealthBar", "hud:health_bar")
    
    # Verify health bar shows correct value (should be 100% at start)
    verify_player_health_percent(1.0, 0.1, "hud:health_full")
    
    # Verify player exists and is alive
    verify_player_alive("hud:player_alive")
    
    # Check for v1.1 features (EXP bar, combo counter)
    var exp_bar = find_node("ExpBar")
    if exp_bar:
        log_pass("hud:exp_bar_exists (v1.1)")
    else:
        log_info("hud:exp_bar not found (pre-v1.1)")
    
    # Check for v1.2 features (guard bar, coin counter)
    var guard_bar = find_node("GuardBar")
    if guard_bar:
        log_pass("hud:guard_bar_exists (v1.2)")
    else:
        log_info("hud:guard_bar not found (pre-v1.2)")
    
    var coin_counter = find_node("CoinCounter")
    if coin_counter:
        log_pass("hud:coin_counter_exists (v1.2)")
    else:
        log_info("hud:coin_counter not found (pre-v1.2)")

## Test pause menu functionality
func test_pause_menu() -> void:
    log_info("--- TEST: Pause Menu ---")
    
    # Make sure we're in gameplay first
    if not get_player():
        log_info("Skipping pause test - not in gameplay")
        return
    
    # Verify pause menu is hidden initially
    verify_hidden("PauseMenu", "pause:initially_hidden")
    verify_not_paused("pause:game_running")
    
    # Simulate ESC to pause
    await press_key(KEY_ESCAPE)
    await wait_seconds(0.3)
    
    # Verify pause state
    verify_paused("pause:game_paused")
    verify_visible("PauseMenu", "pause:menu_visible")
    verify_visible("ResumeButton", "pause:resume_visible")
    verify_visible("QuitButton", "pause:quit_visible")
    
    # Verify sliders exist
    verify_exists("MusicSlider", "pause:music_slider")
    verify_exists("SFXSlider", "pause:sfx_slider")
    
    # Test resume button
    if click_button("ResumeButton"):
        log_pass("pause:click_resume")
    else:
        log_fail("pause:click_resume", "Could not click ResumeButton")
    
    await wait_seconds(0.3)
    
    # Verify unpaused
    verify_not_paused("pause:game_resumed")
    verify_hidden("PauseMenu", "pause:menu_hidden_after_resume")

## Test HUD updates during gameplay
func test_hud_updates() -> void:
    log_info("--- TEST: HUD Updates ---")
    
    var player = get_player()
    if not player:
        log_info("Skipping HUD update test - no player")
        return
    
    # Get initial health
    var initial_health = player.health.current_health if player.health else 100
    
    # Damage the player slightly (simulate)
    if player.health and player.health.has_method("take_damage"):
        player.health.take_damage(10)
        await wait_seconds(0.2)
        
        # Verify health bar updated
        var expected_percent = float(initial_health - 10) / float(player.health.max_health)
        verify_player_health_percent(expected_percent, 0.05, "hud:health_updated_after_damage")
        
        # Heal back
        if player.health.has_method("heal"):
            player.health.heal(10)
            await wait_seconds(0.2)
            verify_player_health_percent(1.0, 0.05, "hud:health_updated_after_heal")
    else:
        log_info("Cannot test health updates - no damage method")

# =============================================================================
# FEATURE-SPECIFIC TESTS (v1.2)
# =============================================================================

## Test block/parry UI (Phase 12)
func test_block_parry_ui() -> void:
    log_info("--- TEST: Block/Parry UI (v1.2) ---")
    
    var guard_bar = find_node("GuardBar")
    if not guard_bar:
        log_info("GuardBar not found - Phase 12 not implemented")
        return
    
    verify_visible("GuardBar", "block:guard_bar_visible")
    
    var player = get_player()
    if player and player.has_node("GuardComponent"):
        var guard = player.get_node("GuardComponent")
        # Verify guard bar shows correct initial value
        verify_bar_percent("GuardBar", 1.0, 0.05, "block:guard_full")
        log_pass("block:guard_component_exists")
    else:
        log_info("GuardComponent not found on player")

## Test pickup/coin UI (Phase 13)
func test_pickup_ui() -> void:
    log_info("--- TEST: Pickup UI (v1.2) ---")
    
    var coin_counter = find_node("CoinCounter")
    if not coin_counter:
        log_info("CoinCounter not found - Phase 13 not implemented")
        return
    
    verify_visible("CoinCounter", "pickup:coin_counter_visible")
    
    # Verify initial coins (should be 0 or whatever GameManager has)
    if GameManager.has_method("get_coins"):
        var initial = GameManager.get_coins()
        log_pass("pickup:initial_coins=%d" % initial)
        
        # Add some coins and verify update
        if GameManager.has_method("add_coins"):
            GameManager.add_coins(5)
            await wait_seconds(0.3)
            verify_coins(initial + 5, "pickup:coins_updated")
            
            # Remove the test coins
            if GameManager.has_method("spend_coins"):
                GameManager.spend_coins(5)

## Test save system UI (Phase 14)
func test_save_ui() -> void:
    log_info("--- TEST: Save UI (v1.2) ---")
    
    # Check for save-related UI in pause menu
    # This would test "Load Game" button on title, save indicator, etc.
    
    # Check title screen for Load Game button
    var load_btn = find_button("LoadButton")
    if load_btn:
        log_pass("save:load_button_exists")
        if load_btn.visible:
            verify_visible("LoadButton", "save:load_button_visible")
    else:
        log_info("LoadButton not found - Phase 14 not implemented or no saves")

# =============================================================================
# COMPREHENSIVE TEST RUNNER
# =============================================================================

## Run v1.2 feature tests
func run_v12_tests() -> void:
    start_tests()
    log_info("Running v1.2 feature UI tests...")
    
    await test_block_parry_ui()
    await test_pickup_ui()
    await test_save_ui()
    
    stop_tests()

## Quick smoke test (fast verification)
func run_smoke_test() -> void:
    start_tests()
    log_info("Running quick smoke test...")
    
    # Just verify critical elements exist
    verify_exists("Player", "smoke:player")
    verify_visible("GameHUD", "smoke:hud")
    verify_visible("HealthBar", "smoke:health")
    verify_player_alive("smoke:alive")
    verify_not_paused("smoke:running")
    
    stop_tests()
```
  </action>
  <verify>
Run game to title screen, press F2
Tests should run through title → gameplay → pause flows
Report should show pass/fail for each test
  </verify>
  <done>Comprehensive test scenarios cover all major UI flows</done>
</task>

<task type="auto">
  <name>Task 2: Add F2 auto-run and console commands</name>
  <files>
    autoloads/ui_tester.gd
  </files>
  <action>
Update the F2 toggle to auto-run tests and add more hotkeys:

```gdscript
# Update _unhandled_input to run tests on F2
func _unhandled_input(event: InputEvent) -> void:
    if event is InputEventKey and event.pressed and not event.echo:
        match event.keycode:
            KEY_F2:
                # Run all tests
                if not enabled:
                    run_all_tests()
                else:
                    stop_tests()
            KEY_F4:
                # Quick smoke test only
                if not enabled:
                    run_smoke_test()
            KEY_F5 when event.shift_pressed:
                # Shift+F5: Run v1.2 specific tests
                if not enabled:
                    run_v12_tests()

# Update _ready to show all hotkeys
func _ready() -> void:
    print("[UITester] Ready")
    print("  F2 = Run all UI tests")
    print("  F4 = Quick smoke test")
    print("  Shift+F5 = Run v1.2 feature tests")
```

Add method to run tests from code (for AutoBot integration):

```gdscript
## Can be called from AutoBot or other scripts
func run_tests_async() -> void:
    await run_all_tests()

## Check if tests are currently running
func is_running() -> bool:
    return enabled
```
  </action>
  <verify>
F2 runs all tests automatically
F4 runs quick smoke test
Shift+F5 runs v1.2 tests
Print shows available hotkeys on startup
  </verify>
  <done>Multiple test modes available via hotkeys</done>
</task>

<task type="auto">
  <name>Task 3: Create game over flow test</name>
  <files>
    autoloads/ui_tester.gd
  </files>
  <action>
Add game over flow verification:

```gdscript
## Test game over screen and retry flow
func test_game_over_flow() -> void:
    log_info("--- TEST: Game Over Flow ---")
    
    var player = get_player()
    if not player or not player.health:
        log_info("Skipping game over test - no player/health")
        return
    
    # Store initial state
    var initial_zone = GameManager.current_zone
    
    # Kill the player (set health to 0)
    log_info("Triggering player death...")
    player.health.current_health = 0
    player.health.died.emit()
    
    # Wait for game over screen
    await wait_seconds(1.5)
    
    # Verify game over state
    verify_visible("GameOver", "gameover:screen_visible")
    verify_exists("RetryButton", "gameover:retry_exists")
    verify_exists("QuitButton", "gameover:quit_exists")
    
    # Test retry button
    if click_button("RetryButton"):
        log_pass("gameover:click_retry")
    else:
        log_fail("gameover:click_retry", "Could not click RetryButton")
        return
    
    # Wait for scene reload
    await wait_seconds(1.5)
    
    # Verify game restarted
    verify_player_alive("gameover:player_alive_after_retry")
    verify_player_health_percent(1.0, 0.1, "gameover:health_full_after_retry")
    verify_zone(initial_zone, "gameover:same_zone_after_retry")

## Test zone transition UI
func test_zone_transition() -> void:
    log_info("--- TEST: Zone Transition ---")
    
    var player = get_player()
    if not player:
        log_info("Skipping zone transition test - no player")
        return
    
    var initial_zone = GameManager.current_zone
    log_info("Initial zone: %s" % initial_zone)
    
    # Find zone exit (if any)
    var exits = get_tree().get_nodes_in_group("zone_exits")
    if exits.is_empty():
        log_info("No zone exits found in current zone")
        return
    
    # Move player to exit (simplified - just teleport)
    var exit = exits[0]
    player.global_position = exit.global_position
    
    await wait_seconds(1.5)
    
    # Verify zone changed
    if GameManager.current_zone != initial_zone:
        log_pass("zone:transition_occurred", "Now in: %s" % GameManager.current_zone)
    else:
        log_fail("zone:transition_occurred", "Still in: %s" % initial_zone)
    
    # Verify HUD still works in new zone
    verify_visible("GameHUD", "zone:hud_persists")
    verify_visible("HealthBar", "zone:health_bar_persists")
```

Add to run_all_tests() if in gameplay:
```gdscript
# In run_all_tests(), add after pause menu test:
# Only run game over test if explicitly requested (it kills the player!)
# await test_game_over_flow()
```
  </action>
  <verify>
test_game_over_flow kills player, shows game over, retry works
test_zone_transition detects zone changes
HUD persists across zones
  </verify>
  <done>Game over and zone transition tests implemented</done>
</task>

</tasks>

<verification>
1. Start game at title screen
2. Press F2 - full test suite runs:
   - Title screen elements verified
   - Start button clicked, game starts
   - HUD elements verified
   - Pause menu opens (ESC), closes (Resume)
   - Report shows all pass/fail results
3. Press F4 during gameplay - quick smoke test runs
4. Press Shift+F5 - v1.2 feature tests run (may show "not implemented")
</verification>

<success_criteria>
- F2 runs comprehensive test suite automatically
- F4 runs quick smoke test (5-10 verifications)
- Shift+F5 runs v1.2-specific tests
- Title screen test verifies buttons exist and work
- Gameplay test verifies HUD elements
- Pause menu test verifies open/close/resume
- Game over test verifies retry flow (optional, destructive)
- Test report clearly shows pass/fail counts
- All tests complete in under 30 seconds
</success_criteria>

<output>
After completion, create `.planning/phases/15-ui-testing/15-02-SUMMARY.md`
</output>
