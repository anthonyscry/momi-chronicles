---
phase: 15-ui-testing
plan: 02
type: execute
wave: 2
depends_on: ["15-01"]
files_modified:
  - autoloads/ui_tester.gd
autonomous: true

must_haves:
  truths:
    - "HUD elements (health, guard, coins, EXP, combo) are verified as present and updating"
    - "Title screen flow test passes (buttons visible, Start works, scene changes)"
    - "Gameplay HUD test verifies all counters are present and functional"
  artifacts:
    - path: "autoloads/ui_tester.gd"
      provides: "HUD verification + scenarios 1-2"
      contains: "func test_scenario_title_screen"
  key_links:
    - from: "autoloads/ui_tester.gd"
      to: "ui/hud/game_hud.gd"
      via: "node path references"
      pattern: "find_child.*HealthBar"
    - from: "autoloads/ui_tester.gd"
      to: "ui/menus/title_screen.gd"
      via: "button interaction"
      pattern: "StartButton"
---

<objective>
Implement HUD element verification and the first two test scenarios: title screen flow and gameplay HUD verification.

Purpose: Core testing functionality that verifies the most frequently used UI elements work correctly.
Output: Working test scenarios for title screen and HUD, with detailed verification of each element.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/15-ui-testing/15-01-SUMMARY.md
@.planning/phases/15-ui-testing/15-CONTEXT.md

# Reference files for node paths and structure
@ui/hud/game_hud.gd
@ui/hud/game_hud.tscn
@ui/menus/title_screen.gd
@ui/menus/title_screen.tscn
@autoloads/events.gd
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement HUD element verification helpers</name>
  <files>autoloads/ui_tester.gd</files>
  <action>
Add comprehensive verification helper functions. Use `find_child()` pattern from auto_bot.gd for flexible node finding:

1. **Generic verification helpers:**
```gdscript
# Find node anywhere in tree (like auto_bot.gd does)
func find_ui_node(node_name: String) -> Node:
    return get_tree().root.find_child(node_name, true, false)

# Existence check with detailed logging
func verify_exists(node_name: String, description: String) -> bool:
    var node = find_ui_node(node_name)
    var exists = node != null
    var actual = "found" if exists else "not found"
    log_check("EXISTS: " + description, actual, "found", exists)
    if not exists:
        capture_screenshot("missing_" + node_name.to_snake_case())
    return exists

# Visibility check
func verify_visible(node_name: String, description: String) -> bool:
    var node = find_ui_node(node_name)
    if not node:
        log_check("VISIBLE: " + description, "node not found", "visible", false)
        capture_screenshot("not_found_" + node_name.to_snake_case())
        return false
    var visible = node.visible if node is CanvasItem else true
    log_check("VISIBLE: " + description, str(visible), "true", visible)
    if not visible:
        capture_screenshot("hidden_" + node_name.to_snake_case())
    return visible

# Value check with tolerance
func verify_value(actual, expected, description: String, tolerance: float = 0.0) -> bool:
    var passed: bool
    if typeof(actual) == TYPE_FLOAT and typeof(expected) == TYPE_FLOAT:
        passed = abs(actual - expected) <= tolerance
    else:
        passed = actual == expected
    log_check("VALUE: " + description, str(actual), str(expected), passed)
    if not passed:
        capture_screenshot("wrong_value_" + description.to_snake_case())
    return passed

# Property check on a node
func verify_property(node_name: String, property: String, expected, description: String) -> bool:
    var node = find_ui_node(node_name)
    if not node:
        log_check("PROPERTY: " + description, "node not found", str(expected), false)
        return false
    var actual = node.get(property)
    var passed = actual == expected
    log_check("PROPERTY: " + description, str(actual), str(expected), passed)
    if not passed:
        capture_screenshot("wrong_prop_" + node_name.to_snake_case())
    return passed
```

2. **HUD-specific verification:**
```gdscript
func verify_hud_elements() -> Dictionary:
    log_test("--- Verifying HUD Elements ---")
    var results = {}
    
    # Health bar (from game_hud.tscn)
    results["health_bar"] = verify_exists("HealthBar", "Health Bar")
    if results["health_bar"]:
        results["health_bar"] = verify_visible("HealthBar", "Health Bar visible") and results["health_bar"]
    
    # Guard bar (from Phase 12)
    results["guard_bar"] = verify_exists("GuardBar", "Guard Bar")
    if results["guard_bar"]:
        results["guard_bar"] = verify_visible("GuardBar", "Guard Bar visible") and results["guard_bar"]
    
    # Coin counter (from Phase 13)
    results["coin_counter"] = verify_exists("CoinCounter", "Coin Counter")
    if results["coin_counter"]:
        results["coin_counter"] = verify_visible("CoinCounter", "Coin Counter visible") and results["coin_counter"]
    
    # EXP bar (from Phase 9)
    results["exp_bar"] = verify_exists("EXPBar", "EXP Bar")
    if results["exp_bar"]:
        results["exp_bar"] = verify_visible("EXPBar", "EXP Bar visible") and results["exp_bar"]
    
    # Combo counter (may only show during combos)
    results["combo_counter"] = verify_exists("ComboCounter", "Combo Counter")
    # Don't fail if hidden - it appears during combos only
    
    return results
```

3. **Player state helpers (for value verification):**
```gdscript
func get_player() -> Node:
    return get_tree().get_first_node_in_group("player")

func get_player_health() -> float:
    var player = get_player()
    if player and player.has_node("HealthComponent"):
        var health = player.get_node("HealthComponent")
        return health.current_health if health.has("current_health") else -1
    return -1

func get_player_level() -> int:
    var player = get_player()
    if player and player.progression:
        return player.progression.current_level
    return -1
```

Implementation notes:
- Use `find_child(name, true, false)` for recursive search (matches auto_bot.gd pattern)
- Read actual node names from game_hud.tscn to get correct names
- All checks log actual vs expected for debugging
  </action>
  <verify>
1. Run game, get to gameplay
2. Press F2 to start tests
3. Console should show "--- Verifying HUD Elements ---"
4. Each element check should show EXISTS/VISIBLE with actual values
  </verify>
  <done>HUD verification helpers exist, log detailed actual vs expected for every check</done>
</task>

<task type="auto">
  <name>Task 2: Implement title screen and gameplay HUD test scenarios</name>
  <files>autoloads/ui_tester.gd</files>
  <action>
Add test scenarios 1 and 2:

**Scenario 1: Title Screen Flow**
```gdscript
func test_scenario_title_screen() -> bool:
    log_scenario_start("Title Screen Flow")
    var all_passed = true
    
    # Navigate to title if not there
    var title = find_ui_node("TitleScreen")
    if not title:
        log_test("Navigating to title screen...")
        get_tree().change_scene_to_file("res://ui/menus/title_screen.tscn")
        await get_tree().create_timer(1.0).timeout
    
    # Check 1: Title screen loaded
    all_passed = verify_exists("TitleScreen", "Title Screen root") and all_passed
    
    # Check 2: Start/Continue button exists
    var start_btn = find_ui_node("StartButton")
    var continue_btn = find_ui_node("ContinueButton")
    all_passed = (start_btn != null or continue_btn != null)
    if not all_passed:
        log_check("EXISTS: Start or Continue button", "neither found", "at least one", false)
        capture_screenshot("missing_start_button")
    else:
        log_check("EXISTS: Start or Continue button", "found", "found", true)
    
    # Check 3: Start button visible (or Continue if save exists)
    if start_btn:
        all_passed = verify_visible("StartButton", "Start Button visible") and all_passed
    
    # Check 4: Quit button exists
    all_passed = verify_exists("QuitButton", "Quit Button") and all_passed
    
    # Check 5: Simulate Start button press
    log_test("Testing Start button interaction...")
    var btn = start_btn if start_btn else continue_btn
    if btn and btn is Button:
        btn.emit_signal("pressed")
        await get_tree().create_timer(2.0).timeout  # Wait for scene change
        
        # Check 6: Scene changed to gameplay (player should exist)
        var player = get_player()
        var scene_changed = player != null
        log_check("SCENE: Gameplay loaded after Start", str(scene_changed), "true", scene_changed)
        all_passed = scene_changed and all_passed
        if not scene_changed:
            capture_screenshot("scene_change_failed")
    else:
        log_failure("Start Button", "Could not interact with button")
        all_passed = false
    
    return all_passed
```

**Scenario 2: Gameplay HUD**
```gdscript
func test_scenario_gameplay_hud() -> bool:
    log_scenario_start("Gameplay HUD")
    var all_passed = true
    
    # Ensure we're in gameplay
    var player = get_player()
    if not player:
        log_test("Not in gameplay - running title screen test first")
        await test_scenario_title_screen()
        await get_tree().create_timer(1.0).timeout
        player = get_player()
    
    if not player:
        log_failure("Gameplay HUD", "Cannot test - no player found")
        return false
    
    # Run HUD element verification
    var hud_results = verify_hud_elements()
    
    for element in hud_results:
        if not hud_results[element]:
            all_passed = false
    
    # Value verification - check HUD matches player state
    log_test("--- HUD Value Verification ---")
    
    # Health bar value check
    var player_hp = get_player_health()
    if player_hp >= 0:
        var health_bar = find_ui_node("HealthBar")
        if health_bar and health_bar.has("value"):
            all_passed = verify_value(health_bar.value, player_hp, "Health bar matches player HP", 1.0) and all_passed
    
    # Coin counter check
    var coins = GameManager.coins if GameManager else 0
    var coin_counter = find_ui_node("CoinCounter")
    if coin_counter:
        # Check if label text contains coin count
        var label = coin_counter.find_child("Label", true, false)
        if label and label is Label:
            var has_coins = str(coins) in label.text
            log_check("VALUE: Coin counter shows correct count", label.text, "contains " + str(coins), has_coins)
    
    # Level/EXP check  
    var player_level = get_player_level()
    if player_level > 0:
        log_test("Player level: " + str(player_level))
    
    log_test("Gameplay HUD verification complete")
    return all_passed
```

**Update run_all_tests():**
```gdscript
func run_all_tests() -> void:
    log_test("========================================")
    log_test("   UI TESTER - FULL TEST SUITE")
    log_test("========================================")
    
    passed_count = 0
    failed_count = 0
    fixed_on_retry_count = 0
    test_results.clear()
    
    # Scenario 1: Title Screen
    var s1_passed = await test_scenario_title_screen()
    test_results.append({"scenario": "Title Screen Flow", "passed": s1_passed})
    log_test("SCENARIO RESULT: Title Screen Flow - " + ("PASS" if s1_passed else "FAIL"))
    
    # Scenario 2: Gameplay HUD
    var s2_passed = await test_scenario_gameplay_hud()
    test_results.append({"scenario": "Gameplay HUD", "passed": s2_passed})
    log_test("SCENARIO RESULT: Gameplay HUD - " + ("PASS" if s2_passed else "FAIL"))
    
    # Scenarios 3-5 added in Plan 03
    
    print_test_summary()
```
  </action>
  <verify>
1. Start game at title screen
2. Press F2 to run tests
3. Console shows "=== STARTING SCENARIO: Title Screen Flow ==="
4. Start button interaction triggers scene change
5. Console shows "=== STARTING SCENARIO: Gameplay HUD ==="
6. All HUD elements are checked with actual vs expected
7. Summary prints at end
  </verify>
  <done>Title screen and gameplay HUD scenarios run, logging detailed verification for each check</done>
</task>

</tasks>

<verification>
- [ ] find_ui_node() finds nodes anywhere in scene tree
- [ ] verify_exists/visible/value helpers log actual vs expected
- [ ] Title screen scenario tests buttons and Start interaction
- [ ] Gameplay HUD scenario tests all 5 HUD elements
- [ ] Value checks compare HUD to player state
- [ ] Screenshots captured on failures
</verification>

<success_criteria>
- Scenarios 1-2 run regardless of failures
- All HUD elements (health, guard, coins, EXP, combo) tested
- Button simulation works
- Detailed logging shows game context for each check
</success_criteria>

<output>
After completion, create `.planning/phases/15-ui-testing/15-02-SUMMARY.md`
</output>
