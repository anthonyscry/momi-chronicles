---
phase: 15-ui-testing
plan: 03
type: execute
wave: 3
depends_on: ["15-02"]
files_modified:
  - autoloads/ui_tester.gd
autonomous: true

must_haves:
  truths:
    - "Pause menu flow test passes (ESC opens, sliders work, resume works)"
    - "Game over flow test passes (death triggers screen, retry works)"
    - "New features smoke test verifies block/parry and pickup UI feedback"
    - "Comprehensive test report shows X passed, Y failed, Z fixed-on-retry"
    - "All tests run automatically with no manual intervention"
  artifacts:
    - path: "autoloads/ui_tester.gd"
      provides: "Complete UITester with all 5 scenarios"
      contains: "func test_scenario_game_over"
  key_links:
    - from: "autoloads/ui_tester.gd"
      to: "ui/menus/pause_menu.gd"
      via: "ESC input simulation"
      pattern: "KEY_ESCAPE"
    - from: "autoloads/ui_tester.gd"
      to: "ui/menus/game_over.gd"
      via: "death detection and retry"
      pattern: "GameOver"
---

<objective>
Complete the UITester with pause menu, game over, and new features smoke test scenarios, plus comprehensive final reporting.

Purpose: Full test coverage of all UI flows and validation that Phases 12-14 features have proper UI feedback.
Output: Complete UITester with all 5 scenarios and detailed pass/fail reporting.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/15-ui-testing/15-01-SUMMARY.md
@.planning/phases/15-ui-testing/15-02-SUMMARY.md
@.planning/phases/15-ui-testing/15-CONTEXT.md

# Reference files
@ui/menus/pause_menu.gd
@ui/menus/pause_menu.tscn
@ui/menus/game_over.gd
@ui/menus/game_over.tscn
@autoloads/events.gd
@autoloads/game_manager.gd
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement pause menu and game over test scenarios</name>
  <files>autoloads/ui_tester.gd</files>
  <action>
Add scenarios 3 and 4:

**Scenario 3: Pause Menu Flow**
```gdscript
func test_scenario_pause_menu() -> bool:
    log_scenario_start("Pause Menu Flow")
    var all_passed = true
    
    # Must be in gameplay
    var player = get_player()
    if not player:
        log_failure("Pause Menu", "Cannot test - not in gameplay")
        return false
    
    # Check 1: Pause menu initially hidden
    var pause_menu = find_ui_node("PauseMenu")
    if pause_menu:
        all_passed = verify_property("PauseMenu", "visible", false, "Pause menu initially hidden") and all_passed
    
    # Check 2: Simulate ESC to open pause
    log_test("Simulating ESC key press...")
    var esc_event = InputEventKey.new()
    esc_event.keycode = KEY_ESCAPE
    esc_event.pressed = true
    Input.parse_input_event(esc_event)
    await get_tree().create_timer(0.5).timeout
    
    # Release ESC
    esc_event.pressed = false
    Input.parse_input_event(esc_event)
    
    # Check 3: Pause menu now visible
    all_passed = verify_visible("PauseMenu", "Pause menu visible after ESC") and all_passed
    
    # Check 4: Game is paused
    var is_paused = get_tree().paused
    log_check("STATE: Game paused", str(is_paused), "true", is_paused)
    all_passed = is_paused and all_passed
    
    # Check 5: Required buttons exist
    all_passed = verify_exists("ResumeButton", "Resume Button") and all_passed
    all_passed = verify_exists("SaveButton", "Save Button") and all_passed
    all_passed = verify_exists("QuitButton", "Quit Button") and all_passed
    
    # Check 6: Audio sliders exist
    var music_slider = find_ui_node("MusicSlider")
    var sfx_slider = find_ui_node("SFXSlider")
    if music_slider:
        log_check("EXISTS: Music Slider", "found", "found", true)
        # Test slider responds
        if music_slider is Slider:
            var original = music_slider.value
            music_slider.value = clamp(original + 0.1, 0, 1)
            await get_tree().create_timer(0.1).timeout
            log_test("Music slider interaction: OK")
            music_slider.value = original
    if sfx_slider:
        log_check("EXISTS: SFX Slider", "found", "found", true)
    
    # Check 7: Test Resume button
    log_test("Testing Resume button...")
    var resume_btn = find_ui_node("ResumeButton")
    if resume_btn and resume_btn is Button:
        resume_btn.emit_signal("pressed")
        await get_tree().create_timer(0.5).timeout
        
        # Game should be unpaused
        var is_unpaused = not get_tree().paused
        log_check("STATE: Game unpaused after Resume", str(is_unpaused), "true", is_unpaused)
        all_passed = is_unpaused and all_passed
        
        # Pause menu should be hidden
        all_passed = verify_property("PauseMenu", "visible", false, "Pause menu hidden after Resume") and all_passed
    else:
        log_failure("Resume Button", "Could not interact")
        all_passed = false
    
    return all_passed
```

**Scenario 4: Game Over Flow**
```gdscript
func test_scenario_game_over() -> bool:
    log_scenario_start("Game Over Flow")
    var all_passed = true
    
    var player = get_player()
    if not player:
        log_failure("Game Over", "Cannot test - player not found")
        return false
    
    # Store current state to detect changes
    log_test("Triggering player death for game over test...")
    
    # Kill the player - try multiple methods
    var death_triggered = false
    
    # Method 1: Direct health component damage
    if player.has_node("HealthComponent"):
        var health = player.get_node("HealthComponent")
        if health.has_method("take_damage"):
            health.take_damage(9999)
            death_triggered = true
        elif health.has_method("die"):
            health.die()
            death_triggered = true
    
    # Method 2: Player die method
    if not death_triggered and player.has_method("_on_died"):
        player._on_died()
        death_triggered = true
    
    # Method 3: Emit death signal
    if not death_triggered:
        Events.player_died.emit()
        death_triggered = true
    
    await get_tree().create_timer(1.5).timeout  # Wait for death/transition
    
    # Check 1: Game over screen exists
    var game_over = find_ui_node("GameOver")
    if not game_over:
        game_over = find_ui_node("GameOverScreen")
    
    if game_over:
        all_passed = verify_visible("GameOver", "Game Over screen visible") and all_passed
        
        # Check 2: Retry button exists
        all_passed = verify_exists("RetryButton", "Retry Button") and all_passed
        
        # Check 3: Test Retry
        log_test("Testing Retry button...")
        var retry_btn = find_ui_node("RetryButton")
        if retry_btn and retry_btn is Button:
            retry_btn.emit_signal("pressed")
            await get_tree().create_timer(2.0).timeout
            
            # Should be back in gameplay with player alive
            player = get_player()
            var back_in_game = player != null
            log_check("STATE: Returned to gameplay after Retry", str(back_in_game), "true", back_in_game)
            all_passed = back_in_game and all_passed
        else:
            log_failure("Retry Button", "Could not interact")
            all_passed = false
    else:
        log_failure("Game Over", "Game over screen not found after death")
        capture_screenshot("missing_game_over")
        all_passed = false
    
    return all_passed
```

Add to run_all_tests() after scenario 2.
  </action>
  <verify>
1. Run game, get to gameplay
2. Press F2 to run all tests
3. Pause menu test: ESC opens pause, Resume closes it
4. Game over test: player dies, game over appears, retry works
5. Check console for detailed pass/fail on each check
  </verify>
  <done>Pause menu and game over scenarios complete with detailed logging</done>
</task>

<task type="auto">
  <name>Task 2: Implement new features smoke test and comprehensive reporting</name>
  <files>autoloads/ui_tester.gd</files>
  <action>
Add scenario 5 and enhanced final report:

**Scenario 5: New Features Smoke Test**
```gdscript
func test_scenario_new_features() -> bool:
    log_scenario_start("New Features Smoke Test")
    var all_passed = true
    
    # Ensure gameplay
    var player = get_player()
    if not player:
        await test_scenario_title_screen()
        await get_tree().create_timer(1.0).timeout
        player = get_player()
    
    if not player:
        log_failure("New Features", "Cannot test - no player")
        return false
    
    log_test("--- Phase 12: Block/Parry UI ---")
    
    # Guard bar exists and is functional
    all_passed = verify_exists("GuardBar", "Guard Bar (block system)") and all_passed
    
    # Check guard component exists on player
    if player.has_node("GuardComponent"):
        var guard = player.get_node("GuardComponent")
        log_check("EXISTS: Player GuardComponent", "found", "found", true)
        
        # Verify guard bar updates with guard value
        var guard_bar = find_ui_node("GuardBar")
        if guard_bar and guard_bar.has("value") and guard.has("current_guard"):
            log_test("Guard bar value: " + str(guard_bar.value))
            log_test("Guard component value: " + str(guard.current_guard))
    else:
        log_test("INFO: GuardComponent not found on player")
    
    log_test("--- Phase 13: Pickup/Coin UI ---")
    
    # Coin counter exists
    all_passed = verify_exists("CoinCounter", "Coin Counter (pickup system)") and all_passed
    
    # Verify coin count matches GameManager
    var coins = GameManager.coins if GameManager else 0
    log_test("GameManager coins: " + str(coins))
    
    var coin_counter = find_ui_node("CoinCounter")
    if coin_counter:
        var label = coin_counter.find_child("Label", true, false)
        if label and label is Label:
            log_test("Coin counter text: " + label.text)
    
    log_test("--- Phase 14: Save System UI ---")
    
    # Save button in pause menu
    # (We tested this exists in pause menu scenario, just log presence here)
    var save_btn = find_ui_node("SaveButton")
    log_check("EXISTS: Save Button (from Phase 14)", "found" if save_btn else "not found", "found", save_btn != null)
    
    # Continue button on title (indicates save exists)
    var continue_btn = find_ui_node("ContinueButton") 
    if continue_btn:
        log_test("Continue button present (save file exists)")
    
    # Test save functionality
    if SaveManager and SaveManager.has_method("save_game"):
        log_test("Testing save functionality...")
        var save_result = SaveManager.save_game()
        log_check("FUNC: SaveManager.save_game()", str(save_result), "true", save_result)
    
    return all_passed
```

**Enhanced Test Reporting:**
```gdscript
func print_test_summary() -> void:
    log_test("")
    log_test("================================================================")
    log_test("                  UI TESTER - FINAL REPORT")
    log_test("================================================================")
    log_test("Timestamp: " + Time.get_datetime_string_from_system())
    log_test("")
    
    # Scenario results
    log_test("SCENARIO RESULTS:")
    log_test("----------------------------------------------------------------")
    for result in test_results:
        var icon = "[PASS]" if result.passed else "[FAIL]"
        log_test("  %s %s" % [icon, result.scenario])
    log_test("")
    
    # Summary counts
    log_test("SUMMARY:")
    log_test("----------------------------------------------------------------")
    var total = passed_count + failed_count
    log_test("  Total checks: %d" % total)
    log_test("  Passed:       %d" % passed_count)
    log_test("  Failed:       %d" % failed_count)
    log_test("  Fixed/Retry:  %d" % fixed_on_retry_count)
    log_test("")
    
    # Pass rate
    var pass_rate = (float(passed_count) / float(total) * 100) if total > 0 else 0
    log_test("  Pass rate: %.1f%%" % pass_rate)
    log_test("")
    
    # Screenshots location
    if failed_count > 0:
        log_test("SCREENSHOTS:")
        log_test("----------------------------------------------------------------")
        log_test("  Location: exports/test_screenshots/")
        log_test("  Check screenshots for failure details")
        log_test("")
    
    log_test("================================================================")
    
    # Final verdict with emoji
    if failed_count == 0:
        log_test("  ALL TESTS PASSED!")
    else:
        log_test("  %d TEST(S) FAILED - Review logs and screenshots" % failed_count)
    
    log_test("================================================================")
    log_test("")
    log_test("UITester complete. Press F2 to run again.")
```

**Complete run_all_tests():**
```gdscript
func run_all_tests() -> void:
    log_test("")
    log_test("================================================================")
    log_test("           UI TESTER - STARTING FULL TEST SUITE")
    log_test("================================================================")
    log_test("")
    
    # Reset counters
    passed_count = 0
    failed_count = 0
    fixed_on_retry_count = 0
    test_results.clear()
    
    # Run all 5 scenarios (continue on failure)
    
    log_test("[1/5] Title Screen Flow")
    var s1 = await test_scenario_title_screen()
    test_results.append({"scenario": "1. Title Screen Flow", "passed": s1})
    
    log_test("")
    log_test("[2/5] Gameplay HUD")
    var s2 = await test_scenario_gameplay_hud()
    test_results.append({"scenario": "2. Gameplay HUD", "passed": s2})
    
    log_test("")
    log_test("[3/5] Pause Menu Flow")
    var s3 = await test_scenario_pause_menu()
    test_results.append({"scenario": "3. Pause Menu Flow", "passed": s3})
    
    log_test("")
    log_test("[4/5] Game Over Flow")
    var s4 = await test_scenario_game_over()
    test_results.append({"scenario": "4. Game Over Flow", "passed": s4})
    
    log_test("")
    log_test("[5/5] New Features Smoke Test")
    var s5 = await test_scenario_new_features()
    test_results.append({"scenario": "5. New Features Smoke", "passed": s5})
    
    # Print comprehensive report
    print_test_summary()
```
  </action>
  <verify>
1. Press F2 to run full test suite
2. All 5 scenarios run in sequence
3. Final report shows:
   - Each scenario with PASS/FAIL
   - Total/Passed/Failed/Fixed counts
   - Pass rate percentage
   - Screenshots location if failures
4. Verify screenshots in exports/test_screenshots/ for any failures
  </verify>
  <done>All 5 scenarios complete, comprehensive report shows pass/fail with detailed breakdown</done>
</task>

</tasks>

<verification>
- [ ] Scenario 3 tests ESC toggle, sliders, Resume
- [ ] Scenario 4 triggers death and tests Retry
- [ ] Scenario 5 verifies Phase 12-14 UI elements
- [ ] Final report shows pass/fail with counts and rate
- [ ] Screenshots saved for failures
- [ ] All tests run automatically with no manual steps
</verification>

<success_criteria>
- All 5 scenarios run to completion automatically
- Report shows X passed, Y failed, Z fixed-on-retry
- Each check logs actual vs expected
- Failure screenshots in exports/test_screenshots/
- Fully autonomous - no human intervention required
</success_criteria>

<output>
After completion, create `.planning/phases/15-ui-testing/15-03-SUMMARY.md`
</output>
