---
phase: 40-dialogue-expansion
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - characters/npcs/kids_gang.gd
  - characters/npcs/kids_gang.tscn
  - characters/npcs/henderson.gd
  - characters/npcs/henderson.tscn
  - resources/dialogues/kids_dialogue.json
  - resources/dialogues/henderson_dialogue.json
  - autoloads/game_manager.gd
  - autoloads/events.gd
  - world/zones/neighborhood.gd
autonomous: true

must_haves:
  truths:
    - "Player can talk to Kids Gang in the park area"
    - "Player can talk to Mr. Henderson near his house"
    - "NPC friendliness changes based on player actions (defeating enemies, helping)"
    - "Reputation is saved and persisted across zone transitions"
    - "Different dialogue options appear based on reputation level"
  artifacts:
    - path: "characters/npcs/kids_gang.gd"
      provides: "Kids Gang NPC (group of neighborhood children)"
      min_lines: 30
    - path: "characters/npcs/henderson.gd"
      provides: "Grumpy Mr. Henderson NPC (initially hostile, warms up)"
      min_lines: 30
    - path: "autoloads/game_manager.gd"
      provides: "npc_reputation dictionary for tracking NPC friendliness"
      contains: "npc_reputation"
    - path: "autoloads/events.gd"
      provides: "reputation_changed signal"
      contains: "reputation_changed"
  key_links:
    - from: "autoloads/game_manager.gd"
      to: "autoloads/save_manager.gd"
      via: "npc_reputation included in save_game() and load_game()"
      pattern: "npc_reputation"
    - from: "characters/npcs/henderson.gd"
      to: "autoloads/game_manager.gd"
      via: "checks reputation to pick dialogue branch"
      pattern: "GameManager\\.npc_reputation"
---

<objective>
Create the remaining two NPCs (Kids Gang, Grumpy Mr. Henderson) and add a reputation system that affects NPC dialogue based on player actions.

Purpose: Henderson's warming-up arc and the Kids Gang's playfulness give the neighborhood life. The reputation system creates a sense of relationship progression — NPCs react differently as the player helps the neighborhood. This lays essential groundwork for the quest system (Phases 41-42) where reputation determines quest availability.

Output: 2 more NPCs with dialogue, reputation system in GameManager, reputation-aware dialogue branching.
</objective>

<context>
@docs/PROJECT.md
@characters/npcs/dialogue_npc.gd (created by 40-01)
@characters/npcs/shop_npc.gd
@autoloads/game_manager.gd
@autoloads/events.gd
@autoloads/dialogue_manager.gd
@systems/dialogue/dialogue_resource.gd
@world/zones/neighborhood.gd
</context>

<tasks>

<task type="auto">
  <name>Task 1: Reputation System in GameManager</name>
  <files>
    autoloads/game_manager.gd
    autoloads/events.gd
  </files>
  <action>
  Add a reputation/friendliness tracking system to GameManager.

  **1. Add signal to `autoloads/events.gd`** — after the quest events section:
  ```
  # =============================================================================
  # REPUTATION EVENTS
  # =============================================================================

  signal reputation_changed(npc_id, old_value, new_value)
  ```

  **2. Add to `autoloads/game_manager.gd`** — after mini_bosses_defeated dictionary (line ~41):
  ```
  ## NPC reputation/friendliness tracking (0-100 scale)
  ## 0 = hostile, 25 = cold, 50 = neutral, 75 = friendly, 100 = best friend
  var npc_reputation: Dictionary = {
      "gertrude": 50,    # Neutral — friendly old lady, starts warm
      "maurice": 50,     # Neutral — chatty mailman
      "kids_gang": 50,   # Neutral — playful kids
      "henderson": 10,   # Very low — grumpy, hostile to strangers
  }
  ```

  **3. Add public API functions** after the zone management section:
  ```
  # =============================================================================
  # NPC REPUTATION
  # =============================================================================

  func get_reputation(npc_id: String) -> int:
      return npc_reputation.get(npc_id, 50)

  func change_reputation(npc_id: String, amount: int) -> void:
      if not npc_reputation.has(npc_id):
          npc_reputation[npc_id] = 50
      var old_value: int = npc_reputation[npc_id]
      npc_reputation[npc_id] = clampi(old_value + amount, 0, 100)
      var new_value: int = npc_reputation[npc_id]
      if old_value != new_value:
          Events.reputation_changed.emit(npc_id, old_value, new_value)
          DebugLogger.log_system("Reputation %s: %d → %d" % [npc_id, old_value, new_value])

  func set_reputation(npc_id: String, value: int) -> void:
      var old_value: int = npc_reputation.get(npc_id, 50)
      npc_reputation[npc_id] = clampi(value, 0, 100)
      if old_value != npc_reputation[npc_id]:
          Events.reputation_changed.emit(npc_id, old_value, npc_reputation[npc_id])
  ```

  **4. Include reputation in save/load** — modify `save_game()` to include:
  ```
  "npc_reputation": npc_reputation.duplicate(),
  ```

  Modify `load_game()` to restore:
  ```
  if save_data.has("npc_reputation"):
      for npc_id in save_data["npc_reputation"]:
          npc_reputation[npc_id] = save_data["npc_reputation"][npc_id]
  ```

  **5. Reset reputation in `reset_game()`:**
  ```
  npc_reputation = {
      "gertrude": 50,
      "maurice": 50,
      "kids_gang": 50,
      "henderson": 10,
  }
  ```

  **6. Auto-boost reputation on mini-boss defeat** — connect to existing signal.
  In `_on_mini_boss_defeated()` (or add a new handler), after setting the dictionary:
  ```
  # Defeating mini-bosses improves all NPC reputation
  for npc_id in npc_reputation:
      change_reputation(npc_id, 10)
  ```

  Important:
  - Use tabs for indentation
  - Use DebugLogger for logging
  - npc_reputation is a Dictionary[String, int], 0-100 scale
  - clampi() clamps to integer range
  </action>
  <verify>
  - `rg -n "npc_reputation" autoloads/game_manager.gd` shows declaration, save, load, reset
  - `rg -n "reputation_changed" autoloads/events.gd` shows signal
  - `rg -n "get_reputation\|change_reputation\|set_reputation" autoloads/game_manager.gd` shows API
  </verify>
  <done>
  GameManager tracks NPC reputation (0-100 scale) with public API. Reputation persists across saves. Mini-boss defeats boost all NPC reputation by 10. reputation_changed signal emitted for UI/NPC reactions.
  </done>
</task>

<task type="auto">
  <name>Task 2: Kids Gang & Henderson NPCs + Reputation-Aware Dialogue</name>
  <files>
    characters/npcs/kids_gang.gd
    characters/npcs/kids_gang.tscn
    characters/npcs/henderson.gd
    characters/npcs/henderson.tscn
    resources/dialogues/kids_dialogue.json
    resources/dialogues/henderson_dialogue.json
    world/zones/neighborhood.gd
  </files>
  <action>
  Create the remaining two NPCs with reputation-aware dialogue.

  **1. Create `characters/npcs/kids_gang.gd`** — extends dialogue_npc.gd:
  ```
  extends "res://characters/npcs/dialogue_npc.gd"
  ## Kids Gang — group of neighborhood children who hang out in the park.
  ## Playful and curious, they look up to Momi as a hero.
  ```

  Override _ready(): npc_name = "Kids", dialogue_id = "kids_start", prompt_action = "Talk". Create a green-tinted sprite (12x16).

  **2. Create `characters/npcs/kids_gang.tscn`** — root Area2D with kids_gang.gd script.

  **3. Create `characters/npcs/henderson.gd`** — extends dialogue_npc.gd:
  ```
  extends "res://characters/npcs/dialogue_npc.gd"
  ## Grumpy Mr. Henderson — initially hostile neighbor who warms up over time.
  ## Reputation-gated dialogue: different conversation at rep < 25, 25-50, > 50.
  ```

  Override _ready(): npc_name = "Henderson", prompt_action = "Talk". Create a brown-tinted sprite.

  **KEY: Override `_unhandled_input()` to pick dialogue_id based on reputation:**
  ```
  func _unhandled_input(event: InputEvent) -> void:
      if player_in_range and event.is_action_pressed("interact"):
          var rep = GameManager.get_reputation("henderson")
          if rep < 25:
              dialogue_id = "henderson_hostile"
          elif rep < 50:
              dialogue_id = "henderson_cold"
          else:
              dialogue_id = "henderson_friendly"
          DialogueManager.start_dialogue(dialogue_id)
          get_viewport().set_input_as_handled()
  ```

  This overrides the base class input handler to dynamically pick the dialogue branch based on current reputation.

  **4. Create `characters/npcs/henderson.tscn`** — root Area2D with henderson.gd script.

  **5. Create `resources/dialogues/kids_dialogue.json`:**

  Kids are playful and excited about Momi's adventures:
  - `kids_start`: "Wow, it's Momi! Are you going to fight more bad guys today?" → choices: "You bet!" / "Shouldn't you be inside?"
  - `kids_excited`: "So cool! We saw you fight that big raccoon! Can you teach us some moves?" → next: kids_end
  - `kids_worried`: "Aww... but we want to watch you! We'll stay safe, promise!" → next: kids_end
  - `kids_end`: "Go get 'em, Momi! We'll cheer for you!" → end

  **6. Create `resources/dialogues/henderson_dialogue.json`:**

  Henderson has THREE separate dialogue branches based on reputation:

  Low reputation (< 25):
  - `henderson_hostile`: "What do you want? Get off my lawn! This neighborhood's gone to the dogs... literally." → choices: "Sorry to bother you" / "I'm trying to help"
  - `henderson_hostile_sorry`: "Hmph. At least you have some manners. Now scram." → end
  - `henderson_hostile_help`: "Help? Ha! That's what everyone says. Then the raccoons come back worse than before." → end

  Medium reputation (25-50):
  - `henderson_cold`: "Oh, it's you again. I suppose you haven't made things worse... yet." → choices: "I defeated a mini-boss" / "How's your garden?"
  - `henderson_cold_boss`: "Hmm... I did notice fewer raccoons lately. Don't let it go to your head." → end
  - `henderson_cold_garden`: "My garden? Those blasted raccoons dug it all up. If someone dealt with them for good, I might be... grateful." → end

  Friendly (>= 50):
  - `henderson_friendly`: "Ah, there you are! I'll admit, you've done good work clearing out those pests." → choices: "Thank you, Mr. Henderson" / "Any tips for me?"
  - `henderson_friendly_thanks`: "Don't get mushy on me. But... you're alright, kid. Here, take this — it's from my garden." → end
  - `henderson_friendly_tips`: "Watch out for the sewers. The Rat King down there is nastier than he looks. And bring health potions!" → end

  **7. Modify `world/zones/neighborhood.gd`** — extend `_build_story_npcs()`:

  Add preloads at top:
  ```
  const KIDS_GANG_SCENE = preload("res://characters/npcs/kids_gang.tscn")
  const HENDERSON_SCENE = preload("res://characters/npcs/henderson.tscn")
  ```

  In `_build_story_npcs()`, add after Maurice:
  ```
  # Load additional dialogue files
  DialogueManager.load_dialogue_file("res://resources/dialogues/kids_dialogue.json")
  DialogueManager.load_dialogue_file("res://resources/dialogues/henderson_dialogue.json")

  # Kids Gang — in the park area, south-west
  var kids = KIDS_GANG_SCENE.instantiate()
  kids.name = "KidsGang"
  kids.position = Vector2(180, 480)  # Park area near default spawn
  add_child(kids)

  # Mr. Henderson — near his house, north area
  var henderson = HENDERSON_SCENE.instantiate()
  henderson.name = "Henderson"
  henderson.position = Vector2(280, 180)  # North, near houses
  add_child(henderson)
  ```

  Important:
  - Use tabs for indentation
  - Path-based extends: `extends "res://characters/npcs/dialogue_npc.gd"`
  - No class_name declarations
  - Henderson's dialogue_id is set dynamically in _unhandled_input based on GameManager.get_reputation()
  - Kids use standard static dialogue_id
  - Dialogue JSON follows exact example_dialogue.json format
  </action>
  <verify>
  - `rg -n "extends.*dialogue_npc" characters/npcs/kids_gang.gd characters/npcs/henderson.gd` shows path-based extends
  - `rg -n "get_reputation" characters/npcs/henderson.gd` shows reputation check
  - `python3 -c "import json; json.load(open('resources/dialogues/kids_dialogue.json'))"` succeeds
  - `python3 -c "import json; json.load(open('resources/dialogues/henderson_dialogue.json'))"` succeeds
  - `rg -n "KIDS_GANG_SCENE\|HENDERSON_SCENE" world/zones/neighborhood.gd` shows preloads
  - `rg -n "henderson_hostile\|henderson_cold\|henderson_friendly" resources/dialogues/henderson_dialogue.json` shows 3 reputation branches
  </verify>
  <done>
  Kids Gang and Henderson NPCs created with dialogue trees. Henderson has reputation-gated dialogue (hostile → cold → friendly). All 4 NPCs placed in logical neighborhood positions. Reputation system integrated: defeating mini-bosses boosts Henderson toward friendliness, unlocking warmer dialogue.
  </done>
</task>

</tasks>

<verification>
- All 4 NPCs exist with scripts, scenes, and dialogue JSON files
- Henderson's dialogue changes based on GameManager.get_reputation("henderson")
- Reputation saved/loaded via GameManager.save_game()/load_game()
- Mini-boss defeats boost all NPC reputation by 10
- No class_name in any new file
- All JSON files parse without errors
</verification>

<success_criteria>
Four story NPCs populate the Neighborhood zone. Each has branching dialogue. Henderson's dialogue changes based on reputation (starts hostile at 10, warms up as player defeats enemies). Reputation persists across saves. The reputation system provides a foundation for quest availability in future phases.
</success_criteria>

<output>
After completion, create `.planning/phases/40-dialogue-expansion/40-02-SUMMARY.md`
</output>
