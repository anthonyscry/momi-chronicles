---
phase: 40-dialogue-expansion
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - characters/npcs/dialogue_npc.gd
  - characters/npcs/dialogue_npc.tscn
  - characters/npcs/gertrude.gd
  - characters/npcs/gertrude.tscn
  - characters/npcs/maurice.gd
  - characters/npcs/maurice.tscn
  - resources/dialogues/gertrude_dialogue.json
  - resources/dialogues/maurice_dialogue.json
  - world/zones/neighborhood.gd
  - world/zones/neighborhood.tscn
autonomous: true

must_haves:
  truths:
    - "Player can walk up to Gertrude in the neighborhood and talk to her"
    - "Player can walk up to Maurice in the neighborhood and talk to him"
    - "Dialogue shows character name, text with typewriter effect, and branching choices"
    - "NPCs show [E] Talk prompt when player is nearby"
    - "NPCs have idle bob animation and name label like Nutkin"
  artifacts:
    - path: "characters/npcs/dialogue_npc.gd"
      provides: "Reusable Area2D-based NPC for dialogue (modeled on ShopNPC pattern)"
      min_lines: 80
    - path: "characters/npcs/dialogue_npc.tscn"
      provides: "Base scene for dialogue NPCs"
    - path: "resources/dialogues/gertrude_dialogue.json"
      provides: "Gertrude's branching dialogue tree (hints about Raccoon King, fetch quest hooks)"
      min_lines: 40
    - path: "resources/dialogues/maurice_dialogue.json"
      provides: "Maurice's branching dialogue tree (delivery quest hooks, neighborhood news)"
      min_lines: 40
  key_links:
    - from: "characters/npcs/dialogue_npc.gd"
      to: "autoloads/dialogue_manager.gd"
      via: "calls DialogueManager.start_dialogue() on interact"
      pattern: "DialogueManager\\.start_dialogue"
    - from: "world/zones/neighborhood.gd"
      to: "autoloads/dialogue_manager.gd"
      via: "loads dialogue JSON files in _setup_zone()"
      pattern: "DialogueManager\\.load_dialogue_file"
---

<objective>
Create the first two story NPCs (Old Lady Gertrude and Mailman Maurice) with branching dialogue trees, and place them in the Neighborhood zone.

Purpose: The game currently has only one NPC (Nutkin the shopkeeper). Adding story NPCs gives the world personality, provides hints about game lore, and lays groundwork for the quest system (Phase 41-42). Gertrude and Maurice are the most important NPCs — Gertrude gives hints about the Raccoon King, Maurice delivers neighborhood news.

Output: Reusable DialogueNPC base script/scene, 2 NPC instances with dialogue JSON files, NPCs placed in neighborhood zone.
</objective>

<context>
@docs/PROJECT.md
@characters/npcs/shop_npc.gd
@characters/npcs/shop_npc.tscn
@autoloads/dialogue_manager.gd
@systems/dialogue/dialogue_resource.gd
@systems/dialogue/dialogue_data.gd
@ui/dialogue/dialogue_box.gd
@resources/dialogues/example_dialogue.json
@world/zones/neighborhood.gd
</context>

<tasks>

<task type="auto">
  <name>Task 1: DialogueNPC Base + Gertrude & Maurice Scripts</name>
  <files>
    characters/npcs/dialogue_npc.gd
    characters/npcs/dialogue_npc.tscn
    characters/npcs/gertrude.gd
    characters/npcs/gertrude.tscn
    characters/npcs/maurice.gd
    characters/npcs/maurice.tscn
  </files>
  <action>
  Create a reusable DialogueNPC script modeled closely on ShopNPC (Area2D pattern, programmatic UI), then create two NPC instances.

  **1. Create `characters/npcs/dialogue_npc.gd`** — extends Area2D (NOT NPCBase, which has class_name issues):
  ```
  extends Area2D
  ## Reusable NPC with dialogue interaction. Modeled on ShopNPC pattern.
  ## Walk near and press E to trigger dialogue from a JSON file.
  ```

  Follow ShopNPC structure exactly:
  - `@export var npc_name: String = ""` — display name
  - `@export var dialogue_id: String = ""` — starting dialogue ID to trigger
  - `@export var dialogue_file: String = ""` — path to JSON file (loaded by zone)
  - `@export var prompt_action: String = "Talk"` — what shows in the [E] prompt
  - `var player_in_range: bool = false`
  - `var prompt_label: Label = null`
  - `var name_label: Label = null`
  - `@onready var sprite: AnimatedSprite2D = $Sprite2D`
  - `var _idle_time: float = 0.0`
  - `var _base_y: float = 0.0`

  `_ready()`: collision_layer=0, collision_mask=2, connect body_entered/exited, _base_y = position.y, _create_collision_shape(), _create_name_label(), _create_prompt_label(), play idle if sprite exists.

  `_process(delta)`: same idle bob as ShopNPC (sin wave * 1.0).

  `_unhandled_input(event)`: if player_in_range and event.is_action_pressed("interact") → `DialogueManager.start_dialogue(dialogue_id)`, set_input_as_handled.

  `_create_collision_shape()`: same as ShopNPC (RectangleShape2D 24x24).
  `_create_name_label()`: same as ShopNPC (gold color, font_size 7, shadow).
  `_create_prompt_label()`: like ShopNPC but text is "[E] %s" % prompt_action, font_size 7, hidden by default.

  `_on_body_entered(body)`: if body is in "player" group → player_in_range = true, show prompt.
  `_on_body_exited(body)`: if body is in "player" group → player_in_range = false, hide prompt.

  Note: Use `body.is_in_group("player")` (NOT `body is Player` which requires class_name import). This matches the pattern used in zone trigger code.

  **2. Create `characters/npcs/dialogue_npc.tscn`** — minimal base scene:
  - Root: Area2D (script: dialogue_npc.gd)
  - Child: Sprite2D (placeholder ColorRect or AnimatedSprite2D — use a simple 16x16 colored square for now, can be replaced with pixel art later)
  - Child: CollisionShape2D (will be created programmatically, but include for editor visibility)

  Actually, since UI is programmatic, the .tscn just needs the root Area2D with script attached. The collision shape and labels are created in _ready(). Match how shop_npc.tscn works — check if it has a Sprite2D child node.

  **3. Create `characters/npcs/gertrude.gd`** — extends dialogue_npc.gd via path:
  ```
  extends "res://characters/npcs/dialogue_npc.gd"
  ## Old Lady Gertrude — neighborhood elder, gives hints about the Raccoon King.
  ```

  Override `_ready()` to set defaults: npc_name = "Gertrude", dialogue_id = "gertrude_start", prompt_action = "Talk". Then call super._ready() (use `super()` in Godot 4.x).

  Add a unique visual: create a small colored sprite (lavender/purple tint, 12x16) in _ready() if no sprite child exists. Position and z_index as needed.

  **4. Create `characters/npcs/gertrude.tscn`** — instance of dialogue_npc.tscn with gertrude.gd script override, or standalone scene with root Area2D + gertrude.gd script.

  **5. Create `characters/npcs/maurice.gd`** — extends dialogue_npc.gd:
  ```
  extends "res://characters/npcs/dialogue_npc.gd"
  ## Mailman Maurice — delivers mail and neighborhood news.
  ```

  Override _ready(): npc_name = "Maurice", dialogue_id = "maurice_start", prompt_action = "Talk". Unique visual: blue-tinted sprite (12x16 mail carrier).

  **6. Create `characters/npcs/maurice.tscn`** — same pattern as gertrude.tscn.

  Important conventions:
  - Use tabs for indentation
  - Use path-based extends: `extends "res://characters/npcs/dialogue_npc.gd"`
  - Do NOT add class_name to any new file
  - Use DebugLogger for any logging
  - Build all UI programmatically in _ready() — match ShopNPC pattern exactly
  - Use `body.is_in_group("player")` not `body is Player`
  </action>
  <verify>
  - `rg -n "DialogueManager.start_dialogue" characters/npcs/dialogue_npc.gd` shows dialogue trigger
  - `rg -n "extends.*dialogue_npc" characters/npcs/gertrude.gd characters/npcs/maurice.gd` shows path-based extends
  - `rg -n "class_name" characters/npcs/dialogue_npc.gd characters/npcs/gertrude.gd characters/npcs/maurice.gd` returns NO results
  - All 6 files exist: dialogue_npc.gd/.tscn, gertrude.gd/.tscn, maurice.gd/.tscn
  </verify>
  <done>
  DialogueNPC reusable base script follows ShopNPC Area2D pattern. Gertrude and Maurice NPCs created with path-based extends, unique visuals, and configured dialogue IDs.
  </done>
</task>

<task type="auto">
  <name>Task 2: Dialogue Content + Zone Placement</name>
  <files>
    resources/dialogues/gertrude_dialogue.json
    resources/dialogues/maurice_dialogue.json
    world/zones/neighborhood.gd
    world/zones/neighborhood.tscn
  </files>
  <action>
  Write dialogue JSON files and place NPCs in the Neighborhood zone.

  **1. Create `resources/dialogues/gertrude_dialogue.json`:**

  Gertrude is an elderly woman who knows about the Raccoon King's history. Her dialogue tree:
  - `gertrude_start`: "Oh my, another brave soul! The neighborhood hasn't been the same since those raccoons moved in..." → choices: "What happened?" / "I'll handle it"
  - `gertrude_history`: "Years ago, it was peaceful. Then the Raccoon King gathered his minions..." → next: gertrude_advice
  - `gertrude_brave`: "That's the spirit! But be careful, dear. They're stronger than they look." → next: gertrude_advice
  - `gertrude_advice`: "If you're serious about stopping them, you'll need to defeat their lieutenants first. I've heard there are four of them scattered across the area." → choices: "Where are they?" / "Thank you, Gertrude"
  - `gertrude_locations`: "The Alpha Raccoon lurks right here in the neighborhood. The Crow Matriarch nests in the backyard trees. The Rat King hides in the sewers. And a new one, some kind of Pigeon King, has taken the rooftops." → end
  - `gertrude_thanks`: "Good luck, dear. The whole neighborhood is counting on you!" → end

  Follow the exact JSON format from example_dialogue.json. All entries need: id, character ("Gertrude"), portrait (""), text, choices (array), next_id, is_cutscene (false).

  **2. Create `resources/dialogues/maurice_dialogue.json`:**

  Maurice is a chatty mailman who delivers neighborhood gossip:
  - `maurice_start`: "Hey there! Busy day, busy day. These raccoons keep knocking over my mail cart!" → choices: "Need help?" / "What's the latest news?"
  - `maurice_help`: "Oh, I appreciate that! But it's not just the mail — the whole neighborhood's on edge. Strange creatures everywhere." → next: maurice_news
  - `maurice_news_ask`: "Well, let me tell you..." → next: maurice_news
  - `maurice_news`: "Word is the raccoons are organized now. Got themselves a king and everything. Even the crows and rats are working together!" → choices: "That sounds dangerous" / "I'm not worried"
  - `maurice_dangerous`: "You should be careful. I've seen some tough-looking critters in the backyard and sewers. Even up on the rooftops now!" → next: maurice_tip
  - `maurice_confident`: "Ha! I like your attitude. Just don't get too cocky — I've seen what those mini-bosses can do." → next: maurice_tip
  - `maurice_tip`: "Hey, I'll tell you what — if you clear out some of those troublemakers, I might have a delivery job for you sometime. Pays well!" → end

  **3. Modify `world/zones/neighborhood.gd`** — add NPC loading and placement:

  At the top, add preloads:
  ```
  const GERTRUDE_SCENE = preload("res://characters/npcs/gertrude.tscn")
  const MAURICE_SCENE = preload("res://characters/npcs/maurice.tscn")
  ```

  In `_setup_zone()`, after `_build_mini_boss_trigger()` and before spawn point handling, add:
  ```
  _build_story_npcs()
  ```

  Add new function:
  ```
  func _build_story_npcs() -> void:
      # Load dialogue files into DialogueManager
      DialogueManager.load_dialogue_file("res://resources/dialogues/gertrude_dialogue.json")
      DialogueManager.load_dialogue_file("res://resources/dialogues/maurice_dialogue.json")

      # Gertrude — near houses, north-west area (near Momi's home)
      var gertrude = GERTRUDE_SCENE.instantiate()
      gertrude.name = "Gertrude"
      gertrude.position = Vector2(120, 220)  # Near home spawn point
      add_child(gertrude)

      # Maurice — on the main road, patrolling between stores
      var maurice = MAURICE_SCENE.instantiate()
      maurice.name = "Maurice"
      maurice.position = Vector2(400, 300)  # Main road near stores
      add_child(maurice)
  ```

  **4. Add spawn point for NPC area** in spawn_points dictionary:
  ```
  "gertrude": Vector2(130, 220),
  ```

  Important:
  - Use tabs for indentation
  - Dialogue JSON must match the exact format in example_dialogue.json
  - Portrait paths can be empty strings "" (no portraits yet)
  - Place NPCs in logical locations (Gertrude near houses, Maurice on the road)
  - Load dialogues via DialogueManager.load_dialogue_file() in zone setup
  </action>
  <verify>
  - JSON files parse correctly: `python3 -c "import json; json.load(open('resources/dialogues/gertrude_dialogue.json'))"` succeeds
  - JSON files parse correctly: `python3 -c "import json; json.load(open('resources/dialogues/maurice_dialogue.json'))"` succeeds
  - `rg -n "_build_story_npcs" world/zones/neighborhood.gd` shows function exists and is called
  - `rg -n "load_dialogue_file" world/zones/neighborhood.gd` shows dialogue loading
  - `rg -n "GERTRUDE_SCENE\|MAURICE_SCENE" world/zones/neighborhood.gd` shows preloads
  </verify>
  <done>
  Two dialogue JSON files with branching conversations. NPCs placed in neighborhood at logical positions. Dialogue files loaded on zone entry via DialogueManager. Players can walk up to Gertrude (near houses) or Maurice (on the road) and have multi-branch conversations.
  </done>
</task>

</tasks>

<verification>
- `rg -rn "DialogueManager.start_dialogue" characters/npcs/` shows NPCs trigger dialogue
- `rg -rn "load_dialogue_file" world/zones/neighborhood.gd` shows dialogues loaded
- Dialogue JSON files exist and contain valid branching dialogue trees
- NPCs visible in neighborhood with name labels and interaction prompts
- No class_name declarations in any new file
</verification>

<success_criteria>
Players can interact with Gertrude and Maurice in the neighborhood zone. Each NPC has a multi-branch dialogue tree (5-7 nodes each) with choices that lead to different responses. Dialogue displays via the existing DialogueBox UI with typewriter effect. NPCs show [E] Talk prompt when player is nearby. Reusable DialogueNPC base script enables easy creation of future NPCs.
</success_criteria>

<output>
After completion, create `.planning/phases/40-dialogue-expansion/40-01-SUMMARY.md`
</output>
