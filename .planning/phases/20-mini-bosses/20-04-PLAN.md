---
phase: 20-mini-bosses
plan: 04
type: execute
wave: 2
depends_on: ["20-01"]
files_modified:
  - characters/enemies/rat_king.gd
  - characters/enemies/rat_king.tscn
  - characters/enemies/states/rat_king_poison_cloud.gd
  - world/zones/sewers.gd
autonomous: true

must_haves:
  truths:
    - "Player encounters Rat King in Sewers via area trigger"
    - "Rat King has poison AoE cloud attack and splits into smaller rats at 50% HP"
    - "Rat King has 150 HP, cycles between poison cloud and idle"
    - "Defeating Rat King grants Rat King's Collar equipment"
    - "Rat King does not respawn after defeat (per save)"
    - "Mini-boss health bar shows 'RAT KING' during fight"
    - "Split into rats happens exactly once at 50% HP (guarded by has_split flag)"
  artifacts:
    - path: "characters/enemies/rat_king.gd"
      provides: "Rat King mini-boss class with split mechanic"
      contains: "class_name RatKing"
    - path: "characters/enemies/rat_king.tscn"
      provides: "Rat King scene with states"
      contains: "RatKingPoisonCloud"
    - path: "characters/enemies/states/rat_king_poison_cloud.gd"
      provides: "Poison AoE cloud attack state"
      contains: "class_name RatKingPoisonCloud"
    - path: "world/zones/sewers.gd"
      provides: "Mini-boss trigger area in sewers"
      contains: "_build_mini_boss_trigger"
  key_links:
    - from: "characters/enemies/rat_king.gd"
      to: "characters/enemies/mini_boss_base.gd"
      via: "extends MiniBossBase"
      pattern: 'extends.*mini_boss_base'
    - from: "characters/enemies/rat_king.gd"
      to: "characters/enemies/sewer_rat.tscn"
      via: "Spawns sewer rats on split at 50% HP"
      pattern: "sewer_rat"
    - from: "world/zones/sewers.gd"
      to: "autoloads/game_manager.gd"
      via: "GameManager.mini_bosses_defeated check"
      pattern: "mini_bosses_defeated"
    - from: "characters/enemies/states/rat_king_poison_cloud.gd"
      to: "components/health/health_component.gd"
      via: "apply_poison for AoE cloud"
      pattern: "apply_poison"
---

<objective>
Create the Rat King mini-boss for the Sewers zone — the toughest mini-boss with poison AoE clouds and a unique split mechanic at 50% HP that spawns sewer rats. Add area trigger in Sewers zone.

Purpose: Final zone-specific mini-boss, highest HP (150), rewards Rat King's Collar. The split mechanic adds a dramatic mid-fight moment unique to this boss.
Output: Playable Rat King encounter in Sewers zone.
</objective>

<execution_context>
@~/.config/Claude/get-shit-done/workflows/execute-plan.md
@~/.config/Claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-mini-bosses/20-RESEARCH.md
@.planning/phases/20-mini-bosses/20-01-SUMMARY.md

Key source files:
@characters/enemies/mini_boss_base.gd — MiniBossBase to extend (from Plan 01)
@characters/enemies/states/mini_boss_idle.gd — MiniBossIdle state (from Plan 01)
@characters/enemies/boss_raccoon_king.gd — boss pattern reference
@characters/enemies/boss_raccoon_king.tscn — scene structure reference
@characters/enemies/sewer_rat.gd — regular sewer rat for split spawning
@characters/enemies/sewer_rat.tscn — sewer rat scene to preload
@components/hazards/toxic_puddle.gd — AoE poison hazard pattern reference
@components/health/health_component.gd — apply_poison() method
@world/zones/sewers.gd — zone to add trigger to
@components/state_machine/state.gd — State base (var player)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rat King class with split mechanic and RatKingPoisonCloud state</name>
  <files>
    characters/enemies/rat_king.gd
    characters/enemies/states/rat_king_poison_cloud.gd
  </files>
  <action>
**1. Create `characters/enemies/states/rat_king_poison_cloud.gd` — Poison AoE Cloud:**

Spawns a temporary Area2D poison zone at the player's position. Based on ToxicPuddle pattern.

```gdscript
extends State
class_name RatKingPoisonCloud
## Rat King poison cloud - creates an AoE poison zone at target location.
## Phase: TELEGRAPH (0.4s) → SPIT (0.2s) → RECOVERY (0.6s)
## The poison cloud persists for 4 seconds, applying poison DoT on contact.

const TELEGRAPH_TIME: float = 0.4
const SPIT_TIME: float = 0.2
const RECOVERY_TIME: float = 0.6
const CLOUD_RADIUS: float = 30.0
const CLOUD_DURATION: float = 4.0
const POISON_DAMAGE: int = 3
const POISON_TICK_DURATION: float = 3.0

var timer: float = 0.0
enum Phase { TELEGRAPH, SPIT, RECOVERY }
var current_phase: Phase = Phase.TELEGRAPH
var target_pos: Vector2 = Vector2.ZERO

func enter() -> void:
    timer = 0.0
    current_phase = Phase.TELEGRAPH
    player.velocity = Vector2.ZERO
    
    # Lock target position
    var player_node = player.get_tree().get_first_node_in_group("player")
    if player_node:
        target_pos = player_node.global_position
    else:
        target_pos = player.global_position + Vector2(0, 30)
    
    # Green-purple glow during telegraph
    if player.sprite:
        player.sprite.modulate = Color(0.7, 1.2, 0.6)

func exit() -> void:
    if player.sprite:
        player.sprite.modulate = Color.WHITE
        player.sprite.position = Vector2.ZERO

func physics_update(delta: float) -> void:
    timer += delta
    match current_phase:
        Phase.TELEGRAPH:
            # Swell/pulse sprite
            if player.sprite:
                var pulse = 1.0 + sin(timer * 12.0) * 0.1
                player.sprite.scale = Vector2(2.0, 2.0) * pulse  # Rat King is 2x scale
            if timer >= TELEGRAPH_TIME:
                current_phase = Phase.SPIT
                timer = 0.0
                _spawn_poison_cloud()
        Phase.SPIT:
            if timer >= SPIT_TIME:
                current_phase = Phase.RECOVERY
                timer = 0.0
        Phase.RECOVERY:
            if player.sprite:
                player.sprite.scale = Vector2(2.0, 2.0)  # Reset scale
            if timer >= RECOVERY_TIME:
                state_machine.transition_to("MiniBossIdle")

func _spawn_poison_cloud() -> void:
    EffectsManager.screen_shake(3.0, 0.1)
    
    # Create poison cloud Area2D
    var cloud = Area2D.new()
    cloud.name = "PoisonCloud"
    cloud.collision_layer = 0
    cloud.collision_mask = 2  # Player layer
    cloud.global_position = target_pos
    
    var shape = CollisionShape2D.new()
    var circle = CircleShape2D.new()
    circle.radius = CLOUD_RADIUS
    shape.shape = circle
    cloud.add_child(shape)
    
    # Visual — green-purple translucent circle
    var visual = Polygon2D.new()
    var points: PackedVector2Array = []
    for i in range(12):
        var angle = i * TAU / 12.0
        points.append(Vector2(cos(angle), sin(angle)) * CLOUD_RADIUS)
    visual.polygon = points
    visual.color = Color(0.4, 0.7, 0.2, 0.35)  # Sickly green, translucent
    visual.z_index = 1
    cloud.add_child(visual)
    
    # Inner darker circle for depth
    var inner = Polygon2D.new()
    var inner_points: PackedVector2Array = []
    for i in range(8):
        var angle = i * TAU / 8.0
        inner_points.append(Vector2(cos(angle), sin(angle)) * CLOUD_RADIUS * 0.5)
    inner.polygon = inner_points
    inner.color = Color(0.3, 0.5, 0.15, 0.5)
    inner.z_index = 2
    cloud.add_child(inner)
    
    # Poison on contact — uses HealthComponent.apply_poison()
    cloud.body_entered.connect(func(body: Node2D):
        if body.is_in_group("player") or body.is_in_group("companions"):
            var hc = body.get_node_or_null("HealthComponent")
            if hc and hc.has_method("apply_poison"):
                hc.apply_poison(POISON_DAMAGE, POISON_TICK_DURATION)
    )
    
    player.get_parent().add_child(cloud)
    
    # Pulse animation on cloud
    var pulse_tween = cloud.create_tween().set_loops(int(CLOUD_DURATION / 0.8))
    pulse_tween.tween_property(visual, "modulate:a", 0.5, 0.4)
    pulse_tween.tween_property(visual, "modulate:a", 1.0, 0.4)
    
    # Auto-despawn after duration
    var despawn_timer = player.get_tree().create_timer(CLOUD_DURATION)
    despawn_timer.timeout.connect(func():
        if is_instance_valid(cloud):
            var fade = cloud.create_tween()
            fade.tween_property(cloud, "modulate:a", 0.0, 0.5)
            fade.tween_callback(cloud.queue_free)
    )
```

**2. Create `characters/enemies/rat_king.gd`:**

The unique mechanic: at 50% HP, splits into 3-4 sewer rats. This is NOT a state — it triggers from _on_hurt() override. Guarded by `has_split` boolean to prevent infinite spawning.

```gdscript
extends "res://characters/enemies/mini_boss_base.gd"
class_name RatKing
## Rat King - Sewers mini-boss.
## 150 HP, poison AoE cloud + split into rats at 50% HP.
## Massive sewer rat with crown of smaller rats. Drops Rat King's Collar on defeat.

const SEWER_RAT_SCENE = preload("res://characters/enemies/sewer_rat.tscn")

## Split mechanic — guard with boolean to prevent infinite spawning
var has_split: bool = false
const SPLIT_THRESHOLD: float = 0.5  # 50% HP
const SPLIT_RAT_COUNT: int = 4

# =============================================================================
# LIFECYCLE
# =============================================================================

func _ready() -> void:
    # Stats — set BEFORE super._ready()
    patrol_speed = 30.0
    chase_speed = 55.0
    detection_range = 100.0
    attack_range = 25.0
    lose_interest_range = 200.0
    attack_damage = 18
    attack_cooldown = 2.0
    knockback_force = 120.0
    exp_value = 120
    
    # Mini-boss config
    boss_name = "RAT KING"
    is_defeated_key = "rat_king"
    loot_equipment_id = "rat_king_collar"
    attack_patterns = ["RatKingPoisonCloud", "MiniBossIdle"]  # Poison cloud → brief idle → poison → ...
    
    super._ready()
    
    # Override health AFTER super._ready()
    if health:
        health.max_health = 150
        health.current_health = 150
    
    # Largest mini-boss (2.0x scale)
    if sprite:
        sprite.scale = Vector2(2.0, 2.0)
        sprite.color = Color(0.3, 0.28, 0.2)  # Dirty brown
    
    _setup_rat_king_appearance()

# =============================================================================
# APPEARANCE
# =============================================================================

func _setup_rat_king_appearance() -> void:
    if not sprite:
        return
    
    # Crown of smaller rat shapes on top
    for i in range(3):
        var rat_nub = Polygon2D.new()
        var x_offset = (i - 1) * 4.0
        rat_nub.polygon = PackedVector2Array([
            Vector2(x_offset - 1, -8),
            Vector2(x_offset, -11),
            Vector2(x_offset + 1, -8),
        ])
        rat_nub.color = Color(0.4, 0.35, 0.25)  # Lighter brown
        sprite.add_child(rat_nub)
    
    # Glowing green eyes (poison theme)
    var left_eye = Polygon2D.new()
    left_eye.polygon = PackedVector2Array([
        Vector2(-3, -2), Vector2(-2, -3), Vector2(-1, -2), Vector2(-2, -1)
    ])
    left_eye.color = Color(0.5, 1.0, 0.3)  # Toxic green
    sprite.add_child(left_eye)
    
    var right_eye = Polygon2D.new()
    right_eye.polygon = PackedVector2Array([
        Vector2(1, -2), Vector2(2, -3), Vector2(3, -2), Vector2(2, -1)
    ])
    right_eye.color = Color(0.5, 1.0, 0.3)
    sprite.add_child(right_eye)
    
    # Tail (long, curved line)
    var tail = Polygon2D.new()
    tail.polygon = PackedVector2Array([
        Vector2(0, 7), Vector2(1, 7),
        Vector2(4, 10), Vector2(5, 10),
        Vector2(7, 8), Vector2(6, 8),
        Vector2(3, 9), Vector2(2, 9),
    ])
    tail.color = Color(0.35, 0.3, 0.22)
    sprite.add_child(tail)

# =============================================================================
# SPLIT MECHANIC (50% HP)
# =============================================================================

## Override _on_hurt to check for split threshold
func _on_hurt(attacking_hitbox: Hitbox) -> void:
    super._on_hurt(attacking_hitbox)
    
    # Check split threshold — CRITICAL: guard with has_split to prevent infinite rats
    if not has_split and health and health.get_health_percent() <= SPLIT_THRESHOLD:
        _split_into_rats()

func _split_into_rats() -> void:
    has_split = true
    
    # Screen shake for dramatic effect
    EffectsManager.screen_shake(10.0, 0.4)
    
    # Brief stun visual — flash green
    if sprite:
        sprite.modulate = Color(0.5, 1.5, 0.5)
        var flash_tween = create_tween()
        flash_tween.tween_property(sprite, "modulate", Color.WHITE, 0.3)
    
    # Spawn sewer rats in circle around Rat King
    for i in range(SPLIT_RAT_COUNT):
        var rat = SEWER_RAT_SCENE.instantiate()
        var angle = i * TAU / SPLIT_RAT_COUNT
        rat.global_position = global_position + Vector2(cos(angle), sin(angle)) * 20
        get_parent().add_child(rat)
        
        # Track for cleanup on boss death
        spawned_minions.append(rat)
        
        # Spawn poof
        _spawn_split_poof(rat.global_position)
    
    # Optional: shrink sprite slightly and speed up (wounded, desperate)
    if sprite:
        var shrink_tween = create_tween()
        shrink_tween.tween_property(sprite, "scale", Vector2(1.7, 1.7), 0.3)
    chase_speed = 70.0  # Speed up when split

func _spawn_split_poof(pos: Vector2) -> void:
    for j in range(4):
        var particle = ColorRect.new()
        particle.size = Vector2(3, 3)
        particle.color = Color(0.4, 0.6, 0.2, 0.8)  # Green poison poof
        particle.global_position = pos
        get_parent().add_child(particle)
        
        var angle = j * TAU / 4
        var end_pos = pos + Vector2(cos(angle), sin(angle)) * 12
        
        var tween = create_tween()
        tween.set_parallel(true)
        tween.tween_property(particle, "global_position", end_pos, 0.3)
        tween.tween_property(particle, "modulate:a", 0.0, 0.3)
        tween.chain().tween_callback(particle.queue_free)

# =============================================================================
# DROPS
# =============================================================================

func _init_default_drops() -> void:
    drop_table = [
        {"scene": COIN_PICKUP_SCENE, "chance": 1.0, "min": 8, "max": 15},
        {"scene": HEALTH_PICKUP_SCENE, "chance": 1.0, "min": 3, "max": 5},
    ]
```

**Key design points:**
- `has_split = false` boolean prevents infinite rat spawning (Pitfall 5 from research)
- Split happens in _on_hurt() (not a state) — boss continues fighting
- After split: sprite shrinks (2.0→1.7), chase speed increases (55→70) — wounded + desperate
- Attack pattern alternates: PoisonCloud → MiniBossIdle (brief pause) → PoisonCloud → ...
  This gives the player clear windows between poison clouds
- 150 HP is highest of all mini-bosses — tanky, slow, dangerous
  </action>
  <verify>
1. `characters/enemies/rat_king.gd` extends mini_boss_base.gd, has `class_name RatKing`
2. `has_split` boolean exists and is checked in `_on_hurt()` before `_split_into_rats()`
3. Split spawns exactly SPLIT_RAT_COUNT (4) sewer rats and sets `has_split = true`
4. `characters/enemies/states/rat_king_poison_cloud.gd` creates Area2D cloud with apply_poison()
5. Poison cloud auto-despawns after CLOUD_DURATION (4 seconds)
6. Attack patterns = ["RatKingPoisonCloud", "MiniBossIdle"]
7. All state/script files use `player.` convention
  </verify>
  <done>
Rat King class with split mechanic (guarded by has_split), RatKingPoisonCloud AoE state, programmatic visuals with crown/eyes/tail. Highest HP mini-boss (150) with unique 50% HP split drama.
  </done>
</task>

<task type="auto">
  <name>Task 2: Rat King scene file and Sewers zone trigger</name>
  <files>
    characters/enemies/rat_king.tscn
    world/zones/sewers.gd
  </files>
  <action>
**1. Create `characters/enemies/rat_king.tscn`:**

```tscn
[gd_scene load_steps=13 format=3 uid="uid://rat_king_001"]

[ext_resource type="Script" path="res://characters/enemies/rat_king.gd" id="1_rat"]
[ext_resource type="Script" path="res://components/state_machine/state_machine.gd" id="2_sm"]
[ext_resource type="Script" path="res://characters/enemies/states/mini_boss_idle.gd" id="3_idle"]
[ext_resource type="Script" path="res://characters/enemies/states/rat_king_poison_cloud.gd" id="4_poison"]
[ext_resource type="Script" path="res://characters/enemies/states/enemy_chase.gd" id="5_chase"]
[ext_resource type="Script" path="res://characters/enemies/states/enemy_hurt.gd" id="6_hurt"]
[ext_resource type="Script" path="res://characters/enemies/states/enemy_death.gd" id="7_death"]
[ext_resource type="Script" path="res://components/hitbox/hitbox.gd" id="8_hitbox"]
[ext_resource type="Script" path="res://components/hurtbox/hurtbox.gd" id="9_hurtbox"]
[ext_resource type="Script" path="res://components/health/health_component.gd" id="10_health"]

[sub_resource type="CapsuleShape2D" id="CapsuleShape2D_body"]
radius = 12.0
height = 28.0

[sub_resource type="CircleShape2D" id="CircleShape2D_detection"]
radius = 100.0

[sub_resource type="RectangleShape2D" id="RectangleShape2D_hitbox"]
size = Vector2(22, 18)

[sub_resource type="CapsuleShape2D" id="CapsuleShape2D_hurtbox"]
radius = 14.0
height = 30.0

[node name="RatKing" type="CharacterBody2D"]
collision_layer = 4
collision_mask = 1
script = ExtResource("1_rat")

[node name="Sprite2D" type="Polygon2D" parent="."]
color = Color(0.3, 0.28, 0.2, 1)
polygon = PackedVector2Array(-7, -7, 7, -7, 7, 7, -7, 7)

[node name="CollisionShape2D" type="CollisionShape2D" parent="."]
position = Vector2(0, 4)
shape = SubResource("CapsuleShape2D_body")

[node name="AnimationPlayer" type="AnimationPlayer" parent="."]

[node name="StateMachine" type="Node" parent="."]
script = ExtResource("2_sm")
initial_state_path = NodePath("MiniBossIdle")

[node name="MiniBossIdle" type="Node" parent="StateMachine"]
script = ExtResource("3_idle")

[node name="RatKingPoisonCloud" type="Node" parent="StateMachine"]
script = ExtResource("4_poison")

[node name="Chase" type="Node" parent="StateMachine"]
script = ExtResource("5_chase")

[node name="Hurt" type="Node" parent="StateMachine"]
script = ExtResource("6_hurt")

[node name="Death" type="Node" parent="StateMachine"]
script = ExtResource("7_death")

[node name="DetectionArea" type="Area2D" parent="."]
collision_layer = 0
collision_mask = 2

[node name="CollisionShape2D" type="CollisionShape2D" parent="DetectionArea"]
shape = SubResource("CircleShape2D_detection")

[node name="Hitbox" type="Area2D" parent="."]
collision_layer = 128
collision_mask = 16
monitoring = false
monitorable = false
script = ExtResource("8_hitbox")
damage = 18

[node name="CollisionShape2D" type="CollisionShape2D" parent="Hitbox"]
position = Vector2(18, 0)
shape = SubResource("RectangleShape2D_hitbox")
disabled = true

[node name="Hurtbox" type="Area2D" parent="."]
collision_layer = 32
collision_mask = 64
script = ExtResource("9_hurtbox")

[node name="CollisionShape2D" type="CollisionShape2D" parent="Hurtbox"]
position = Vector2(0, 4)
shape = SubResource("CapsuleShape2D_hurtbox")

[node name="HealthComponent" type="Node" parent="."]
script = ExtResource("10_health")
max_health = 150
```

NOTE: Only 5 states (MiniBossIdle, RatKingPoisonCloud, Chase, Hurt, Death) — the Rat King's attack pattern alternates PoisonCloud with MiniBossIdle (no second attack state needed; the split mechanic triggers from _on_hurt, not from a state).

**2. Update `world/zones/sewers.gd` — Add mini-boss trigger:**

Read the current sewers.gd first to find the right insertion point. Add at the top of the file (after existing const declarations):

```gdscript
const RAT_KING_SCENE = preload("res://characters/enemies/rat_king.tscn")
```

Add `_build_mini_boss_trigger()` call in `_setup_zone()` (locate the existing _setup_zone function in sewers.gd and add after the zone_id assignment).

Then add the trigger builder function. The trigger should be placed in one of the side rooms or at a corridor junction in the sewers. Based on the layout data, the "ambush" side room at Rect2(280, 490, 90, 80) is a good candidate — center at ~(325, 530).

```gdscript
# =============================================================================
# MINI-BOSS TRIGGER (Rat King)
# =============================================================================

var _rat_king_spawned: bool = false

func _build_mini_boss_trigger() -> void:
    # Check if already defeated
    if GameManager.mini_bosses_defeated.get("rat_king", false):
        return
    
    # Place trigger in the lower corridor area (wide enough for fight)
    var trigger_pos = Vector2(325, 445)  # Lower horizontal corridor center
    
    # Warning decor — sickly green marking
    var warning = Polygon2D.new()
    warning.name = "MiniBossWarning"
    var points: PackedVector2Array = []
    for i in range(8):
        var angle = i * TAU / 8.0
        points.append(Vector2(cos(angle), sin(angle)) * 18.0)
    warning.polygon = points
    warning.color = Color(0.3, 0.5, 0.15, 0.3)  # Faint sickly green
    warning.position = trigger_pos
    warning.z_index = 1
    add_child(warning)
    
    # Trigger Area2D
    var trigger = Area2D.new()
    trigger.name = "RatKingTrigger"
    trigger.collision_layer = 0
    trigger.collision_mask = 2
    trigger.position = trigger_pos
    add_child(trigger)
    
    var shape = CollisionShape2D.new()
    var rect = RectangleShape2D.new()
    rect.size = Vector2(60, 50)  # Slightly smaller — sewer corridors
    shape.shape = rect
    trigger.add_child(shape)
    
    trigger.body_entered.connect(_on_rat_king_trigger)

func _on_rat_king_trigger(body: Node2D) -> void:
    if not body.is_in_group("player"):
        return
    if _rat_king_spawned:
        return
    if GameManager.mini_bosses_defeated.get("rat_king", false):
        return
    
    _rat_king_spawned = true
    
    var boss = RAT_KING_SCENE.instantiate()
    boss.global_position = Vector2(325, 430)  # Slightly above trigger
    add_child(boss)
    
    # Remove trigger and warning
    var trigger_node = get_node_or_null("RatKingTrigger")
    if trigger_node:
        trigger_node.queue_free()
    var warning_node = get_node_or_null("MiniBossWarning")
    if warning_node:
        var tween = create_tween()
        tween.tween_property(warning_node, "modulate:a", 0.0, 0.5)
        tween.tween_callback(warning_node.queue_free)
    
    # Play boss music
    if AudioManager.has_method("play_music"):
        AudioManager.play_music("boss_fight_b")
```

**Positioning notes for Sewers:**
- Lower horizontal corridor: Rect2(224, 420, 250, 56) — spans x:224-474, y:420-476
- Center at ~(349, 448), but use (325, 445) for slight offset
- This corridor is 250px wide and 56px tall — enough room for the fight
- Corridors are dark (CanvasModulate) — player's PointLight2D provides visibility
- The trigger pos must be within a walkable corridor section

**IMPORTANT:** When adding the `_build_mini_boss_trigger()` call to sewers.gd's `_setup_zone()`, insert it after the zone_id assignment but BEFORE any spawn point logic. Read the existing sewers.gd `_setup_zone()` to find the exact insertion point.
  </action>
  <verify>
1. `characters/enemies/rat_king.tscn` loads without errors, has MiniBossIdle + RatKingPoisonCloud + Chase + Hurt + Death states
2. `world/zones/sewers.gd` has `_build_mini_boss_trigger()` and preloads rat_king.tscn
3. Trigger at (325, 445) is within the lower horizontal corridor bounds (224-474, 420-476) ✓
4. Trigger checks `GameManager.mini_bosses_defeated.get("rat_king", false)`
5. Run game, enter Sewers, navigate to lower corridor — Rat King spawns
6. Health bar shows "RAT KING" with orange fill
7. At 50% HP (75), Rat King splits into 4 sewer rats + visual effects
8. Kill Rat King — "Got Rat King's Collar!" notification
9. Save/reload — Rat King doesn't respawn
10. Existing sewers features (toxic puddles, enemies, boss door, darkness) unaffected
  </verify>
  <done>
Rat King scene wired with all states. Sewers zone has trigger in lower corridor that spawns mini-boss, checks defeat flag, plays boss music. Complete Rat King encounter with poison clouds and dramatic 50% HP split.
  </done>
</task>

</tasks>

<verification>
1. Rat King spawns in Sewers lower corridor when player enters trigger zone
2. Poison cloud: telegraph (green glow) → spawn Area2D cloud at player position → poison DoT on contact → auto-despawn after 4s
3. Split at 50% HP: exactly once (has_split guard), spawns 4 sewer rats, screen shake, sprite shrinks + speeds up
4. 150 HP, slow but heavy damage (18 base), heavy knockback (120)
5. Death grants Rat King's Collar + coin/health drops, cleans up spawned rats
6. One-time defeat persists across save/load
7. Sewers darkness, toxic puddles, boss door, zone transitions all unaffected
</verification>

<success_criteria>
- Complete Rat King fight including the dramatic 50% HP split moment
- Poison clouds apply DoT via HealthComponent.apply_poison()
- Split spawns exactly 4 rats (never more due to has_split guard)
- Rat King's Collar in equipment inventory after defeat
- No sewers zone regressions
</success_criteria>

<output>
After completion, create `.planning/phases/20-mini-bosses/20-04-SUMMARY.md`
</output>
