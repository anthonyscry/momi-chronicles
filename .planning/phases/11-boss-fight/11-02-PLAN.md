---
phase: 11-boss-fight
plan: 02
type: execute
wave: 2
depends_on: ["11-01"]
files_modified:
  - world/zones/boss_arena.gd (NEW)
  - world/zones/boss_arena.tscn (NEW)
  - world/zones/backyard.gd
  - world/zones/backyard.tscn
  - autoloads/game_manager.gd
autonomous: true

must_haves:
  truths:
    - "Boss arena is separate zone from backyard"
    - "Arena doors lock when fight starts"
    - "Doors unlock after boss defeated"
  artifacts:
    - path: "world/zones/boss_arena.tscn"
      provides: "Boss arena zone"
    - path: "world/zones/boss_arena.gd"
      provides: "Arena logic"
  key_links:
    - from: "boss_arena.gd"
      to: "Events.boss_defeated"
      via: "unlock doors on victory"
---

<objective>
Create boss arena zone with door lock mechanics.

Purpose: Create contained boss encounter with clear win/lose conditions
Output: Boss arena zone that locks player in during fight
</objective>

<context>
@world/zones/base_zone.gd (base zone class)
@world/zones/backyard.gd (zone to connect from)
@characters/enemies/boss_raccoon_king.tscn (boss to spawn)
@autoloads/game_manager.gd (zone management)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Boss Arena Zone</name>
  <files>world/zones/boss_arena.gd, world/zones/boss_arena.tscn</files>
  <action>
Create boss arena zone:

**boss_arena.gd:**
```gdscript
extends BaseZone
class_name BossArena
## Boss arena zone - locked encounter with Raccoon King

const BOSS_SCENE = preload("res://characters/enemies/boss_raccoon_king.tscn")

# =============================================================================
# ARENA STATE
# =============================================================================

var boss: BossRaccoonKing = null
var doors_locked: bool = false
var boss_defeated: bool = false

@onready var entrance_door: StaticBody2D = $Doors/EntranceDoor
@onready var exit_door: StaticBody2D = $Doors/ExitDoor
@onready var boss_spawn_point: Marker2D = $BossSpawnPoint

# =============================================================================
# LIFECYCLE
# =============================================================================

func _ready() -> void:
    super._ready()
    
    zone_name = "boss_arena"
    
    # Connect to boss events
    Events.boss_defeated.connect(_on_boss_defeated)
    
    # Spawn boss
    _spawn_boss()
    
    # Lock doors after brief delay (let player enter)
    await get_tree().create_timer(1.0).timeout
    _lock_doors()

func _spawn_boss() -> void:
    boss = BOSS_SCENE.instantiate()
    boss.global_position = boss_spawn_point.global_position if boss_spawn_point else Vector2(192, 100)
    add_child(boss)

func _lock_doors() -> void:
    doors_locked = true
    
    # Enable door collisions
    if entrance_door:
        entrance_door.set_collision_layer_value(1, true)
        _animate_door_close(entrance_door)
    if exit_door:
        exit_door.set_collision_layer_value(1, true)
        _animate_door_close(exit_door)
    
    # Visual feedback
    EffectsManager.screen_shake(3.0, 0.2)
    
    # Play boss music
    AudioManager.play_music("boss_fight")
    
    Events.zone_entered.emit("boss_arena")

func _unlock_doors() -> void:
    doors_locked = false
    
    # Disable door collisions
    if entrance_door:
        entrance_door.set_collision_layer_value(1, false)
        _animate_door_open(entrance_door)
    if exit_door:
        exit_door.set_collision_layer_value(1, false)
        _animate_door_open(exit_door)

func _on_boss_defeated(_boss: Node) -> void:
    boss_defeated = true
    
    # Dramatic pause
    Engine.time_scale = 0.3
    await get_tree().create_timer(0.5 * 0.3).timeout
    Engine.time_scale = 1.0
    
    # Unlock doors
    _unlock_doors()
    
    # Victory music
    AudioManager.play_music("victory")
    
    # Spawn rewards
    _spawn_victory_rewards()

func _spawn_victory_rewards() -> void:
    # Spawn multiple health pickups
    var pickup_scene = preload("res://components/health/health_pickup.tscn")
    for i in range(3):
        var pickup = pickup_scene.instantiate()
        pickup.global_position = boss_spawn_point.global_position + Vector2(randf_range(-30, 30), randf_range(-30, 30))
        add_child(pickup)

# =============================================================================
# DOOR ANIMATIONS
# =============================================================================

func _animate_door_close(door: Node2D) -> void:
    if not door:
        return
    
    # Simple visual: darken and add bars
    var tween = create_tween()
    tween.tween_property(door, "modulate", Color(0.5, 0.4, 0.4), 0.3)
    
    # Flash effect
    door.modulate = Color(1.5, 1, 1)

func _animate_door_open(door: Node2D) -> void:
    if not door:
        return
    
    var tween = create_tween()
    tween.tween_property(door, "modulate", Color(1, 1, 1), 0.3)
```

**boss_arena.tscn structure:**
```
BossArena (Node2D, script: boss_arena.gd)
├── TileMapLayer (arena floor - use existing tileset)
├── Walls (StaticBody2D with CollisionPolygon2D for arena boundaries)
├── Doors
│   ├── EntranceDoor (StaticBody2D) - at bottom
│   │   └── CollisionShape2D
│   │   └── Sprite (ColorRect placeholder)
│   └── ExitDoor (StaticBody2D) - at top (leads to victory/credits)
│       └── CollisionShape2D
│       └── Sprite (ColorRect placeholder)
├── BossSpawnPoint (Marker2D) - center-ish of arena
├── PlayerSpawnPoints
│   └── default (Marker2D) - near entrance
└── ZoneExits (for after boss is defeated)
    └── VictoryExit (Area2D) - triggers victory screen
```

Arena size: 384x216 (same as other zones)
  </action>
  <verify>Boss arena zone files exist</verify>
  <done>Boss arena zone with door mechanics</done>
</task>

<task type="auto">
  <name>Task 2: Add Boss Arena to Zone System</name>
  <files>autoloads/game_manager.gd</files>
  <action>
Update GameManager to include boss arena:

```gdscript
## Zone scene paths
var zone_scenes: Dictionary = {
    "neighborhood": "res://world/zones/neighborhood.tscn",
    "backyard": "res://world/zones/backyard.tscn",
    "boss_arena": "res://world/zones/boss_arena.tscn",
    "test_zone": "res://world/zones/test_zone.tscn"
}

## Track boss defeat for save state
var boss_defeated: bool = false

func _ready() -> void:
    Events.player_died.connect(_on_player_died)
    Events.zone_entered.connect(_on_zone_entered)
    Events.zone_transition_requested.connect(_on_zone_transition_requested)
    Events.boss_defeated.connect(_on_boss_defeated)

func _on_boss_defeated(_boss: Node) -> void:
    boss_defeated = true
```
  </action>
  <verify>game_manager.gd has boss_arena in zone_scenes</verify>
  <done>Boss arena registered in zone system</done>
</task>

<task type="auto">
  <name>Task 3: Add Boss Arena Exit to Backyard</name>
  <files>world/zones/backyard.gd, world/zones/backyard.tscn</files>
  <action>
1. In backyard.tscn, add zone exit to boss arena:
   - Place ZoneExit at right edge (or top) of backyard
   - Set target_zone = "boss_arena"
   - Set spawn_point = "default"

2. In backyard.gd, optionally add visual indicator:
```gdscript
@onready var boss_entrance: Area2D = $ZoneExits/BossEntrance

func _ready() -> void:
    super._ready()
    
    # Add warning sign near boss entrance
    if boss_entrance:
        var warning = Label.new()
        warning.text = "DANGER!"
        warning.add_theme_font_size_override("font_size", 8)
        warning.add_theme_color_override("font_color", Color(1, 0.3, 0.3))
        warning.position = boss_entrance.position + Vector2(-15, -20)
        add_child(warning)
```

Zone flow:
```
Neighborhood → Backyard → Boss Arena
     ←            ←           (locked during fight)
```
  </action>
  <verify>Backyard has exit to boss_arena</verify>
  <done>Zone connection established</done>
</task>

</tasks>

<verification>
1. Run game, go to backyard
2. Find exit to boss arena (right/top edge)
3. Enter boss arena:
   - Doors should close after 1 second
   - Boss spawns in center
   - Boss music plays
4. Defeat boss:
   - Dramatic slowdown
   - Doors open
   - Victory music plays
   - Health pickups spawn
</verification>

<success_criteria>
- Boss arena accessible from backyard
- Doors lock when fight starts
- Doors unlock after boss defeated
- Victory rewards spawn
</success_criteria>

<output>
After completion, create `.planning/phases/11-boss-fight/11-02-SUMMARY.md`
</output>
