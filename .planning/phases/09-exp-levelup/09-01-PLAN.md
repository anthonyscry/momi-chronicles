---
phase: 09-exp-levelup
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - components/progression/progression_component.gd (NEW)
  - components/progression/progression_component.tscn (NEW)
  - autoloads/events.gd
  - autoloads/game_manager.gd
  - characters/enemies/enemy_base.gd
autonomous: true

must_haves:
  truths:
    - "Killing enemies grants EXP"
    - "EXP accumulates toward level thresholds"
    - "Level increases when EXP threshold reached"
  artifacts:
    - path: "components/progression/progression_component.gd"
      provides: "EXP tracking and level math"
    - path: "autoloads/game_manager.gd"
      provides: "Persistent progression state"
  key_links:
    - from: "enemy_base.gd"
      to: "Events.exp_gained"
      via: "_on_died emits exp"
---

<objective>
Create EXP and leveling system foundation with enemy rewards.

Purpose: Add progression that rewards combat and encourages engagement
Output: Working EXP gain from enemies, level up when threshold reached
</objective>

<context>
@autoloads/game_manager.gd (game state)
@autoloads/events.gd (signals)
@characters/enemies/enemy_base.gd (enemy death)
@characters/enemies/raccoon.gd (enemy type)
@characters/enemies/crow.gd (enemy type)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Progression Component</name>
  <files>components/progression/progression_component.gd, components/progression/progression_component.tscn</files>
  <action>
Create directory `components/progression/` and files:

**progression_component.gd:**
```gdscript
extends Node
class_name ProgressionComponent
## Manages EXP, levels, and stat scaling for player

# =============================================================================
# SIGNALS
# =============================================================================

signal exp_changed(current_exp: int, exp_to_next: int)
signal level_changed(new_level: int)

# =============================================================================
# CONFIGURATION
# =============================================================================

## Starting level
const START_LEVEL: int = 1

## Maximum level
const MAX_LEVEL: int = 20

## Base EXP needed for level 2
const BASE_EXP: int = 100

## EXP scaling factor per level (exponential curve)
const EXP_SCALE: float = 1.5

## Stat increases per level
const STATS_PER_LEVEL = {
    "max_health": 10,      # +10 HP per level
    "attack_damage": 3,    # +3 damage per level
    "move_speed": 2        # +2 speed per level
}

# =============================================================================
# STATE
# =============================================================================

var current_level: int = START_LEVEL
var current_exp: int = 0
var total_exp: int = 0  # Lifetime EXP earned

# =============================================================================
# LIFECYCLE
# =============================================================================

func _ready() -> void:
    Events.enemy_defeated.connect(_on_enemy_defeated)

# =============================================================================
# PUBLIC METHODS
# =============================================================================

## Get EXP required to reach next level
func get_exp_for_level(level: int) -> int:
    if level <= 1:
        return 0
    # Exponential curve: BASE_EXP * (SCALE ^ (level - 2))
    return int(BASE_EXP * pow(EXP_SCALE, level - 2))

## Get total EXP needed from level 1 to target level
func get_total_exp_for_level(level: int) -> int:
    var total = 0
    for i in range(2, level + 1):
        total += get_exp_for_level(i)
    return total

## Get EXP needed for current level to next
func get_exp_to_next_level() -> int:
    if current_level >= MAX_LEVEL:
        return 0
    return get_exp_for_level(current_level + 1)

## Get EXP progress within current level (0 to exp_to_next)
func get_exp_progress() -> int:
    var exp_for_current = get_total_exp_for_level(current_level)
    return total_exp - exp_for_current

## Add EXP and check for level up
func add_exp(amount: int) -> void:
    if current_level >= MAX_LEVEL:
        return
    
    current_exp += amount
    total_exp += amount
    
    # Check for level up(s)
    while current_exp >= get_exp_to_next_level() and current_level < MAX_LEVEL:
        current_exp -= get_exp_to_next_level()
        _level_up()
    
    exp_changed.emit(get_exp_progress(), get_exp_to_next_level())
    Events.exp_gained.emit(amount, current_level, get_exp_progress(), get_exp_to_next_level())

## Get stat bonus for current level
func get_stat_bonus(stat_name: String) -> int:
    if not STATS_PER_LEVEL.has(stat_name):
        return 0
    return STATS_PER_LEVEL[stat_name] * (current_level - 1)

## Get current level
func get_level() -> int:
    return current_level

## Reset progression (for new game)
func reset() -> void:
    current_level = START_LEVEL
    current_exp = 0
    total_exp = 0
    exp_changed.emit(0, get_exp_to_next_level())
    level_changed.emit(current_level)

# =============================================================================
# PRIVATE METHODS
# =============================================================================

func _level_up() -> void:
    current_level += 1
    level_changed.emit(current_level)
    Events.player_leveled_up.emit(current_level)
    print("[Progression] Level up! Now level ", current_level)

func _on_enemy_defeated(enemy: Node) -> void:
    # Get EXP value from enemy
    var exp_value = enemy.get("exp_value") if enemy.get("exp_value") else 10
    add_exp(exp_value)
```

**progression_component.tscn:**
- Root: Node (script: progression_component.gd)
  </action>
  <verify>Files exist in components/progression/</verify>
  <done>Progression component with EXP curve and level math</done>
</task>

<task type="auto">
  <name>Task 2: Add Progression Signals to Events</name>
  <files>autoloads/events.gd</files>
  <action>
Add progression-related signals:

```gdscript
# =============================================================================
# PROGRESSION SIGNALS
# =============================================================================

## Emitted when player gains EXP
signal exp_gained(amount: int, current_level: int, current_exp: int, exp_to_next: int)

## Emitted when player levels up
signal player_leveled_up(new_level: int)

## Emitted when stats change due to level up
signal stats_updated(stat_name: String, new_value: int)
```
  </action>
  <verify>Events.gd has progression signals</verify>
  <done>Progression signals available globally</done>
</task>

<task type="auto">
  <name>Task 3: Add EXP Values to Enemies</name>
  <files>characters/enemies/enemy_base.gd, characters/enemies/raccoon.gd, characters/enemies/crow.gd</files>
  <action>
1. In enemy_base.gd, add export variable:
```gdscript
@export var exp_value: int = 10  # Base EXP for generic enemy
```

2. In raccoon.gd (or raccoon.tscn), set:
```gdscript
exp_value = 25  # Raccoons are tougher, worth more
```

3. In crow.gd (or crow.tscn), set:
```gdscript
exp_value = 15  # Crows are fast but squishy
```

EXP values based on difficulty:
- Crow: 15 EXP (fast, low HP)
- Raccoon: 25 EXP (tanky, melee)
- Boss (later): 200 EXP
  </action>
  <verify>Enemy scripts have exp_value property</verify>
  <done>Enemies have EXP rewards</done>
</task>

</tasks>

<verification>
1. Run game
2. Kill a Raccoon → should see console log of EXP gained
3. Kill ~4 Raccoons (100 EXP) → should level up to 2
4. Check Events.player_leveled_up fires correctly
</verification>

<success_criteria>
- EXP gained on enemy kill
- Level up occurs at correct thresholds (100, 150, 225...)
- Console shows level up message
- No errors on progression system
</success_criteria>

<output>
After completion, create `.planning/phases/09-exp-levelup/09-01-SUMMARY.md`
</output>
