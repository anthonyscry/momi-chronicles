---
phase: 17-new-enemies
plan: 03
type: execute
wave: 2
depends_on: ["17-01", "17-02"]
files_modified:
  - characters/enemies/shadow_creature.gd
  - characters/enemies/shadow_creature.tscn
  - characters/enemies/states/shadow_phase.gd
  - characters/enemies/states/shadow_ranged_attack.gd
  - components/projectile/shadow_bolt.gd
  - components/projectile/shadow_bolt.tscn
  - world/zones/neighborhood.tscn
  - world/zones/backyard.tscn
autonomous: true

must_haves:
  truths:
    - "Shadow Creature phases in/out of visibility periodically"
    - "Shadow Creature fires ranged shadow bolt projectiles at the player"
    - "Shadow Creature teleports a short distance when hit"
    - "Shadow Creatures appear in both neighborhood and backyard zones"
    - "Shadow bolts travel in a direction and deal damage on contact"
  artifacts:
    - path: "characters/enemies/shadow_creature.gd"
      provides: "Shadow enemy with phase and ranged behavior"
      exports: ["ShadowCreature"]
    - path: "characters/enemies/shadow_creature.tscn"
      provides: "Instantiable shadow scene"
    - path: "characters/enemies/states/shadow_phase.gd"
      provides: "Phase state - visibility toggle with approach"
    - path: "characters/enemies/states/shadow_ranged_attack.gd"
      provides: "Ranged attack state - fires shadow bolt"
    - path: "components/projectile/shadow_bolt.gd"
      provides: "Projectile that travels and damages"
    - path: "components/projectile/shadow_bolt.tscn"
      provides: "Instantiable shadow bolt scene"
  key_links:
    - from: "shadow_creature.gd"
      to: "enemy_base.gd"
      via: "extends"
      pattern: 'extends.*enemy_base'
    - from: "shadow_ranged_attack.gd"
      to: "shadow_bolt.tscn"
      via: "instantiate projectile"
      pattern: 'shadow_bolt.*instantiate'
    - from: "shadow_creature.gd"
      to: "teleport on hurt"
      via: "_on_hurt override"
      pattern: 'global_position.*rand'
---

<objective>
Create the Shadow Creature enemy — a mysterious ranged attacker that phases in/out of visibility and fires shadow bolt projectiles. When hit, it teleports a short distance to evade. This is the primary "strange threat" from the game's lore.

Also creates the projectile system (shadow_bolt) that can be reused for other ranged attacks.

Purpose: Introduces ranged combat threat + projectile system. Shadow creatures are the mysterious lore antagonist.
Output: Shadow Creature enemy in both zones + reusable projectile component.
</objective>

<execution_context>
@~/.config/Claude/get-shit-done/workflows/execute-plan.md
@~/.config/Claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@characters/enemies/enemy_base.gd
@characters/enemies/raccoon.gd
@characters/enemies/raccoon.tscn
@characters/enemies/states/enemy_idle.gd
@characters/enemies/states/enemy_chase.gd
@characters/enemies/states/enemy_attack.gd
@characters/enemies/states/enemy_hurt.gd
@characters/enemies/states/enemy_death.gd
@components/hitbox/hitbox.gd
@autoloads/events.gd
@autoloads/effects_manager.gd
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Shadow Creature + projectile system</name>
  <files>
    characters/enemies/shadow_creature.gd
    characters/enemies/states/shadow_phase.gd
    characters/enemies/states/shadow_ranged_attack.gd
    components/projectile/shadow_bolt.gd
    components/projectile/shadow_bolt.tscn
  </files>
  <action>
**Shadow Bolt Projectile:**

Create directory `components/projectile/` if it doesn't exist.

Create `shadow_bolt.gd`:
- extends Area2D, class_name ShadowBolt
- Properties: speed: float = 120.0, damage: int = 12, lifetime: float = 3.0, direction: Vector2 = Vector2.ZERO
- collision_layer = 128 (enemy hitbox layer), collision_mask = 16 (player hurtbox)
- _ready(): Start lifetime timer. Connect body_entered and area_entered for hit detection. Create visual: a Polygon2D child (small dark purple diamond shape, 4x4, with glow via modulate Color(0.6, 0.2, 0.8, 0.9)). Add a subtle trail effect (spawn fading particles behind it every 0.1s).
- _process(delta): Move position by direction * speed * delta. Destroy after lifetime.
- On hit player hurtbox: Call the hurtbox's hurt signal with a temporary hitbox-like reference (or create a simple damage-dealing mechanism). Simplest: the shadow bolt IS an Area2D with a Hitbox script attached, so it works with the existing hurtbox system. Actually, make ShadowBolt extend Area2D and include a Hitbox child with damage set. When the hitbox's area overlaps a hurtbox, the standard damage system handles it.

Actually simplest approach: Make the shadow_bolt.tscn have:
- Root: Area2D named "ShadowBolt" with shadow_bolt.gd
- Child: A Hitbox Area2D with hitbox.gd, damage=12, always enabled (monitoring=true)
- Collision shape for the hitbox
- Visual Polygon2D

On _ready: Set monitoring to true on the hitbox child.
On body_entered or when hitbox detects hurtbox hit: queue_free (one-hit projectile).
Actually the Hitbox system handles hit detection via area_entered/exited. The shadow bolt just needs to move and contain a hitbox. When the hitbox overlaps a hurtbox, the standard hurt signal fires.

Add `func fire(from_pos: Vector2, target_pos: Vector2)`:
- Set global_position = from_pos
- Set direction = (target_pos - from_pos).normalized()
- Enable monitoring on hitbox child

Create `shadow_bolt.tscn`:
- Root: Node2D named "ShadowBolt", script=shadow_bolt.gd
- Visual: Polygon2D child, color=Color(0.5, 0.1, 0.7, 0.9), polygon diamond shape
- Hitbox: Area2D child, script=hitbox.gd, damage=12, collision_layer=128, collision_mask=16, monitoring=true
- HitboxShape: CollisionShape2D child of Hitbox, CircleShape2D radius=4

In shadow_bolt.gd _process: move the entire node by direction * speed * delta. When hitbox hits something, queue_free. Despawn after lifetime.

**Shadow Creature enemy:**

Create `shadow_creature.gd` extending `"res://characters/enemies/enemy_base.gd"`. class_name ShadowCreature.

Stats:
- HP: 35
- patrol_speed: 25.0 (slow, eerie drift)
- chase_speed: 35.0 (doesn't chase fast — ranged attacker)
- detection_range: 100.0 (long range awareness)
- attack_range: 80.0 (ranged attack distance)
- attack_damage: 12 (via projectile)
- attack_cooldown: 2.0 (between shots)
- knockback_force: 40.0
- exp_value: 40 (tough enemy)

Shadow-specific properties:
- `var phase_timer: float = 0.0`
- `var phase_cycle: float = 4.0` — seconds per full visible/invisible cycle
- `var is_phased_out: bool = false`
- `var teleport_distance: float = 50.0` — how far to teleport on hit
- `const SHADOW_BOLT_SCENE = preload("res://components/projectile/shadow_bolt.tscn")`

Appearance in _ready(): sprite.color = Color(0.15, 0.05, 0.25) (very dark purple). Polygon — amorphous blob shape:
```
sprite.polygon = PackedVector2Array([
    Vector2(-5, -8), Vector2(0, -10), Vector2(5, -8),
    Vector2(8, -2), Vector2(6, 5), Vector2(2, 8),
    Vector2(-2, 8), Vector2(-6, 5), Vector2(-8, -2)
])
```
Add a glow effect: second larger Polygon2D child of sprite with Color(0.3, 0.1, 0.5, 0.3) and slightly larger polygon, creating an aura.

Override `_on_hurt`:
- Call super._on_hurt(attacking_hitbox)
- Then teleport: pick random direction, move global_position by teleport_distance in that direction. Clamp to zone bounds if possible. Add visual effect: spawn particles at old position (purple poof).
- If phased_out when hit, force phase back in (become visible).

Override `_process(delta)`:
- Call super._process(delta)
- Phase cycling: increment phase_timer, toggle visibility every phase_cycle/2 seconds. When phased out: sprite modulate alpha = 0.1, disable hurtbox (can't be hit). When phased in: sprite modulate alpha = 0.85 (slightly translucent always), enable hurtbox.
- Only phase cycle when NOT in attack or hurt state.

_init_default_drops(): 80% chance 2-4 coins (shadows are valuable), 30% health.

Create `shadow_phase.gd` (extends State, class_name ShadowPhase):
- Replaces standard Idle for shadow creatures
- On enter: Start phased out (invisible). Set sprite alpha to 0.1. Disable hurtbox.
- physics_update: Slowly drift in a random direction (patrol_speed * 0.3). Check if target within detection_range. If yes and creature is currently phased IN (visible), transition to "ShadowRangedAttack" if can_attack. If target detected but phased out, start phasing in (tween alpha to 0.85 over 0.5s, enable hurtbox, set is_phased_out = false).
- Phase cycling happens in shadow_creature.gd _process, not in this state.

Create `shadow_ranged_attack.gd` (extends State, class_name ShadowRangedAttack):
- On enter: Stop movement. Face target. Brief charge-up (0.4s): visual = sprite pulses brighter (modulate tween to Color(0.8, 0.3, 1.0) then back). Show charge particles.
- After charge-up: Instantiate shadow_bolt.tscn, call fire(player.global_position, player.target.global_position). Add the bolt to the scene tree (get_tree().current_scene or player.get_parent()).
- Start attack_cooldown.
- After firing (0.5s total duration), transition to "ShadowPhase".
- On exit: nothing special.
  </action>
  <verify>
shadow_bolt.gd and .tscn exist in components/projectile/. shadow_creature.gd has teleport-on-hurt, phase cycling, and ranged attack. shadow_phase.gd handles visibility. shadow_ranged_attack.gd fires shadow bolt projectile.
  </verify>
  <done>
Shadow Creature with phase cycling, ranged shadow bolt, and teleport-on-hurt created. Projectile system established in components/projectile/.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create shadow scene and place in both zones</name>
  <files>
    characters/enemies/shadow_creature.tscn
    world/zones/neighborhood.tscn
    world/zones/backyard.tscn
  </files>
  <action>
Create `shadow_creature.tscn` following raccoon.tscn pattern:
- Root: CharacterBody2D named "ShadowCreature", collision_layer=4, collision_mask=1, script=shadow_creature.gd
- Sprite2D: Polygon2D with amorphous shape, dark purple Color(0.15, 0.05, 0.25)
- GlowAura: Polygon2D child of Sprite2D, larger shape, Color(0.3, 0.1, 0.5, 0.3) — the glow
- CollisionShape2D: CapsuleShape2D radius=6, height=14
- AnimationPlayer: empty
- StateMachine: Node with script=state_machine.gd, initial_state_path="ShadowPhase"
  - ShadowPhase: Node, script=shadow_phase.gd
  - Idle: Node, script=enemy_idle.gd
  - Patrol: Node, script=enemy_patrol.gd
  - Chase: Node, script=enemy_chase.gd (fallback if phase AI breaks)
  - ShadowRangedAttack: Node, script=shadow_ranged_attack.gd
  - Hurt: Node, script=enemy_hurt.gd
  - Death: Node, script=enemy_death.gd
- DetectionArea: Area2D, collision_layer=0, collision_mask=2, CircleShape2D radius=100
- Hitbox: Area2D, collision_layer=128, collision_mask=16, monitoring=false, monitorable=false, script=hitbox.gd, damage=12. Child CollisionShape2D with RectangleShape2D size=Vector2(10, 10), position=Vector2(8, 0), disabled=true
- Hurtbox: Area2D, collision_layer=32, collision_mask=64, script=hurtbox.gd. Child CollisionShape2D with CapsuleShape2D radius=7, height=16
- HealthComponent: Node, script=health_component.gd, max_health=35

IMPORTANT: initial_state is "ShadowPhase" (not "Idle") so shadows start phased out.

Add ShadowCreature instances to BOTH zones:

**neighborhood.tscn**: Add 1 ShadowCreature
- Position ~Vector2(180, 300) near the park area (mysterious shadow in the park)

**backyard.tscn**: Add 1 ShadowCreature
- Position ~Vector2(350, 130) near the edge of the zone (lurking shadow)

These are intentionally sparse (1 per zone) — shadows are rare, mysterious enemies that hint at the deeper threat. More will appear in the Sewers zone (Phase 19).
  </action>
  <verify>
shadow_creature.tscn exists with all required nodes. neighborhood.tscn has 1 ShadowCreature. backyard.tscn has 1 ShadowCreature. Shadows start phased out (invisible), fire projectiles at player, teleport when hit.
  </verify>
  <done>
Shadow Creature scene created. 1 shadow placed in neighborhood (park area), 1 in backyard (zone edge). Shadows phase in/out, fire bolts, and teleport when hit.
  </done>
</task>

</tasks>

<verification>
- All shadow creature files exist under characters/enemies/
- Shadow bolt projectile exists under components/projectile/
- Shadow starts phased out (nearly invisible)
- Shadow phases in periodically and fires shadow bolts
- Shadow bolts travel toward player and deal damage on contact
- Shadow teleports away when hit
- 1 shadow in neighborhood, 1 in backyard
- Shadow death awards 40 EXP and drops loot
- Projectile system is reusable for other ranged enemies
</verification>

<success_criteria>
Shadow Creature functions as a mysterious ranged threat. Players encounter barely-visible shadows that fire projectiles and teleport away when attacked. The shadow bolt projectile system works independently and can be reused. Both zones have shadow encounters that hint at the larger lore threat.
</success_criteria>

<output>
After completion, create `.planning/phases/17-new-enemies/17-03-SUMMARY.md`
</output>
