---
phase: 17-new-enemies
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - characters/enemies/stray_cat.gd
  - characters/enemies/stray_cat.tscn
  - characters/enemies/states/cat_stealth.gd
  - characters/enemies/states/cat_pounce.gd
  - characters/enemies/states/cat_retreat.gd
  - world/zones/neighborhood.tscn
autonomous: true

must_haves:
  truths:
    - "Stray Cat enemy hides (semi-transparent) until player is close"
    - "Stray Cat pounces with a fast lunge attack for high damage"
    - "Stray Cat retreats after attacking and re-enters stealth"
    - "Stray Cats spawn in the neighborhood zone and can be defeated"
  artifacts:
    - path: "characters/enemies/stray_cat.gd"
      provides: "Cat enemy with stealth ambush behavior"
      exports: ["StrayCat"]
    - path: "characters/enemies/stray_cat.tscn"
      provides: "Instantiable cat scene"
    - path: "characters/enemies/states/cat_stealth.gd"
      provides: "Stealth state - invisible approach"
    - path: "characters/enemies/states/cat_pounce.gd"
      provides: "Pounce state - lunge attack"
    - path: "characters/enemies/states/cat_retreat.gd"
      provides: "Retreat state - flee after attack"
  key_links:
    - from: "stray_cat.gd"
      to: "enemy_base.gd"
      via: "extends"
      pattern: 'extends.*enemy_base'
    - from: "stray_cat.tscn"
      to: "StateMachine"
      via: "state nodes"
      pattern: "CatStealth|CatPounce|CatRetreat"
    - from: "neighborhood.tscn"
      to: "stray_cat.tscn"
      via: "instanced child nodes"
---

<objective>
Create the Stray Cat enemy — a stealthy ambusher that hides, pounces from stealth for high damage, then retreats to re-enter stealth. Forces players to stay alert and watch for nearly-invisible threats.

Purpose: First new enemy type for v1.3, introduces stealth mechanic that existing enemies lack.
Output: Fully functional cat enemy placed in the neighborhood zone.
</objective>

<execution_context>
@~/.config/Claude/get-shit-done/workflows/execute-plan.md
@~/.config/Claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@characters/enemies/enemy_base.gd
@characters/enemies/raccoon.gd
@characters/enemies/raccoon.tscn
@characters/enemies/states/enemy_idle.gd
@characters/enemies/states/enemy_chase.gd
@characters/enemies/states/enemy_attack.gd
@characters/enemies/states/enemy_hurt.gd
@characters/enemies/states/enemy_death.gd
@components/state_machine/state_machine.gd
@components/state_machine/state.gd
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Stray Cat enemy with stealth states</name>
  <files>
    characters/enemies/stray_cat.gd
    characters/enemies/states/cat_stealth.gd
    characters/enemies/states/cat_pounce.gd
    characters/enemies/states/cat_retreat.gd
  </files>
  <action>
Create `stray_cat.gd` extending `"res://characters/enemies/enemy_base.gd"` (use path-based extend, NOT class_name — this avoids autoload scope issues seen in Phase 16). Set class_name StrayCat.

Stats:
- HP: 30 (fragile)
- patrol_speed: 20.0 (slow stalk)
- chase_speed: 90.0 (fast pounce)
- detection_range: 60.0
- attack_range: 30.0 (pounce distance)
- attack_damage: 20 (high burst)
- attack_cooldown: 2.5 (slow between attacks)
- knockback_force: 100.0 (strong pounce impact)
- exp_value: 30

Add cat-specific properties:
- `var stealth_alpha: float = 0.15` — transparency when stealthed
- `var is_stealthed: bool = true` — starts in stealth
- `var pounce_speed: float = 200.0` — lunge velocity

Add cat appearance in _ready(): sprite.color = Color(0.85, 0.55, 0.2) (orange/ginger). Override sprite polygon to be cat-shaped (triangle ears on top):
```
sprite.polygon = PackedVector2Array([
    Vector2(-6, -5), Vector2(-4, -9), Vector2(-2, -5),  # left ear
    Vector2(2, -5), Vector2(4, -9), Vector2(6, -5),     # right ear
    Vector2(7, 0), Vector2(5, 7), Vector2(-5, 7), Vector2(-7, 0)  # body
])
```

Add `_init_default_drops()`: 70% chance 1-2 coins, 20% chance health.

Create `cat_stealth.gd` (extends State, class_name CatStealth):
- On enter: Set sprite modulate alpha to stealth_alpha (0.15). Set velocity to zero.
- physics_update: If target detected within detection_range, slowly approach (patrol_speed * 0.5) while staying transparent. If target within attack_range (pounce distance), transition to "CatPounce". If no target, transition to "Idle" after 3 seconds.
- On exit: nothing (pounce handles visibility).

Create `cat_pounce.gd` (extends State, class_name CatPounce):
- On enter: Fully reveal (sprite alpha = 1.0). Calculate lunge direction toward target. Set velocity to direction * pounce_speed. Enable hitbox. Show "!" telegraph above cat (same pattern as enemy_attack.gd). Play a quick squash-stretch animation on sprite.
- physics_update: Timer-based (0.3s total). Hitbox active frames 0.1-0.25. Decelerate velocity. After 0.3s, disable hitbox, start attack_cooldown, transition to "CatRetreat".
- On exit: disable hitbox.

Create `cat_retreat.gd` (extends State, class_name CatRetreat):
- On enter: Calculate direction AWAY from target (or last known position). Set velocity to retreat direction * chase_speed.
- physics_update: Move away for 0.8 seconds. Gradually fade sprite alpha back to stealth_alpha (tween over the retreat duration). After 0.8s, set is_stealthed = true, transition to "CatStealth".
  </action>
  <verify>
All 4 files exist. Each script has correct extends/class_name. cat_stealth.gd has alpha logic. cat_pounce.gd has lunge + hitbox logic. cat_retreat.gd has flee + re-stealth logic.
  </verify>
  <done>
Stray Cat script and 3 custom states created with stealth→pounce→retreat→stealth loop.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create cat scene and place in neighborhood</name>
  <files>
    characters/enemies/stray_cat.tscn
    world/zones/neighborhood.tscn
  </files>
  <action>
Create `stray_cat.tscn` following the exact pattern of raccoon.tscn:
- Root: CharacterBody2D named "StrayCat", collision_layer=4, collision_mask=1, script=stray_cat.gd
- Sprite2D: Polygon2D with cat shape and orange color
- CollisionShape2D: CapsuleShape2D radius=5, height=12 (slightly smaller than raccoon)
- AnimationPlayer: empty
- StateMachine: Node with script=state_machine.gd, initial_state_path="CatStealth"
  - CatStealth: Node, script=cat_stealth.gd
  - Idle: Node, script=enemy_idle.gd (idle_duration=1.0)
  - Patrol: Node, script=enemy_patrol.gd
  - Chase: Node, script=enemy_chase.gd
  - CatPounce: Node, script=cat_pounce.gd
  - CatRetreat: Node, script=cat_retreat.gd
  - Hurt: Node, script=enemy_hurt.gd
  - Death: Node, script=enemy_death.gd
- DetectionArea: Area2D, collision_layer=0, collision_mask=2, CircleShape2D radius=60
- Hitbox: Area2D, collision_layer=128, collision_mask=16, monitoring=false, monitorable=false, script=hitbox.gd, damage=20. Child CollisionShape2D with RectangleShape2D size=Vector2(14, 10), position=Vector2(10, 0), disabled=true
- Hurtbox: Area2D, collision_layer=32, collision_mask=64, script=hurtbox.gd. Child CollisionShape2D with CapsuleShape2D radius=6, height=14
- HealthComponent: Node, script=health_component.gd, max_health=30

IMPORTANT: initial_state is "CatStealth" (not "Idle") so cats start hidden.

Add 2 StrayCat instances to neighborhood.tscn:
- Instance 1: position ~Vector2(300, 400) near the stores area
- Instance 2: position ~Vector2(550, 200) near the road

Verify the .tscn parses without errors by checking node structure.
  </action>
  <verify>
stray_cat.tscn exists with all required nodes. neighborhood.tscn has 2 StrayCat instances. Open Godot and verify cats appear semi-transparent, pounce at player, and retreat to re-stealth. `grep -r "StrayCat" world/zones/neighborhood.tscn` returns matches.
  </verify>
  <done>
Stray Cat scene created and 2 cats placed in neighborhood zone. Cats start stealthed, ambush player, retreat, re-stealth.
  </done>
</task>

</tasks>

<verification>
- All stray cat files exist under characters/enemies/
- Cat starts in stealth (semi-transparent)
- Cat approaches player while stealthed
- Cat pounces with lunge attack when close
- Cat retreats and re-enters stealth after attacking
- 2 cats spawn in neighborhood zone
- Cat can be defeated (drops coins/health)
- Cat integrates with existing damage/health/EXP systems
</verification>

<success_criteria>
Stray Cat enemy functions as a stealth ambusher in the neighborhood zone. Players must watch for barely-visible cats that pounce for high damage then retreat. Cat death awards EXP and drops loot.
</success_criteria>

<output>
After completion, create `.planning/phases/17-new-enemies/17-01-SUMMARY.md`
</output>
