---
phase: 38-rooftop-encounters
plan: 02
type: execute
wave: 1
depends_on: []
files_modified: [world/zones/rooftops.gd]
autonomous: true

must_haves:
  truths:
    - "Enemies spawn in waves as player progresses through platforms, not all at once"
    - "Each platform area has escalating difficulty from Entry (easy) to Boss Overlook (hard)"
    - "Player sees announcement text when entering a new platform encounter area"
    - "Boss Overlook guards don't spawn until Sentry Ridge is reached"
  artifacts:
    - path: "world/zones/rooftops.gd"
      provides: "Wave-based encounter spawning with platform triggers"
      contains: "_spawn_wave_"
  key_links:
    - from: "world/zones/rooftops.gd"
      to: "Area2D triggers on walkways"
      via: "body_entered signal spawns next wave"
      pattern: "_on_wave_.*_trigger"
---

<objective>
Convert the Rooftops zone from static all-at-once enemy spawning to wave-based encounters that trigger as the player progresses across platforms. Add encounter announcements and tune difficulty escalation.

Purpose: Static spawning means all ~20 enemies exist simultaneously, which is overwhelming and doesn't create a sense of progression through the zone. Wave-based spawning gives each platform its own encounter, building tension toward the Pigeon King fight.

Output: Updated rooftops.gd with wave triggers, encounter announcements, and tuned difficulty per platform.
</objective>

<context>
@docs/PROJECT.md
@docs/ROADMAP.md
@world/zones/rooftops.gd
@characters/enemies/pigeon.gd
@characters/enemies/gnome.gd
@characters/enemies/roof_rat.gd
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wave-Based Encounter System</name>
  <files>world/zones/rooftops.gd</files>
  <action>
  Refactor `_build_enemies()` in rooftops.gd to use wave-based spawning with platform triggers:

  1. **Replace `_build_enemies()` with `_build_wave_triggers()`.**
     Remove the current `_build_enemies()` function (lines 563-642) and the `_build_enemies()` call
     in `_setup_zone()` (line 105). Replace with `_build_wave_triggers()` call.

     The new system:
     - Entry Platform enemies still spawn immediately (warm-up/tutorial area)
     - Walkway 1 has a trigger Area2D that spawns Central Rooftop enemies
     - Walkway 2 has a trigger Area2D that spawns Sentry Ridge enemies
     - Walkway 3 has a trigger Area2D that spawns Boss Overlook guard

  2. **Add wave state tracking variables** near the spawn_points section (after line 40):
     ```
     # Wave encounter state
     var _wave_central_spawned: bool = false
     var _wave_ridge_spawned: bool = false
     var _wave_boss_spawned: bool = false
     var _enemies_container: Node2D = null
     ```

  3. **Implement `_build_wave_triggers()`:**
     ```
     func _build_wave_triggers() -> void:
         # Create shared enemies container
         _enemies_container = Node2D.new()
         _enemies_container.name = "Enemies"
         add_child(_enemies_container)

         # Entry Platform — spawn immediately (warm-up area)
         _spawn_wave_entry()

         # Wave triggers at walkway entrances
         _create_wave_trigger("WaveTrigger_Central", walkways[0].position + walkways[0].size / 2, Vector2(60, 60), _on_wave_central_trigger)
         _create_wave_trigger("WaveTrigger_Ridge", walkways[1].position + walkways[1].size / 2, Vector2(60, 60), _on_wave_ridge_trigger)
         _create_wave_trigger("WaveTrigger_Boss", walkways[2].position + walkways[2].size / 2, Vector2(50, 50), _on_wave_boss_trigger)

         DebugLogger.log_zone("Rooftops wave triggers placed (3 triggers + entry enemies)")
     ```

  4. **Implement `_create_wave_trigger()` helper:**
     ```
     func _create_wave_trigger(trigger_name: String, pos: Vector2, trigger_size: Vector2, callback: Callable) -> void:
         var trigger = Area2D.new()
         trigger.name = trigger_name
         trigger.collision_layer = 0
         trigger.collision_mask = 2  # Player layer
         trigger.position = pos
         add_child(trigger)

         var shape = CollisionShape2D.new()
         var rect = RectangleShape2D.new()
         rect.size = trigger_size
         shape.shape = rect
         trigger.add_child(shape)

         trigger.body_entered.connect(callback)
     ```

  5. **Implement wave spawn functions — each spawns enemies for its platform:**

     `_spawn_wave_entry()` — spawns immediately:
     - 1 pigeon flock of 3 at Vector2(100, 420)
     - 1 roof rat at Vector2(160, 430)
     - Show announcement: "ENTRY PLATFORM" (subtle, fades quickly)

     `_on_wave_central_trigger(body)` — when player crosses walkway 1:
     - Guard: `if not body.is_in_group("player") or _wave_central_spawned: return`
     - Set `_wave_central_spawned = true`
     - Spawn: 1 pigeon flock of 5 at Vector2(400, 340), 2 gnomes at Vector2(350, 310) and Vector2(500, 380), 2 roof rats at Vector2(320, 360) and Vector2(480, 330)
     - Show announcement: "CENTRAL ROOFTOP"
     - Free the trigger node

     `_on_wave_ridge_trigger(body)` — when player crosses walkway 2:
     - Guard: `if not body.is_in_group("player") or _wave_ridge_spawned: return`
     - Set `_wave_ridge_spawned = true`
     - Spawn: 2 gnomes at Vector2(700, 230) and Vector2(820, 260), 1 pigeon flock of 4 at Vector2(750, 280), 1 roof rat at Vector2(870, 240)
     - Show announcement: "SENTRY RIDGE"
     - Free the trigger node

     `_on_wave_boss_trigger(body)` — when player crosses walkway 3:
     - Guard: `if not body.is_in_group("player") or _wave_boss_spawned: return`
     - Set `_wave_boss_spawned = true`
     - Spawn: 1 roof rat at Vector2(980, 310) — light guard before mini-boss
     - Show announcement: "BOSS OVERLOOK"
     - Free the trigger node

     These use the same positions and enemy counts as the original _build_enemies(), just deferred.

  6. **Implement `_show_encounter_announcement(text: String)`:**
     Creates a centered Label that fades in, holds, then fades out (2.5s total).
     ```
     func _show_encounter_announcement(text: String) -> void:
         var label = Label.new()
         label.name = "Announcement"
         label.text = text
         label.add_theme_font_size_override("font_size", 14)
         label.add_theme_color_override("font_color", Color(0.95, 0.85, 0.5))
         label.horizontal_alignment = HORIZONTAL_ALIGNMENT_CENTER
         label.position = Vector2(zone_size.x / 2 - 80, 20)
         label.size = Vector2(160, 30)
         label.modulate.a = 0.0
         label.z_index = 100
         add_child(label)

         var tween = create_tween()
         tween.tween_property(label, "modulate:a", 1.0, 0.3)
         tween.tween_interval(1.5)
         tween.tween_property(label, "modulate:a", 0.0, 0.7)
         tween.tween_callback(label.queue_free)
     ```

  7. **Update `_setup_zone()`** to call `_build_wave_triggers()` instead of `_build_enemies()`.
     Change line 105 from `_build_enemies()` to `_build_wave_triggers()`.

  Important conventions:
  - Use tabs for indentation (match existing file)
  - Use DebugLogger.log_zone() for logging
  - Use preloaded GNOME_SCENE, ROOF_RAT_SCENE constants (already defined)
  - Use Events.create_pigeon_flock() for pigeon flocks (already imported)
  - Add spawned enemies to `_enemies_container` (not direct `add_child`)
  - Do NOT use class_name in this file (it doesn't have one — correct)
  - Do NOT modify the mini-boss trigger (_build_mini_boss_trigger remains unchanged)
  </action>
  <verify>
  - Grep for "_build_enemies" — should NOT appear (replaced by wave system)
  - Grep for "_build_wave_triggers" — should appear in _setup_zone and function definition
  - Grep for "_on_wave_central_trigger" — should appear as callback and function
  - Grep for "_show_encounter_announcement" — should appear with label creation
  - Count "Events.create_pigeon_flock" calls — should be 3 (same as before: entry, central, ridge)
  - Verify _build_mini_boss_trigger still exists unchanged
  </verify>
  <done>
  Enemies spawn in waves as player progresses: Entry (immediate) → Central (walkway 1 trigger) → Sentry Ridge (walkway 2 trigger) → Boss Overlook (walkway 3 trigger). Each wave shows a gold encounter announcement that fades in/out. Same total enemy count as before (~20), just deferred. Mini-boss trigger remains unchanged.
  </done>
</task>

</tasks>

<verification>
- `grep -n "_build_wave_triggers\|_spawn_wave_\|_on_wave_\|_show_encounter" world/zones/rooftops.gd` shows all wave system functions
- `grep -c "create_pigeon_flock" world/zones/rooftops.gd` returns 3 (entry, central, ridge flocks)
- `grep -n "_build_enemies" world/zones/rooftops.gd` returns NO results (old function removed)
- `grep -n "_build_mini_boss_trigger" world/zones/rooftops.gd` still exists
- No syntax errors in the file
</verification>

<success_criteria>
Rooftops zone uses wave-based encounter spawning. Entry platform has enemies on arrival. Central, Sentry Ridge, and Boss Overlook enemies spawn only when player crosses the connecting walkway. Gold announcement text appears for each area. Total enemy count unchanged. Mini-boss trigger unaffected.
</success_criteria>

<output>
After completion, create `.planning/phases/38-rooftop-encounters/38-02-SUMMARY.md`
</output>
