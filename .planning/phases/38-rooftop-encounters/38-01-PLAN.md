---
phase: 38-rooftop-encounters
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [autoloads/auto_bot.gd]
autonomous: true

must_haves:
  truths:
    - "AutoBot navigates to Rooftops zone as part of its game loop progression"
    - "AutoBot fights enemies and clears Rooftops before progressing to boss"
    - "AutoBot patrols across all 4 Rooftops platforms instead of grid wandering"
    - "AutoBot uses rooftops mini-boss trigger correctly"
  artifacts:
    - path: "autoloads/auto_bot.gd"
      provides: "Rooftops zone awareness in game loop AI"
      contains: "rooftops"
  key_links:
    - from: "autoloads/auto_bot.gd"
      to: "world/zones/rooftops.gd"
      via: "_get_next_zone() returns 'rooftops'"
      pattern: "rooftops"
---

<objective>
Add Rooftops zone awareness to the AutoBot's game loop AI so it can navigate to, fight through, and clear the Rooftops zone as part of its automated play-through progression.

Purpose: The AutoBot currently only knows neighborhood → backyard → sewers → boss_arena. Rooftops is a new zone between backyard/sewers and the endgame that needs to be part of the progression chain. Without this, the AutoBot will never visit Rooftops.

Output: Updated auto_bot.gd with Rooftops in the zone progression, platform-based patrol, and level gating.
</objective>

<context>
@docs/PROJECT.md
@docs/ROADMAP.md
@autoloads/auto_bot.gd
@world/zones/rooftops.gd
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Rooftops to AutoBot Game Loop Progression</name>
  <files>autoloads/auto_bot.gd</files>
  <action>
  Modify auto_bot.gd to integrate the Rooftops zone into the game loop:

  1. Add constant near line 107 (after MIN_LEVEL_FOR_BOSS):
     ```
     const MIN_LEVEL_FOR_ROOFTOPS: int = 4   # Don't enter rooftops below level 4
     ```

  2. Update `_get_next_zone()` (line ~1781) to include rooftops in the progression chain:
     ```
     func _get_next_zone(current_zone: String, level: int) -> String:
         match current_zone:
             "neighborhood":
                 if level >= MIN_LEVEL_FOR_ROOFTOPS:
                     return "rooftops"
                 return "backyard"
             "backyard":
                 if level >= MIN_LEVEL_FOR_ROOFTOPS:
                     return "rooftops"
                 elif level >= MIN_LEVEL_FOR_SEWERS:
                     return "sewers"
                 else:
                     return "neighborhood"
             "rooftops":
                 if level >= MIN_LEVEL_FOR_BOSS:
                     return "sewers"  # Sewers leads to boss_arena
                 else:
                     return "neighborhood"  # Go back to farm
             "sewers":
                 if level >= MIN_LEVEL_FOR_BOSS:
                     return "boss_arena"
                 else:
                     return "neighborhood"
             "boss_arena":
                 return ""
             _:
                 return "neighborhood"
     ```
     
     The progression is now: neighborhood → backyard → rooftops → sewers → boss_arena.
     The bot can also go neighborhood → rooftops directly at level 4+.

  3. Update `_game_loop_clear()` (line ~1726) to handle rooftops zone clearing:
     Add a case for rooftops between the backyard and sewers cases:
     ```
     elif zone_id == "rooftops":
         # Move to sewers after clearing rooftops
         game_loop_state = GameLoopState.TRAVERSE
         DebugLogger.log_bot("GameLoop: CLEAR → TRAVERSE (rooftops cleared)")
     ```

  4. Add platform-based patrol point generation for rooftops.
     Add a new helper method after `_generate_corridor_patrol_points()` (line ~1336):
     ```
     ## Generate patrol points at the center of each rooftop platform
     func _generate_platform_patrol_points() -> Array[Vector2]:
         var points: Array[Vector2] = []
         if "platforms" in current_zone_ref:
             var plats: Array = current_zone_ref.platforms
             for plat in plats:
                 # Center of each platform
                 points.append(plat.position + plat.size / 2.0)
             # Also add walkway midpoints for traversal
             if "walkways" in current_zone_ref:
                 var walks: Array = current_zone_ref.walkways
                 for walk in walks:
                     points.append(walk.position + walk.size / 2.0)
         return points
     ```

  5. Update `_generate_patrol_points()` (line ~1290) to detect rooftops platform layout.
     After the corridor_segments check (line ~1294), add:
     ```
     # Check if zone has platforms (rooftops-style layout)
     if "platforms" in current_zone_ref:
         return _generate_platform_patrol_points()
     ```

  6. Update `_game_loop_boss()` (line ~1754) to also accept coming from rooftops:
     Currently checks `zone_id != "sewers" and zone_id != "boss_arena"`. The bot should navigate
     to sewers from rooftops. This already works via `_get_next_zone()` returning "sewers" from
     rooftops, so no change needed here — just verify the flow works.

  Important: Do NOT change the file's existing indentation style (tabs). Do NOT add class_name.
  Do NOT use bare print() — use DebugLogger.log_bot() for any new logging.
  </action>
  <verify>
  - Search auto_bot.gd for "rooftops" — should appear in _get_next_zone, _game_loop_clear, and patrol generation
  - Search for MIN_LEVEL_FOR_ROOFTOPS constant
  - Verify _generate_patrol_points checks for "platforms" property
  - Verify no syntax errors: `grep -n "func " autoloads/auto_bot.gd` shows all functions parsed
  </verify>
  <done>
  AutoBot's game loop progression includes rooftops: neighborhood → backyard → rooftops → sewers → boss_arena.
  AutoBot patrols rooftops using platform centers instead of grid points.
  AutoBot clears rooftops before moving to sewers/boss.
  Level 4+ required to enter rooftops.
  </done>
</task>

</tasks>

<verification>
- `grep -n "rooftops" autoloads/auto_bot.gd` shows references in _get_next_zone, _game_loop_clear, and patrol
- `grep -n "MIN_LEVEL_FOR_ROOFTOPS" autoloads/auto_bot.gd` shows the constant
- `grep -n "_generate_platform_patrol_points" autoloads/auto_bot.gd` shows the new helper
- No syntax errors in the file
</verification>

<success_criteria>
AutoBot can autonomously navigate to Rooftops, fight through all 4 platforms, and progress to sewers/boss after clearing. Platform-based patrol ensures it explores the full zone instead of wandering off platforms.
</success_criteria>

<output>
After completion, create `.planning/phases/38-rooftop-encounters/38-01-SUMMARY.md`
</output>
