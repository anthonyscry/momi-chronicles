---
phase: 28-bug-fixes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - systems/inventory/inventory.gd
  - characters/enemies/states/boss_attack_summon.gd
  - world/zones/base_zone.gd
autonomous: true

must_haves:
  truths:
    - "Using Revival Bone from ring menu revives a knocked-out companion with 50% HP"
    - "Using Antidote from ring menu clears active poison (DoT stops, green tint removed)"
    - "Boss summon state uses preload() — no frame stutter when Raccoon King summons"
    - "Enemy respawn uses cached PackedScene — no runtime load() stutter"
  artifacts:
    - path: "systems/inventory/inventory.gd"
      provides: "Working REVIVE and CURE_STATUS item effects"
      contains: "revive_companion"
    - path: "characters/enemies/states/boss_attack_summon.gd"
      provides: "Preloaded raccoon scene for boss summon"
      contains: "preload"
    - path: "world/zones/base_zone.gd"
      provides: "Cached PackedScene for enemy respawn"
      contains: "scene_resource"
  key_links:
    - from: "systems/inventory/inventory.gd"
      to: "systems/party/party_manager.gd"
      via: "GameManager.party_manager.revive_companion()"
      pattern: "party_manager\\.revive_companion"
    - from: "systems/inventory/inventory.gd"
      to: "components/health/health_component.gd"
      via: "clear_poison() method call"
      pattern: "clear_poison"
    - from: "characters/enemies/states/boss_attack_summon.gd"
      to: "res://characters/enemies/raccoon.tscn"
      via: "const preload at top of file"
      pattern: "RACCOON_SCENE.*preload"
    - from: "world/zones/base_zone.gd"
      to: "enemy_spawn_data/original_enemy_configs"
      via: "scene_resource key in config dict"
      pattern: "scene_resource"
---

<objective>
Fix all 3 confirmed player-facing bugs and 1 tech debt item from the v1.5 codebase audit.

Purpose: Items must work correctly when used from the ring menu (BUG-01 revival, BUG-02 antidote), and scene loading must use preload/caching to prevent frame stutters (BUG-03 boss summon, DEBT-01 enemy respawn).

Output: 3 modified files with all 4 issues resolved.
</objective>

<execution_context>
@~/.config/Claude/get-shit-done/workflows/execute-plan.md
@~/.config/Claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md

@systems/inventory/inventory.gd
@systems/party/party_manager.gd
@autoloads/game_manager.gd
@components/health/health_component.gd
@characters/enemies/states/boss_attack_summon.gd
@world/zones/base_zone.gd
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix Revival Bone and Antidote item effects</name>
  <files>systems/inventory/inventory.gd</files>
  <action>
  Fix two bugs in `_apply_item_effect()`:

  **BUG-01 — Revival Bone (lines 174-180):**
  Replace the REVIVE stub with a working implementation:
  1. Access `GameManager.party_manager` (it's a child node of GameManager autoload, always available after _ready)
  2. Find the first knocked-out companion by iterating `GameManager.party_manager.knocked_out` dictionary keys
  3. Call `GameManager.party_manager.revive_companion(companion_id, value)` where `value` is the item's heal percent (0.5 for Revival Bone per ItemDatabase)
  4. If no companion is knocked out, return `false` (item should NOT be consumed)
  5. If revival succeeds, return `true`

  The replacement code for the REVIVE match branch should be:
  ```gdscript
  ItemDatabase.EffectType.REVIVE:
      # Revive first knocked-out companion
      if GameManager.party_manager:
          var knocked = GameManager.party_manager.knocked_out
          if knocked.is_empty():
              return false  # No one to revive — don't consume item
          var companion_id = knocked.keys()[0]
          GameManager.party_manager.revive_companion(companion_id, value)
          _spawn_buff_effect(target, Color(1.0, 0.95, 0.5))  # Gold glow
          return true
      return false
  ```

  **BUG-02 — Antidote (line 156):**
  Change `hp.has_method("cure_poison")` to `hp.has_method("clear_poison")` and change `hp.cure_poison()` to `hp.clear_poison()`.
  The method on HealthComponent is named `clear_poison()` (line 178 of health_component.gd), NOT `cure_poison()`.

  Do NOT change anything else in the file. The buff system, heal system, smoke bomb, etc. all work correctly.
  </action>
  <verify>
  1. Grep inventory.gd for "clear_poison" — must appear (not "cure_poison")
  2. Grep inventory.gd for "revive_companion" — must appear in REVIVE branch
  3. Grep inventory.gd for "return true" in REVIVE branch — stub removed
  4. Grep inventory.gd for "knocked_out.is_empty" — guard against wasting item
  5. Confirm no other lines changed: `git diff systems/inventory/inventory.gd` should only show the REVIVE block and the cure_poison→clear_poison rename
  </verify>
  <done>
  - REVIVE effect finds first knocked-out companion and calls party_manager.revive_companion()
  - REVIVE returns false (doesn't consume item) when no companion is knocked out
  - CURE_STATUS effect calls clear_poison() matching health_component.gd method name
  - All other item effects unchanged
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix preload issues in boss summon and enemy respawn</name>
  <files>characters/enemies/states/boss_attack_summon.gd, world/zones/base_zone.gd</files>
  <action>
  Fix two preload/caching issues:

  **BUG-03 — boss_attack_summon.gd (line 41):**
  1. Add a const preload at the top of the file (after the class variables, before `enter()`):
     ```gdscript
     const RACCOON_SCENE: PackedScene = preload("res://characters/enemies/raccoon.tscn")
     ```
  2. Replace line 41 (`var raccoon_scene = load("res://characters/enemies/raccoon.tscn")`) with:
     ```gdscript
     var raccoon_scene = RACCOON_SCENE
     ```
  3. The rest of `_do_summon()` stays the same — it already uses `raccoon_scene.instantiate()`.

  **DEBT-01 — base_zone.gd respawn system (lines 206-219, 299-323):**
  Cache the PackedScene resource during `_capture_enemy_spawn_data()` so `_respawn_enemy()` doesn't need runtime `load()`.

  In `_capture_enemy_spawn_data()` (around line 214), add a `"scene_resource"` key to each config dict:
  ```gdscript
  var config = {
      "scene_path": enemy.scene_file_path,
      "scene_resource": load(enemy.scene_file_path),  # Cache at zone init (not hot path)
      "position": enemy.global_position,
      "name": enemy.name
  }
  ```
  Note: `load()` here is fine because `_capture_enemy_spawn_data()` runs once during `_ready()`, not in a hot path. This caches the resource for later use.

  In `_respawn_enemy()` (around line 307), replace the runtime load with cached lookup:
  ```gdscript
  # Use cached scene resource from capture
  var enemy_scene = null
  for config in original_enemy_configs:
      if config.scene_path == scene_path:
          enemy_scene = config.get("scene_resource")
          break
  
  if not enemy_scene:
      push_warning("No cached scene for: %s" % scene_path)
      return
  ```
  This replaces the `var enemy_scene = load(scene_path)` call that previously ran every respawn tick.

  Also propagate the scene_resource through the respawn death tracking. In `_on_enemy_died()` (around line 243), add `"scene_resource"` to spawn_entry:
  ```gdscript
  var spawn_entry = {
      "scene_path": config.scene_path,
      "scene_resource": config.get("scene_resource"),
      "position": config.position,
      "death_time": Time.get_ticks_msec() / 1000.0,
      "name": config.name
  }
  ```

  And update `_respawn_enemy()` to prefer the spawn_entry's own scene_resource before falling back to config lookup:
  ```gdscript
  var enemy_scene = spawn_entry.get("scene_resource")
  if not enemy_scene:
      # Fallback: find in original configs
      for config in original_enemy_configs:
          if config.scene_path == scene_path:
              enemy_scene = config.get("scene_resource")
              break
  
  if not enemy_scene:
      push_warning("No cached scene for: %s" % scene_path)
      return
  ```

  Similarly in `_on_respawned_enemy_died()`, propagate scene_resource:
  ```gdscript
  var spawn_entry = {
      "scene_path": original_spawn.scene_path,
      "scene_resource": original_spawn.get("scene_resource"),
      "position": original_spawn.position,
      "death_time": Time.get_ticks_msec() / 1000.0,
      "name": original_spawn.name
  }
  ```
  </action>
  <verify>
  1. Grep boss_attack_summon.gd for "preload" — must find RACCOON_SCENE const
  2. Grep boss_attack_summon.gd for `= load(` — must NOT find any (no runtime load)
  3. Grep base_zone.gd `_respawn_enemy` function for `= load(` — must NOT find runtime load in respawn path
  4. Grep base_zone.gd for "scene_resource" — must appear in capture, death, and respawn functions
  5. `git diff` both files to confirm changes are minimal and correct
  </verify>
  <done>
  - Boss summon uses preloaded const RACCOON_SCENE — zero frame stutter on summon
  - Enemy respawn uses cached PackedScene from zone init — zero stutter on respawn
  - Scene resource propagated through death→respawn cycle
  - No runtime load() calls remain in hot paths
  </done>
</task>

</tasks>

<verification>
After both tasks complete:
1. `grep -n "cure_poison" systems/inventory/inventory.gd` → 0 results (method name fixed)
2. `grep -n "clear_poison" systems/inventory/inventory.gd` → appears in CURE_STATUS branch
3. `grep -n "revive_companion" systems/inventory/inventory.gd` → appears in REVIVE branch
4. `grep -n "= load(" characters/enemies/states/boss_attack_summon.gd` → 0 results
5. `grep -n "preload" characters/enemies/states/boss_attack_summon.gd` → RACCOON_SCENE const
6. `grep -n "scene_resource" world/zones/base_zone.gd` → multiple hits (capture, death, respawn)
7. `grep -rn "= load(" world/zones/base_zone.gd` → only in `_capture_enemy_spawn_data` (init-time, acceptable)
</verification>

<success_criteria>
- BUG-01: Revival Bone from ring menu revives first knocked-out companion with 50% HP, or is not consumed if no one is knocked out
- BUG-02: Antidote from ring menu calls clear_poison() on HealthComponent, stopping DoT and clearing green tint
- BUG-03: Boss summon state uses const preload — no frame stutter when Raccoon King summons minions
- DEBT-01: Enemy respawn system uses cached PackedScene from zone init — no runtime load() in hot paths
- Requirements covered: BUG-01, BUG-02, BUG-03, DEBT-01
</success_criteria>

<output>
After completion, create `.planning/phases/28-bug-fixes/28-01-SUMMARY.md`
</output>
