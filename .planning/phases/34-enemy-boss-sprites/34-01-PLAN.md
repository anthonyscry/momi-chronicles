---
phase: 34-enemy-boss-sprites
plan: 01
type: execute
wave: 2
depends_on: ["32-01"]
files_modified:
  - characters/enemies/enemy_base.gd
  - characters/enemies/raccoon.tscn
  - characters/enemies/raccoon.gd
  - characters/enemies/crow.tscn
  - characters/enemies/crow.gd
  - characters/enemies/stray_cat.tscn
  - characters/enemies/stray_cat.gd
  - characters/enemies/sewer_rat.tscn
  - characters/enemies/sewer_rat.gd
  - characters/enemies/shadow_creature.tscn
  - characters/enemies/shadow_creature.gd
autonomous: true

must_haves:
  truths:
    - "All 5 regular enemy types display as pixel art sprites instead of colored squares"
    - "Enemy AI behavior is unchanged — sprite swap is visual only"
    - "Damage flash still visible on all enemies when hit"
    - "Enemy death still triggers visual effects"
  artifacts:
    - path: "characters/enemies/enemy_base.gd"
      provides: "AnimatedSprite2D compatible flash_damage and visual feedback"
      contains: "modulate"
    - path: "characters/enemies/raccoon.tscn"
      provides: "Raccoon with sprite-based visuals"
      contains: "AnimatedSprite2D"
  key_links:
    - from: "characters/enemies/enemy_base.gd"
      to: "AnimatedSprite2D"
      via: "flash_damage uses modulate instead of color"
      pattern: "sprite\\.modulate"
---

<objective>
Replace all 5 regular enemy Polygon2D placeholders with AnimatedSprite2D using generated pixel art. Fix enemy_base.gd visual feedback to work with new sprite type.

Purpose: Enemies are the most frequently seen NPCs. Replacing colored squares with sprites transforms combat encounters visually.
Output: All regular enemies (raccoon, crow, stray cat, sewer rat, shadow creature) display as sprites.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/32-player-sprites/32-01-SUMMARY.md
@characters/enemies/enemy_base.gd
@characters/enemies/raccoon.tscn
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace Polygon2D with AnimatedSprite2D in all 5 enemy scenes</name>
  <files>
    characters/enemies/raccoon.tscn
    characters/enemies/crow.tscn
    characters/enemies/stray_cat.tscn
    characters/enemies/sewer_rat.tscn
    characters/enemies/shadow_creature.tscn
  </files>
  <action>
  Apply the same conversion pattern from Phase 32 to each enemy scene.

  **For each enemy .tscn:**
  1. Remove the `Polygon2D` node named `Sprite2D`
  2. Add `AnimatedSprite2D` node named `Sprite2D`
  3. Create `SpriteFrames` with enemy-specific animations:

  **Raccoon** (`raccoon.tscn`):
  - `idle` — `art/generated/enemies/raccoon_idle.png`
  - `attack` — `art/generated/enemies/raccoon_attack.png`

  **Crow** (`crow.tscn`):
  - `idle` — `art/generated/enemies/crow_idle.png`
  - `dive` — `art/generated/enemies/crow_dive.png`

  **Stray Cat** (`stray_cat.tscn`):
  - `idle` — `art/generated/enemies/stray_cat_idle.png`
  - `pounce` — `art/generated/enemies/stray_cat_pounce.png`
  - `stealth` — `art/generated/enemies/stray_cat_stealth.png`

  **Sewer Rat** (`sewer_rat.tscn`):
  - `idle` — `art/generated/enemies/sewer_rat_idle.png`
  - Note: Sewer Rat has a custom 7-vertex polygon (rat-shaped). Replace entirely with the sprite. Remove the custom scale=0.8.

  **Shadow Creature** (`shadow_creature.tscn`):
  - `idle` — `art/generated/enemies/shadow_creature_idle.png`

  **Collision sizes:** Enemies had 12-14px collision shapes. With 32x32 sprites, check if collision needs enlarging. The collision should cover roughly the lower 2/3 of the sprite (feet area for 3/4 perspective).
  </action>
  <verify>
  - Grep all 5 enemy .tscn files for `Polygon2D` — zero matches
  - Each .tscn has AnimatedSprite2D with correct animations
  </verify>
  <done>All 5 enemy scenes use AnimatedSprite2D with generated sprite textures, no Polygon2D nodes remain</done>
</task>

<task type="auto">
  <name>Task 2: Fix enemy_base.gd and state scripts for AnimatedSprite2D</name>
  <files>
    characters/enemies/enemy_base.gd
    characters/enemies/raccoon.gd
    characters/enemies/crow.gd
    characters/enemies/stray_cat.gd
    characters/enemies/sewer_rat.gd
    characters/enemies/shadow_creature.gd
  </files>
  <action>
  **In enemy_base.gd:**
  1. Change sprite type: `@onready var sprite: Polygon2D = $Sprite2D` → `@onready var sprite: AnimatedSprite2D = $Sprite2D`
  2. Fix `flash_damage()` (line ~286-291):
     ```gdscript
     func flash_damage() -> void:
         sprite.modulate = Color(1, 0.3, 0.3, 1)
         await get_tree().create_timer(0.1).timeout
         if is_instance_valid(self) and sprite:
             sprite.modulate = Color.WHITE
     ```
     (Replace `sprite.color` with `sprite.modulate`, reset to `Color.WHITE` not original_color)
  3. Fix stun visual: `sprite.modulate = Color(0.7, 0.7, 1.0)` — already uses modulate, should be fine
  4. Fix knockback sprite pop: `sprite.position` tween — still works on AnimatedSprite2D
  5. Fix any facing code: `sprite.scale.x = -1` → `sprite.flip_h = true`
  6. Add `sprite.play("idle")` in `_ready()`

  **In each enemy's individual .gd script:**
  - Add animation switches in state enter functions:
    - **Raccoon states:** Chase/Patrol → `sprite.play("idle")`, Attack → `sprite.play("attack")`
    - **Crow states:** idle → `sprite.play("idle")`, Attack/Dive → `sprite.play("dive")`
    - **Stray Cat states:** idle/patrol → `sprite.play("idle")`, Stealth → `sprite.play("stealth")`, Pounce → `sprite.play("pounce")`
    - **Sewer Rat states:** idle → `sprite.play("idle")` (only has idle sprite)
    - **Shadow Creature states:** all → `sprite.play("idle")` (only has idle sprite; bolt is a separate projectile scene)
  - Replace any `sprite.color` with `sprite.modulate`
  - Replace any `sprite.scale.x = -1` with `sprite.flip_h = true`

  **Shadow Creature phase in/out:**
  The shadow creature phases in/out of visibility. This is likely done via `sprite.modulate.a` (alpha) or `sprite.visible`. Ensure this still works with AnimatedSprite2D (it should — modulate.a works the same way).

  **Do NOT change:**
  - Enemy AI (detection, chasing, patrol paths)
  - Damage values, health, drop tables
  - Spawn logic
  </action>
  <verify>
  - Run the game, encounter each enemy type — all show as sprites
  - Hit enemies — red damage flash visible
  - Kill enemies — death effect plays, drops spawn
  - Stray cat enters stealth — visual changes
  - Shadow creature phases — transparency works
  - Grep enemy_base.gd for `\.color\s*=` — zero matches
  </verify>
  <done>enemy_base.gd uses AnimatedSprite2D compatible code, all 5 enemy scripts switch animations per state, visual feedback preserved</done>
</task>

</tasks>

<verification>
1. Walk through all 3 zones — every enemy type displays as a sprite
2. Combat with each enemy works: hit detection, damage, knockback, death
3. Stray cat stealth visual is distinct from idle
4. Crow dive attack has visual change
5. Shadow creature phase effect still works
6. `grep -r "Polygon2D" characters/enemies/*.gd` returns zero matches
</verification>

<success_criteria>
- All 5 enemy types display as sprites with state-appropriate visuals
- Enemy AI unchanged — no behavioral regression
- Damage flash and death effects still work
- Zero Polygon2D references in enemy scenes/scripts
</success_criteria>

<output>
After completion, create `.planning/phases/34-enemy-boss-sprites/34-01-SUMMARY.md`
</output>
