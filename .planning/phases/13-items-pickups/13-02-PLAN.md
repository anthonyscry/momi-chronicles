---
phase: 13-items-pickups
plan: 02
type: execute
wave: 2
depends_on: ["13-01"]
files_modified:
  - components/pickup/coin_pickup.gd
  - components/pickup/coin_pickup.tscn
  - autoloads/game_manager.gd
  - autoloads/events.gd
  - characters/enemies/enemy_base.gd
  - characters/enemies/raccoon.gd
  - characters/enemies/crow.gd
  - characters/enemies/boss_raccoon_king.gd
  - assets/audio/sfx/coin.wav
  - autoloads/audio_manager.gd
autonomous: true

must_haves:
  truths:
    - "Coins can be collected and counted"
    - "Enemies drop both coins and health on death"
    - "Different enemies have different drop tables"
    - "Coins persist in GameManager"
  artifacts:
    - path: "components/pickup/coin_pickup.gd"
      provides: "Currency pickup"
      exports: ["CoinPickup"]
    - path: "characters/enemies/enemy_base.gd"
      provides: "Drop table system"
      contains: "drop_table"
  key_links:
    - from: "enemy_base.gd"
      to: "coin_pickup.tscn"
      via: "instantiate on death"
      pattern: "instantiate"
    - from: "coin_pickup.gd"
      to: "game_manager.gd"
      via: "add_coins"
      pattern: "GameManager\\.add_coins"
---

<objective>
Add coin pickup and refactor enemy drop system to use configurable drop tables.

Purpose: Create economy foundation with coins, unify drop system for all pickup types
Output: Working coin system and configurable enemy drop tables
</objective>

<execution_context>
@~/.config/Claude/get-shit-done/workflows/execute-plan.md
@~/.config/Claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/13-items-pickups/13-01-SUMMARY.md
@components/health/health_pickup.gd
@characters/enemies/enemy_base.gd
@autoloads/game_manager.gd
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CoinPickup and coin infrastructure</name>
  <files>
    components/pickup/coin_pickup.gd
    components/pickup/coin_pickup.tscn
    autoloads/game_manager.gd
    autoloads/events.gd
    assets/audio/sfx/coin.wav
    autoloads/audio_manager.gd
  </files>
  <action>
Create components/pickup/ directory and CoinPickup:

coin_pickup.gd:
```gdscript
extends Area2D
class_name CoinPickup
## A coin pickup that adds currency when collected.

@export var coin_value: int = 1

## Magnet and movement
@export var magnet_range: float = 50.0  # Coins have bigger magnet than health
@export var magnet_speed: float = 200.0  # Coins move faster to player
@export var lifetime: float = 60.0  # Coins last longer than health

## Bob animation
var bob_time: float = 0.0
var start_y: float = 0.0
var is_collected: bool = false

@onready var sprite: Polygon2D = $Sprite2D

func _ready() -> void:
    add_to_group("pickups")
    add_to_group("coins")
    body_entered.connect(_on_body_entered)
    start_y = position.y
    
    # Start lifetime timer
    if lifetime > 0:
        var timer = get_tree().create_timer(lifetime)
        timer.timeout.connect(_on_lifetime_expired)
    
    # Spawn animation - pop in
    scale = Vector2.ZERO
    var tween = create_tween()
    tween.tween_property(self, "scale", Vector2.ONE, 0.2).set_trans(Tween.TRANS_BACK).set_ease(Tween.EASE_OUT)

func _process(delta: float) -> void:
    if is_collected:
        return
    
    # Gentle bob animation
    bob_time += delta * 4.0
    position.y = start_y + sin(bob_time) * 1.5
    
    # Gold shimmer effect
    if sprite:
        var shimmer = 0.85 + sin(bob_time * 2.0) * 0.15
        sprite.modulate = Color(1.0, shimmer, 0.2, 1.0)
    
    # Magnet toward player
    var player = _get_player()
    if player:
        var distance = global_position.distance_to(player.global_position)
        if distance <= magnet_range:
            var direction = (player.global_position - global_position).normalized()
            global_position += direction * magnet_speed * delta
            start_y = global_position.y - sin(bob_time) * 1.5

func _on_body_entered(body: Node2D) -> void:
    if is_collected:
        return
    if body.is_in_group("player"):
        is_collected = true
        
        # Add coins to GameManager
        GameManager.add_coins(coin_value)
        
        # Emit signal
        Events.pickup_collected.emit("coin", coin_value)
        
        # Play coin sound
        AudioManager.play_sfx("coin")
        
        # Pickup effect - quick scale up and fade
        var tween = create_tween()
        tween.set_parallel(true)
        tween.tween_property(self, "scale", Vector2(1.5, 1.5), 0.15)
        tween.tween_property(self, "modulate:a", 0.0, 0.15)
        tween.set_parallel(false)
        tween.tween_callback(queue_free)

func _on_lifetime_expired() -> void:
    if is_collected:
        return
    var tween = create_tween()
    tween.tween_property(self, "modulate:a", 0.0, 0.5)
    tween.tween_callback(queue_free)

func _get_player() -> Node:
    var players = get_tree().get_nodes_in_group("player")
    return players[0] if players.size() > 0 else null
```

coin_pickup.tscn:
- Area2D (root, script: coin_pickup.gd)
  - CollisionShape2D (CircleShape2D, radius 5)
  - Polygon2D "Sprite2D" (circle shape - gold color)
    - Vertices: small circle or octagon
    - Color: Color(1.0, 0.85, 0.2) # Gold
  - Collision layer 0, mask 2 (player layer)

Add to GameManager:
```gdscript
var coins: int = 0

func add_coins(amount: int) -> void:
    coins += amount
    Events.coins_changed.emit(coins)

func get_coins() -> int:
    return coins

func spend_coins(amount: int) -> bool:
    if coins >= amount:
        coins -= amount
        Events.coins_changed.emit(coins)
        return true
    return false
```

Add to Events:
```gdscript
## Emitted when coin count changes
signal coins_changed(total: int)
```

Generate coin sound using generate_placeholder_audio.py or create manually:
- Higher pitch than health_pickup (1046Hz C6)
- Duration: 0.1 seconds
- Add to AudioManager sfx dictionary as "coin"
  </action>
  <verify>
Place coin_pickup.tscn in test zone
Collect coin - GameManager.coins should increase
Sound should play
Coin should have gold shimmer animation
  </verify>
  <done>CoinPickup exists, adds to GameManager, plays distinct sound</done>
</task>

<task type="auto">
  <name>Task 2: Refactor enemy drop system to use drop tables</name>
  <files>
    characters/enemies/enemy_base.gd
  </files>
  <action>
Refactor enemy_base.gd to use configurable drop tables instead of hardcoded health drops:

Replace the existing health drop code with:
```gdscript
# Preload pickup scenes
const HEALTH_PICKUP_SCENE = preload("res://components/health/health_pickup.tscn")
const COIN_PICKUP_SCENE = preload("res://components/pickup/coin_pickup.tscn")

## Drop table: Array of {scene, chance, min_count, max_count}
## Override in subclass or configure in editor
@export var drop_table: Array[Dictionary] = []

func _ready() -> void:
    # ... existing ready code ...
    if drop_table.is_empty():
        _init_default_drops()

## Override in subclass to set default drops
func _init_default_drops() -> void:
    # Base enemy: 30% health, 50% coin (1)
    drop_table = [
        {"scene": HEALTH_PICKUP_SCENE, "chance": 0.3, "min": 1, "max": 1},
        {"scene": COIN_PICKUP_SCENE, "chance": 0.5, "min": 1, "max": 1},
    ]

## Spawn drops on death - replaces _try_spawn_health_pickup
func _spawn_drops() -> void:
    for drop in drop_table:
        var scene = drop.get("scene")
        var chance = drop.get("chance", 0.0)
        if scene and randf() <= chance:
            var min_count = drop.get("min", 1)
            var max_count = drop.get("max", 1)
            var count = randi_range(min_count, max_count)
            for i in count:
                _spawn_single_drop(scene, i)

func _spawn_single_drop(scene: PackedScene, index: int) -> void:
    var pickup = scene.instantiate()
    # Offset drops slightly so they don't stack
    var offset = Vector2(randf_range(-8, 8), randf_range(-8, 8))
    pickup.global_position = global_position + offset
    get_parent().add_child(pickup)
```

Update _on_died to call _spawn_drops():
```gdscript
func _on_died() -> void:
    state_machine.transition_to("Death")
    Events.enemy_defeated.emit(self)
    _spawn_drops()  # Replaces _try_spawn_health_pickup()
```

Remove old _try_spawn_health_pickup() function.
  </action>
  <verify>
Kill enemy - should drop coins AND health based on drop table
Multiple drops should spread out slightly (not stacked)
  </verify>
  <done>Enemy base has configurable drop_table system</done>
</task>

<task type="auto">
  <name>Task 3: Configure per-enemy drop tables</name>
  <files>
    characters/enemies/raccoon.gd
    characters/enemies/crow.gd
    characters/enemies/boss_raccoon_king.gd
  </files>
  <action>
Override _init_default_drops() in each enemy type:

raccoon.gd:
```gdscript
func _init_default_drops() -> void:
    drop_table = [
        {"scene": COIN_PICKUP_SCENE, "chance": 0.8, "min": 1, "max": 2},
        {"scene": HEALTH_PICKUP_SCENE, "chance": 0.25, "min": 1, "max": 1},
    ]
```

crow.gd:
```gdscript
func _init_default_drops() -> void:
    drop_table = [
        {"scene": COIN_PICKUP_SCENE, "chance": 0.9, "min": 1, "max": 3},
        {"scene": HEALTH_PICKUP_SCENE, "chance": 0.15, "min": 1, "max": 1},
    ]
```

boss_raccoon_king.gd:
```gdscript
func _init_default_drops() -> void:
    drop_table = [
        {"scene": COIN_PICKUP_SCENE, "chance": 1.0, "min": 10, "max": 20},
        {"scene": HEALTH_PICKUP_SCENE, "chance": 1.0, "min": 3, "max": 5},
    ]
```

Drop summary:
| Enemy | Coins | Health |
|-------|-------|--------|
| Raccoon | 80%, 1-2 coins | 25%, 1 heart |
| Crow | 90%, 1-3 coins | 15%, 1 heart |
| Boss | 100%, 10-20 coins | 100%, 3-5 hearts |
  </action>
  <verify>
Kill raccoon - usually drops 1-2 coins, sometimes health
Kill crow - usually drops 1-3 coins, rarely health
Kill boss - always drops lots of coins and hearts
  </verify>
  <done>Each enemy type has appropriate drop rates configured</done>
</task>

</tasks>

<verification>
1. Run game
2. Kill a raccoon - should drop coins (80% chance) and maybe health (25%)
3. Kill a crow - should drop coins (90% chance, 1-3)
4. Collect coins - hear "ching" sound, GameManager.coins increases
5. Collect health - hear pickup sound, HP restored
6. Multiple drops should spread out, not stack on same position
</verification>

<success_criteria>
- CoinPickup exists and works (collects, adds to GameManager, plays sound)
- Coins have larger magnet range (50px) and faster speed (200)
- Coins last 60 seconds before despawn
- Drop table system replaces hardcoded health drops
- Each enemy type has configured drop rates
- Multiple drops spread out slightly
- coins_changed signal emitted when coins collected
</success_criteria>

<output>
After completion, create `.planning/phases/13-items-pickups/13-02-SUMMARY.md`
</output>
