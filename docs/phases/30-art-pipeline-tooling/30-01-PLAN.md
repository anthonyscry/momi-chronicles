---
phase: 30-art-pipeline-tooling
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - tools/gemini_automation.py
autonomous: true

must_haves:
  truths:
    - "User can run gemini_automation.py --list and see all 96 prompts grouped by category"
    - "User can run gemini_automation.py and see browser open to Gemini with prompts submitted"
    - "Generated images are downloaded to art/generated/{category}/{filename} matching prompts.json structure"
    - "User can filter by category (--category characters) or run a single prompt (--single 0)"
    - "Script resumes where it left off by skipping prompts whose output files already exist"
  artifacts:
    - path: "tools/gemini_automation.py"
      provides: "Playwright browser automation for Gemini image generation"
      min_lines: 250
  key_links:
    - from: "tools/gemini_automation.py"
      to: "art/prompts.json"
      via: "JSON load at startup"
      pattern: "json\\.load.*prompts\\.json"
    - from: "tools/gemini_automation.py"
      to: "art/generated/"
      via: "image download saves to category subdirectory"
      pattern: "art/generated"
---

<objective>
Create a Playwright browser automation script that submits art prompts to Google Gemini and downloads the generated images. Modeled after the existing `tools/suno_automation.py` (290 lines) which automates Suno music generation.

Purpose: TOOL-01 — Automated art generation from the 96 structured prompts in `art/prompts.json`. This is the first step of the v1.6 Visual Polish milestone, enabling batch sprite generation without manual copy-paste.

Output: `tools/gemini_automation.py` — a complete CLI tool that opens Gemini in a browser, submits prompts with the global style suffix, and saves generated images to the correct `art/generated/{category}/` subdirectories.
</objective>

<execution_context>
@~/.config/Claude/get-shit-done/workflows/execute-plan.md
@~/.config/Claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

Key reference files (read these before implementing):
@tools/suno_automation.py — Template: existing Playwright automation for Suno.com (290 lines)
@art/prompts.json — 96 structured prompts with global_suffix, categories, and filenames
@art/rip_sprites.py — Downstream consumer: processes generated images into game-ready PNGs
@art/AI_ART_PROMPTS.md — Art direction and prompt strategy documentation
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create tools/gemini_automation.py</name>
  <files>tools/gemini_automation.py</files>
  <action>
Create a Playwright browser automation script modeled closely after `tools/suno_automation.py` but adapted for Google Gemini image generation. The script must:

**Prompt Loading (from art/prompts.json):**
- Load `art/prompts.json` from `Path(__file__).parent.parent / "art" / "prompts.json"` (script is in tools/, prompts are in art/)
- Parse the JSON structure: `global_suffix` at top level, `categories` array with `name`, `folder`, and `prompts` (each having `id`, `filename`, `prompt`)
- For each prompt, compose the full text: `{prompt.prompt}. {global_suffix}` — append the global suffix to every individual prompt
- Count total prompts across all categories (should be 96)

**CLI Interface (argparse, same pattern as suno_automation.py):**
- `--list` / `-l`: List all prompts grouped by category with index numbers
- `--category` / `-c CATEGORY`: Run only prompts from one category (characters, enemies, bosses, npcs, items, equipment, effects, zones)
- `--single` / `-s INDEX`: Run a single prompt by global index
- `--auto-submit`: Automatically press Enter/Send after filling prompt (default: wait for user)
- `--headless`: Run browser headless (not recommended, default visible)
- `--site SITE`: Choose target site — "gemini" for gemini.google.com (default) or "aistudio" for aistudio.google.com
- `--skip-existing`: Skip prompts whose output file already exists in art/generated/ (enabled by default, use `--no-skip-existing` to override)
- No arguments = run ALL prompts with skip-existing enabled

**Browser Automation (Playwright sync API):**
- Launch Chromium with `headless=False`, `args=["--start-maximized"]`
- Create context with `viewport={"width": 1400, "height": 900}`
- Navigate to the chosen site URL
- Wait for page load, check for sign-in requirement (print instructions if needed, wait for user Enter)
- For Gemini (gemini.google.com):
  - Find the chat input textarea (try selectors: `div[contenteditable="true"]`, `textarea`, `[aria-label*="prompt"]`, `rich-textarea`)
  - For each prompt: clear input, type/fill the composed prompt text, submit (Enter key or click send button)
  - Wait for image generation (look for image elements appearing in the response)
  - Attempt to download the generated image:
    1. Find the most recent image in the response (try: `img[src*="blob:"]`, `img[src*="data:"]`, `img[alt]` within the latest response)
    2. If image found: right-click → Save As, or extract src URL and download via page.evaluate/fetch
    3. If download fails: print the prompt ID and instruct user to manually save
  - Save to `art/generated/{category.folder}/{prompt.filename}`
- For AI Studio (aistudio.google.com):
  - Similar flow but adapted for AI Studio's chat interface
  - Find prompt input, submit, wait for image, download

**Download Strategy (best-effort, graceful fallback):**
- Primary: Try to extract image blob/data URL from DOM and save via Python
- Secondary: Try right-click context menu → Save Image As (Playwright can simulate)
- Fallback: Print clear message "Please manually save the image as: art/generated/{category}/{filename}" and wait for user Enter
- The script should NOT crash if download fails — log the failure and continue to next prompt

**Resume / Skip Logic:**
- Before processing each prompt, check if `art/generated/{category.folder}/{prompt.filename}` exists
- If exists and --skip-existing (default): print "SKIP {id} (already exists)" and continue
- Track progress: print `[{current}/{total}] {category}/{id}` for each prompt

**Progress & Output:**
- Print banner at start (like suno_automation.py)
- Print instructions for the user (sign in, click Create if not auto-submit, etc.)
- Print progress for each prompt
- Print summary at end: X generated, Y skipped, Z failed
- Exit cleanly on Ctrl+C

**Directory Setup:**
- On startup, create all category subdirectories under art/generated/ if they don't exist:
  `characters/`, `enemies/`, `bosses/`, `npcs/`, `items/`, `equipment/`, `effects/`, `zones/`

**Error Handling:**
- Wrap all Playwright operations in try/except
- TimeoutError: print warning, skip to next prompt
- If browser closes unexpectedly: print error and summary of what was completed
- Never crash the entire script on a single prompt failure

**Code Style:**
- Python 3.10+ (match suno_automation.py style)
- Type hints on function signatures
- Docstrings on all public functions
- Same import pattern as suno_automation.py (try/except for playwright import)
  </action>
  <verify>
    - File exists: `tools/gemini_automation.py`
    - `python tools/gemini_automation.py --list` runs without error and shows all 96 prompts grouped by category
    - Script has argparse with all flags: --list, --category, --single, --auto-submit, --headless, --site, --skip-existing
    - Script reads from `art/prompts.json` and composes prompts with global_suffix
    - Script creates `art/generated/{category}/` directories on startup
  </verify>
  <done>
    - gemini_automation.py exists with 250+ lines
    - --list flag shows all 96 prompts across 8 categories
    - Script handles both gemini.google.com and aistudio.google.com
    - Download has 3-tier fallback (blob extraction → context menu → manual instruction)
    - Skip-existing logic prevents re-generating already-downloaded images
    - Graceful error handling (no crash on individual prompt failure)
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify art pipeline completeness</name>
  <files>art/prompts.json</files>
  <action>
Verify that the full art pipeline is ready for the user:

1. **Verify prompts.json completeness against game code:**
   - Cross-reference item IDs in `systems/inventory/item_database.gd` ITEMS dict against prompts.json items category
   - Cross-reference equipment IDs in `systems/equipment/equipment_database.gd` EQUIPMENT dict against prompts.json equipment category
   - Cross-reference enemy types (raccoon, crow, stray_cat, sewer_rat, shadow_creature) against prompts.json enemies category
   - Cross-reference mini-bosses (alpha_raccoon, crow_matriarch, rat_king) and boss (raccoon_king) against bosses category
   - Cross-reference NPC (nutkin) against npcs category
   - Cross-reference effect types (hit_spark, death_poof, dust_puff) against effects category
   - If ANY game entity is missing from prompts.json, add the missing prompt entry

2. **Verify rip_sprites.py TARGET_SIZES match prompts.json categories:**
   - Confirm every category `folder` name in prompts.json has a corresponding entry in rip_sprites.py TARGET_SIZES dict
   - If any mismatch, fix rip_sprites.py

3. **Verify art/generated/ directory structure:**
   - Ensure all category subdirectories exist: characters/, enemies/, bosses/, npcs/, items/, equipment/, effects/, zones/
   - Create any missing directories

4. **Print pipeline readiness report** to verify everything is aligned:
   - Total prompts per category
   - Target sizes per category
   - Any missing mappings
  </action>
  <verify>
    - Every item in ItemDatabase.ITEMS has a corresponding prompt in prompts.json items category
    - Every equipment in EquipmentDatabase.EQUIPMENT has a corresponding prompt in prompts.json equipment category
    - Every enemy type has idle + attack prompts in enemies category
    - rip_sprites.py TARGET_SIZES keys match all prompts.json category folder names
    - All art/generated/ subdirectories exist
  </verify>
  <done>
    - prompts.json has prompts for every game entity (items, equipment, enemies, bosses, NPCs, effects)
    - rip_sprites.py TARGET_SIZES aligned with prompts.json categories
    - art/generated/ has all 8 category subdirectories ready
    - Zero missing mappings between game code entities and art prompts
  </done>
</task>

</tasks>

<verification>
1. `python tools/gemini_automation.py --list` outputs all 96 prompts grouped by 8 categories
2. `python tools/gemini_automation.py --help` shows all CLI flags
3. art/generated/ contains all 8 category subdirectories
4. Every game entity (items, equipment, enemies, bosses, NPCs, effects) has a corresponding prompt in prompts.json
5. rip_sprites.py TARGET_SIZES dict has entries matching all prompts.json category folders
</verification>

<success_criteria>
- tools/gemini_automation.py exists and runs without import errors
- --list shows 96+ prompts across 8 categories
- Script creates output directories and skips existing files
- prompts.json covers all game entities with zero gaps
- Full pipeline is ready: user runs gemini_automation.py → rip_sprites.py → game-ready PNGs
</success_criteria>

<output>
After completion, create `.planning/phases/30-art-pipeline-tooling/30-01-SUMMARY.md`
</output>
