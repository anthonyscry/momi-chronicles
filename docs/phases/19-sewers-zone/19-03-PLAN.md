---
phase: 19-sewers-zone
plan: 03
type: execute
wave: 3
depends_on: ["19-02"]
files_modified:
  - world/zones/neighborhood.tscn
  - world/zones/neighborhood.gd
  - autoloads/save_manager.gd
autonomous: true

must_haves:
  truths:
    - "Player can press E at a manhole cover in the Neighborhood to enter the Sewers"
    - "Player can exit the Sewers back to the Neighborhood"
    - "Zone transitions work bidirectionally without errors"
    - "Save system correctly records 'sewers' as current zone"
    - "Camera stays within zone bounds at 1152x648 size"
    - "Companions spawn and follow player in the sewers"
    - "Enemies respawn in the sewers after the respawn delay"
  artifacts:
    - path: "world/zones/neighborhood.tscn"
      provides: "Manhole ZoneExit pointing to sewers + manhole cover visual"
    - path: "world/zones/neighborhood.gd"
      provides: "Updated spawn_points with 'from_sewers' entry"
  key_links:
    - from: "world/zones/neighborhood.tscn"
      to: "world/zones/sewers.tscn"
      via: "ZoneExit (to_sewers) triggers Events.zone_transition_requested"
      pattern: "target_zone.*sewers"
    - from: "world/zones/sewers.tscn"
      to: "world/zones/neighborhood.tscn"
      via: "ZoneExit (to_neighborhood) triggers return transition"
      pattern: "target_zone.*neighborhood"
    - from: "autoloads/save_manager.gd"
      to: "world/zones/sewers.tscn"
      via: "Save system records current_zone = 'sewers' on auto-save"
      pattern: "sewers"
---

<objective>
Connect the sewers to the Neighborhood zone via a manhole entrance and verify full integration with save system, camera, companions, and respawning.

Purpose: The sewers zone must be reachable from the existing game world. This plan adds the manhole entrance to the Neighborhood, creates the return path, and verifies all systems work correctly with the new zone.

Output: Updated neighborhood scene/script with manhole entrance, verified bidirectional transitions, save compatibility confirmed.
</objective>

<execution_context>
@~/.config/Claude/get-shit-done/workflows/execute-plan.md
@~/.config/Claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-sewers-zone/19-CONTEXT.md
@.planning/phases/19-sewers-zone/19-RESEARCH.md
@.planning/phases/19-sewers-zone/19-01-SUMMARY.md
@.planning/phases/19-sewers-zone/19-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add manhole entrance to Neighborhood zone</name>
  <files>world/zones/neighborhood.tscn, world/zones/neighborhood.gd</files>
  <action>
**Read neighborhood.gd and neighborhood.tscn first** to understand existing structure.

**1. Update neighborhood.gd:**
- Find the `spawn_points` dictionary
- Add entry: `"from_sewers": Vector2(X, Y)` — position near the manhole cover location. Use the same position as the manhole exit (so player appears standing on the manhole when returning)
- The exact position should be near (300, 350) or wherever makes sense in the existing Neighborhood layout. Read the file to see existing spawn points and zone layout to pick a good spot that doesn't overlap with existing NPCs (Nutkin is at 400, 350) or exits.

**2. Add manhole visual and ZoneExit to neighborhood.tscn (or programmatically in neighborhood.gd):**

Since this project builds visuals programmatically, the cleanest approach is to add a method in neighborhood.gd:

```gdscript
func _setup_zone() -> void:
    # ... existing setup code ...
    _build_manhole()

func _build_manhole() -> void:
    var manhole_pos = Vector2(300, 350)  # Adjust based on existing layout
    
    # Manhole cover visual — dark grey circle
    var cover = Polygon2D.new()
    cover.name = "ManholeCover"
    # Draw a circle-ish polygon (8-sided)
    var points: PackedVector2Array = []
    var radius = 12.0
    for i in range(8):
        var angle = i * TAU / 8.0
        points.append(Vector2(cos(angle), sin(angle)) * radius)
    cover.polygon = points
    cover.color = Color(0.25, 0.25, 0.28)  # Dark grey metal
    cover.position = manhole_pos
    cover.z_index = 2
    add_child(cover)
    
    # Manhole rim — slightly lighter grey outline
    var rim = Polygon2D.new()
    rim.name = "ManholeRim"
    var rim_points: PackedVector2Array = []
    var rim_radius = 14.0
    for i in range(8):
        var angle = i * TAU / 8.0
        rim_points.append(Vector2(cos(angle), sin(angle)) * rim_radius)
    rim.polygon = rim_points
    rim.color = Color(0.35, 0.35, 0.38)  # Lighter grey rim
    rim.position = manhole_pos
    rim.z_index = 1
    add_child(rim)
    
    # Interaction prompt label (hidden until player is near)
    # This will be handled by the ZoneExit's require_interaction
    
    # ZoneExit for manhole — press E to enter sewers
    var exit = preload("res://components/zone_exit/zone_exit.tscn").instantiate()
    exit.name = "ToSewers"
    exit.position = manhole_pos
    exit.exit_id = "to_sewers"
    exit.target_zone = "sewers"
    exit.target_spawn = "from_neighborhood"
    exit.require_interaction = true
    # Adjust collision shape to match manhole size
    add_child(exit)
```

**IMPORTANT:**
- Read the existing `_setup_zone()` method in neighborhood.gd first — ADD the manhole call, don't replace existing code
- Check if ZoneExit instances are added in the .tscn file or programmatically. Follow the same pattern.
- If ZoneExits are placed in the .tscn, add the manhole ZoneExit there instead of in code
- The manhole should NOT overlap with Nutkin's shop NPC (positioned at 400, 350) — pick a position with enough clearance (at least 50px away)
- `require_interaction = true` means player must press E to enter (matches user decision: "manhole cover entrance, freely re-enter anytime")
  </action>
  <verify>
- `grep -n "from_sewers" world/zones/neighborhood.gd` — shows spawn point entry
- `grep -n "sewers" world/zones/neighborhood.gd` or grep neighborhood.tscn — shows ZoneExit or manhole setup
- Manhole visual exists (Polygon2D or equivalent) at the exit position
- ZoneExit has target_zone="sewers", target_spawn="from_neighborhood", require_interaction=true
  </verify>
  <done>Neighborhood has a visible manhole cover with a ZoneExit. Player can press E at the manhole to enter the Sewers. Returning from Sewers spawns player at the manhole position.</done>
</task>

<task type="auto">
  <name>Task 2: Verify save system, camera, companions, and respawn integration</name>
  <files>autoloads/save_manager.gd</files>
  <action>
**Read save_manager.gd** to verify sewers zone compatibility.

**Check these integration points:**

**1. SaveManager zone handling:**
- Read save_manager.gd and check if there's a hardcoded zone list/whitelist/validation
- If the save system uses `zone_id` from Events.zone_entered and stores it directly, it should work automatically (the "sewers" zone_id is set in sewers.gd's _setup_zone)
- If there IS a zone whitelist or validation: add "sewers" to it
- If there is NOT a whitelist: no changes needed — just verify the save flow:
  1. Events.zone_entered.emit("sewers") fires from BaseZone._ready()
  2. SaveManager catches zone_entered signal
  3. SaveManager stores current_zone = "sewers" in save data
  4. On load, GameManager loads the zone scene from zone_scenes["sewers"]

**2. Camera limits:**
- The sewers zone_size is Vector2(1152, 648)
- BaseZone._setup_camera() calls player.set_camera_limits(Rect2(Vector2.ZERO, zone_size))
- Verify this works with the larger size — camera should smoothly follow player within the 1152x648 bounds
- This should work automatically since zone_size is an export var set per-zone

**3. Companion spawning:**
- BaseZone._spawn_companions() spawns all 3 companions
- In tight sewer corridors (48-64px wide), companions may have navigation issues
- Check companion AI follow logic — if they use simple "move toward player" without pathfinding, they should be fine in corridors
- If companion offsets need adjustment for tight corridors, reduce the spawn offset distances

**4. Enemy respawning:**
- BaseZone._capture_enemy_spawn_data() + _check_respawns() handles respawning automatically
- Enemies placed in the Enemies container will be captured and tracked
- Respawn delay is 150s (2.5 min) by default — appropriate for sewers
- Verify: SewerRat instances placed with specific pack_id values will respawn correctly (pack_id is set in _ready() so new instances will have default pack_id=0 unless configured)

**If any issues found:** Make targeted fixes. If SaveManager needs "sewers" added, do it. If companion offsets need adjustment, tune them in sewers.gd.

**If no issues found:** Create a brief note in the summary confirming all systems work without modification.
  </action>
  <verify>
- Read save_manager.gd — confirm no zone whitelist excluding sewers, OR add sewers to it
- Camera: zone_size=Vector2(1152,648) is handled by BaseZone._setup_camera() automatically
- Companions: _spawn_companions() runs in BaseZone._ready() — works for any zone
- Respawn: _capture_enemy_spawn_data() iterates Enemies container — works for any zone with enemies
  </verify>
  <done>All integration systems verified: save system records "sewers" zone correctly, camera bounds work at 1152x648, companions spawn and follow in sewers, enemies respawn after delay. Sewers zone is fully integrated into the game world.</done>
</task>

</tasks>

<verification>
- [ ] Manhole cover visual exists in Neighborhood zone
- [ ] ZoneExit in Neighborhood points to "sewers" zone with require_interaction=true
- [ ] neighborhood.gd spawn_points has "from_sewers" entry
- [ ] Bidirectional transition: Neighborhood → Sewers → Neighborhood works
- [ ] SaveManager stores "sewers" as current_zone without errors
- [ ] Camera stays within 1152x648 bounds in sewers
- [ ] All 3 companions spawn in sewers
- [ ] Enemies respawn after dying in sewers (150s delay)
- [ ] No existing Neighborhood functionality broken by manhole addition
</verification>

<success_criteria>
- Player can navigate from Neighborhood to Sewers via manhole (press E)
- Player can return from Sewers to Neighborhood via entrance exit
- Game saves correctly when in Sewers zone
- Loading a save from the Sewers zone works (player appears in sewers)
- Camera, companions, and respawning all function correctly in the new zone
- Manhole cover is visually distinct and recognizable in the Neighborhood
</success_criteria>

<output>
After completion, create `.planning/phases/19-sewers-zone/19-03-SUMMARY.md`
</output>
