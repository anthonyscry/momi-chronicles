---
phase: 41-quest-tracking-ui
plan: 02
type: execute
wave: 2
depends_on: ["41-01"]
files_modified:
  - ui/hud/game_hud.gd
  - ui/ring_menu/ring_menu.gd
  - ui/quest/quest_tracker.gd
  - characters/npcs/dialogue_npc.gd
autonomous: true

must_haves:
  truths:
    - "Active quest title and current objective visible in top-right HUD corner"
    - "HUD tracker updates when objectives complete (pop animation)"
    - "HUD tracker fades out when quest completes"
    - "Player can open Quest Log from ring menu Options ring"
    - "Quest Log shows active, completed, and available quests"
    - "NPCs with available quests show a yellow ! marker above their head"
    - "NPCs with in-progress quests show a gray ? marker"
    - "Quest completion shows a reward notification popup"
  artifacts:
    - path: "ui/hud/game_hud.gd"
      provides: "QuestTracker instance added to HUD"
    - path: "ui/ring_menu/ring_menu.gd"
      provides: "Quest Log option in OPTIONS ring"
    - path: "characters/npcs/dialogue_npc.gd"
      provides: "Quest marker icons above NPC heads"
  key_links:
    - from: "ui/hud/game_hud.gd"
      to: "ui/quest/quest_tracker.tscn"
      via: "preload + add_child in _setup_quest_tracker()"
      pattern: "preload.*quest_tracker"
    - from: "ui/ring_menu/ring_menu.gd"
      to: "ui/quest/quest_log.tscn"
      via: "instantiate on 'Quest Log' option select"
      pattern: "quest_log"
    - from: "characters/npcs/dialogue_npc.gd"
      to: "QuestManager"
      via: "checks can_start_quest/is_quest_active for marker display"
      pattern: "QuestManager"
---

<objective>
Wire the quest UI into the game: HUD tracker in the top-right corner, quest log accessible from ring menu, quest giver markers on NPCs, and reward notification popup.

Purpose: The QuestTracker and QuestLog UI components already exist as stubs but aren't connected to the actual game. This plan integrates them into the HUD and ring menu, adds visual quest markers on NPCs, and adds reward feedback.

Output: Visible quest tracking on HUD, accessible quest journal, NPC quest indicators, and reward popups — making the quest system feel like a real game feature.
</objective>

<context>
@docs/phases/41-quest-tracking-ui/41-01-SUMMARY.md
@ui/hud/game_hud.gd
@ui/ring_menu/ring_menu.gd
@ui/quest/quest_tracker.gd
@ui/quest/quest_tracker.tscn
@ui/quest/quest_log.gd
@ui/quest/quest_log.tscn
@characters/npcs/dialogue_npc.gd
</context>

<tasks>

<task type="auto">
  <name>Task 1: HUD tracker + Ring Menu quest log + reward notification</name>
  <files>
    ui/hud/game_hud.gd
    ui/ring_menu/ring_menu.gd
    ui/quest/quest_tracker.gd
  </files>
  <action>
    **Add QuestTracker to GameHUD (following existing programmatic pattern):**
    In `ui/hud/game_hud.gd`, add a new setup method called from `_ready()`:

    Add a member variable at the top (near buff_icons, tutorial_prompt):
    ```gdscript
    ## Quest objective tracker (top-right corner)
    var quest_tracker = null
    ```

    Add `_setup_quest_tracker()` call in `_ready()` (after `_setup_tutorial_prompt()`):
    ```gdscript
    _setup_quest_tracker()
    ```

    Add the setup method (following the exact pattern of `_setup_buff_icons` and `_setup_tutorial_prompt`):
    ```gdscript
    func _setup_quest_tracker() -> void:
        var tracker_scene = preload("res://ui/quest/quest_tracker.tscn")
        quest_tracker = tracker_scene.instantiate()
        quest_tracker.name = "QuestTracker"
        add_child(quest_tracker)
    ```

    The quest_tracker.tscn is already anchored to top-right (anchor_left=1.0, anchor_right=1.0, offset_left=-210, offset_top=10). No positioning needed.

    **Add quest reward notification popup to GameHUD:**
    Add another member variable:
    ```gdscript
    ## Quest reward notification
    var reward_popup: Label = null
    ```

    Add `_setup_reward_popup()` call in `_ready()` (after quest tracker setup):
    ```gdscript
    _setup_reward_popup()
    ```

    Add the setup and handler methods:
    ```gdscript
    func _setup_reward_popup() -> void:
        reward_popup = Label.new()
        reward_popup.name = "RewardPopup"
        reward_popup.horizontal_alignment = HORIZONTAL_ALIGNMENT_CENTER
        reward_popup.vertical_alignment = VERTICAL_ALIGNMENT_CENTER
        reward_popup.add_theme_font_size_override("font_size", 10)
        reward_popup.add_theme_color_override("font_color", Color(1, 0.9, 0.3, 1))
        reward_popup.add_theme_color_override("font_outline_color", Color(0, 0, 0, 1))
        reward_popup.add_theme_constant_override("outline_size", 2)
        # Center of screen, slightly above middle
        reward_popup.position = Vector2(92, 80)
        reward_popup.size = Vector2(200, 40)
        reward_popup.modulate.a = 0.0
        reward_popup.z_index = 10
        add_child(reward_popup)

        # Connect to quest completion
        Events.quest_completed.connect(_on_quest_completed_reward)

    func _on_quest_completed_reward(quest_id: String) -> void:
        if not reward_popup:
            return
        # Build reward text
        var quest = QuestManager.available_quests.get(quest_id, null)
        if not quest:
            return
        var rewards = quest.rewards
        var parts: Array = ["Quest Complete!"]
        if rewards.has("coins") and rewards["coins"] > 0:
            parts.append("+%d Coins" % rewards["coins"])
        if rewards.has("exp") and rewards["exp"] > 0:
            parts.append("+%d EXP" % rewards["exp"])
        reward_popup.text = " ".join(parts)

        # Animate: slide up + fade in, hold, fade out
        var tween = create_tween()
        reward_popup.position.y = 90
        reward_popup.modulate.a = 0.0
        tween.tween_property(reward_popup, "modulate:a", 1.0, 0.3)
        tween.parallel().tween_property(reward_popup, "position:y", 75, 0.3).set_ease(Tween.EASE_OUT)
        tween.tween_interval(2.0)
        tween.tween_property(reward_popup, "modulate:a", 0.0, 0.5)
    ```

    **Add "Quest Log" option to ring menu OPTIONS ring:**
    In `ui/ring_menu/ring_menu.gd`, update `_setup_default_options()` to add Quest Log as the first option:
    ```gdscript
    func _setup_default_options() -> void:
        rings[RingType.OPTIONS] = [
            {"id": "quest_log", "name": "Quest Log", "type": "option", "desc": "View your quests"},
            {"id": "save", "name": "Save Game", "type": "option", "desc": "Save your progress"},
            {"id": "settings", "name": "Settings", "type": "option", "desc": "Audio and display options"},
            {"id": "quit", "name": "Quit", "type": "option", "desc": "Return to title screen"},
        ]
    ```

    **Wire quest log opening in `_handle_option()`:**
    Add a quest log overlay variable at the class level:
    ```gdscript
    var _quest_log_overlay: CanvasLayer = null
    ```

    In `_handle_option()`, add a case before "save":
    ```gdscript
    "quest_log":
        _open_quest_log()
    ```

    Add the quest log open/close methods:
    ```gdscript
    func _open_quest_log() -> void:
        if _quest_log_overlay and is_instance_valid(_quest_log_overlay):
            _close_quest_log()
            return

        close_menu()  # Close ring menu first

        _quest_log_overlay = CanvasLayer.new()
        _quest_log_overlay.name = "QuestLogOverlay"
        _quest_log_overlay.layer = 100
        _quest_log_overlay.process_mode = Node.PROCESS_MODE_ALWAYS

        # Dark background
        var bg = ColorRect.new()
        bg.color = Color(0, 0, 0, 0.85)
        bg.anchors_preset = Control.PRESET_FULL_RECT
        _quest_log_overlay.add_child(bg)

        # Quest log panel
        var quest_log_scene = preload("res://ui/quest/quest_log.tscn")
        var quest_log = quest_log_scene.instantiate()
        _quest_log_overlay.add_child(quest_log)

        add_child(_quest_log_overlay)

        # Pause game while viewing
        GameManager.pause_game()

    func _close_quest_log() -> void:
        if _quest_log_overlay and is_instance_valid(_quest_log_overlay):
            _quest_log_overlay.queue_free()
            _quest_log_overlay = null
        GameManager.resume_game()
    ```

    **Handle closing quest log with ESC/Cancel:**
    In `_unhandled_input()`, add BEFORE the ring_menu toggle check:
    ```gdscript
    # Close quest log if open
    if _quest_log_overlay and is_instance_valid(_quest_log_overlay):
        if event.is_action_pressed("ui_cancel") or event.is_action_pressed("dodge") or event.is_action_pressed("ring_menu"):
            _close_quest_log()
            get_viewport().set_input_as_handled()
            return
    ```

    **Fix quest_tracker.gd signal handler to be robust:**
    The quest_tracker already connects to Events.quest_updated, but it calls `QuestManager.get_active_quest(quest_id)` directly. Verify this works. If QuestManager is not loaded yet when quest_tracker._ready() runs, wrap the connection in a deferred call. Add a safety check:

    In quest_tracker.gd `_on_active_quest_changed()`, wrap the QuestManager call:
    ```gdscript
    if not has_node("/root/QuestManager"):
        return
    current_quest = QuestManager.get_active_quest(quest_id)
    ```

    Also hide the tracker when ring_menu_closed is emitted (re-show if quest active):
    ```gdscript
    Events.ring_menu_closed.connect(func():
        if current_quest:
            visible = true
    )
    ```
    Add this in `_ready()` after the ring_menu_opened connection.
  </action>
  <verify>
    Run the game. Check top-right corner — should be empty (no active quest yet). Talk to Gertrude — quest tracker should appear with "Meet the Neighbors" title and first objective. Press Tab to open ring menu, navigate to Options, select "Quest Log" — should show fullscreen quest journal. Press ESC to close. Complete a quest — reward notification should appear center-screen.
  </verify>
  <done>
    Quest tracker visible in HUD top-right when quest is active. Quest Log accessible from ring menu Options. Quest reward notification shows on completion. Quest log closeable with ESC.
  </done>
</task>

<task type="auto">
  <name>Task 2: NPC quest marker icons</name>
  <files>
    characters/npcs/dialogue_npc.gd
  </files>
  <action>
    **Add quest marker icon above NPC heads in dialogue_npc.gd:**
    NPCs should show visual indicators for quest availability:
    - Yellow "!" — NPC has a quest the player can accept
    - Gray "?" — NPC has a quest in progress (player needs to complete objectives elsewhere)
    - No marker — no quest activity for this NPC

    Add member variables (after `_dialogue_active`):
    ```gdscript
    ## Quest marker label (! or ?)
    var quest_marker: Label = null

    ## Quest IDs this NPC can give (set by zone when spawning, or derived from dialogue_id)
    @export var quest_giver_ids: Array[String] = []
    ```

    Add `_create_quest_marker()` call in `_ready()` (after `_create_prompt_label()`):
    ```gdscript
    _create_quest_marker()
    ```

    Add the marker creation method:
    ```gdscript
    func _create_quest_marker() -> void:
        quest_marker = Label.new()
        quest_marker.name = "QuestMarker"
        quest_marker.horizontal_alignment = HORIZONTAL_ALIGNMENT_CENTER
        quest_marker.position = Vector2(-6, -34)
        quest_marker.size = Vector2(12, 14)
        quest_marker.add_theme_font_size_override("font_size", 12)
        quest_marker.add_theme_color_override("font_outline_color", Color(0, 0, 0, 0.8))
        quest_marker.add_theme_constant_override("outline_size", 2)
        quest_marker.z_index = 5
        quest_marker.visible = false
        add_child(quest_marker)
    ```

    Add a method to update the marker state, called periodically:
    ```gdscript
    func _update_quest_marker() -> void:
        if not quest_marker:
            return
        if not has_node("/root/QuestManager"):
            quest_marker.visible = false
            return

        # Check if this NPC can give a new quest
        var has_available = false
        var has_active = false

        # Check quests that this NPC gives
        var check_ids = quest_giver_ids.duplicate()
        # Also check quests triggered by this NPC's dialogue_id
        if not dialogue_id.is_empty():
            # Check all registered quests — if any have objectives matching our dialogue_id
            for qid in QuestManager.available_quests.keys():
                if QuestManager.can_start_quest(qid):
                    has_available = true
                    break
                if QuestManager.is_quest_active(qid):
                    var quest = QuestManager.get_active_quest(qid)
                    if quest:
                        for obj in quest.objectives:
                            if obj.trigger_type == "dialogue" and obj.trigger_id == dialogue_id and not obj.is_completed():
                                has_active = true
                                break

        # Simpler approach: check if talking to this NPC would start or advance any quest
        # by matching dialogue_id against known quest triggers
        var npc_starts_quest = false
        var npc_has_objective = false

        # Check if this NPC's dialogue_id matches a quest auto-start trigger
        # (Gertrude starts "meet_neighbors", Maurice starts "community_watch")
        for qid in QuestManager.available_quests.keys():
            if QuestManager.can_start_quest(qid):
                npc_starts_quest = true
                break

        # Check if any active quest has a dialogue objective for this NPC
        for qid in QuestManager.active_quests.keys():
            var quest = QuestManager.get_active_quest(qid)
            if quest:
                for obj in quest.objectives:
                    if obj.trigger_type == "dialogue" and obj.trigger_id == dialogue_id and not obj.is_completed():
                        npc_has_objective = true
                        break

        if npc_starts_quest:
            quest_marker.text = "!"
            quest_marker.add_theme_color_override("font_color", Color(1, 0.85, 0.2, 1))
            quest_marker.visible = true
        elif npc_has_objective:
            quest_marker.text = "?"
            quest_marker.add_theme_color_override("font_color", Color(0.8, 0.8, 0.8, 1))
            quest_marker.visible = true
        else:
            quest_marker.visible = false
    ```

    IMPORTANT: The `_update_quest_marker()` above has a problem — checking `can_start_quest` for ALL quests without matching to this specific NPC. The cleaner approach is to use the `quest_giver_ids` array. But for simplicity, let's match by dialogue_id:

    Replace the complex logic above with this cleaner version:
    ```gdscript
    func _update_quest_marker() -> void:
        if not quest_marker or dialogue_id.is_empty():
            quest_marker.visible = false if quest_marker else null
            return
        if not has_node("/root/QuestManager"):
            quest_marker.visible = false
            return

        var show_exclamation = false
        var show_question = false

        # Check if this NPC has a "dialogue" objective in any active quest
        for qid in QuestManager.active_quests.keys():
            var quest = QuestManager.get_active_quest(qid)
            if quest:
                for obj in quest.objectives:
                    if obj.trigger_type == "dialogue" and obj.trigger_id == dialogue_id and not obj.is_completed():
                        show_question = true
                        break

        # Check if talking to this NPC would start any available quest
        # Simple mapping: gertrude → meet_neighbors, maurice → community_watch
        var npc_quest_map: Dictionary = {
            "gertrude": "meet_neighbors",
            "maurice": "community_watch",
        }
        if npc_quest_map.has(dialogue_id):
            var mapped_quest = npc_quest_map[dialogue_id]
            if QuestManager.can_start_quest(mapped_quest):
                show_exclamation = true

        # Exclamation takes priority over question mark
        if show_exclamation:
            quest_marker.text = "!"
            quest_marker.add_theme_color_override("font_color", Color(1, 0.85, 0.2, 1))
            quest_marker.visible = true
        elif show_question:
            quest_marker.text = "?"
            quest_marker.add_theme_color_override("font_color", Color(0.7, 0.7, 0.8, 1))
            quest_marker.visible = true
        else:
            quest_marker.visible = false
    ```

    **Call marker update on relevant events:**
    In `_ready()`, after the existing event connections, add:
    ```gdscript
    Events.quest_started.connect(func(_qid): _update_quest_marker())
    Events.quest_updated.connect(func(_qid, _idx): _update_quest_marker())
    Events.quest_completed.connect(func(_qid): _update_quest_marker())
    ```

    And call `_update_quest_marker()` at the end of `_ready()` for initial state.

    Also update after dialogue ends (existing `_on_dialogue_ended` handler):
    ```gdscript
    func _on_dialogue_ended() -> void:
        _dialogue_active = false
        if player_in_range and prompt_label:
            prompt_label.visible = true
        # Refresh quest marker after dialogue (quest may have started/progressed)
        _update_quest_marker()
    ```

    **Add subtle bob animation to quest marker:**
    In `_process()`, add after the body bob:
    ```gdscript
    # Quest marker float animation (faster than body bob)
    if quest_marker and quest_marker.visible:
        quest_marker.position.y = -34 + sin(_idle_time * 3.0) * 1.5
    ```
  </action>
  <verify>
    Run the game in neighborhood zone. Gertrude should have a yellow "!" above her head (she gives "meet_neighbors" quest). Talk to Gertrude — "!" disappears. Maurice, Kids Gang, Henderson should now show gray "?" markers (they have talk-to objectives). Talk to all three — "?" markers disappear. Maurice should now show "!" (he gives "community_watch" quest, since "meet_neighbors" is complete).
  </verify>
  <done>
    NPCs show "!" for available quests and "?" for in-progress objectives. Markers update dynamically on quest state changes. Markers bob gently for visibility.
  </done>
</task>

</tasks>

<verification>
1. HUD shows quest tracker in top-right when quest is active
2. Quest tracker updates title and objective text correctly
3. Quest tracker shows pop animation when objective completes
4. Quest tracker fades out when quest completes
5. Ring menu Options ring includes "Quest Log" option
6. Selecting "Quest Log" opens fullscreen journal overlay
7. Quest log shows active, completed, and available quest sections
8. ESC closes quest log and resumes game
9. Gertrude shows "!" marker (available quest)
10. After accepting quest, target NPCs show "?" markers
11. After completing objectives, "?" markers disappear
12. After completing "meet_neighbors", Maurice shows "!" for next quest
13. Quest completion shows reward notification popup with coins/EXP text
14. Reward popup animates in, holds, fades out
</verification>

<success_criteria>
- Quest tracker visible on HUD during active quests
- Quest log accessible from ring menu
- NPC quest markers ("!" / "?") visible and updating dynamically
- Reward notification appears on quest completion
- Full flow works: see marker → talk → accept → track → complete → reward
</success_criteria>

<output>
After completion, create `docs/phases/41-quest-tracking-ui/41-02-SUMMARY.md`
</output>
