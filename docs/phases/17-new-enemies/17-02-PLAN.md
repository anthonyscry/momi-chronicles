---
phase: 17-new-enemies
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - characters/enemies/sewer_rat.gd
  - characters/enemies/sewer_rat.tscn
  - characters/enemies/states/rat_swarm_chase.gd
  - characters/enemies/states/rat_poison_attack.gd
  - components/health/health_component.gd
  - world/zones/backyard.tscn
autonomous: true

must_haves:
  truths:
    - "Sewer Rats spawn in packs of 3-4 and move together"
    - "Rats are individually weak (15 HP) but deal poison damage-over-time"
    - "Poison ticks damage on the player for several seconds after being bitten"
    - "Sewer Rats can be defeated and drop loot"
  artifacts:
    - path: "characters/enemies/sewer_rat.gd"
      provides: "Rat enemy with swarm and poison behavior"
      exports: ["SewerRat"]
    - path: "characters/enemies/sewer_rat.tscn"
      provides: "Instantiable rat scene"
    - path: "characters/enemies/states/rat_swarm_chase.gd"
      provides: "Swarm chase - coordinated pack movement"
    - path: "characters/enemies/states/rat_poison_attack.gd"
      provides: "Poison bite attack state"
    - path: "components/health/health_component.gd"
      provides: "Poison DoT support (apply_poison, tick damage)"
  key_links:
    - from: "sewer_rat.gd"
      to: "enemy_base.gd"
      via: "extends"
      pattern: 'extends.*enemy_base'
    - from: "rat_poison_attack.gd"
      to: "health_component.gd"
      via: "apply_poison call"
      pattern: 'apply_poison'
    - from: "backyard.tscn"
      to: "sewer_rat.tscn"
      via: "instanced child nodes"
---

<objective>
Create the Sewer Rat enemy — weak individually but spawns in packs and inflicts poison damage-over-time. Forces players to deal with swarms quickly or suffer sustained poison. Also adds poison DoT system to HealthComponent for reuse by other enemies/hazards.

Purpose: Introduces swarm threat + poison status effect. Both mechanics reused by Sewers zone (Phase 19).
Output: Functional rat enemy pack in backyard zone, poison system on HealthComponent.
</objective>

<execution_context>
@~/.config/Claude/get-shit-done/workflows/execute-plan.md
@~/.config/Claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@characters/enemies/enemy_base.gd
@characters/enemies/raccoon.gd
@characters/enemies/raccoon.tscn
@characters/enemies/states/enemy_idle.gd
@characters/enemies/states/enemy_chase.gd
@characters/enemies/states/enemy_attack.gd
@characters/enemies/states/enemy_hurt.gd
@characters/enemies/states/enemy_death.gd
@components/health/health_component.gd
@autoloads/events.gd
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Sewer Rat enemy + poison DoT system</name>
  <files>
    characters/enemies/sewer_rat.gd
    characters/enemies/states/rat_swarm_chase.gd
    characters/enemies/states/rat_poison_attack.gd
    components/health/health_component.gd
  </files>
  <action>
**Poison DoT system on HealthComponent:**
Add to `health_component.gd`:
```
signal poison_started
signal poison_ended

var is_poisoned: bool = false
var poison_damage: int = 0
var poison_tick_interval: float = 0.5
var poison_remaining: float = 0.0
var poison_tick_timer: float = 0.0
```

Add method `apply_poison(damage_per_tick: int, duration: float)`:
- Set is_poisoned = true, poison_damage = damage_per_tick, poison_remaining = duration, poison_tick_timer = 0
- Emit poison_started signal
- Visual: tint the parent node's sprite green (modulate = Color(0.7, 1.0, 0.7))

Add to existing `_process(delta)` (or create if not exists):
- If is_poisoned: tick timer, deal poison_damage every poison_tick_interval, decrement poison_remaining. When expired, clear poison, restore sprite modulate, emit poison_ended.
- NOTE: Check if _process already exists in health_component.gd. If not, add it. If yes, add poison logic to it.

Add method `clear_poison()`:
- Reset all poison vars, restore modulate, emit poison_ended

**Sewer Rat enemy:**
Create `sewer_rat.gd` extending `"res://characters/enemies/enemy_base.gd"`. class_name SewerRat.

Stats:
- HP: 15 (very fragile)
- patrol_speed: 40.0 (fast scurrying)
- chase_speed: 65.0 (fast in packs)
- detection_range: 50.0 (short sight)
- attack_range: 12.0 (close bite)
- attack_damage: 5 (weak bite)
- attack_cooldown: 0.8 (fast attacks)
- knockback_force: 30.0 (barely any)
- exp_value: 8 (low per rat)

Rat-specific properties:
- `var poison_damage: int = 3` — DoT per tick
- `var poison_duration: float = 3.0` — 3 seconds of poison
- `var pack_id: int = 0` — which pack this rat belongs to

Appearance in _ready(): sprite.color = Color(0.45, 0.35, 0.3) (dark brown). Small polygon:
```
sprite.polygon = PackedVector2Array([
    Vector2(-4, -3), Vector2(0, -5), Vector2(4, -3),  # pointed snout
    Vector2(5, 2), Vector2(3, 5), Vector2(-3, 5), Vector2(-5, 2)  # body
])
```
Scale sprite to Vector2(0.8, 0.8) — rats are small.

_init_default_drops(): 60% chance 1 coin, 10% health.

Create `rat_swarm_chase.gd` (extends State, class_name RatSwarmChase):
- Replaces standard Chase for rats
- On enter: find other rats in "enemies" group that share same pack_id
- physics_update: Move toward target like normal chase, BUT add a slight offset toward pack center (average position of pack members). This creates swarming motion where rats cluster together while chasing. Add jitter: small random velocity offset every 0.3 seconds for erratic rat movement.
- Still respects detection/attack range transitions like enemy_chase.gd
- Transition to "RatPoisonAttack" when in attack_range (instead of "Attack")

Create `rat_poison_attack.gd` (extends State, class_name RatPoisonAttack):
- Similar to enemy_attack.gd but shorter duration (0.3s)
- On enter: face target, position hitbox, show "!" telegraph
- Hitbox active frames: 0.1 to 0.25
- AFTER hitbox hits: call `target.health.apply_poison(player.poison_damage, player.poison_duration)` if target has a HealthComponent. Access target via `player.target` (which is the actual player character).
- Actually, better approach: On hitbox connection, the player's _on_hurt already handles damage. Add poison application to the rat's attack exit or use a signal. Simplest: override `_on_hurt` in the target isn't ideal. Instead, in rat_poison_attack.gd, after the attack connects, check if player.target has HealthComponent and call apply_poison on it. Use a flag `var hit_applied_poison` to only apply once per attack.
- Alternative simpler approach: In sewer_rat.gd, connect to Events.player_damaged or check in attack state — when hitbox is enabled and overlaps player hurtbox, apply poison. The hitbox system already handles damage, so we just need to additionally apply poison when this rat attacks.
- Cleanest: In rat_poison_attack.gd, connect to `player.hitbox.area_entered` on enter, disconnect on exit. When triggered, apply poison to the body that was hit.
  
Best approach: After hitbox active window ends (HITBOX_END), check if the hitbox hit anything during this attack (hitbox has `has_hit` tracking). If it did, find the player and apply poison to their HealthComponent.
  
After 0.3s, start cooldown, transition to "RatSwarmChase".
  </action>
  <verify>
health_component.gd has apply_poison(), clear_poison(), poison tick logic. sewer_rat.gd exists with correct stats and class_name. rat_swarm_chase.gd moves rats in pack formation. rat_poison_attack.gd applies poison on hit.
  </verify>
  <done>
Sewer Rat script with swarm chase + poison bite created. HealthComponent supports poison DoT with visual feedback and signals.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create rat scene and place pack in backyard</name>
  <files>
    characters/enemies/sewer_rat.tscn
    world/zones/backyard.tscn
  </files>
  <action>
Create `sewer_rat.tscn` following raccoon.tscn pattern:
- Root: CharacterBody2D named "SewerRat", collision_layer=4, collision_mask=1, script=sewer_rat.gd
- Sprite2D: Polygon2D with rat shape, dark brown, scale=Vector2(0.8, 0.8)
- CollisionShape2D: CapsuleShape2D radius=4, height=10 (small)
- AnimationPlayer: empty
- StateMachine: Node with script=state_machine.gd, initial_state_path="Idle"
  - Idle: Node, script=enemy_idle.gd (idle_duration=0.8 — rats are restless)
  - Patrol: Node, script=enemy_patrol.gd
  - RatSwarmChase: Node, script=rat_swarm_chase.gd
  - RatPoisonAttack: Node, script=rat_poison_attack.gd
  - Hurt: Node, script=enemy_hurt.gd
  - Death: Node, script=enemy_death.gd
  
  NOTE: Do NOT include standard Chase or Attack states — rats use RatSwarmChase and RatPoisonAttack instead. Update rat_swarm_chase to transition to "RatPoisonAttack" and rat_poison_attack to transition to "RatSwarmChase".
  
- DetectionArea: Area2D, collision_layer=0, collision_mask=2, CircleShape2D radius=50
- Hitbox: Area2D, collision_layer=128, collision_mask=16, monitoring=false, monitorable=false, script=hitbox.gd, damage=5. Child CollisionShape2D with RectangleShape2D size=Vector2(8, 6), position=Vector2(6, 0), disabled=true
- Hurtbox: Area2D, collision_layer=32, collision_mask=64, script=hurtbox.gd. Child CollisionShape2D with CapsuleShape2D radius=5, height=10
- HealthComponent: Node, script=health_component.gd, max_health=15

Add a pack of 4 SewerRat instances to backyard.tscn:
- All 4 rats get pack_id = 1 (set in scene or let default)
- Position them clustered near the shed area: ~Vector2(280, 80), Vector2(290, 90), Vector2(275, 95), Vector2(295, 75)
- This creates a visible rat nest near the shed

Verify the scene structure is valid.
  </action>
  <verify>
sewer_rat.tscn exists with all required nodes. backyard.tscn has 4 SewerRat instances clustered together. `grep -r "SewerRat" world/zones/backyard.tscn` returns matches. Rats use RatSwarmChase (not standard Chase) and RatPoisonAttack (not standard Attack).
  </verify>
  <done>
Sewer Rat scene created and pack of 4 placed near shed in backyard zone. Rats swarm together and inflict poison.
  </done>
</task>

</tasks>

<verification>
- All sewer rat files exist under characters/enemies/
- HealthComponent has apply_poison/clear_poison methods
- Rats spawn as a pack of 4 in backyard
- Rats swarm toward player together
- Rat bite applies poison DoT (green tint, ticking damage)
- Poison clears after duration expires
- Individual rats can be defeated (drops coins)
- Each rat awards 8 EXP
</verification>

<success_criteria>
Sewer Rat pack functions as a swarm threat in the backyard zone. Rats cluster together while chasing, bite inflicts poison that ticks damage over 3 seconds with green visual. Players must eliminate the pack quickly or suffer sustained poison damage.
</success_criteria>

<output>
After completion, create `.planning/phases/17-new-enemies/17-02-SUMMARY.md`
</output>
