# Plan 02: Game Flow & Death State

```yaml
phase: 07-polish-audio
plan: 02
wave: 1
depends_on: []
files_modified: 5
autonomous: true
must_haves:
  truths:
    - "Player death triggers game over screen"
    - "Game over screen has Retry and Quit options"
    - "Retry resets player to zone start"
    - "Full game loop: Title -> Play -> Die -> Game Over -> Retry"
  artifacts:
    - path: "characters/player/states/player_death.gd"
      provides: "Death state with game over trigger"
    - path: "ui/menus/game_over.gd"
      provides: "Game over screen with retry"
  key_links:
    - from: "player_death.gd"
      to: "game_manager.gd"
      via: "game_over signal"
    - from: "game_over.gd"
      to: "game_manager.gd"
      via: "restart_game call"
```

## Objective

Ensure the complete game flow works: Title Screen -> Gameplay -> Death -> Game Over -> Retry/Quit. Verify all transitions are smooth and state is properly reset.

## Tasks

<task type="auto">
<name>Task 1: Verify Death State Implementation</name>
<files>characters/player/states/player_death.gd</files>
<action>
Read and verify the player_death.gd state:

1. Check that death state:
   - Plays death animation (or visual feedback)
   - Disables player input
   - Emits player_died signal via Events
   - Triggers game over after delay (1-2 seconds)

2. If missing any of these, add them:
   ```gdscript
   func enter(_prev: String = "", _data: Dictionary = {}) -> void:
       player.set_physics_process(false)
       # Visual feedback
       player.modulate = Color(0.5, 0.5, 0.5)
       # Play death sound
       if AudioManager:
           AudioManager.play_sfx("player_death")
       # Emit death signal
       Events.player_died.emit()
       # Trigger game over after delay
       await get_tree().create_timer(1.5).timeout
       GameManager.show_game_over()
   ```

3. Ensure GameManager has show_game_over() method
</action>
<verify>Read the file and confirm death triggers game over</verify>
<done>Death state properly chains to game over screen</done>
</task>

<task type="auto">
<name>Task 2: Verify Game Over Screen</name>
<files>ui/menus/game_over.gd, ui/menus/game_over.tscn</files>
<action>
Verify game_over scene has:

1. "GAME OVER" or "DEFEATED" label
2. "Retry" button - calls GameManager.restart_game()
3. "Quit" / "Main Menu" button - returns to title screen
4. Proper button focus for keyboard navigation

If buttons don't exist or don't work, fix the connections:
```gdscript
func _on_retry_pressed() -> void:
    GameManager.restart_game()

func _on_quit_pressed() -> void:
    GameManager.go_to_title()
```

Ensure GameManager has these methods:
- restart_game() - reloads current zone, resets player
- go_to_title() - loads title screen scene
</action>
<verify>Buttons exist and have correct signal connections</verify>
<done>Game over screen has working Retry and Quit buttons</done>
</task>

<task type="auto">
<name>Task 3: Verify GameManager Reset Logic</name>
<files>autoloads/game_manager.gd</files>
<action>
Check GameManager has proper reset functionality:

1. restart_game() should:
   - Unpause game (get_tree().paused = false)
   - Reset player health to max
   - Reload the starting zone (neighborhood)
   - Reset enemy states

2. go_to_title() should:
   - Unpause game
   - Load title screen scene
   - Clean up current zone

3. show_game_over() should:
   - Load/show game over UI
   - Pause game (optional - prevents background action)
   - Play game over music

If any method is missing, add it.
</action>
<verify>GameManager has restart_game, go_to_title, show_game_over methods</verify>
<done>GameManager properly handles game state transitions</done>
</task>

<task type="auto">
<name>Task 4: Full Flow Test</name>
<files>None (testing only)</files>
<action>
Test the complete game flow manually:

1. **Title -> Game**: Click Start, verify neighborhood loads
2. **Take Damage**: Let raccoon hit you, verify health decreases
3. **Die**: Let health reach 0, verify:
   - Death animation/visual plays
   - Game over screen appears after delay
   - Game over music plays (if implemented)
4. **Retry**: Click Retry, verify:
   - Returns to gameplay
   - Player health is full
   - Player at starting position
   - Enemies respawned
5. **Quit**: Die again, click Quit/Menu, verify:
   - Returns to title screen
   - Can start new game

Document any issues found.
</action>
<verify>Complete flow works: Title -> Play -> Die -> Game Over -> Retry works</verify>
<done>Full game loop functional with proper state resets</done>
</task>

## Verification

Run the game and test the death/retry cycle multiple times.

```bash
godot --path .
```

## Success Criteria

- [ ] Player can die (health reaches 0)
- [ ] Death triggers visual feedback
- [ ] Game over screen appears after death
- [ ] Retry button works and resets game properly
- [ ] Quit/Menu button returns to title
- [ ] Can play multiple games without restart
- [ ] No stuck states or soft locks
