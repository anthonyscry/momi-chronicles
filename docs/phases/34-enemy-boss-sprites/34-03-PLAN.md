---
phase: 34-enemy-boss-sprites
plan: 03
type: execute
wave: 3
depends_on: ["34-01"]
files_modified:
  - characters/enemies/alpha_raccoon.tscn
  - characters/enemies/alpha_raccoon.gd
  - characters/enemies/crow_matriarch.tscn
  - characters/enemies/crow_matriarch.gd
  - characters/enemies/rat_king.tscn
  - characters/enemies/rat_king.gd
  - characters/enemies/boss_raccoon_king.tscn
  - characters/enemies/boss_raccoon_king.gd
autonomous: true

must_haves:
  truths:
    - "All 3 mini-bosses display as sprites with unique attack animations"
    - "Raccoon King displays as sprite with normal and enrage visual variants"
    - "Boss/mini-boss health bars still display correctly over sprite-based enemies"
    - "Boss death sequence still has dramatic visual effect"
  artifacts:
    - path: "characters/enemies/boss_raccoon_king.tscn"
      provides: "Boss with sprite-based visuals including enrage variant"
      contains: "AnimatedSprite2D"
    - path: "characters/enemies/alpha_raccoon.tscn"
      provides: "Alpha Raccoon with sprite-based visuals"
      contains: "AnimatedSprite2D"
  key_links:
    - from: "characters/enemies/boss_raccoon_king.gd"
      to: "art/generated/archive/bosses/raccoon_king_*.png"
      via: "SpriteFrames with normal + enrage animations"
    - from: "characters/enemies/boss_raccoon_king.gd"
      to: "AnimatedSprite2D"
      via: "sprite.play('enrage') at 50% HP"
      pattern: "sprite\\.play\\("
---

<objective>
Replace all mini-boss and boss Polygon2D placeholders with AnimatedSprite2D using archive pixel art. Handle boss-specific visuals: Raccoon King's crown, enrage phase, and death particle explosion.

Purpose: Boss fights are climactic moments. The Raccoon King and mini-bosses need to look impressive as sprites, not colored squares with code-drawn crowns.
Output: All 3 mini-bosses and the final boss display as pixel art characters with state-specific visuals.
</objective>

<execution_context>
@~/.config/Claude/get-shit-done/workflows/execute-plan.md
@~/.config/Claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/34-enemy-boss-sprites/34-01-SUMMARY.md
@characters/enemies/boss_raccoon_king.gd
@characters/enemies/boss_raccoon_king.tscn
@characters/enemies/alpha_raccoon.gd
@characters/enemies/alpha_raccoon.tscn
@characters/enemies/mini_boss_base.gd
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace mini-boss Polygon2Ds with AnimatedSprite2D</name>
  <files>
    characters/enemies/alpha_raccoon.tscn
    characters/enemies/alpha_raccoon.gd
    characters/enemies/crow_matriarch.tscn
    characters/enemies/crow_matriarch.gd
    characters/enemies/rat_king.tscn
    characters/enemies/rat_king.gd
  </files>
  <action>
  NOTE: Mini-boss files use names WITHOUT the `mini_boss_` prefix: `alpha_raccoon.*`, `crow_matriarch.*`, `rat_king.*`.

  **For each mini-boss .tscn:**
  1. Remove `Polygon2D` node named `Sprite2D`
  2. Add `AnimatedSprite2D` named `Sprite2D`
  3. Create SpriteFrames:

  **Alpha Raccoon:**
  - `idle` → `art/generated/archive/bosses/alpha_raccoon.png`
  - `slam` → `art/generated/archive/bosses/alpha_raccoon_slam.png`

  **Crow Matriarch:**
  - `idle` → `art/generated/archive/bosses/crow_matriarch.png`
  - `dive` → `art/generated/archive/bosses/crow_matriarch_dive.png`

  **Rat King:**
  - `idle` → `art/generated/archive/bosses/rat_king.png`
  - `poison` → `art/generated/archive/bosses/rat_king_poison.png`

  **For each mini-boss .gd script:**
  1. Check if sprite type is declared locally (may inherit from mini_boss_base.gd which inherits from enemy_base.gd — already fixed in 34-01). If mini_boss_base.gd has its own `var sprite` declaration, fix it too.
  2. Add `sprite.play("idle")` in `_ready()` or ensure inherited base does it.
  3. Wire attack states to animations:
     - Alpha Raccoon: ground slam state → `sprite.play("slam")`, return to idle after
     - Crow Matriarch: dive bomb state → `sprite.play("dive")`, return to idle after
     - Rat King: poison cloud state → `sprite.play("poison")`, return to idle after
  4. Replace any `sprite.color` with `sprite.modulate` everywhere.
  5. Replace any `sprite.scale.x = -1` with `sprite.flip_h = true`.

  **Check mini_boss_base.gd:** Read it first. If it has `var sprite: Polygon2D` or any `sprite.color` references, fix those too. It likely inherits from enemy_base.gd which was already fixed, but may have overrides.

  **Mini-boss scaling:** Mini-bosses are visually bigger than regular enemies. If code uses `sprite.scale = Vector2(X, X)`, keep reasonable scale (e.g., 1.5x) so mini-bosses look larger. The archive sprites are 32x32 same as regular enemies, so a 1.5x scale makes them ~48x48 pixels — noticeably bigger.

  **Health bar positioning:** Mini-boss health bar is positioned above the enemy. It's relative to the enemy node, not the sprite child, so it should be unaffected. Verify after conversion.

  **State scripts to update:**
  Check `alpha_slam.gd`, `crow_dive_bomb.gd`, `rat_king_poison_cloud.gd` for animation calls. Add `enemy.sprite.play("slam"/"dive"/"poison")` in enter() and `enemy.sprite.play("idle")` in exit() if not already present.
  </action>
  <verify>
  - All 3 mini-boss .tscn files have AnimatedSprite2D, zero Polygon2D
  - Each has correct SpriteFrames (2 animations each)
  - Mini-boss health bar positioning still works
  - `grep -r "Polygon2D" characters/enemies/alpha_raccoon.tscn characters/enemies/crow_matriarch.tscn characters/enemies/rat_king.tscn` — zero matches
  </verify>
  <done>All 3 mini-bosses use AnimatedSprite2D with idle + attack animations, visual feedback uses modulate</done>
</task>

<task type="auto">
  <name>Task 2: Replace Raccoon King boss Polygon2D and handle special visuals</name>
  <files>
    characters/enemies/boss_raccoon_king.tscn
    characters/enemies/boss_raccoon_king.gd
  </files>
  <action>
  The Raccoon King has the most complex placeholder visuals:
  - A Polygon2D scaled to 2.5x
  - A child Polygon2D gold crown
  - Enrage modulate tint at 50% HP
  - Death explosion with 20 ColorRect particles

  **In boss_raccoon_king.tscn:**
  1. Remove `Polygon2D` "Sprite2D" (the 14x14 square) and any child Polygon2D (crown)
  2. Add `AnimatedSprite2D` named `Sprite2D`
  3. Create SpriteFrames:
     - `normal` → `art/generated/archive/bosses/raccoon_king_normal.png`
     - `enrage` → `art/generated/archive/bosses/raccoon_king_enrage.png`
     - `death` → `art/generated/archive/bosses/raccoon_king_death.png`
  4. Set `centered = true`

  **In boss_raccoon_king.gd:**
  1. Change sprite type to AnimatedSprite2D (if declared locally; may inherit from enemy_base.gd)
  2. **Remove `_setup_boss_appearance()`** entirely — no more code-built color + crown. The sprite art already includes the crown design.
  3. Remove the `sprite.scale = Vector2(2.5, 2.5)` line — apply a reasonable scale like `Vector2(2.0, 2.0)` to make the boss visually larger (~64x64 from 32x32 sprite). Ensure collision shapes match.
  4. Replace enrage visual (currently `sprite.modulate = Color(1.3, 0.8, 0.8)`):
     ```gdscript
     # Switch to enrage sprite instead of just tinting:
     sprite.play("enrage")
     ```
  5. In `_ready()`: `sprite.play("normal")` (override base class "idle" since boss uses "normal" animation name)
  6. **Death sequence:** Change `sprite.play("death")` before the explosion. Keep the 20 ColorRect explosion particles as-is (ephemeral VFX — Phase 35 handles effects).
  7. Replace all `sprite.color` with `sprite.modulate`
  8. Replace `sprite.scale.x = -1` with `sprite.flip_h = true`

  **Boss attack states:** Check `boss_attack_charge.gd`, `boss_attack_swipe.gd`, `boss_attack_summon.gd`, `boss_idle.gd`. Add sprite animation calls if appropriate:
  - boss_idle: `sprite.play("normal")` (or "enrage" if boss is already enraged — check boss's `is_enraged` flag)
  - boss_attack_charge/swipe: could play "normal" or "enrage" depending on phase — check enrage flag

  **Collision:** Boss has larger collision shapes (CapsuleShape2D). Verify they match the visual after sprite + scale change.

  **Boss health bar:** Positioned at top of screen via CanvasLayer — not affected by sprite change.

  **Summon state:** Boss summons minion raccoons. These are separate scenes — already handled by 34-01 (regular raccoon sprite). No change needed here.
  </action>
  <verify>
  - Boss scene has AnimatedSprite2D with 3 animations (normal, enrage, death)
  - No Polygon2D nodes in boss scene
  - No `_setup_boss_appearance()` function (or it's been removed/gutted)
  - Enrage switches to enrage animation at 50% HP
  - Boss is visually larger than regular enemies
  - Boss health bar still displays at top of screen
  - `grep "Polygon2D" characters/enemies/boss_raccoon_king.tscn` — zero matches
  </verify>
  <done>Raccoon King uses AnimatedSprite2D with normal/enrage/death sprites, crown is part of art (no code-drawn crown), enrage phase uses distinct sprite, death sequence preserved</done>
</task>

</tasks>

<verification>
1. Fight all 3 mini-bosses — each displays as a sprite with attack animations
2. Fight Raccoon King — displays as large sprite
3. Get boss to 50% HP — enrage sprite is visually different from normal
4. Kill the boss — death sequence plays with explosion
5. Boss/mini-boss health bars display correctly
6. `grep -r "Polygon2D" characters/enemies/alpha_raccoon.tscn characters/enemies/crow_matriarch.tscn characters/enemies/rat_king.tscn characters/enemies/boss_raccoon_king.tscn` — zero matches
</verification>

<success_criteria>
- All 3 mini-bosses display as sprites with idle + attack animations
- Raccoon King displays with normal/enrage/death sprite variants
- Boss health bar and combat mechanics unchanged
- No code-drawn crown, no scaled Polygon2D
- Zero Polygon2D references in boss/mini-boss files
</success_criteria>

<output>
After completion, create `.planning/phases/34-enemy-boss-sprites/34-03-SUMMARY.md`
</output>
