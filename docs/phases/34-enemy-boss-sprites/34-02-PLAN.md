---
phase: 34-enemy-boss-sprites
plan: 02
type: execute
wave: 3
depends_on: ["34-01"]
files_modified:
  - characters/enemies/roomba.gd
  - characters/enemies/roomba.tscn
  - characters/enemies/gnome.gd
  - characters/enemies/gnome.tscn
  - characters/enemies/goose.gd
  - characters/enemies/goose.tscn
  - characters/enemies/squirrel.gd
  - characters/enemies/squirrel.tscn
autonomous: true

must_haves:
  truths:
    - "Roomba enemy appears in game with idle/attack sprites and raccoon-like melee AI"
    - "Gnome enemy appears in game with idle/attack sprites and stray-cat-like ambush AI"
    - "Goose enemy appears in game with idle/attack sprites and crow-like aggressive AI"
    - "Squirrel enemy appears in game with idle/attack sprites and shadow-creature-like ranged AI"
    - "All 4 new enemies have unique drop tables and EXP values"
    - "All 4 new enemies use the fixed AnimatedSprite2D base from 34-01"
  artifacts:
    - path: "characters/enemies/roomba.tscn"
      provides: "Roomba enemy scene with AnimatedSprite2D and raccoon state machine"
      contains: "AnimatedSprite2D"
    - path: "characters/enemies/gnome.tscn"
      provides: "Gnome enemy scene with AnimatedSprite2D and cat stealth states"
      contains: "CatStealth"
    - path: "characters/enemies/goose.tscn"
      provides: "Goose enemy scene with AnimatedSprite2D and crow flying behavior"
      contains: "AnimatedSprite2D"
    - path: "characters/enemies/squirrel.tscn"
      provides: "Squirrel enemy scene with AnimatedSprite2D and ranged attack states"
      contains: "ShadowRangedAttack"
  key_links:
    - from: "characters/enemies/roomba.gd"
      to: "characters/enemies/enemy_base.gd"
      via: "extends enemy_base.gd"
      pattern: 'extends.*enemy_base'
    - from: "characters/enemies/squirrel.gd"
      to: "components/projectile/shadow_bolt.tscn"
      via: "preload projectile scene for ranged attack"
      pattern: "preload.*shadow_bolt"
---

<objective>
Create 4 new enemy types (roomba, gnome, goose, squirrel) as re-skins of existing enemy AI patterns, using the newly generated pixel art sprites. Each new enemy inherits from enemy_base.gd and reuses existing state scripts.

Purpose: The 4 new enemies add variety to combat encounters. By re-skinning existing AI (raccoon→roomba, stray_cat→gnome, crow→goose, shadow_creature→squirrel), we get 4 fully functional enemies with zero new AI code — only new .tscn scenes, .gd stat files, and sprite art.
Output: 4 new enemy scenes + scripts ready for zone placement.
</objective>

<execution_context>
@~/.config/Claude/get-shit-done/workflows/execute-plan.md
@~/.config/Claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/34-enemy-boss-sprites/34-01-SUMMARY.md
@characters/enemies/enemy_base.gd
@characters/enemies/raccoon.tscn
@characters/enemies/raccoon.gd
@characters/enemies/stray_cat.tscn
@characters/enemies/stray_cat.gd
@characters/enemies/crow.tscn
@characters/enemies/crow.gd
@characters/enemies/shadow_creature.tscn
@characters/enemies/shadow_creature.gd
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create roomba and goose enemies (melee + flying re-skins)</name>
  <files>
    characters/enemies/roomba.gd
    characters/enemies/roomba.tscn
    characters/enemies/goose.gd
    characters/enemies/goose.tscn
  </files>
  <action>
  **ROOMBA — Re-skin of Raccoon (basic melee charger):**

  Create `roomba.tscn` by duplicating raccoon.tscn structure:
  - Root node: `Roomba` (CharacterBody2D), collision_layer=4, collision_mask=1
  - `Sprite2D` node: **AnimatedSprite2D** (NOT Polygon2D — 34-01 established the pattern)
    - SpriteFrames with:
      - `idle` → `art/generated/enemies/roomba_idle.png` (user will have picked the final sprite by now; if not in `art/generated/enemies/`, check `art/generated/batch_1/enemies/roomba_idle.png` and use batch_1 as default)
      - `attack` → `art/generated/enemies/roomba_attack.png` (same fallback logic)
  - Same state machine as raccoon: Idle, Patrol, Chase, Attack, Hurt, Death (all using the shared enemy state scripts)
  - CollisionShape2D: CapsuleShape2D radius=6, height=14 (same as raccoon)
  - DetectionArea: CircleShape2D radius=65 (slightly less than raccoon's 70)
  - Hitbox: RectangleShape2D 12x10, damage=12
  - Hurtbox: CapsuleShape2D radius=7, height=16
  - HealthComponent: max_health=30

  Create `roomba.gd`:
  ```gdscript
  extends "res://characters/enemies/enemy_base.gd"
  class_name Roomba
  ## Roomba enemy - erratic bumping melee attacker, re-skin of Raccoon AI.

  func _ready() -> void:
      patrol_speed = 30.0
      chase_speed = 50.0
      detection_range = 65.0
      attack_range = 16.0
      attack_damage = 12
      attack_cooldown = 1.0
      exp_value = 20
      super._ready()

  func _init_default_drops() -> void:
      drop_table = [
          {"scene": COIN_PICKUP_SCENE, "chance": 0.75, "min": 1, "max": 2},
          {"scene": HEALTH_PICKUP_SCENE, "chance": 0.20, "min": 1, "max": 1},
          {"item_id": "acorn", "chance": 0.08, "min": 1, "max": 1},
      ]
  ```

  ---

  **GOOSE — Re-skin of Crow (aggressive flying dive-bomber):**

  Create `goose.tscn` by duplicating crow.tscn structure:
  - Root node: `Goose` (CharacterBody2D), collision_layer=4, collision_mask=1
  - `Sprite2D` node: **AnimatedSprite2D**
    - SpriteFrames with:
      - `idle` → `art/generated/enemies/goose_idle.png`
      - `attack` → `art/generated/enemies/goose_attack.png`
  - Same state machine as crow: Idle, Patrol, Chase, Attack, Hurt, Death
  - CollisionShape2D: CapsuleShape2D radius=6, height=14
  - DetectionArea: CircleShape2D radius=85
  - Hitbox: RectangleShape2D 12x10, damage=12
  - Hurtbox: CapsuleShape2D radius=7, height=16
  - HealthComponent: max_health=25

  Create `goose.gd`:
  ```gdscript
  extends "res://characters/enemies/enemy_base.gd"
  class_name Goose
  ## Goose enemy - aggressive honking dive-bomber, re-skin of Crow AI.

  var is_flying: bool = true

  func _ready() -> void:
      patrol_speed = 30.0
      chase_speed = 70.0
      detection_range = 85.0
      attack_range = 16.0
      lose_interest_range = 130.0
      attack_damage = 12
      attack_cooldown = 0.9
      knockback_force = 65.0
      exp_value = 18
      super._ready()
      # Goose flies over obstacles like crow
      set_collision_mask_value(1, false)

  func _init_default_drops() -> void:
      drop_table = [
          {"scene": COIN_PICKUP_SCENE, "chance": 0.85, "min": 1, "max": 2},
          {"scene": HEALTH_PICKUP_SCENE, "chance": 0.15, "min": 1, "max": 1},
          {"item_id": "bird_seed", "chance": 0.12, "min": 1, "max": 2},
      ]
  ```
  </action>
  <verify>
  - `roomba.tscn` and `roomba.gd` exist, roomba.tscn has AnimatedSprite2D (no Polygon2D)
  - `goose.tscn` and `goose.gd` exist, goose.tscn has AnimatedSprite2D (no Polygon2D)
  - Both scenes have correct state machine nodes (Idle, Patrol, Chase, Attack, Hurt, Death)
  - Goose has `set_collision_mask_value(1, false)` for flying behavior
  - Both .gd files extend enemy_base.gd
  </verify>
  <done>Roomba (melee) and Goose (flying) enemy scenes/scripts created with AnimatedSprite2D sprites and correct AI state machines</done>
</task>

<task type="auto">
  <name>Task 2: Create gnome and squirrel enemies (ambush + ranged re-skins)</name>
  <files>
    characters/enemies/gnome.gd
    characters/enemies/gnome.tscn
    characters/enemies/squirrel.gd
    characters/enemies/squirrel.tscn
  </files>
  <action>
  **GNOME — Re-skin of Stray Cat (stealth ambusher):**

  Create `gnome.tscn` by duplicating stray_cat.tscn structure:
  - Root node: `Gnome` (CharacterBody2D), collision_layer=4, collision_mask=1
  - `Sprite2D` node: **AnimatedSprite2D**
    - SpriteFrames with:
      - `idle` → `art/generated/enemies/gnome_idle.png`
      - `attack` → `art/generated/enemies/gnome_attack.png`
      - Note: gnome only has 2 sprites (idle + attack), not 3 like stray cat. Use `idle` for stealth too (the alpha reduction handles the visual). If the state script tries `sprite.play("stealth")`, guard it: the base class plays "idle" which is fine as fallback.
  - **State machine — MUST match stray_cat exactly:** CatStealth (initial), Idle, Patrol, Chase, CatPounce, CatRetreat, Hurt, Death
    - Uses the SAME state scripts: `cat_stealth.gd`, `cat_pounce.gd`, `cat_retreat.gd` + shared enemy states
  - initial_state_path = NodePath("CatStealth")
  - CollisionShape2D: CapsuleShape2D radius=5, height=12
  - DetectionArea: CircleShape2D radius=55
  - Hitbox: RectangleShape2D 14x10, damage=18
  - Hurtbox: CapsuleShape2D radius=6, height=14
  - HealthComponent: max_health=25

  Create `gnome.gd`:
  ```gdscript
  extends "res://characters/enemies/enemy_base.gd"
  class_name Gnome
  ## Gnome enemy - lurking garden ambusher, re-skin of Stray Cat AI.
  ## Hides with reduced alpha, then lunges with a burst attack.

  var stealth_alpha: float = 0.15
  var is_stealthed: bool = true
  var pounce_speed: float = 180.0

  func _ready() -> void:
      patrol_speed = 18.0
      chase_speed = 85.0
      detection_range = 55.0
      attack_range = 28.0
      attack_damage = 18
      attack_cooldown = 2.8
      knockback_force = 90.0
      exp_value = 28
      super._ready()

  ## Override attack state to use CatPounce (same as stray cat)
  func get_attack_state_name() -> String:
      return "CatPounce"

  func _init_default_drops() -> void:
      drop_table = [
          {"scene": COIN_PICKUP_SCENE, "chance": 0.70, "min": 1, "max": 3},
          {"scene": HEALTH_PICKUP_SCENE, "chance": 0.25, "min": 1, "max": 1},
          {"item_id": "tough_treat", "chance": 0.06, "min": 1, "max": 1},
      ]
  ```

  **IMPORTANT for gnome.gd:** The stray cat states (`cat_stealth.gd`, `cat_pounce.gd`, `cat_retreat.gd`) reference the enemy's `stealth_alpha`, `is_stealthed`, and `pounce_speed` variables. The gnome MUST declare these same variables (as shown above) for the shared state scripts to work.

  ---

  **SQUIRREL — Re-skin of Shadow Creature (ranged phasing attacker):**

  Create `squirrel.tscn` by duplicating shadow_creature.tscn structure:
  - Root node: `Squirrel` (CharacterBody2D), collision_layer=4, collision_mask=1
  - `Sprite2D` node: **AnimatedSprite2D**
    - SpriteFrames with:
      - `idle` → `art/generated/enemies/squirrel_idle.png`
      - `attack` → `art/generated/enemies/squirrel_attack.png`
  - **State machine — MUST match shadow_creature exactly:** ShadowPhase (initial), Idle, Patrol, Chase, ShadowRangedAttack, Hurt, Death
    - Uses the SAME state scripts: `shadow_phase.gd`, `shadow_ranged_attack.gd` + shared enemy states
  - initial_state_path = NodePath("ShadowPhase")
  - CollisionShape2D: CapsuleShape2D radius=6, height=14
  - DetectionArea: CircleShape2D radius=90
  - Hitbox: RectangleShape2D 10x10, damage=10
  - Hurtbox: CapsuleShape2D radius=7, height=16
  - HealthComponent: max_health=28

  Create `squirrel.gd`:
  ```gdscript
  extends "res://characters/enemies/enemy_base.gd"
  class_name Squirrel
  ## Squirrel enemy - darting ranged attacker that throws acorn projectiles,
  ## re-skin of Shadow Creature AI. Phases in/out and teleports when hit.

  ## Uses shadow bolt projectile scene (re-skinned as acorn conceptually)
  const SHADOW_BOLT_SCENE = preload("res://components/projectile/shadow_bolt.tscn")

  ## Phase cycling properties (must match shadow_creature interface)
  var phase_timer: float = 0.0
  var phase_cycle: float = 4.5
  var is_phased_out: bool = false

  ## Teleport evasion
  var teleport_distance: float = 45.0

  func _ready() -> void:
      patrol_speed = 30.0
      chase_speed = 40.0
      detection_range = 90.0
      attack_range = 70.0
      attack_damage = 10
      attack_cooldown = 1.8
      knockback_force = 35.0
      exp_value = 35
      super._ready()

  func _init_default_drops() -> void:
      drop_table = [
          {"scene": COIN_PICKUP_SCENE, "chance": 0.80, "min": 1, "max": 3},
          {"scene": HEALTH_PICKUP_SCENE, "chance": 0.25, "min": 1, "max": 1},
          {"item_id": "acorn", "chance": 0.15, "min": 1, "max": 3},
          {"item_id": "power_treat", "chance": 0.04, "min": 1, "max": 1},
      ]

  func _process(delta: float) -> void:
      super._process(delta)
      if not is_alive():
          return
      var current_state_name = ""
      if state_machine and state_machine.current_state:
          current_state_name = state_machine.current_state.name.to_lower()
      if current_state_name == "hurt" or current_state_name == "death":
          return
      phase_timer += delta
      var half_cycle = phase_cycle / 2.0
      if phase_timer >= half_cycle:
          phase_timer -= half_cycle
          _toggle_phase()

  func _toggle_phase() -> void:
      is_phased_out = not is_phased_out
      if is_phased_out:
          _phase_out()
      else:
          _phase_in()

  func _phase_out() -> void:
      is_phased_out = true
      var tween = create_tween()
      tween.tween_property(self, "modulate:a", 0.1, 0.3)
      if hurtbox:
          hurtbox.start_invincibility(0.0)

  func _phase_in() -> void:
      is_phased_out = false
      var tween = create_tween()
      tween.tween_property(self, "modulate:a", 0.85, 0.3)
      if hurtbox:
          hurtbox.end_invincibility()

  func _on_hurt(attacking_hitbox: Hitbox) -> void:
      if is_phased_out:
          _phase_in()
          phase_timer = 0.0
      var old_pos = global_position
      super._on_hurt(attacking_hitbox)
      var random_angle = randf() * TAU
      var teleport_offset = Vector2(cos(random_angle), sin(random_angle)) * teleport_distance
      global_position = old_pos + teleport_offset
      _spawn_teleport_poof(old_pos)

  func _spawn_teleport_poof(pos: Vector2) -> void:
      if not get_parent():
          return
      for i in range(6):
          var particle = ColorRect.new()
          particle.size = Vector2(3, 3)
          particle.color = Color(0.6, 0.4, 0.2, 0.8)  # Brown/acorn colored poof
          particle.global_position = pos + Vector2(randf_range(-4, 4), randf_range(-4, 4))
          get_parent().add_child(particle)
          var angle = randf() * TAU
          var end_pos = pos + Vector2(cos(angle), sin(angle)) * randf_range(8, 18)
          var tween = particle.create_tween()
          tween.set_parallel(true)
          tween.tween_property(particle, "global_position", end_pos, 0.3).set_ease(Tween.EASE_OUT)
          tween.tween_property(particle, "modulate:a", 0.0, 0.35)
          tween.tween_callback(particle.queue_free)
  ```

  **IMPORTANT for squirrel.gd:** The shadow state scripts (`shadow_phase.gd`, `shadow_ranged_attack.gd`) reference the enemy's `SHADOW_BOLT_SCENE`, `is_phased_out`, `phase_timer`, `phase_cycle`, `teleport_distance`. The squirrel MUST declare all of these for the shared state scripts to work. The squirrel also needs the `_phase_out()`, `_phase_in()`, `_toggle_phase()`, `_process()` phase cycling, and `_on_hurt()` teleport override — these are all copied from shadow_creature.gd but with the Polygon2D/glow_aura code removed.

  **Sprite fallback logic:** The user should have picked final sprites from batches using compare.html. Check `art/generated/enemies/` first for picked sprites. If not there yet, use `art/generated/batch_1/enemies/` as default (user can re-pick later).
  </action>
  <verify>
  - `gnome.tscn` and `gnome.gd` exist, gnome.tscn has CatStealth/CatPounce/CatRetreat state nodes
  - `squirrel.tscn` and `squirrel.gd` exist, squirrel.tscn has ShadowPhase/ShadowRangedAttack state nodes
  - Gnome declares `stealth_alpha`, `is_stealthed`, `pounce_speed` (required by cat state scripts)
  - Squirrel declares `SHADOW_BOLT_SCENE`, `is_phased_out`, phase cycling vars (required by shadow state scripts)
  - Both .gd files extend enemy_base.gd
  - No Polygon2D in any .tscn
  </verify>
  <done>Gnome (ambush) and Squirrel (ranged) enemy scenes/scripts created with correct state machines matching their base archetypes, all variables present for shared state script compatibility</done>
</task>

</tasks>

<verification>
1. Instantiate each new enemy in a test zone — all 4 display as sprites
2. Roomba patrols, chases player, attacks with melee — raccoon behavior clone
3. Gnome starts stealthed (low alpha), pounces when player is close, retreats after — stray cat behavior clone
4. Goose flies over obstacles, fast chase, hit-and-run attacks — crow behavior clone
5. Squirrel phases in/out, fires ranged projectiles, teleports when hit — shadow creature behavior clone
6. All 4 enemies drop items on death correctly
7. All 4 enemies give EXP on defeat
8. `grep -r "Polygon2D" characters/enemies/roomba.tscn characters/enemies/gnome.tscn characters/enemies/goose.tscn characters/enemies/squirrel.tscn` — zero matches
</verification>

<success_criteria>
- 4 new enemy scenes + scripts exist with AnimatedSprite2D sprites
- Each re-skins existing AI: roomba→raccoon, gnome→stray_cat, goose→crow, squirrel→shadow_creature
- All required variables declared for shared state script compatibility
- Unique stats, drop tables, and EXP values per enemy
- No new AI state scripts needed — full reuse of existing ones
</success_criteria>

<output>
After completion, create `.planning/phases/34-enemy-boss-sprites/34-02-SUMMARY.md`
</output>
