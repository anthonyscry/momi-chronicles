---
phase: 34-enemy-boss-sprites
plan: 01
type: execute
wave: 2
depends_on: ["32-01"]
files_modified:
  - characters/enemies/enemy_base.gd
  - characters/enemies/raccoon.tscn
  - characters/enemies/raccoon.gd
  - characters/enemies/crow.tscn
  - characters/enemies/crow.gd
  - characters/enemies/stray_cat.tscn
  - characters/enemies/stray_cat.gd
  - characters/enemies/sewer_rat.tscn
  - characters/enemies/sewer_rat.gd
  - characters/enemies/shadow_creature.tscn
  - characters/enemies/shadow_creature.gd
autonomous: true

must_haves:
  truths:
    - "All 5 original enemy types display as pixel art sprites instead of colored squares"
    - "Enemy AI behavior is unchanged — sprite swap is visual only"
    - "Damage flash still visible on all enemies when hit"
    - "Enemy death still triggers visual effects and drops"
    - "Stray cat stealth shows reduced alpha on sprite"
    - "Shadow creature phase in/out still works with sprite"
  artifacts:
    - path: "characters/enemies/enemy_base.gd"
      provides: "AnimatedSprite2D compatible flash_damage and visual feedback"
      contains: "AnimatedSprite2D"
    - path: "characters/enemies/raccoon.tscn"
      provides: "Raccoon with sprite-based visuals"
      contains: "AnimatedSprite2D"
  key_links:
    - from: "characters/enemies/enemy_base.gd"
      to: "AnimatedSprite2D"
      via: "flash_damage uses modulate instead of color"
      pattern: "sprite\\.modulate"
    - from: "characters/enemies/enemy_base.gd"
      to: "AnimatedSprite2D"
      via: "update_facing uses flip_h instead of scale.x"
      pattern: "sprite\\.flip_h"
---

<objective>
Fix enemy_base.gd for AnimatedSprite2D compatibility and replace all 5 original enemy Polygon2D placeholders with AnimatedSprite2D using archive pixel art.

Purpose: Enemies are the most frequently seen NPCs. Replacing colored squares with sprites transforms combat encounters visually. This also fixes the shared base class so all future enemies (including 4 new ones in 34-02) inherit correct sprite behavior.
Output: enemy_base.gd uses AnimatedSprite2D, all 5 original enemies (raccoon, crow, stray cat, sewer rat, shadow creature) display as sprites.
</objective>

<execution_context>
@~/.config/Claude/get-shit-done/workflows/execute-plan.md
@~/.config/Claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/32-player-sprites/32-01-SUMMARY.md
@characters/enemies/enemy_base.gd
@characters/enemies/raccoon.tscn
@characters/enemies/raccoon.gd
@characters/enemies/stray_cat.gd
@characters/enemies/shadow_creature.gd
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix enemy_base.gd and replace Polygon2D with AnimatedSprite2D in all 5 original enemy scenes</name>
  <files>
    characters/enemies/enemy_base.gd
    characters/enemies/raccoon.tscn
    characters/enemies/crow.tscn
    characters/enemies/stray_cat.tscn
    characters/enemies/sewer_rat.tscn
    characters/enemies/shadow_creature.tscn
  </files>
  <action>
  **In enemy_base.gd — 4 critical fixes:**

  1. Change sprite type declaration (line 14):
     `@onready var sprite: Polygon2D = $Sprite2D` → `@onready var sprite: AnimatedSprite2D = $Sprite2D`

  2. Fix `flash_damage()` (line ~286-291) — `Polygon2D.color` does not exist on `AnimatedSprite2D`:
     ```gdscript
     func flash_damage() -> void:
         sprite.modulate = Color(1, 0.3, 0.3, 1)
         await get_tree().create_timer(0.1).timeout
         if is_instance_valid(self) and sprite:
             sprite.modulate = Color.WHITE
     ```

  3. Fix `update_facing()` (line ~278-284) — `scale.x = -1` works but `flip_h` is the correct AnimatedSprite2D approach:
     ```gdscript
     func update_facing(direction: Vector2) -> void:
         if direction == Vector2.ZERO:
             return
         facing_direction = direction
         if abs(direction.x) > abs(direction.y):
             facing_left = direction.x < 0
             sprite.flip_h = facing_left
     ```

  4. Add `sprite.play("idle")` at end of `_ready()` (after `_init_default_drops()`):
     ```gdscript
     # Start default animation
     if sprite:
         sprite.play("idle")
     ```

  **For each of the 5 original enemy .tscn files, apply the same conversion:**
  1. Remove the `Polygon2D` node named `Sprite2D` (and any child nodes like GlowAura on shadow_creature)
  2. Add `AnimatedSprite2D` node named `Sprite2D`
  3. Create `SpriteFrames` resource with enemy-specific animations

  **Sprite mappings (archive sprites):**

  **Raccoon** (`raccoon.tscn`):
  - `idle` → `art/generated/archive/enemies/raccoon_idle.png`
  - `attack` → `art/generated/archive/enemies/raccoon_attack.png`

  **Crow** (`crow.tscn`):
  - `idle` → `art/generated/archive/enemies/crow_idle.png`
  - `dive` → `art/generated/archive/enemies/crow_dive.png`

  **Stray Cat** (`stray_cat.tscn`):
  - `idle` → `art/generated/archive/enemies/stray_cat_idle.png`
  - `pounce` → `art/generated/archive/enemies/stray_cat_pounce.png`
  - `stealth` → `art/generated/archive/enemies/stray_cat_stealth.png`

  **Sewer Rat** (`sewer_rat.tscn`):
  - `idle` → `art/generated/archive/enemies/sewer_rat_idle.png`
  - `pack` → `art/generated/archive/enemies/sewer_rat_pack.png`

  **Shadow Creature** (`shadow_creature.tscn`):
  - `idle` → `art/generated/archive/enemies/shadow_creature_idle.png`
  - `bolt` → `art/generated/archive/enemies/shadow_creature_bolt.png`
  - Remove the `GlowAura` child Polygon2D from the scene — the sprite art already conveys the glow.

  **Collision sizes:** Keep existing collision shapes unchanged. With 32x32 sprites, collision should cover roughly the lower 2/3 of the sprite (feet area for 3/4 perspective). The existing 12-14px capsules are fine.
  </action>
  <verify>
  - Grep all 5 enemy .tscn files for `Polygon2D` — zero matches
  - Grep enemy_base.gd for `.color =` — zero matches (all replaced with .modulate)
  - Grep enemy_base.gd for `scale.x =` — zero matches in update_facing (replaced with flip_h)
  - Each .tscn has AnimatedSprite2D with correct SpriteFrames animations
  </verify>
  <done>enemy_base.gd declares AnimatedSprite2D, uses modulate/flip_h, plays idle. All 5 original enemy .tscn files use AnimatedSprite2D with archive sprites.</done>
</task>

<task type="auto">
  <name>Task 2: Fix individual enemy scripts for AnimatedSprite2D compatibility</name>
  <files>
    characters/enemies/raccoon.gd
    characters/enemies/crow.gd
    characters/enemies/stray_cat.gd
    characters/enemies/sewer_rat.gd
    characters/enemies/shadow_creature.gd
  </files>
  <action>
  **Raccoon (raccoon.gd):**
  - No sprite-specific code to change. It only sets stats and drops. The base class handles sprite.play("idle") in _ready(). No animation switches needed — raccoon uses generic attack state which should play "attack" animation.
  - Verify: no `sprite.color` or `sprite.scale.x` references.

  **Crow (crow.gd):**
  - Same — stats/drops only. No sprite-specific code. Verify no `sprite.color` references.

  **Stray Cat (stray_cat.gd):**
  - **Remove** the `_ready()` lines that set `sprite.color` and `sprite.polygon` (lines ~26-33). The sprite art replaces the code-drawn cat shape.
  - Keep `stealth_alpha`, `is_stealthed`, `pounce_speed` variables.
  - The cat starts in CatStealth state (initial_state_path in .tscn). The stealth state likely modulates alpha — this should still work with AnimatedSprite2D since it operates on the node's `modulate.a`, not `color.a`.
  - Add to _ready() after super._ready(): `if sprite: sprite.play("idle")` — but base already does this. However, stealth state will override alpha. This is fine.

  **Sewer Rat (sewer_rat.gd):**
  - Check for any `sprite.polygon` or `sprite.color` references and remove them.
  - The sewer rat had a custom 7-vertex polygon and scale=0.8 — remove any such references since the sprite art is the correct shape/size.

  **Shadow Creature (shadow_creature.gd):**
  - **Remove** the `_ready()` lines that set `sprite.color` and `sprite.polygon` (lines ~37-43).
  - **Remove** the entire `glow_aura` Polygon2D creation block (lines ~46-57) — the glow is baked into the sprite art.
  - Remove the `var glow_aura: Polygon2D` variable declaration.
  - **Phase in/out (`_phase_out`, `_phase_in`):** These tween `self.modulate.a` (NOT `sprite.modulate.a`), so they affect the entire node including the AnimatedSprite2D. This is correct and works with no changes.
  - **Teleport poof (`_spawn_teleport_poof`):** Uses ColorRect particles — keep as-is for now (these are ephemeral VFX, not character art; Phase 35 will handle effects).
  - Verify: no `sprite.color` references remain.

  **For ALL enemy .gd files — animation state switches:**
  The enemy state scripts (`enemy_attack.gd`, `cat_pounce.gd`, `shadow_ranged_attack.gd`, etc.) likely reference the enemy directly. Check if they need `enemy.sprite.play("attack")` calls. If the state scripts DON'T call sprite.play(), add animation switches:
  - In `enemy_attack.gd` enter(): `enemy.sprite.play("attack")` 
  - In `enemy_attack.gd` exit(): `enemy.sprite.play("idle")`
  - In `cat_pounce.gd` enter(): `enemy.sprite.play("pounce")`
  - In `cat_stealth.gd` enter(): `enemy.sprite.play("stealth")`
  - In `cat_retreat.gd` enter(): `enemy.sprite.play("idle")`
  - In `shadow_ranged_attack.gd` enter(): `enemy.sprite.play("bolt")` (or "idle" if no bolt animation distinction needed — the bolt is a separate projectile)
  - In `enemy_hurt.gd` enter(): `enemy.flash_damage()` — already calls modulate flash
  - In `enemy_idle.gd` / `enemy_patrol.gd` enter(): `enemy.sprite.play("idle")`
  - In `enemy_chase.gd` enter(): `enemy.sprite.play("idle")` (running uses idle sprite — no separate run animation for enemies)

  **Important:** Only add `sprite.play()` calls if the animation name exists in that enemy's SpriteFrames. Guard with `if enemy.sprite.sprite_frames.has_animation("attack"):` to avoid errors for enemies that don't have an "attack" animation (e.g., stray cat uses "pounce" instead).

  **Do NOT change:**
  - Enemy AI logic (detection, chasing, patrol paths)
  - Damage values, health, drop tables
  - Spawn logic, state machine transitions
  </action>
  <verify>
  - Run the game, encounter each enemy type — all show as sprites
  - Hit enemies — red damage flash visible (modulate, not color)
  - Kill enemies — death effect plays, drops spawn
  - Stray cat in stealth — reduced alpha visible on sprite
  - Shadow creature phases — transparency works
  - Grep all enemy .gd files for `\.color\s*=` — zero matches (except drop text label.color which is unrelated)
  </verify>
  <done>All 5 original enemy scripts cleaned of Polygon2D code, state scripts wire sprite.play() for animation switches, visual feedback preserved with modulate/flip_h</done>
</task>

</tasks>

<verification>
1. Walk through all 3 zones — every original enemy type displays as a sprite
2. Combat with each enemy works: hit detection, damage, knockback, death
3. Stray cat stealth visual is distinct from idle (alpha-reduced sprite)
4. Crow still flies over obstacles
5. Shadow creature phase effect still works (modulate.a tween)
6. Shadow creature teleport poof still spawns particles
7. Sewer rat displays correctly without old custom polygon
8. `grep -r "Polygon2D" characters/enemies/raccoon.tscn characters/enemies/crow.tscn characters/enemies/stray_cat.tscn characters/enemies/sewer_rat.tscn characters/enemies/shadow_creature.tscn` — zero matches
9. `grep "\.color\s*=" characters/enemies/enemy_base.gd` — zero matches
</verification>

<success_criteria>
- All 5 original enemy types display as sprites with state-appropriate animations
- enemy_base.gd uses AnimatedSprite2D type, modulate for flash, flip_h for facing
- State scripts wire sprite.play() for relevant animation names
- Enemy AI unchanged — no behavioral regression
- Zero Polygon2D references in original enemy scenes/scripts
</success_criteria>

<output>
After completion, create `.planning/phases/34-enemy-boss-sprites/34-01-SUMMARY.md`
</output>
