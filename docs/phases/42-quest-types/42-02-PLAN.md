---
phase: 42-quest-types
plan: 02
type: execute
wave: 2
depends_on: ["42-01"]
files_modified:
  - autoloads/quest_manager.gd
  - world/zones/neighborhood.gd
  - world/zones/backyard.gd
autonomous: true

must_haves:
  truths:
    - "Player can accept and complete a Fetch quest (find item, return to NPC)"
    - "Player can accept and complete an Elimination quest (defeat N enemies, return)"
    - "Player can accept and complete a Delivery quest (pickup, travel, deliver to NPC)"
    - "Chain quests unlock sequentially (completing one makes next available)"
    - "Quest rewards grant coins, EXP, and reputation appropriately"
    - "Quest item pickups appear in zones when quest is active"
    - "All quest givers show correct markers (! for available, ? for turn-in)"
  artifacts:
    - path: "autoloads/quest_manager.gd"
      provides: "6+ quest definitions covering all quest types"
    - path: "world/zones/backyard.gd"
      provides: "Quest item pickup placement (lost ball)"
    - path: "world/zones/neighborhood.gd"
      provides: "Quest item pickup placement (mail package)"
  key_links:
    - from: "autoloads/quest_manager.gd"
      to: "Events.dialogue_started"
      via: "auto-start logic for new quest givers"
    - from: "world/zones/backyard.gd"
      to: "components/quest_item_pickup/quest_item_pickup.gd"
      via: "instantiation of lost_ball pickup"
    - from: "world/zones/neighborhood.gd"
      to: "components/quest_item_pickup/quest_item_pickup.gd"
      via: "instantiation of mail_package pickup"
---

<objective>
Define all quest content covering the 5 quest types (Fetch, Elimination, Delivery, Interaction, Chain) and place quest item pickups in zones.

Purpose: Plan 42-01 built the quest engine infrastructure (new trigger types, data-driven markers, pickup component). This plan uses that infrastructure to create the actual quest content that players will experience.
Output: 8 playable quests (1 fetch, 1 elimination, 1 delivery, 4 chain, plus 2 existing) with collectible items in zones.
</objective>

<context>
@docs/STATE.md
@docs/ROADMAP.md
@docs/phases/42-quest-types/42-01-SUMMARY.md
@autoloads/quest_manager.gd
@systems/quest/quest_data.gd
@systems/quest/quest_objective.gd
@world/zones/neighborhood.gd
@world/zones/backyard.gd
@characters/npcs/dialogue_npc.gd
@components/quest_item_pickup/quest_item_pickup.gd
</context>

<tasks>

<task type="auto">
  <name>Task 1: Define all new quest data in QuestManager._register_all_quests</name>
  <files>
    autoloads/quest_manager.gd
  </files>
  <action>
Add the following quest definitions to `_register_all_quests()` AFTER the existing q1 (meet_neighbors) and q2 (community_watch) quests. Follow the exact same pattern as q1/q2.

**Quest 3: Fetch — "Find the Lost Ball" (Kids Gang)**
```gdscript
# Quest 3: Fetch — Find the Lost Ball (triggered by talking to Kids Gang, requires meet_neighbors)
var q3 = QuestData.new()
q3.id = "find_lost_ball"
q3.title = "Find the Lost Ball"
q3.description = "The Kids Gang lost their favorite ball somewhere in the Backyard. Find it and bring it back!"
q3.is_main_quest = false
q3.quest_giver_id = "kids_gang"
q3.prerequisite_quest_ids = ["meet_neighbors"]
q3.objective_descriptions = ["Find the lost ball in the Backyard", "Return to the Kids Gang"]
q3.optional_objectives = [false, false]
q3.objective_trigger_types = ["item_collect", "dialogue"]
q3.objective_trigger_ids = ["lost_ball", "kids_gang"]
q3.objective_target_counts = [1, 1]
q3.objective_requires_prior = [false, true]  # Must find ball before returning
q3.rewards = {"coins": 60, "exp": 30, "reputation": {"kids_gang": 15}}
register_quest_data(q3)
```

**Quest 4: Elimination — "Pest Control" (Henderson)**
```gdscript
# Quest 4: Elimination — Pest Control (triggered by talking to Henderson, requires rep >= 30)
var q4 = QuestData.new()
q4.id = "pest_control"
q4.title = "Pest Control"
q4.description = "Mr. Henderson is tired of pests in the Backyard. Defeat 5 enemies there to clean things up."
q4.is_main_quest = false
q4.quest_giver_id = "henderson"
q4.prerequisite_quest_ids = ["meet_neighbors"]
q4.objective_descriptions = ["Defeat 5 enemies in the Backyard", "Report back to Mr. Henderson"]
q4.optional_objectives = [false, false]
q4.objective_trigger_types = ["enemy_kill", "dialogue"]
q4.objective_trigger_ids = ["any", "henderson"]
q4.objective_target_counts = [5, 1]
q4.objective_requires_prior = [false, true]  # Must defeat enemies before reporting
q4.rewards = {"coins": 100, "exp": 50, "reputation": {"henderson": 20}}
register_quest_data(q4)
```

**Quest 5: Delivery — "Special Delivery" (Maurice)**
```gdscript
# Quest 5: Delivery — Special Delivery (triggered by talking to Maurice, requires community_watch)
var q5 = QuestData.new()
q5.id = "special_delivery"
q5.title = "Special Delivery"
q5.description = "Maurice has a package for Old Lady Gertrude but can't leave his route. Pick it up and deliver it to her."
q5.is_main_quest = false
q5.quest_giver_id = "maurice"
q5.prerequisite_quest_ids = ["community_watch"]
q5.objective_descriptions = ["Pick up Maurice's package", "Deliver the package to Gertrude"]
q5.optional_objectives = [false, false]
q5.objective_trigger_types = ["item_collect", "dialogue"]
q5.objective_trigger_ids = ["mail_package", "gertrude"]
q5.objective_target_counts = [1, 1]
q5.objective_requires_prior = [false, true]  # Must pick up before delivering
q5.rewards = {"coins": 75, "exp": 35, "reputation": {"maurice": 15, "gertrude": 10}}
register_quest_data(q5)
```

**Quests 6-9: Chain — "Neighborhood Investigation" (Gertrude, 4-part series)**
```gdscript
# Quest 6: Chain 1/4 — First Patrol (triggered by talking to Gertrude, requires meet_neighbors)
var q6 = QuestData.new()
q6.id = "investigation_1"
q6.title = "Neighborhood Investigation: First Patrol"
q6.description = "Gertrude heard strange noises from the Backyard at night. Go check it out and report back."
q6.is_main_quest = true
q6.quest_giver_id = "gertrude"
q6.prerequisite_quest_ids = ["meet_neighbors"]
q6.objective_descriptions = ["Investigate the Backyard", "Report back to Gertrude"]
q6.optional_objectives = [false, false]
q6.objective_trigger_types = ["zone", "dialogue"]
q6.objective_trigger_ids = ["backyard", "gertrude"]
q6.objective_target_counts = [1, 1]
q6.objective_requires_prior = [false, true]
q6.rewards = {"coins": 40, "exp": 20, "reputation": {"gertrude": 10}}
register_quest_data(q6)

# Quest 7: Chain 2/4 — Backyard Cleanup (requires investigation_1)
var q7 = QuestData.new()
q7.id = "investigation_2"
q7.title = "Neighborhood Investigation: Cleanup"
q7.description = "Gertrude says the pests are getting worse. Clear out some enemies in the Backyard."
q7.is_main_quest = true
q7.quest_giver_id = "gertrude"
q7.prerequisite_quest_ids = ["investigation_1"]
q7.objective_descriptions = ["Defeat 3 enemies in the Backyard", "Report back to Gertrude"]
q7.optional_objectives = [false, false]
q7.objective_trigger_types = ["enemy_kill", "dialogue"]
q7.objective_trigger_ids = ["any", "gertrude"]
q7.objective_target_counts = [3, 1]
q7.objective_requires_prior = [false, true]
q7.rewards = {"coins": 60, "exp": 30, "reputation": {"gertrude": 10}}
register_quest_data(q7)

# Quest 8: Chain 3/4 — Sewers Recon (requires investigation_2)
var q8 = QuestData.new()
q8.id = "investigation_3"
q8.title = "Neighborhood Investigation: Sewers Recon"
q8.description = "Gertrude suspects the source of the pests is in the Sewers. Scout the area."
q8.is_main_quest = true
q8.quest_giver_id = "gertrude"
q8.prerequisite_quest_ids = ["investigation_2"]
q8.objective_descriptions = ["Explore the Sewers", "Report back to Gertrude"]
q8.optional_objectives = [false, false]
q8.objective_trigger_types = ["zone", "dialogue"]
q8.objective_trigger_ids = ["sewers", "gertrude"]
q8.objective_target_counts = [1, 1]
q8.objective_requires_prior = [false, true]
q8.rewards = {"coins": 80, "exp": 40, "reputation": {"gertrude": 10}}
register_quest_data(q8)

# Quest 9: Chain 4/4 — The Full Report (requires investigation_3)
var q9 = QuestData.new()
q9.id = "investigation_4"
q9.title = "Neighborhood Investigation: The Full Report"
q9.description = "Gertrude wants a full report. Talk to all the neighbors about what you've found, then report back."
q9.is_main_quest = true
q9.quest_giver_id = "gertrude"
q9.prerequisite_quest_ids = ["investigation_3"]
q9.objective_descriptions = ["Talk to Maurice about the sewers", "Talk to the Kids Gang about the backyard", "Talk to Mr. Henderson about the noises", "Deliver the full report to Gertrude"]
q9.optional_objectives = [false, false, false, false]
q9.objective_trigger_types = ["dialogue", "dialogue", "dialogue", "dialogue"]
q9.objective_trigger_ids = ["maurice", "kids_gang", "henderson", "gertrude"]
q9.objective_target_counts = [1, 1, 1, 1]
q9.objective_requires_prior = [false, false, false, true]  # First 3 parallel, last requires all prior
q9.rewards = {"coins": 150, "exp": 75, "reputation": {"gertrude": 20, "maurice": 10, "kids_gang": 10, "henderson": 10}}
register_quest_data(q9)
```

**Also add a reputation check for Henderson's quest:**
The pest_control quest requires Henderson to have warming reputation (>= 30). Since the prerequisite system only checks quest IDs, add a runtime check in _on_dialogue_started_for_quests.

After the generic auto-start loop (added in Plan 42-01), add a reputation gate:
```gdscript
# Special gate: Henderson quests require reputation >= 30
if qdata.quest_giver_id == "henderson" and dialogue_id == "henderson":
    if has_node("/root/GameManager"):
        var game_manager = get_node("/root/GameManager")
        if game_manager.get_reputation("henderson") < 30:
            continue  # Skip — reputation too low
```

Wait — this needs to go INSIDE the generic auto-start loop, before `start_quest`. Update the loop to:
```gdscript
# Auto-start quests where this NPC is the quest giver
for qid in available_quests.keys():
    var qdata: QuestData = available_quests[qid]
    if qdata.quest_giver_id == dialogue_id and can_start_quest(qid):
        # Reputation gate for Henderson quests
        if dialogue_id == "henderson" and has_node("/root/GameManager"):
            if get_node("/root/GameManager").get_reputation("henderson") < 30:
                continue
        start_quest(qid)
        DebugLogger.log_system("Quest auto-started: %s (talked to %s)" % [qid, dialogue_id])
```

Note: The `dialogue_id` variable in _on_dialogue_started_for_quests is extracted from DialogueManager._dialogues and will be "henderson" (the base key from the JSON file). This matches the quest_giver_id "henderson".

**Update QuestManager log message:**
At the end of _register_all_quests, the existing log message at line 52 (`_ready`) already shows quest count. No changes needed there.
  </action>
  <verify>
- Count quests in _register_all_quests: should be 9 total (q1-q9)
- Each quest has: id, title, description, quest_giver_id, objective arrays of matching length
- Chain quests: investigation_1→2→3→4 have correct prerequisite_quest_ids
- requires_prior arrays: return-to-NPC objectives all have `true` as last element
- Fetch (q3): item_collect + dialogue triggers, requires_prior [false, true]
- Elimination (q4): enemy_kill + dialogue triggers, target_count [5, 1]
- Delivery (q5): item_collect + dialogue triggers, requires_prior [false, true]
- Chain (q6-q9): zone/enemy_kill/dialogue triggers with escalating difficulty
- Henderson reputation gate (>= 30) in auto-start loop
  </verify>
  <done>
- 9 quests registered (2 existing + 7 new) covering all 5 types: Interaction (q1), Zone (q2), Fetch (q3), Elimination (q4), Delivery (q5), Chain (q6-q9)
- Quest prerequisite chains are correctly wired
- Sequential objectives use requires_prior_complete for return-to-NPC steps
- Reputation rewards specified for all new quests
- Henderson reputation gate prevents starting pest_control before rep >= 30
  </done>
</task>

<task type="auto">
  <name>Task 2: Place quest item pickups in zones</name>
  <files>
    world/zones/backyard.gd
    world/zones/neighborhood.gd
  </files>
  <action>
**backyard.gd — Add "lost ball" quest item pickup:**

At the top of the file (after the existing preload constants), add:
```gdscript
const QuestItemPickupScript = preload("res://components/quest_item_pickup/quest_item_pickup.gd")
```

In `_setup_zone()`, after the mini-boss trigger build and before the spawn point check, add:
```gdscript
# Build quest item pickups
_build_quest_pickups()
```

Add the new function:
```gdscript
# =============================================================================
# QUEST ITEM PICKUPS
# =============================================================================

func _build_quest_pickups() -> void:
    _build_lost_ball_pickup()

func _build_lost_ball_pickup() -> void:
    # Lost ball for "Find the Lost Ball" quest (Kids Gang fetch quest)
    # Placed in the backyard near some bushes, away from the main path
    var pickup = Area2D.new()
    pickup.set_script(QuestItemPickupScript)
    pickup.name = "LostBallPickup"
    pickup.item_id = "lost_ball"
    pickup.quest_id = "find_lost_ball"  # Only visible when quest is active
    pickup.pickup_color = Color(0.9, 0.3, 0.3)  # Red ball
    pickup.label_text = "Ball"
    pickup.position = Vector2(300, 80)  # Back-right area of backyard
    add_child(pickup)
```

**neighborhood.gd — Add "mail package" quest item pickup:**

At the top of the file, the QuestItemPickupScript preload. After the existing `const DialogueNPCScript`:
```gdscript
const QuestItemPickupScript = preload("res://components/quest_item_pickup/quest_item_pickup.gd")
```

In `_setup_zone()`, after the NPC build calls (after `_build_henderson()`) and before the spawn point check, add:
```gdscript
# Build quest item pickups
_build_quest_pickups()
```

Add the new function section before the existing `# =============================================================================
# STORY NPCs` section:
```gdscript
# =============================================================================
# QUEST ITEM PICKUPS
# =============================================================================

func _build_quest_pickups() -> void:
    _build_mail_package_pickup()

func _build_mail_package_pickup() -> void:
    # Mail package for "Special Delivery" quest (Maurice delivery quest)
    # Placed near Maurice's position — he asks you to pick it up from his mail cart
    var pickup = Area2D.new()
    pickup.set_script(QuestItemPickupScript)
    pickup.name = "MailPackagePickup"
    pickup.item_id = "mail_package"
    pickup.quest_id = "special_delivery"  # Only visible when quest is active
    pickup.pickup_color = Color(0.4, 0.3, 0.7)  # Purple package
    pickup.label_text = "Package"
    pickup.position = Vector2(420, 310)  # Near Maurice (400, 300) — his mail cart area
    add_child(pickup)
```

**Placement rationale:**
- Lost ball at (300, 80) in backyard: away from spawn point (60, 140), requires exploring the zone. Near the back area for natural exploration flow.
- Mail package at (420, 310) in neighborhood: very close to Maurice (400, 300), simulating picking up from his mail cart. Player grabs it then walks to Gertrude (120, 220).
  </action>
  <verify>
- backyard.gd: has QuestItemPickupScript preload, _build_quest_pickups() called in _setup_zone(), _build_lost_ball_pickup creates Area2D with item_id="lost_ball" and quest_id="find_lost_ball"
- neighborhood.gd: has QuestItemPickupScript preload, _build_quest_pickups() called in _setup_zone(), _build_mail_package_pickup creates Area2D with item_id="mail_package" and quest_id="special_delivery"
- Run the game, enter Backyard without quest active → no ball visible
- Start "Find the Lost Ball" quest → ball appears at (300, 80) in Backyard
- Touch the ball → Events.pickup_collected emitted → objective advances
- Mail package only visible when "Special Delivery" quest is active
  </verify>
  <done>
- Lost ball pickup in Backyard (300, 80): red diamond, quest-gated to find_lost_ball
- Mail package pickup in Neighborhood (420, 310): purple diamond, quest-gated to special_delivery
- Both use QuestItemPickupScript component from Plan 42-01
- Both emit Events.pickup_collected on player collision
- Both are invisible until their associated quest is active
  </done>
</task>

</tasks>

<verification>
Full end-to-end verification after both tasks complete:

1. **Interaction quest (existing):** Talk to Gertrude → "Meet the Neighbors" starts. Talk to Maurice, Kids Gang, Henderson (any order) → objectives complete → quest completes. Rewards: 50 coins, 25 EXP.

2. **Zone quest (existing):** Talk to Maurice → "Community Watch" starts (requires meet_neighbors complete). Visit Backyard and Sewers → quest completes. Rewards: 75 coins, 30 EXP.

3. **Fetch quest:** Talk to Kids Gang → "Find the Lost Ball" starts (requires meet_neighbors). Go to Backyard → red ball visible at (300, 80). Touch ball → "Find the lost ball" objective completes. Return to Kids Gang → quest completes. Rewards: 60 coins, 30 EXP, +15 kids_gang rep.

4. **Elimination quest:** Talk to Henderson (rep >= 30) → "Pest Control" starts. Defeat 5 enemies anywhere → tracker shows "Defeat 5 enemies (3/5)" progress. After 5 kills → return to Henderson → quest completes. Rewards: 100 coins, 50 EXP, +20 henderson rep.

5. **Delivery quest:** Talk to Maurice (requires community_watch) → "Special Delivery" starts. Purple package appears near Maurice (420, 310). Pick it up → talk to Gertrude → quest completes. Rewards: 75 coins, 35 EXP, +15 maurice rep, +10 gertrude rep.

6. **Chain quest:** Talk to Gertrude → "Investigation: First Patrol" starts. Visit Backyard → return to Gertrude → quest completes. Then "Investigation: Cleanup" auto-starts → defeat 3 enemies → return. Then "Sewers Recon" → visit sewers → return. Then "The Full Report" → talk to 3 NPCs (any order) → return to Gertrude → quest completes. Final rewards: 150 coins, 75 EXP, +20 gertrude + reps for all NPCs.

7. **NPC markers:** All quest givers show "!" when they have available quests. NPCs with active dialogue objectives show "?" (only when objective can advance).

8. **Save/load:** Save mid-quest, reload → quest state preserved (active quests, objective progress, completed quests).
</verification>

<success_criteria>
- 9 total quests playable: 2 existing (interaction, zone) + 7 new (1 fetch, 1 elimination, 1 delivery, 4 chain)
- All 5 quest types functional: Interaction, Zone, Fetch, Elimination, Delivery, Chain
- Quest item pickups appear in correct zones only when quests are active
- Chain quests unlock sequentially via prerequisite_quest_ids
- Sequential objectives prevent premature turn-in (requires_prior_complete)
- NPC quest markers work correctly for all 4 NPCs across all quests
- Reputation rewards granted on quest completion
- No regressions in existing quest functionality
</success_criteria>

<output>
After completion, create `docs/phases/42-quest-types/42-02-SUMMARY.md`
</output>
