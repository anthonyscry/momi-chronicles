---
phase: 45-web-export
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - autoloads/save_manager.gd
  - autoloads/settings_manager.gd
  - autoloads/auto_bot.gd
  - ui/hud/audio_debug.tscn
  - lib/serve_web.py
  - exports/web/index.html
autonomous: false

must_haves:
  truths:
    - "Web export builds without errors from CLI"
    - "Game loads in Chrome/Firefox/Edge browser"
    - "Save/load works in browser (IndexedDB persistence)"
    - "Audio plays after first user interaction"
    - "All 5 zones are reachable and playable in browser"
  artifacts:
    - path: "exports/web/index.html"
      provides: "Web build entry point"
    - path: "exports/web/index.wasm"
      provides: "WebAssembly binary"
    - path: "exports/web/index.pck"
      provides: "Game data package"
    - path: "lib/serve_web.py"
      provides: "Local test server with COOP/COEP headers"
  key_links:
    - from: "autoloads/save_manager.gd"
      to: "Emscripten IndexedDB"
      via: "FileAccess + OS.has_feature('web') guard"
      pattern: "OS\\.has_feature.*web"
---

<objective>
Build and test a working web export of Momi's Adventure.

Purpose: Enable browser-based play for itch.io hosting (Phase 47 target).
Output: Working web build in exports/web/, local test server, web-compatible save system.
</objective>

<context>
@project.godot
@export_presets.cfg
@autoloads/save_manager.gd
@autoloads/settings_manager.gd
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add web compatibility guards</name>
  <files>
    autoloads/save_manager.gd
    autoloads/settings_manager.gd
  </files>
  <action>
  Add web-safe file I/O to SaveManager. The current atomic write pattern
  (write .tmp file → backup old → rename .tmp → done) may fail on
  Emscripten's virtual filesystem. Add an OS.has_feature("web") branch
  in _write_save_file() that skips the atomic write and instead writes
  directly to SAVE_FILE_PATH (no .tmp, no rename, no backup — Emscripten
  handles persistence through IndexedDB sync). Keep the desktop path unchanged.

  In SettingsManager.apply_video_settings(), guard the fullscreen toggle:
  on web, DisplayServer.window_set_mode() may behave differently. Wrap
  the fullscreen call in `if not OS.has_feature("web"):` for now — web
  fullscreen is handled by the HTML shell's fullscreen button instead.

  In save_manager.gd _write_save_file(), after writing on web, call:
    if OS.has_feature("web"):
        # Flush Emscripten FS to IndexedDB
        if Engine.has_method("get_write_movie_path"):
            pass  # Godot 4.5 auto-syncs on file close
  (Note: Godot 4.x auto-syncs the virtual FS to IndexedDB when FileAccess
  is closed, so explicit sync may not be needed. But add the web branch
  for the simplified write path regardless.)

  Do NOT change the desktop save path — keep atomic writes for Windows/Linux.
  </action>
  <verify>
  - grep for OS.has_feature.*web in save_manager.gd — should find web branch
  - grep for OS.has_feature.*web in settings_manager.gd — should find fullscreen guard
  - The desktop save path (non-web) must be completely unchanged
  </verify>
  <done>
  SaveManager has web-safe write path (direct write, no atomic rename).
  SettingsManager skips fullscreen toggle on web. Desktop behavior unchanged.
  </done>
</task>

<task type="auto">
  <name>Task 2: Export web build + create local test server</name>
  <files>
    exports/web/index.html
    lib/serve_web.py
  </files>
  <action>
  1. Create exports/web/ directory if it doesn't exist.

  2. Run Godot CLI web export:
     godot --headless --export-release "Web" exports/web/index.html
     (If export templates aren't installed, run:
      godot --headless --export-release "Web" exports/web/index.html 2>&1
      and check for "No export template found" error. If so, this becomes
      a checkpoint — user needs to download web export templates via
      Godot Editor > Editor > Manage Export Templates > Download.)

  3. Create lib/serve_web.py — a minimal Python 3 HTTP server that:
     - Serves files from exports/web/
     - Adds required COOP/COEP headers on every response:
       Cross-Origin-Opener-Policy: same-origin
       Cross-Origin-Embedder-Policy: require-corp
     - Serves .wasm files with correct Content-Type: application/wasm
     - Runs on localhost:8060 (or configurable port)
     - Prints "Open http://localhost:8060 in your browser" on start

  4. Verify the export produced at minimum:
     - exports/web/index.html
     - exports/web/index.wasm
     - exports/web/index.pck (or index.js)
     - exports/web/index.audio.worklet.js

  The web export should produce a playable build. If Godot is not on PATH,
  try common Windows install locations or ask user for godot.exe path.
  </action>
  <verify>
  - ls exports/web/ shows index.html, index.wasm, index.pck (or equivalent)
  - python lib/serve_web.py starts without errors (test with timeout)
  - curl -I http://localhost:8060 shows COOP/COEP headers in response
  </verify>
  <done>
  Web export files exist in exports/web/. Local test server serves them
  with correct COOP/COEP headers.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
  Web export of Momi's Adventure with local test server.
  </what-built>
  <how-to-verify>
  1. Start the test server: `python lib/serve_web.py`
  2. Open http://localhost:8060 in Chrome (or Firefox/Edge)
  3. Wait for WASM to load (may take 10-30 seconds first time)
  4. Verify title screen appears
  5. Click "New Game" → select difficulty → verify neighborhood loads
  6. Walk around, attack an enemy, verify audio plays
  7. Press ESC → verify pause menu works
  8. Walk to backyard zone exit → verify zone transition works
  9. Press ESC → Quit to Title → Continue → verify save loaded
  10. (Optional) Test in a second browser for compatibility

  Known limitations:
  - First load may be slow (large WASM + PCK download)
  - F1/F2 debug toggles still active (cosmetic, not blocking)
  - Fullscreen button may not work (use browser F11 instead)
  </how-to-verify>
  <resume-signal>
  Type "approved" if the game runs in browser, or describe any issues.
  </resume-signal>
</task>

</tasks>

<verification>
- Web build exists in exports/web/ with all required files
- Local server serves with COOP/COEP headers
- Game loads and runs in at least one modern browser
- Save/load persists across page refreshes
- Audio plays after first interaction
</verification>

<success_criteria>
Momi's Adventure runs in a web browser from local server. Player can start
a new game, play through zones, save, and reload. Audio works. The build
is ready for itch.io upload in Phase 47.
</success_criteria>

<output>
After completion, create `docs/phases/45-web-export/45-01-SUMMARY.md`
</output>
