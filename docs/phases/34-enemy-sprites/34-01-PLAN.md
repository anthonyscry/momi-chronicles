---
phase: 34-enemy-sprites
plan: 01
type: execute
wave: 1
depends_on: ["33-01"]
files_modified:
  - characters/enemies/enemy_base.gd
  - characters/enemies/raccoon.tscn
  - characters/enemies/crow.tscn
  - characters/enemies/stray_cat.tscn
  - characters/enemies/sewer_rat.tscn
  - characters/enemies/shadow_creature.tscn
  - characters/enemies/alpha_raccoon.tscn
  - characters/enemies/crow_matriarch.tscn
  - characters/enemies/rat_king.tscn
  - characters/enemies/boss_raccoon_king.tscn
autonomous: true

must_haves:
  truths:
    - "All 5 regular enemies display as pixel art sprites"
    - "All 3 mini-bosses display as pixel art sprites"
    - "Raccoon King boss displays as sprite with normal and enrage variants"
    - "Enemy animations play correctly for each state (idle, walk, attack, hurt, death)"
    - "All enemy states (idle, patrol, chase, attack, hurt, death) trigger appropriate animations"
    - "No Polygon2D placeholder visible on any enemy"
  artifacts:
    - path: "characters/enemies/enemy_base.gd"
      provides: "AnimatedSprite2D reference and animation state machine integration"
      contains: "AnimatedSprite2D"
    - path: "characters/enemies/raccoon.tscn"
      provides: "Raccoon with SpriteFrames (idle, walk, attack, hurt, death)"
      contains: "AnimatedSprite2D"
  key_links:
    - from: "characters/enemies/states/*.gd"
      to: "AnimatedSprite2D"
      via: "owner.sprite.play() in enter()"
    - from: "characters/enemies/enemy_base.gd"
      to: "art/generated/enemies/*.png"
      via: "SpriteFrames per enemy type"

<objective>
Replace all enemy and boss Polygon2D placeholders with AnimatedSprite2D using generated pixel art. Wire enemy state machines to play correct animations for each state (idle, patrol, chase, attack, hurt, death). Handle special states (enrage, dive, split, stealth, pounce) with distinct animations.

Purpose: Enemies are the most frequently encountered entities after the player. Polishing them completes the visual overhaul of all combat encounters.
Output: All 5 regular enemies, 3 mini-bosses, and the final boss display as animated pixel art characters.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@docs/ROADMAP.md
@docs/STATE.md
@characters/enemies/enemy_base.gd
@characters/enemies/raccoon.tscn
@characters/enemies/states/enemy_idle.gd
@characters/enemies/states/enemy_patrol.gd
@characters/enemies/states/enemy_chase.gd
@characters/enemies/states/enemy_attack.gd
@characters/enemies/states/enemy_hurt.gd
@characters/enemies/states/enemy_death.gd
@art/generated/enemies/*.png
@art/generated/bosses/*.png
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update enemy_base.gd to use AnimatedSprite2D</name>
  <files>
    characters/enemies/enemy_base.gd
  </files>
  <action>
  **In enemy_base.gd:**
  1. Change line 28 from `@onready var sprite: Polygon2D = $Sprite2D` to `@onready var sprite: AnimatedSprite2D = $Sprite2D`
  2. Add helper function for animation state switching:
     ```gdscript
     func _update_animation() -> void:
         if not sprite or health.current_health <= 0:
             return
         
         var new_animation: String = "idle"
         if state_machine.current_state_name in ["Patrol", "Wander"]:
             new_animation = "walk"
         elif state_machine.current_state_name == "Chase":
             new_animation = "walk"  # or "run" if enemy has one
         elif state_machine.current_state_name == "Attack":
             new_animation = "attack"
         elif state_machine.current_state_name == "Hurt":
             new_animation = "hurt"
         
         if sprite.animation != new_animation:
             sprite.play(new_animation)
         
         # Facing direction
         if velocity.x < 0:
             sprite.flip_h = true
         elif velocity.x > 0:
             sprite.flip_h = false
     ```
  3. Add `_physics_process` override to call `_update_animation()`:
     ```gdscript
     func _physics_process(delta: float) -> void:
         _update_animation()
     ```
  4. Find any `sprite.color` references and change to `sprite.modulate`
  
  **Do NOT change:**
  - Any AI behavior, detection ranges, attack logic
  - Health/damage handling
  - Drop tables
  - State machine logic
  </action>
  <verify>
  - Grep enemy_base.gd for "Polygon2D" — should return zero matches
  - Grep enemy_base.gd for "\.color\s*=" — should return zero matches (all use .modulate)
  - Check that `_update_animation()` is called in _physics_process
  </verify>
  <done>enemy_base.gd uses AnimatedSprite2D type, animation helper function added, zero Polygon2D references</done>
</task>

<task type="auto">
  <name>Task 2: Update all regular enemy scenes with SpriteFrames</name>
  <files>
    characters/enemies/raccoon.tscn
    characters/enemies/crow.tscn
    characters/enemies/stray_cat.tscn
    characters/enemies/sewer_rat.tscn
    characters/enemies/shadow_creature.tscn
  </files>
  <action>
  **For each enemy scene:**

  **raccoon.tscn:**
  - Replace Polygon2D with AnimatedSprite2D
  - Add SpriteFrames with: idle, walk, attack, hurt, death
  - Use: raccoon_idle.png, raccoon_attack.png

  **crow.tscn:**
  - Add: idle, dive, hurt, death
  - Use: crow_idle.png, crow_dive.png

  **stray_cat.tscn:**
  - Add: idle, stealth, pounce, hurt, death
  - Use: stray_cat_idle.png, stray_cat_stealth.png, stray_cat_pounce.png

  **sewer_rat.tscn:**
  - Add: idle, pack, hurt, death
  - Use: sewer_rat_idle.png, sewer_rat_pack.png

  **shadow_creature.tscn:**
  - Add: idle, bolt, hurt, death
  - Use: shadow_creature_idle.png, shadow_creature_bolt.png

  **Pattern for each:**
  1. Remove Polygon2D node
  2. Add AnimatedSprite2D named "Sprite2D"
  3. Create SpriteFrames resource with animations
  4. Set centered=true, z_index=0
  5. Keep all collision shapes, state machine, health component intact
  </action>
  <verify>
  - Grep each enemy .tscn for "Polygon2D" — zero matches
  - Open each scene in Godot editor (or read file) — confirm AnimatedSprite2D with SpriteFrames
  - Verify SpriteFrames has 4-5 animations each
  </verify>
  <done>All 5 regular enemy scenes use AnimatedSprite2D with appropriate SpriteFrames</done>
</task>

<task type="auto">
  <name>Task 3: Update mini-boss enemy scenes</name>
  <files>
    characters/enemies/alpha_raccoon.tscn
    characters/enemies/crow_matriarch.tscn
    characters/enemies/rat_king.tscn
  </files>
  <action>
  **alpha_raccoon.tscn:**
  - Add: idle, slam, summon, hurt, death
  - Use: alpha_raccoon.png, alpha_raccoon_slam.png

  **crow_matriarch.tscn:**
  - Add: idle, dive, summon, hurt, death
  - Use: crow_matriarch.png, crow_matriarch_dive.png

  **rat_king.tscn:**
  - Add: idle, poison, split, hurt, death
  - Use: rat_king.png, rat_king_poison.png

  **Note:** Mini-bosses may have special animations for their unique abilities
  </action>
  <verify>
  - Each mini-boss scene has 5+ animations
  - Special ability animations included (slam, dive, poison)
  </verify>
  <done>All 3 mini-boss scenes use AnimatedSprite2D with ability-specific animations</done>
</task>

<task type="auto">
  <name>Task 4: Update Raccoon King boss scene</name>
  <files>
    characters/enemies/boss_raccoon_king.tscn
  </files>
  <action>
  **boss_raccoon_king.tscn:**
  - Add SpriteFrames with enrage variant:
    - idle (normal)
    - idle_enrage (enrage animation)
    - attack
    - hurt
    - death
  
  - Use: raccoon_king_normal.png, raccoon_king_enrage.png, raccoon_king_death.png

  **Enrage handling:**
  - Add `is_enraged: bool = false` to boss script
  - When HP < 50%, set `is_enraged = true` and play enrage animation
  - Update `_update_animation()` to use enrage variants when `is_enraged`
  </action>
  <verify>
  - Boss scene has enrage animation
  - HP-based enrage trigger works
  - Sprite changes when enrage activates
  </verify>
  <done>Boss scene has normal and enrage animations with HP-triggered transition</done>
</task>

<task type="auto">
  <name>Task 5: Wire enemy state scripts to play animations</name>
  <files>
    characters/enemies/states/enemy_idle.gd
    characters/enemies/states/enemy_patrol.gd
    characters/enemies/states/enemy_chase.gd
    characters/enemies/states/enemy_attack.gd
    characters/enemies/states/enemy_hurt.gd
    characters/enemies/states/enemy_death.gd
  </files>
  <action>
  **In each state script, add animation call in enter():**

  **enemy_idle.gd:**
  ```gdscript
  func enter() -> void:
      player.velocity = Vector2.ZERO
      if player.sprite:
          player.sprite.play("idle")
      # ... rest of enter()
  ```

  **enemy_patrol.gd:**
  ```gdscript
  func enter() -> void:
      # ... existing code
      if player.sprite:
          player.sprite.play("walk")
  ```

  **enemy_chase.gd:**
  ```gdscript
  func enter() -> void:
      # ... existing code  
      if player.sprite:
          player.sprite.play("walk")  # or "run" if available
  ```

  **enemy_attack.gd:**
  ```gdscript
  func enter() -> void:
      # ... existing code
      if player.sprite:
          player.sprite.play("attack")
  ```

  **enemy_hurt.gd:**
  ```gdscript
  func enter() -> void:
      # ... existing code
      if player.sprite:
          player.sprite.play("hurt")
  ```

  **enemy_death.gd:**
  ```gdscript
  func enter() -> void:
      # ... existing code
      if player.sprite:
          player.sprite.play("death")
  ```
  </action>
  <verify>
  - Each state script has `player.sprite.play()` call in enter()
  - Animation names match SpriteFrames in each enemy scene
  </verify>
  <done>All 6 enemy state scripts trigger correct animations on state entry</done>
</task>

<task type="auto">
  <name>Task 6: Handle enemy-specific special states</name>
  <files>
    characters/enemies/stray_cat.gd
    characters/enemies/crow.gd
    characters/enemies/rat_king.gd
    characters/enemies/boss_raccoon_king.gd
  </files>
  <action>
  **stray_cat.gd - stealth/pounce states:**
  - Add `play_stealth()` and `play_pounce()` calls in appropriate state transitions
  - When entering stealth state: `sprite.play("stealth")`
  - When pouncing: `sprite.play("pounce")`

  **crow.gd - dive state:**
  - Add dive animation trigger when entering dive attack
  - `sprite.play("dive")` when aerial attack triggers

  **rat_king.gd - split/poison states:**
  - Add `sprite.play("poison")` when poison cloud triggers
  - Add `sprite.play("split")` when split mechanic triggers

  **boss_raccoon_king.gd - enrage state:**
  - Add HP check in _physics_process or health callback:
    ```gdscript
    if health.current_health <= health.max_health * 0.5 and not is_enraged:
        is_enraged = true
        sprite.play("idle_enrage")
    ```
  </action>
  <verify>
  - Enemy-specific animations trigger at correct times
  - Enrage transition works at 50% HP
  - Stealth, pounce, dive, poison animations play correctly
  </verify>
  <done>All enemy-specific special states have corresponding animations</done>
</task>

</tasks>

<verification>
1. Run the game and enter combat
2. All enemies display as pixel art sprites (no colored squares)
3. Watch enemy animations during combat:
   - Raccoon: idle, walk, attack, hurt, death
   - Crow: idle, dive attack, hurt, death
   - Stray Cat: idle, stealth, pounce, hurt, death
   - Sewer Rat: idle, pack formation, hurt, death
   - Shadow Creature: idle, bolt projectile, hurt, death
4. Mini-bosses:
   - Alpha Raccoon: slam and summon animations
   - Crow Matriarch: dive and swarm animations
   - Rat King: poison cloud and split animations
5. Raccoon King:
   - Normal animations at 100-50% HP
   - Enrage animation at 50% HP
   - Death animation at 0 HP
6. No Polygon2D nodes visible anywhere in enemies
</verification>

<success_criteria>
- All 5 regular enemies display as animated pixel art (idle, walk, attack, hurt, death)
- All 3 mini-bosses display as animated pixel art with ability-specific animations
- Raccoon King boss displays with normal and enrage visual variants
- Enemy state transitions trigger correct animations
- Zero Polygon2D references in enemy scenes/scripts
- All combat gameplay mechanics function identically (no AI regression)
</success_criteria>

<output>
After completion, create `docs/phases/34-enemy-sprites/34-01-SUMMARY.md`
</output>
