---
phase: 11-boss-fight
plan: 03
type: execute
wave: 2
depends_on: ["11-01"]
files_modified:
  - ui/hud/boss_health_bar.gd (NEW)
  - ui/hud/boss_health_bar.tscn (NEW)
  - ui/hud/game_hud.gd
  - ui/hud/game_hud.tscn
  - ui/menus/victory_screen.gd (NEW)
  - ui/menus/victory_screen.tscn (NEW)
autonomous: true

must_haves:
  truths:
    - "Boss health bar appears at top of screen"
    - "Boss name displayed above health bar"
    - "Victory screen shows after boss defeated"
  artifacts:
    - path: "ui/hud/boss_health_bar.tscn"
      provides: "Boss health bar UI"
    - path: "ui/menus/victory_screen.tscn"
      provides: "Victory celebration screen"
  key_links:
    - from: "boss_health_bar.gd"
      to: "Events.boss_spawned"
      via: "show bar on spawn"
---

<objective>
Add boss-specific UI: large health bar at top of screen and victory screen.

Purpose: Give boss fight proper UI treatment and victory celebration
Output: Boss health bar, victory screen with stats
</objective>

<context>
@ui/hud/game_hud.gd (existing HUD)
@ui/hud/health_bar.gd (reference for bar style)
@autoloads/events.gd (boss signals)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Boss Health Bar</name>
  <files>ui/hud/boss_health_bar.gd, ui/hud/boss_health_bar.tscn</files>
  <action>
Create large boss health bar for top of screen:

**boss_health_bar.tscn structure:**
```
BossHealthBar (Control) [anchored top-center]
├── Container (VBoxContainer)
│   ├── BossName (Label) - "RACCOON KING"
│   └── BarContainer (Control)
│       ├── Background (ColorRect) - dark
│       ├── Fill (ColorRect) - red/orange
│       ├── DamageFill (ColorRect) - shows recent damage (white, fades)
│       └── Border (ColorRect)
```

**boss_health_bar.gd:**
```gdscript
extends Control
class_name BossHealthBar
## Large health bar for boss encounters

@onready var boss_name_label: Label = $Container/BossName
@onready var background: ColorRect = $Container/BarContainer/Background
@onready var fill: ColorRect = $Container/BarContainer/Fill
@onready var damage_fill: ColorRect = $Container/BarContainer/DamageFill

const BAR_WIDTH: float = 200.0
const BAR_HEIGHT: float = 12.0

const BG_COLOR: Color = Color(0.15, 0.1, 0.1, 0.9)
const FILL_COLOR: Color = Color(0.9, 0.3, 0.2)
const FILL_COLOR_ENRAGED: Color = Color(1.0, 0.2, 0.1)
const DAMAGE_COLOR: Color = Color(1, 1, 1, 0.7)

var boss_ref: Node = null
var current_health: int = 0
var max_health: int = 100
var displayed_health: float = 100.0  # For smooth animation
var is_enraged: bool = false

var fill_tween: Tween

func _ready() -> void:
    # Hide by default
    visible = false
    
    # Setup visuals
    _setup_visuals()
    
    # Connect to boss events
    Events.boss_spawned.connect(_on_boss_spawned)
    Events.boss_enraged.connect(_on_boss_enraged)
    Events.boss_defeated.connect(_on_boss_defeated)

func _setup_visuals() -> void:
    background.color = BG_COLOR
    background.size = Vector2(BAR_WIDTH, BAR_HEIGHT)
    
    fill.color = FILL_COLOR
    fill.size = Vector2(BAR_WIDTH, BAR_HEIGHT)
    
    damage_fill.color = DAMAGE_COLOR
    damage_fill.size = Vector2(0, BAR_HEIGHT)
    
    boss_name_label.add_theme_font_size_override("font_size", 14)
    boss_name_label.add_theme_color_override("font_color", Color(1, 0.9, 0.8))
    boss_name_label.horizontal_alignment = HORIZONTAL_ALIGNMENT_CENTER

func _process(_delta: float) -> void:
    if not visible or not boss_ref:
        return
    
    # Update health from boss
    if boss_ref.health:
        var new_health = boss_ref.health.current_health
        if new_health != current_health:
            _update_health(new_health, boss_ref.health.max_health)

func _on_boss_spawned(boss: Node) -> void:
    boss_ref = boss
    
    # Set boss name
    boss_name_label.text = "RACCOON KING"
    
    # Initialize health
    if boss.health:
        max_health = boss.health.max_health
        current_health = boss.health.current_health
        displayed_health = float(current_health)
    
    # Show with animation
    _show_bar()

func _on_boss_enraged(_boss: Node) -> void:
    is_enraged = true
    fill.color = FILL_COLOR_ENRAGED
    
    # Flash effect
    modulate = Color(1.5, 1.2, 1.2)
    var tween = create_tween()
    tween.tween_property(self, "modulate", Color.WHITE, 0.3)
    
    # Add "ENRAGED!" to name
    boss_name_label.text = "RACCOON KING - ENRAGED!"
    boss_name_label.add_theme_color_override("font_color", Color(1, 0.5, 0.4))

func _on_boss_defeated(_boss: Node) -> void:
    # Drain bar dramatically
    var tween = create_tween()
    tween.tween_property(fill, "size:x", 0.0, 0.5)
    tween.tween_property(self, "modulate:a", 0.0, 0.3)
    tween.tween_callback(func(): visible = false)
    
    boss_ref = null

func _update_health(new_health: int, new_max: int) -> void:
    var old_health = current_health
    current_health = new_health
    max_health = new_max
    
    # Show damage flash
    if new_health < old_health:
        _show_damage_flash(old_health, new_health)
    
    # Animate fill bar
    _animate_fill()

func _show_damage_flash(old_hp: int, new_hp: int) -> void:
    # Position damage fill to show lost health
    var old_percent = float(old_hp) / float(max_health)
    var new_percent = float(new_hp) / float(max_health)
    
    damage_fill.position.x = BAR_WIDTH * new_percent
    damage_fill.size.x = BAR_WIDTH * (old_percent - new_percent)
    damage_fill.modulate.a = 1.0
    
    # Fade out
    var tween = create_tween()
    tween.tween_property(damage_fill, "modulate:a", 0.0, 0.4).set_delay(0.1)

func _animate_fill() -> void:
    if fill_tween:
        fill_tween.kill()
    
    var target_width = BAR_WIDTH * (float(current_health) / float(max_health))
    
    fill_tween = create_tween()
    fill_tween.tween_property(fill, "size:x", target_width, 0.2)

func _show_bar() -> void:
    visible = true
    modulate.a = 0
    position.y = -30
    
    var tween = create_tween()
    tween.set_parallel(true)
    tween.tween_property(self, "modulate:a", 1.0, 0.3)
    tween.tween_property(self, "position:y", 0.0, 0.3).set_ease(Tween.EASE_OUT)
```
  </action>
  <verify>Boss health bar files exist</verify>
  <done>Boss health bar UI component</done>
</task>

<task type="auto">
  <name>Task 2: Create Victory Screen</name>
  <files>ui/menus/victory_screen.gd, ui/menus/victory_screen.tscn</files>
  <action>
Create victory celebration screen:

**victory_screen.tscn structure:**
```
VictoryScreen (Control) [full screen, process_mode: always]
├── Background (ColorRect) - semi-transparent dark
├── Container (VBoxContainer) [centered]
│   ├── Title (Label) - "VICTORY!"
│   ├── Spacer (Control)
│   ├── Stats (VBoxContainer)
│   │   ├── BossName (Label) - "Defeated: Raccoon King"
│   │   ├── LevelReached (Label) - "Level: 7"
│   │   └── TotalEXP (Label) - "Total EXP: 450"
│   ├── Spacer2 (Control)
│   └── Buttons (VBoxContainer)
│       ├── ContinueButton - "Continue Playing"
│       └── QuitButton - "Quit to Title"
```

**victory_screen.gd:**
```gdscript
extends Control
class_name VictoryScreen
## Shown after defeating the boss

@onready var title: Label = $Container/Title
@onready var boss_name_label: Label = $Container/Stats/BossName
@onready var level_label: Label = $Container/Stats/LevelReached
@onready var exp_label: Label = $Container/Stats/TotalEXP
@onready var continue_button: Button = $Container/Buttons/ContinueButton
@onready var quit_button: Button = $Container/Buttons/QuitButton

func _ready() -> void:
    visible = false
    process_mode = Node.PROCESS_MODE_ALWAYS
    
    Events.boss_defeated.connect(_on_boss_defeated)
    
    continue_button.pressed.connect(_on_continue)
    quit_button.pressed.connect(_on_quit)

func _on_boss_defeated(_boss: Node) -> void:
    # Wait for death animation
    await get_tree().create_timer(2.0).timeout
    
    _show_victory()

func _show_victory() -> void:
    visible = true
    get_tree().paused = true
    
    # Populate stats
    var player = get_tree().get_first_node_in_group("player")
    if player and player.progression:
        level_label.text = "Level Reached: " + str(player.progression.get_level())
        exp_label.text = "Total EXP: " + str(player.progression.total_exp)
    
    boss_name_label.text = "Defeated: Raccoon King"
    
    # Animate in
    modulate.a = 0
    var tween = create_tween()
    tween.tween_property(self, "modulate:a", 1.0, 0.5)
    
    # Title animation
    title.scale = Vector2(0.5, 0.5)
    var title_tween = create_tween()
    title_tween.tween_property(title, "scale", Vector2(1.0, 1.0), 0.3).set_ease(Tween.EASE_OUT_BACK)

func _on_continue() -> void:
    visible = false
    get_tree().paused = false
    
    # Return to neighborhood
    GameManager.load_zone("neighborhood", "default")

func _on_quit() -> void:
    get_tree().paused = false
    get_tree().change_scene_to_file("res://ui/menus/title_screen.tscn")

func _setup_style() -> void:
    # Title
    title.text = "VICTORY!"
    title.add_theme_font_size_override("font_size", 32)
    title.add_theme_color_override("font_color", Color(1, 0.9, 0.3))
    
    # Stats labels
    for label in [boss_name_label, level_label, exp_label]:
        label.add_theme_font_size_override("font_size", 14)
        label.add_theme_color_override("font_color", Color(0.9, 0.9, 0.9))
    
    # Buttons
    continue_button.text = "Continue Playing"
    quit_button.text = "Quit to Title"
```
  </action>
  <verify>Victory screen files exist</verify>
  <done>Victory screen UI</done>
</task>

<task type="auto">
  <name>Task 3: Integrate Boss UI into HUD</name>
  <files>ui/hud/game_hud.tscn, ui/hud/game_hud.gd</files>
  <action>
1. In game_hud.tscn:
   - Instance boss_health_bar.tscn as child
   - Anchor: top-center
   - Position: (0, 10) from top
   - Instance victory_screen.tscn as child
   - Anchor: full rect (covers screen)

2. Final HUD layout:
```
┌─────────────────────────────────────────┐
│          [RACCOON KING]                 │  <- Boss bar (when fighting boss)
│          [████████████░░░]              │
│                                         │
│ [Health ████████░░]                     │  <- Player health (top-left)
│ Lv.3 [EXP ██████░░]                     │  <- Player EXP
│                                         │
│            [1][2][3]                    │  <- Combo counter (when active)
│                                         │
│                                         │
│         [C]  [G]                        │  <- Ability bar (bottom-center)
└─────────────────────────────────────────┘
```

3. In game_hud.gd (optional references):
```gdscript
@onready var boss_health_bar: BossHealthBar = $BossHealthBar
@onready var victory_screen: VictoryScreen = $VictoryScreen
```
  </action>
  <verify>Boss UI elements in HUD</verify>
  <done>Boss UI integrated into game HUD</done>
</task>

</tasks>

<verification>
1. Run game, reach boss arena
2. Boss health bar should:
   - Slide in from top
   - Show "RACCOON KING" name
   - Have large, prominent health bar
3. Damage boss:
   - White flash shows damage amount
   - Bar smoothly decreases
4. At 50% HP:
   - Bar changes to red
   - Name shows "ENRAGED!"
5. Defeat boss:
   - Bar drains and fades
   - Victory screen appears after 2 seconds
   - Shows stats (level, EXP)
   - Can continue or quit
</verification>

<success_criteria>
- Boss health bar prominent and readable
- Damage visualization clear
- Enrage state visible in UI
- Victory screen celebratory
</success_criteria>

<output>
After completion, create `.planning/phases/11-boss-fight/11-03-SUMMARY.md`
</output>
