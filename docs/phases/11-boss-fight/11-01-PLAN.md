---
phase: 11-boss-fight
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - characters/enemies/boss_raccoon_king.gd (NEW)
  - characters/enemies/boss_raccoon_king.tscn (NEW)
  - characters/enemies/states/boss_idle.gd (NEW)
  - characters/enemies/states/boss_attack_swipe.gd (NEW)
  - characters/enemies/states/boss_attack_charge.gd (NEW)
  - characters/enemies/states/boss_attack_summon.gd (NEW)
autonomous: true

must_haves:
  truths:
    - "Boss has 3 distinct attack patterns"
    - "Boss is significantly larger than normal enemies"
    - "Boss has 200 HP"
  artifacts:
    - path: "characters/enemies/boss_raccoon_king.gd"
      provides: "Boss enemy class"
    - path: "characters/enemies/boss_raccoon_king.tscn"
      provides: "Boss scene"
  key_links:
    - from: "boss_raccoon_king.gd"
      to: "boss_attack_*.gd"
      via: "state machine transitions"
---

<objective>
Create the Raccoon King boss enemy with multiple attack patterns.

Purpose: Provide epic culmination encounter for the backyard zone
Output: Working boss with 3 attack types and 200 HP
</objective>

<context>
@characters/enemies/enemy_base.gd (base class)
@characters/enemies/raccoon.gd (reference for raccoon style)
@characters/enemies/states/ (enemy state examples)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Raccoon King Boss Class</name>
  <files>characters/enemies/boss_raccoon_king.gd</files>
  <action>
Create boss enemy extending EnemyBase:

```gdscript
extends EnemyBase
class_name BossRaccoonKing
## The Raccoon King - Final boss of the backyard zone
## Has 3 attack patterns that cycle, enrages at 50% HP

# =============================================================================
# BOSS CONFIGURATION
# =============================================================================

## Boss stats (override base)
const BOSS_MAX_HP: int = 200
const BOSS_DAMAGE: int = 25
const BOSS_SPEED: float = 40.0
const BOSS_EXP: int = 200

## Attack pattern timings
const ATTACK_COOLDOWN: float = 2.0
const ENRAGE_THRESHOLD: float = 0.5  # 50% HP

## Attack patterns
enum AttackPattern { SWIPE, CHARGE, SUMMON }
var attack_pattern_order = [AttackPattern.SWIPE, AttackPattern.CHARGE, AttackPattern.SWIPE, AttackPattern.SUMMON]
var current_attack_index: int = 0

## Enrage state
var is_enraged: bool = false

## Boss-specific
var phase: int = 1  # 1 = normal, 2 = enraged

# =============================================================================
# LIFECYCLE
# =============================================================================

func _ready() -> void:
    super._ready()
    
    # Override base stats
    if health:
        health.max_health = BOSS_MAX_HP
        health.current_health = BOSS_MAX_HP
    
    patrol_speed = BOSS_SPEED
    chase_speed = BOSS_SPEED * 1.5
    attack_damage = BOSS_DAMAGE
    exp_value = BOSS_EXP
    
    # Boss is bigger - scale up
    if sprite:
        sprite.scale = Vector2(2.5, 2.5)
    
    # Larger detection range
    detection_range = 150.0
    attack_range = 35.0
    lose_interest_range = 300.0  # Never loses interest
    
    # Customize appearance
    _setup_boss_appearance()
    
    add_to_group("boss")
    
    Events.boss_spawned.emit(self)

func _setup_boss_appearance() -> void:
    if not sprite:
        return
    
    # Darker, more menacing raccoon colors
    sprite.color = Color(0.25, 0.22, 0.3)  # Dark purple-gray
    
    # Crown indicator (add yellow accent at top)
    var crown = Polygon2D.new()
    crown.polygon = PackedVector2Array([
        Vector2(-4, -8),
        Vector2(-2, -12),
        Vector2(0, -9),
        Vector2(2, -12),
        Vector2(4, -8)
    ])
    crown.color = Color(1, 0.85, 0.2)  # Gold
    sprite.add_child(crown)

# =============================================================================
# COMBAT AI
# =============================================================================

func get_next_attack() -> AttackPattern:
    var pattern = attack_pattern_order[current_attack_index]
    current_attack_index = (current_attack_index + 1) % attack_pattern_order.size()
    return pattern

func get_attack_state_name() -> String:
    var pattern = get_next_attack()
    match pattern:
        AttackPattern.SWIPE:
            return "BossAttackSwipe"
        AttackPattern.CHARGE:
            return "BossAttackCharge"
        AttackPattern.SUMMON:
            return "BossAttackSummon"
    return "BossAttackSwipe"

func check_enrage() -> void:
    if is_enraged:
        return
    
    if health and health.get_health_percent() <= ENRAGE_THRESHOLD:
        _enter_enrage()

func _enter_enrage() -> void:
    is_enraged = true
    phase = 2
    
    # Speed up attacks
    attack_cooldown = ATTACK_COOLDOWN * 0.6
    chase_speed = BOSS_SPEED * 2.0
    
    # Visual feedback
    if sprite:
        sprite.modulate = Color(1.3, 0.8, 0.8)  # Red tint
    
    # Screen shake
    EffectsManager.screen_shake(10.0, 0.5)
    
    Events.boss_enraged.emit(self)

# =============================================================================
# DAMAGE OVERRIDE
# =============================================================================

func _on_hurt(attacking_hitbox: Hitbox) -> void:
    super._on_hurt(attacking_hitbox)
    check_enrage()
    
    # Boss doesn't flinch as much
    velocity = velocity * 0.3

func _on_died() -> void:
    # Boss death is special
    Events.boss_defeated.emit(self)
    
    # Dramatic death sequence
    _play_death_sequence()

func _play_death_sequence() -> void:
    # Disable collision
    set_collision_layer_value(2, false)
    
    # Stop all movement
    velocity = Vector2.ZERO
    
    # Flash and shake
    for i in range(5):
        if sprite:
            sprite.modulate = Color(2, 2, 2) if i % 2 == 0 else Color(1, 0.5, 0.5)
        EffectsManager.screen_shake(8.0, 0.2)
        await get_tree().create_timer(0.3).timeout
    
    # Explode into particles
    _spawn_death_particles()
    
    # Remove boss
    queue_free()

func _spawn_death_particles() -> void:
    for i in range(20):
        var particle = ColorRect.new()
        particle.size = Vector2(6, 6)
        particle.color = Color(0.4, 0.35, 0.5)
        particle.global_position = global_position
        get_parent().add_child(particle)
        
        var angle = randf() * TAU
        var speed = randf_range(50, 150)
        var end_pos = global_position + Vector2(cos(angle), sin(angle)) * speed
        
        var tween = create_tween()
        tween.set_parallel(true)
        tween.tween_property(particle, "global_position", end_pos, 0.5)
        tween.tween_property(particle, "modulate:a", 0.0, 0.5)
        tween.chain().tween_callback(particle.queue_free)
```
  </action>
  <verify>File exists with boss class</verify>
  <done>Boss class with stats and enrage mechanic</done>
</task>

<task type="auto">
  <name>Task 2: Create Boss Attack States</name>
  <files>characters/enemies/states/boss_idle.gd, characters/enemies/states/boss_attack_swipe.gd, characters/enemies/states/boss_attack_charge.gd, characters/enemies/states/boss_attack_summon.gd</files>
  <action>
Create 4 boss-specific states:

**boss_idle.gd:**
```gdscript
extends State
class_name BossIdle
## Boss idle - waits briefly then picks next attack

var idle_timer: float = 0.0
const IDLE_DURATION: float = 1.0

func enter() -> void:
    idle_timer = 0.0
    enemy.velocity = Vector2.ZERO

func physics_update(delta: float) -> void:
    if not enemy.can_act():
        return
    
    idle_timer += delta
    
    # Face player
    if enemy.target:
        enemy.update_facing(enemy.get_direction_to_target())
    
    if idle_timer >= IDLE_DURATION:
        # Pick next attack
        var attack_state = enemy.get_attack_state_name()
        state_machine.transition_to(attack_state)
```

**boss_attack_swipe.gd:**
```gdscript
extends State
class_name BossAttackSwipe
## Wide melee swipe attack

const WINDUP: float = 0.4
const SWIPE: float = 0.3
const RECOVERY: float = 0.5

var timer: float = 0.0
enum Phase { WINDUP, SWIPE, RECOVERY }
var current_phase: Phase = Phase.WINDUP

func enter() -> void:
    timer = 0.0
    current_phase = Phase.WINDUP
    enemy.velocity = Vector2.ZERO
    
    # Windup visual
    if enemy.sprite:
        enemy.sprite.modulate = Color(1.2, 1.0, 0.8)

func exit() -> void:
    if enemy.hitbox:
        enemy.hitbox.disable()
    if enemy.sprite:
        enemy.sprite.modulate = Color.WHITE if not enemy.is_enraged else Color(1.3, 0.8, 0.8)

func physics_update(delta: float) -> void:
    timer += delta
    
    match current_phase:
        Phase.WINDUP:
            if timer >= WINDUP:
                current_phase = Phase.SWIPE
                timer = 0.0
                _do_swipe()
        Phase.SWIPE:
            if timer >= SWIPE:
                current_phase = Phase.RECOVERY
                timer = 0.0
                enemy.hitbox.disable()
        Phase.RECOVERY:
            if timer >= RECOVERY:
                state_machine.transition_to("BossIdle")

func _do_swipe() -> void:
    # Enable larger hitbox
    if enemy.hitbox:
        enemy.hitbox.damage = enemy.attack_damage
        var shape = enemy.hitbox.get_node_or_null("CollisionShape2D")
        if shape:
            shape.scale = Vector2(2.0, 1.5)  # Wide swipe
            shape.position = enemy.get_direction_to_target() * 25
        enemy.hitbox.enable()
    
    # Visual swing
    if enemy.sprite:
        enemy.sprite.rotation = -0.3 if not enemy.facing_left else 0.3
        var tween = create_tween()
        tween.tween_property(enemy.sprite, "rotation", 0.3 if not enemy.facing_left else -0.3, SWIPE)
        tween.tween_property(enemy.sprite, "rotation", 0.0, 0.1)
    
    EffectsManager.screen_shake(4.0, 0.1)
```

**boss_attack_charge.gd:**
```gdscript
extends State
class_name BossAttackCharge
## Charges at player, deals heavy damage on impact

const TELEGRAPH: float = 0.6
const CHARGE_SPEED: float = 200.0
const CHARGE_DURATION: float = 0.8
const RECOVERY: float = 0.8

var timer: float = 0.0
var charge_direction: Vector2 = Vector2.ZERO
enum Phase { TELEGRAPH, CHARGE, RECOVERY }
var current_phase: Phase = Phase.TELEGRAPH

func enter() -> void:
    timer = 0.0
    current_phase = Phase.TELEGRAPH
    enemy.velocity = Vector2.ZERO
    
    # Lock onto player position
    if enemy.target:
        charge_direction = enemy.get_direction_to_target()
    
    # Telegraph visual - crouch and glow
    if enemy.sprite:
        enemy.sprite.scale.y = 0.7
        enemy.sprite.modulate = Color(1.5, 0.8, 0.8)

func exit() -> void:
    if enemy.hitbox:
        enemy.hitbox.disable()
    if enemy.sprite:
        enemy.sprite.scale = Vector2(2.5, 2.5)
        enemy.sprite.modulate = Color.WHITE if not enemy.is_enraged else Color(1.3, 0.8, 0.8)

func physics_update(delta: float) -> void:
    timer += delta
    
    match current_phase:
        Phase.TELEGRAPH:
            # Shake during telegraph
            if enemy.sprite:
                enemy.sprite.position.x = randf_range(-2, 2)
            
            if timer >= TELEGRAPH:
                current_phase = Phase.CHARGE
                timer = 0.0
                _start_charge()
        
        Phase.CHARGE:
            enemy.velocity = charge_direction * CHARGE_SPEED
            
            if timer >= CHARGE_DURATION:
                current_phase = Phase.RECOVERY
                timer = 0.0
                _end_charge()
        
        Phase.RECOVERY:
            enemy.velocity = enemy.velocity.lerp(Vector2.ZERO, delta * 5)
            
            if timer >= RECOVERY:
                state_machine.transition_to("BossIdle")

func _start_charge() -> void:
    if enemy.sprite:
        enemy.sprite.scale = Vector2(2.5, 2.5)
        enemy.sprite.position.x = 0
    
    if enemy.hitbox:
        enemy.hitbox.damage = int(enemy.attack_damage * 1.5)
        enemy.hitbox.enable()
    
    EffectsManager.screen_shake(6.0, 0.2)

func _end_charge() -> void:
    if enemy.hitbox:
        enemy.hitbox.disable()
    
    # Dust cloud on stop
    EffectsManager.screen_shake(8.0, 0.15)
```

**boss_attack_summon.gd:**
```gdscript
extends State
class_name BossAttackSummon
## Summons 2 minion raccoons (only in phase 2 / enraged)

const SUMMON_TIME: float = 1.0
const RECOVERY: float = 0.5
const RACCOON_SCENE = preload("res://characters/enemies/raccoon.tscn")

var timer: float = 0.0
var summoned: bool = false

func enter() -> void:
    timer = 0.0
    summoned = false
    enemy.velocity = Vector2.ZERO
    
    # Summon pose
    if enemy.sprite:
        enemy.sprite.modulate = Color(0.8, 0.8, 1.2)  # Blue glow

func exit() -> void:
    if enemy.sprite:
        enemy.sprite.modulate = Color.WHITE if not enemy.is_enraged else Color(1.3, 0.8, 0.8)

func physics_update(delta: float) -> void:
    timer += delta
    
    if not summoned and timer >= SUMMON_TIME * 0.5:
        _do_summon()
        summoned = true
    
    if timer >= SUMMON_TIME + RECOVERY:
        state_machine.transition_to("BossIdle")

func _do_summon() -> void:
    # Only summon in enraged phase, or always but fewer in phase 1
    var count = 2 if enemy.is_enraged else 1
    
    for i in range(count):
        var raccoon = RACCOON_SCENE.instantiate()
        
        # Spawn near boss
        var offset = Vector2(randf_range(-30, 30), randf_range(-30, 30))
        raccoon.global_position = enemy.global_position + offset
        
        # Add to scene
        enemy.get_parent().add_child(raccoon)
        
        # Spawn effect
        _spawn_effect(raccoon.global_position)
    
    EffectsManager.screen_shake(5.0, 0.2)

func _spawn_effect(pos: Vector2) -> void:
    # Poof of smoke
    for j in range(6):
        var particle = ColorRect.new()
        particle.size = Vector2(4, 4)
        particle.color = Color(0.6, 0.5, 0.7, 0.8)
        particle.global_position = pos
        enemy.get_parent().add_child(particle)
        
        var angle = j * TAU / 6
        var end_pos = pos + Vector2(cos(angle), sin(angle)) * 15
        
        var tween = create_tween()
        tween.set_parallel(true)
        tween.tween_property(particle, "global_position", end_pos, 0.3)
        tween.tween_property(particle, "modulate:a", 0.0, 0.3)
        tween.chain().tween_callback(particle.queue_free)
```
  </action>
  <verify>All 4 boss state files exist</verify>
  <done>Boss attack states created</done>
</task>

<task type="auto">
  <name>Task 3: Create Boss Scene and Add Signals</name>
  <files>characters/enemies/boss_raccoon_king.tscn, autoloads/events.gd</files>
  <action>
1. Create boss_raccoon_king.tscn based on raccoon.tscn structure:
   - Root: CharacterBody2D (script: boss_raccoon_king.gd)
   - Sprite2D (Polygon2D for placeholder)
   - AnimationPlayer
   - StateMachine with boss states:
     - BossIdle (boss_idle.gd)
     - BossAttackSwipe (boss_attack_swipe.gd)
     - BossAttackCharge (boss_attack_charge.gd)
     - BossAttackSummon (boss_attack_summon.gd)
     - Hurt (enemy_hurt.gd)
     - Death (enemy_death.gd)
   - Hitbox (Area2D)
   - Hurtbox (Area2D)
   - HealthComponent
   - DetectionArea (larger radius: 150)
   - CollisionShape2D (larger for boss)

2. In events.gd, add boss signals:
```gdscript
# =============================================================================
# BOSS SIGNALS
# =============================================================================

## Emitted when boss spawns
signal boss_spawned(boss: Node)

## Emitted when boss enters enraged state
signal boss_enraged(boss: Node)

## Emitted when boss is defeated
signal boss_defeated(boss: Node)
```
  </action>
  <verify>Boss scene exists, signals in events.gd</verify>
  <done>Boss scene and signals ready</done>
</task>

</tasks>

<verification>
1. Manually place boss in test zone
2. Boss should be visibly larger with crown
3. Attack patterns cycle: Swipe → Charge → Swipe → Summon
4. At 50% HP (100 HP), boss turns red and speeds up
5. Boss death has dramatic explosion
</verification>

<success_criteria>
- Boss has 200 HP (much more than regular enemies)
- 3 attack patterns work correctly
- Enrage triggers at 50% HP
- Boss death is dramatic
</success_criteria>

<output>
After completion, create `.planning/phases/11-boss-fight/11-01-SUMMARY.md`
</output>
