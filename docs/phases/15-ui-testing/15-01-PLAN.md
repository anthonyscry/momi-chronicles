---
phase: 15-ui-testing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - autoloads/ui_tester.gd
  - project.godot
autonomous: true

must_haves:
  truths:
    - "F2 toggles UITester mode ON/OFF"
    - "Test status logging shows timestamps and context"
    - "Screenshots are captured and saved on test failures"
  artifacts:
    - path: "autoloads/ui_tester.gd"
      provides: "UITester autoload with test runner framework"
      contains: "func _input"
    - path: "exports/test_screenshots/"
      provides: "Directory for failure screenshots"
  key_links:
    - from: "autoloads/ui_tester.gd"
      to: "project.godot"
      via: "autoload registration"
      pattern: "autoload.*ui_tester"
---

<objective>
Create the UITester foundation as an autoload that toggles with F2, provides comprehensive logging infrastructure, and captures screenshots on failures.

Purpose: Establishes the testing framework that all subsequent test scenarios will build upon.
Output: Working UITester autoload with F2 toggle, timestamped logging, and screenshot capture system.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-ui-testing/15-CONTEXT.md

# Pattern reference - existing AutoBot for structure
@autoloads/auto_bot.gd
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create UITester autoload with F2 toggle and test runner framework</name>
  <files>autoloads/ui_tester.gd, project.godot</files>
  <action>
Create `autoloads/ui_tester.gd` following the pattern established by `auto_bot.gd`:

1. **State variables:**
   - `var enabled: bool = false` - UITester active state
   - `var current_scenario: String = ""` - Which scenario is running
   - `var test_results: Array = []` - Store all test outcomes
   - `var passed_count: int = 0`
   - `var failed_count: int = 0`
   - `var fixed_on_retry_count: int = 0`

2. **F2 toggle in `_input(event)`:**
   - Check for `KEY_F2` press
   - Toggle `enabled` state
   - Log "UITester ENABLED" or "UITester DISABLED" with timestamp
   - When enabled, call `run_all_tests()` to start test suite

3. **Logging infrastructure:**
   - `func log_test(message: String)` - prints with `[UITester]` prefix + ISO timestamp
   - `func log_scenario_start(name: String)` - prints "=== STARTING SCENARIO: {name} ==="
   - `func log_check(description: String, actual, expected, passed: bool)` - logs actual vs expected with PASS/FAIL
   - `func log_failure(description: String, reason: String)` - detailed failure logging

4. **Test runner skeleton:**
   - `func run_all_tests()` - will orchestrate all 5 scenarios (placeholder implementations for now)
   - `func record_result(scenario: String, check: String, passed: bool, details: Dictionary)`
   - Use `_physics_process` or timers for timing-sensitive checks (follow auto_bot.gd pattern)

5. **Register autoload in project.godot:**
   - Add `[autoload]` entry: `UITester="*res://autoloads/ui_tester.gd"`
   - Place after AutoBot if it exists

Implementation notes:
- Follow GDScript 4.x syntax patterns from auto_bot.gd
- Use `Time.get_datetime_string_from_system()` for timestamps
- Structure for easy extension in subsequent plans
  </action>
  <verify>
1. Run game
2. Press F2 - should see "[UITester] UITester ENABLED" in console with timestamp
3. Press F2 again - should see "[UITester] UITester DISABLED"
4. Verify no errors in Output panel
  </verify>
  <done>F2 toggles UITester mode, logging infrastructure outputs timestamped messages to console</done>
</task>

<task type="auto">
  <name>Task 2: Implement screenshot capture system for failures</name>
  <files>autoloads/ui_tester.gd</files>
  <action>
Add screenshot capture functionality to UITester:

1. **Screenshot function:**
```gdscript
func capture_screenshot(test_name: String) -> void:
    var datetime = Time.get_datetime_string_from_system().replace(":", "-")
    var filename = "exports/test_screenshots/%s_%s.png" % [test_name.to_snake_case(), datetime]
    
    # Ensure directory exists
    var dir = DirAccess.open("res://")
    if not dir.dir_exists("exports/test_screenshots"):
        dir.make_dir_recursive("exports/test_screenshots")
    
    # Capture viewport
    await RenderingServer.frame_post_draw
    var viewport = get_viewport()
    var img = viewport.get_texture().get_image()
    img.save_png(filename)
    
    log_test("Screenshot saved: " + filename)
```

2. **Integrate with failure recording:**
   - Update `record_result()` to call `capture_screenshot()` when `passed == false`
   - Pass test name + scenario for meaningful screenshot filenames

3. **Retry logic skeleton:**
```gdscript
func run_check_with_retry(check_name: String, check_func: Callable, fix_func: Callable = Callable()) -> bool:
    var result = check_func.call()
    if result:
        log_check(check_name, "pass", "pass", true)
        passed_count += 1
        return true
    
    # First failure - capture screenshot
    capture_screenshot(check_name)
    log_failure(check_name, "Initial check failed")
    
    # Attempt fix if provided
    if fix_func.is_valid():
        log_test("Attempting fix for: " + check_name)
        fix_func.call()
        await get_tree().create_timer(0.5).timeout  # Wait for fix to apply
        
        result = check_func.call()
        if result:
            log_check(check_name + " (fixed)", "pass", "pass", true)
            fixed_on_retry_count += 1
            return true
        else:
            capture_screenshot(check_name + "_after_fix")
    
    # Final failure
    log_check(check_name, "fail", "pass", false)
    failed_count += 1
    return false
```

4. **Add .gitignore entry** for test screenshots (optional, just note in summary)

Implementation notes:
- Use `await` for frame timing on screenshot capture
- Screenshots go to `exports/test_screenshots/` (create if not exists)
- Filename format: `{test_name}_{timestamp}.png`
  </action>
  <verify>
1. Run game
2. Press F2 to enable UITester
3. Manually trigger a failing test or add temp failing check
4. Verify screenshot appears in `exports/test_screenshots/`
5. Verify screenshot filename contains test name and timestamp
  </verify>
  <done>Screenshots are captured on every test failure, saved with descriptive filenames to exports/test_screenshots/</done>
</task>

</tasks>

<verification>
- [ ] UITester autoload registered in project.godot
- [ ] F2 toggles UITester ON/OFF with console logging
- [ ] Timestamps appear on all log messages
- [ ] Screenshot capture creates files in exports/test_screenshots/
- [ ] No script errors on toggle or capture
</verification>

<success_criteria>
- F2 key toggles UITester mode with visible console feedback
- All log messages include ISO timestamps
- Screenshot capture produces valid PNG files with descriptive names
- Foundation ready for test scenarios in Plan 02
</success_criteria>

<output>
After completion, create `.planning/phases/15-ui-testing/15-01-SUMMARY.md`
</output>
