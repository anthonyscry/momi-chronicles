---
phase: 31-art-generation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - tools/gemini_api_generate.py
  - art/style_context.txt
autonomous: true

must_haves:
  truths:
    - "Running the script with --model gemini-2.5-flash-image generates images via generate_content() API"
    - "Running with --reference-dir loads PNG files and passes them as PIL.Image context alongside each prompt"
    - "Script reads prompts from art/prompts.json (v1) which maps to all 96 actual game entities"
    - "Each prompt is prefixed with the style context from art/style_context.txt for consistent art direction"
    - "Generated images save to art/generated/{category}/{filename}.png matching paths expected by phases 32-35"
  artifacts:
    - path: "tools/gemini_api_generate.py"
      provides: "Nano Banana Pro API-based image generator with reference image support"
      contains: "generate_content"
    - path: "art/style_context.txt"
      provides: "Nano Banana Pro style prefix loaded by the script and prepended to every prompt"
  key_links:
    - from: "tools/gemini_api_generate.py"
      to: "art/prompts.json"
      via: "PROMPTS_FILE path constant"
      pattern: "prompts\\.json"
    - from: "tools/gemini_api_generate.py"
      to: "art/generated/"
      via: "GENERATED_DIR output path"
    - from: "tools/gemini_api_generate.py"
      to: "art/style_context.txt"
      via: "STYLE_CONTEXT_FILE loaded at startup"
---

<objective>
Rewrite the art generation script to use Nano Banana Pro (generate_content API) instead of Imagen 4 (generate_images API), add reference image support for style consistency, create a style context file based on the NanoBananaPro guide, and point the script at the correct prompts.json (v1) that maps to all actual game entities.

Purpose: The previous Imagen 4 approach produced unusable results ("99% non-viable"). Nano Banana Pro is a thinking model that understands intent and can maintain style consistency via reference images. The user has ~220 reference images that represent the target vibe — feeding these as context will produce art that matches their vision.
Output: A working script that generates game-ready sprites using Nano Banana Pro with reference image support.
</objective>

<execution_context>
@~/.config/Claude/get-shit-done/workflows/execute-plan.md
@~/.config/Claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/30-art-pipeline-tooling/30-01-SUMMARY.md
@tools/gemini_api_generate.py
@art/prompts.json
@MomiAdventure_NanoBananaPro_Guide (1).md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewrite gemini_api_generate.py for Nano Banana Pro with reference image support</name>
  <files>
    tools/gemini_api_generate.py
  </files>
  <action>
  **Complete rewrite of the generate_image() function and related configuration:**

  **1. Switch API from generate_images() to generate_content():**

  The current script uses:
  ```python
  response = client.models.generate_images(
      model=model,
      prompt=prompt,
      config=types.GenerateImagesConfig(...)
  )
  response.generated_images[0].image.save(str(output_path))
  ```

  Replace with:
  ```python
  contents = []

  # Add reference images if provided (up to 5 for style consistency)
  for ref_img in reference_images:
      contents.append(ref_img)  # PIL.Image objects

  # Add the prompt text (style_context + prompt)
  contents.append(full_prompt)

  response = client.models.generate_content(
      model=model,
      contents=contents,
      config=types.GenerateContentConfig(
          response_modalities=['IMAGE'],
      ),
  )

  # Extract image from response parts
  for part in response.parts:
      if part.inline_data is not None:
          image = part.as_image()
          image.save(str(output_path))
          return True
  ```

  **2. Change DEFAULT_MODEL:**
  ```python
  DEFAULT_MODEL = "gemini-2.5-flash-image"  # Nano Banana (free tier)
  ```
  Keep the `--model` CLI flag so user can pass `gemini-3-pro-image-preview` for Nano Banana Pro.

  **3. Fix PROMPTS_FILE to point at v1 (correct game entities):**
  ```python
  PROMPTS_FILE = PROJECT_ROOT / "art" / "prompts.json"  # NOT prompts_v2
  ```
  The v2 file has wrong entities (roomba, gnome, goose, squirrel). The v1 file has all 96 correct game entities (raccoon, crow, stray_cat, sewer_rat, shadow_creature, etc.) that phases 32-35 expect.

  **4. Add STYLE_CONTEXT_FILE loading:**
  ```python
  STYLE_CONTEXT_FILE = PROJECT_ROOT / "art" / "style_context.txt"

  def load_style_context() -> str:
      if STYLE_CONTEXT_FILE.exists():
          with open(STYLE_CONTEXT_FILE, "r", encoding="utf-8") as f:
              return f.read().strip()
      return ""
  ```
  In `flatten_prompts()`, compose `full_prompt` as:
  ```python
  style_ctx = load_style_context()
  full_prompt = f"{style_ctx}\n\n{p['prompt']}" if style_ctx else p["prompt"]
  ```
  This REPLACES the old global_suffix approach. The style context is richer natural language guidance, not a tag-soup suffix.

  **5. Add --reference-dir CLI flag:**
  ```python
  parser.add_argument("--reference-dir", "-r",
                      help="Directory of reference images for style consistency (max 5 loaded)")
  ```
  Implementation:
  ```python
  def load_reference_images(ref_dir: str, max_images: int = 5) -> list:
      """Load reference images from a directory for style context."""
      from PIL import Image
      ref_path = pathlib.Path(ref_dir)
      if not ref_path.exists():
          print(f"WARN: Reference directory {ref_dir} not found, continuing without references")
          return []

      # Load PNGs and JPGs, sorted by name, up to max_images
      image_files = sorted(
          [f for f in ref_path.iterdir()
           if f.suffix.lower() in ('.png', '.jpg', '.jpeg')
           and f.stat().st_size < 10_000_000],  # Skip files > 10MB
          key=lambda f: f.name
      )[:max_images]

      images = []
      for img_file in image_files:
          try:
              img = Image.open(img_file)
              # Resize if too large (Nano Banana Pro works best with reasonable sizes)
              if max(img.size) > 1024:
                  ratio = 1024 / max(img.size)
                  new_size = (int(img.size[0] * ratio), int(img.size[1] * ratio))
                  img = img.resize(new_size, Image.LANCZOS)
              images.append(img)
              print(f"  REF: Loaded {img_file.name} ({img.size[0]}x{img.size[1]})")
          except Exception as e:
              print(f"  WARN: Could not load {img_file.name}: {e}")

      return images
  ```

  **6. Update run_generation() signature** to accept and pass reference_images:
  ```python
  def run_generation(prompts, api_key, model, skip_existing, dry_run, delay, reference_images=None):
  ```
  Pass `reference_images` (or empty list) through to `generate_image()`.

  **7. Update error handling** for the generate_content API:
  - Rate limit errors: same pattern (429, quota, resource_exhausted)
  - Safety filter: check `response.prompt_feedback` for blocked status
  - No image in response: iterate `response.parts` and check for `inline_data`

  **8. Keep ALL existing CLI features intact:**
  - `--list`, `--category`, `--single`, `--skip-existing`, `--no-skip-existing`
  - `--dry-run`, `--delay`, `--api-key`
  - Windows UTF-8 console reconfigure

  **9. Update the docstring** at the top of the file to reflect Nano Banana Pro usage, new model names, and new --reference-dir flag.

  **Do NOT:**
  - Remove the Pillow dependency
  - Change the output directory structure (art/generated/{category}/{filename})
  - Change the skip-existing logic
  - Break the prompts.json loading format
  </action>
  <verify>
  - `python tools/gemini_api_generate.py --list` runs without error and shows all 96 prompts from prompts.json (NOT prompts_v2)
  - Grep the file for `generate_images` — should return zero matches (all replaced with `generate_content`)
  - Grep for `prompts_v2` — should return zero matches
  - Grep for `generate_content` — should find the API call
  - Grep for `reference_images` or `reference-dir` — should find the feature
  - `python tools/gemini_api_generate.py --dry-run` completes showing all 96 prompts would be generated
  </verify>
  <done>Script uses generate_content() with Nano Banana model, supports --reference-dir for style images, reads from prompts.json v1 (correct entities), composes prompts with style context prefix</done>
</task>

<task type="auto">
  <name>Task 2: Create style_context.txt using NanoBananaPro guide methodology</name>
  <files>
    art/style_context.txt
  </files>
  <action>
  Create `art/style_context.txt` — a natural language style prefix that gets prepended to every generation prompt. This file encodes the NanoBananaPro guide's Golden Rules into a reusable context block.

  **Content of style_context.txt:**

  ```
  [STYLE CONTEXT]
  Game: "Momi's Adventure" - 2D action RPG with 3/4 top-down perspective
  Engine: Godot 4
  Aesthetic: 16-bit SNES-era pixel art, warm and vibrant, Earthbound quirk meets Studio Ghibli warmth
  Perspective: 3/4 top-down view (not pure top-down, not side-view — slight elevation showing front and top)
  Resolution: Generate at high quality, will be downscaled to game resolution (32x32 characters, 16x16 items)
  Background: Pure white (#FFFFFF) for easy background removal — no ground shadows, no gradients, no scenery
  Palette: Consistent limited palette with clean pixel edges, cel-shading with 2-3 value steps per color
  Outline: Clean 1px black outline around all sprites

  [ART DIRECTION]
  - All sprites must be isolated on plain white background for extraction
  - Characters should be expressive and readable at small game sizes
  - Use natural language descriptions, not tag lists
  - Maintain consistent proportions and style across all sprites
  - If generating animation frames: horizontal strip layout, evenly spaced, loop-ready
  - Frame count standard: 8 frames per animation where applicable

  [CHARACTER IDENTITY - MOMI]
  When generating Momi sprites: She is a 5-year-old female French Bulldog with black brindle coat (dark charcoal base with subtle darker striping), distinctive white tuxedo chest patch, white chin marking like a goatee, big expressive brown eyes, classic bat ears (dark, rounded), compact sturdy body, small nub tail.

  [CHARACTER IDENTITY - CINNAMON]
  When generating Cinnamon sprites: She is a female English Bulldog with black and tan coloring (dark base with tan points on eyebrows, cheeks, legs, chest), white blaze on face and chest, pronounced underbite, wrinkly face, stocky tank build, red tactical harness.

  [CHARACTER IDENTITY - PHILO]
  When generating Philo sprites: He is a senior male Boston Terrier with classic black and white tuxedo pattern, gray muzzle showing age, wise patient eyes, pointed ears, slim compact build, blue bandana.
  ```

  **Why this approach works:**
  - Nano Banana Pro is a thinking model — it reads and understands this context block
  - The style context establishes consistency across all 96 prompts
  - Character identities only activate when generating that character (the prompts reference characters by name)
  - The guide's Golden Rules (natural language, be specific, provide context) are embedded in the format
  - Easy to edit without touching the script — just update the text file

  **Also:** Copy the full NanoBananaPro guide to `.planning/` for reference:
  ```
  cp "MomiAdventure_NanoBananaPro_Guide (1).md" .planning/nanobananapro-guide.md
  ```
  This keeps the full guide accessible without cluttering the art directory.
  </action>
  <verify>
  - `art/style_context.txt` exists and contains the style context block
  - The file starts with `[STYLE CONTEXT]` (parseable marker)
  - Character identities for all 3 main characters are included (Momi, Cinnamon, Philo)
  - `.planning/nanobananapro-guide.md` exists (guide preserved for reference)
  - `python tools/gemini_api_generate.py --list` still works (style context doesn't break prompt loading)
  </verify>
  <done>Style context file created with game art direction and character identities, NanoBananaPro guide preserved in .planning/</done>
</task>

</tasks>

<verification>
1. `python tools/gemini_api_generate.py --list` shows all 96 prompts from prompts.json v1 (correct game entities)
2. `python tools/gemini_api_generate.py --dry-run` completes without errors
3. `python tools/gemini_api_generate.py --dry-run --reference-dir C:\Projects\MomiAdventure\gemini_images` loads reference images and shows them in output
4. No references to `generate_images` remain in the script
5. No references to `prompts_v2` remain in the script
6. `art/style_context.txt` exists with complete style direction
7. `.planning/nanobananapro-guide.md` exists
</verification>

<success_criteria>
- Script generates images via Nano Banana Pro generate_content() API (not Imagen 4 generate_images())
- Reference images from any directory can be passed for style consistency
- All 96 prompts map to correct game entities matching phases 32-35 expectations
- Style context prefix ensures consistent art direction across all generations
- All existing CLI features preserved (--list, --category, --single, --skip-existing, --dry-run)
</success_criteria>

<output>
After completion, create `.planning/phases/31-art-generation/31-01-SUMMARY.md`
</output>
