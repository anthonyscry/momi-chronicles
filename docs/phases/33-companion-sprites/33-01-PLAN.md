---
phase: 33-companion-sprites
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - characters/companions/companion_base.tscn
  - characters/companions/companion_base.gd
  - characters/companions/momi_companion.tscn
  - characters/companions/momi_companion.gd
  - characters/companions/cinnamon_companion.tscn
  - characters/companions/cinnamon_companion.gd
  - characters/companions/philo_companion.tscn
  - characters/companions/philo_companion.gd
autonomous: true

must_haves:
  truths:
    - "Cinnamon displays as animated pixel art in all 4 states (idle, walk, attack, overheat)"
    - "Philo displays as animated pixel art in all 5 states (idle, walk, attack, motivated, lazy)"
    - "Momi companion displays as animated pixel art (idle, walk, attack)"
    - "Companions follow Momi correctly with proper facing direction"
    - "Unique mechanic states are visually distinct (overheat vs idle, motivated vs lazy)"
  artifacts:
    - path: "characters/companions/companion_base.gd"
      provides: "AnimatedSprite2D reference and animation switching"
      contains: "AnimatedSprite2D"
    - path: "characters/companions/cinnamon_companion.tscn"
      provides: "Cinnamon with sprite-based visuals"
      contains: "AnimatedSprite2D"
    - path: "characters/companions/philo_companion.tscn"
      provides: "Philo with sprite-based visuals"
      contains: "AnimatedSprite2D"
  key_links:
    - from: "characters/companions/companion_base.gd"
      to: "art/generated/characters/*_*.png"
      via: "SpriteFrames texture loading per companion"
    - from: "characters/companions/cinnamon_companion.gd"
      to: "AnimatedSprite2D"
      via: "sprite.play() for overheat state"
    - from: "characters/companions/philo_companion.gd"
      to: "AnimatedSprite2D"
      via: "sprite.play() for lazy/motivated states"
---

<objective>
Replace all companion Polygon2D placeholders with AnimatedSprite2D using generated pixel art. Wire companion-specific mechanic states (Cinnamon overheat, Philo lazy/motivated, Momi zoomies) to distinct animation poses.

Purpose: Companions fight alongside Momi in every encounter. Replacing their colored squares with sprites makes the party visually distinguishable.
Output: All 3 companions display as animated pixel art characters with state-specific visuals.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@docs/PROJECT.md
@docs/ROADMAP.md
@docs/phases/32-player-sprites/32-01-SUMMARY.md
@characters/companions/companion_base.gd
@characters/companions/cinnamon_companion.gd
@characters/companions/philo_companion.gd
@systems/party/companion_data.gd
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace companion Polygon2Ds with AnimatedSprite2D for all 3 companions</name>
  <files>
    characters/companions/companion_base.tscn
    characters/companions/momi_companion.tscn
    characters/companions/cinnamon_companion.tscn
    characters/companions/philo_companion.tscn
    characters/companions/companion_base.gd
    autoloads/companion_data.gd
  </files>
  <action>
  Follow the same pattern established in Phase 32 (player sprite conversion).

  **For each companion .tscn file:**
  1. Remove the `Polygon2D` node named `Sprite2D`
  2. Add an `AnimatedSprite2D` node named `Sprite2D` (preserves $Sprite2D references)
  3. Create `SpriteFrames` resource with companion-specific animations:

  **Momi companion** (`momi_companion.tscn`):
  - `idle` — `art/generated/characters/momi_idle.png`
  - `walk` — `art/generated/characters/momi_walk.png`
  - `attack` — `art/generated/characters/momi_attack.png`

  **Cinnamon** (`cinnamon_companion.tscn`):
  - `idle` — `art/generated/characters/cinnamon_idle.png`
  - `walk` — `art/generated/characters/cinnamon_walk.png`
  - `attack` — `art/generated/characters/cinnamon_attack.png`
  - `overheat` — `art/generated/characters/cinnamon_overheat.png`

  **Philo** (`philo_companion.tscn`):
  - `idle` — `art/generated/characters/philo_idle.png`
  - `walk` — `art/generated/characters/philo_walk.png`
  - `attack` — `art/generated/characters/philo_attack.png`
  - `lazy` — `art/generated/characters/philo_lazy.png`
  - `motivated` — `art/generated/characters/philo_motivated.png`

  **In companion_base.gd:**
  1. Change `@onready var sprite: Polygon2D = $Sprite2D` to `@onready var sprite: AnimatedSprite2D = $Sprite2D`
  2. Remove the color-setting line: `sprite.color = data.color` (AnimatedSprite2D doesn't have .color)
  3. In CompanionData autoload: the `color` property per companion can remain for backward compat but is no longer applied

  **In companion_base.tscn:** If the base scene has a Polygon2D, replace it. Child scenes (momi/cinnamon/philo) inherit and override.

  **Collision adjustment:** Companions use CircleShape2D for collision. Verify sizes still match sprite dimensions (14-18px polygons → 32x32 sprites means collision might need slight enlargement).
  </action>
  <verify>
  - Grep all companion .tscn files for `Polygon2D` — zero matches
  - Grep companion_base.gd for `Polygon2D` — zero matches
  - Each companion .tscn has AnimatedSprite2D with correct number of animations (Momi: 3, Cinnamon: 4, Philo: 5)
  </verify>
  <done>All 3 companion scenes use AnimatedSprite2D with correct SpriteFrames, companion_base.gd references AnimatedSprite2D</done>
</task>

<task type="auto">
  <name>Task 2: Wire companion mechanic states to animations and fix visual feedback</name>
  <files>
    characters/companions/companion_base.gd
    characters/companions/momi_companion.gd
    characters/companions/cinnamon_companion.gd
    characters/companions/philo_companion.gd
  </files>
  <action>
  **In companion_base.gd — convert ALL visual feedback from .color to .modulate:**

  The existing code uses `sprite.modulate` for feedback (not .color), which is already compatible with AnimatedSprite2D. Verify and fix:
  - Attack flash: `sprite.modulate = Color(1.2, 1.2, 0.8)` → keep as-is (modulate works on AnimatedSprite2D)
  - Hurt flash: `sprite.modulate = Color.RED` → keep as-is
  - Reset: `sprite.modulate = Color.WHITE` → keep as-is

  However, `flash_damage()` or similar functions might use `sprite.color` — search and replace any `.color =` with `.modulate =`.

  **Add animation switching in companion_base.gd:**
  Companions don't have a StateMachine node — they're AI-driven. Look for state changes in the AI logic:
  - When companion starts following/walking: `sprite.play("walk")`
  - When companion attacks: `sprite.play("attack")`, then back to `sprite.play("idle")` after attack timer
  - When companion is idle/stationary: `sprite.play("idle")`
  - Facing: replace any `sprite.scale.x = -1` with `sprite.flip_h = true`

  **In cinnamon_companion.gd — overheat state:**
  - When overheat triggers: `sprite.play("overheat")`
  - When overheat ends: `sprite.play("idle")` (remove the orange modulate tint OR keep it layered on top for emphasis)

  **In philo_companion.gd — lazy/motivated states:**
  - When motivation is low: `sprite.play("lazy")`
  - When motivation surges (Momi takes damage): `sprite.play("motivated")`
  - Transition back to `idle` when in normal state

  **In momi_companion.gd — zoomies state:**
  - When zoomies triggers: keep the golden modulate tint `Color(1.2, 1.0, 0.7)` on top of the sprite animation
  - No separate zoomies sprite exists, so use `idle`/`walk`/`attack` with the tint overlay

  **Remove any Polygon2D-specific code:**
  - Any references to `sprite.polygon` or `sprite.vertices`
  - Any code that sets `sprite.color` directly
  </action>
  <verify>
  - Run the game, enter a zone with companions — all 3 show as sprites
  - Move around — companions follow with walk animation, flip when changing direction
  - Enter combat — companions switch to attack animation
  - Let Cinnamon overheat — visual changes to overheat sprite
  - Let Momi take damage — Philo's motivation rises, visual changes
  - Grep all companion .gd files for `\.color\s*=` — zero matches (except string comparisons)
  </verify>
  <done>All companion mechanic states trigger correct animations, visual feedback uses modulate, facing uses flip_h, zero Polygon2D artifacts</done>
</task>

</tasks>

<verification>
1. All 3 companions display as pixel art sprites (no colored squares)
2. Each companion has visually distinct mechanic states (Cinnamon overheat, Philo lazy/motivated)
3. Companions flip correctly when following Momi left/right
4. Companion combat still works (attacks deal damage, knocked out works, revival works)
5. `grep -r "Polygon2D" characters/companions/` returns zero matches
</verification>

<success_criteria>
- Cinnamon: 4 distinct sprite states visible during gameplay
- Philo: 5 distinct sprite states visible during gameplay
- Momi companion: 3 sprite states visible
- All companions follow and fight correctly (no AI regression)
- Zero Polygon2D references in companion scene/scripts
</success_criteria>

<output>
After completion, create `docs/phases/33-companion-sprites/33-01-SUMMARY.md`
</output>
