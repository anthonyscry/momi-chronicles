---
phase: 10-special-abilities
plan: 03
type: execute
wave: 2
depends_on: ["10-01", "10-02"]
files_modified:
  - ui/hud/ability_bar.gd (NEW)
  - ui/hud/ability_bar.tscn (NEW)
  - ui/hud/game_hud.tscn
  - autoloads/effects_manager.gd
autonomous: true

must_haves:
  truths:
    - "Ability icons visible in HUD"
    - "Locked abilities appear grayed out"
    - "Cooldown shown as radial overlay"
  artifacts:
    - path: "ui/hud/ability_bar.tscn"
      provides: "Ability bar UI"
    - path: "ui/hud/ability_bar.gd"
      provides: "Ability display logic"
  key_links:
    - from: "ability_bar.gd"
      to: "Events.player_leveled_up"
      via: "unlock check"
---

<objective>
Add ability bar HUD showing available abilities, unlock status, and cooldowns.

Purpose: Let player see ability availability at a glance
Output: Bottom HUD bar with ability icons, lock states, and cooldown radials
</objective>

<context>
@ui/hud/game_hud.gd (existing HUD)
@ui/hud/game_hud.tscn (HUD scene)
@characters/player/player.gd (ability unlock checks)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Ability Bar Component</name>
  <files>ui/hud/ability_bar.gd, ui/hud/ability_bar.tscn</files>
  <action>
Create ability bar showing charge attack and ground pound:

**ability_bar.tscn structure:**
```
AbilityBar (Control)
└── HBoxContainer (centered, spacing: 8)
    ├── ChargeAbility (Control) [40x40]
    │   ├── Background (ColorRect)
    │   ├── Icon (Label) - "C" for Charge
    │   ├── CooldownOverlay (ColorRect) - dark, adjusts height
    │   └── LockOverlay (ColorRect) - if locked
    └── GroundPoundAbility (Control) [40x40]
        ├── Background (ColorRect)
        ├── Icon (Label) - "G" for Ground Pound
        ├── CooldownOverlay (ColorRect)
        ├── LockOverlay (ColorRect)
        └── UnlockLevel (Label) - "Lv.5"
```

**ability_bar.gd:**
```gdscript
extends Control
class_name AbilityBar
## Displays abilities, their unlock state, and cooldowns

# =============================================================================
# ABILITY DATA
# =============================================================================

const ABILITIES = {
    "charge": {
        "name": "Charge Attack",
        "key": "Hold Attack",
        "icon": "C",
        "unlock_level": 1,
        "color": Color(1, 0.8, 0.3)
    },
    "ground_pound": {
        "name": "Ground Pound",
        "key": "Special",
        "icon": "G",
        "unlock_level": 5,
        "color": Color(0.5, 0.8, 1.0)
    }
}

# =============================================================================
# NODE REFERENCES
# =============================================================================

@onready var container: HBoxContainer = $HBoxContainer
var ability_nodes: Dictionary = {}

# =============================================================================
# STATE
# =============================================================================

var current_level: int = 1
var player_ref: Player = null

# =============================================================================
# LIFECYCLE
# =============================================================================

func _ready() -> void:
    Events.player_leveled_up.connect(_on_level_up)
    
    # Find player
    await get_tree().process_frame
    player_ref = get_tree().get_first_node_in_group("player")
    
    _create_ability_slots()
    _update_all_abilities()

func _process(_delta: float) -> void:
    _update_cooldowns()

# =============================================================================
# UI CREATION
# =============================================================================

func _create_ability_slots() -> void:
    for ability_id in ABILITIES:
        var ability = ABILITIES[ability_id]
        var slot = _create_slot(ability_id, ability)
        container.add_child(slot)
        ability_nodes[ability_id] = slot

func _create_slot(id: String, data: Dictionary) -> Control:
    var slot = Control.new()
    slot.custom_minimum_size = Vector2(36, 36)
    slot.name = id
    
    # Background
    var bg = ColorRect.new()
    bg.name = "Background"
    bg.size = Vector2(36, 36)
    bg.color = Color(0.2, 0.2, 0.25, 0.9)
    slot.add_child(bg)
    
    # Border
    var border = ColorRect.new()
    border.name = "Border"
    border.size = Vector2(36, 36)
    border.color = data.color
    border.modulate.a = 0.5
    # Create border effect by making it hollow
    var inner = ColorRect.new()
    inner.size = Vector2(32, 32)
    inner.position = Vector2(2, 2)
    inner.color = Color(0.15, 0.15, 0.2, 1)
    border.add_child(inner)
    slot.add_child(border)
    
    # Icon
    var icon = Label.new()
    icon.name = "Icon"
    icon.text = data.icon
    icon.add_theme_font_size_override("font_size", 18)
    icon.add_theme_color_override("font_color", data.color)
    icon.position = Vector2(12, 6)
    slot.add_child(icon)
    
    # Cooldown overlay (covers from bottom up)
    var cooldown = ColorRect.new()
    cooldown.name = "CooldownOverlay"
    cooldown.size = Vector2(32, 0)  # 0 height when ready
    cooldown.position = Vector2(2, 34)  # Bottom of slot
    cooldown.color = Color(0, 0, 0, 0.7)
    slot.add_child(cooldown)
    
    # Lock overlay
    var lock = ColorRect.new()
    lock.name = "LockOverlay"
    lock.size = Vector2(36, 36)
    lock.color = Color(0.1, 0.1, 0.1, 0.8)
    lock.visible = false
    slot.add_child(lock)
    
    # Lock icon
    var lock_text = Label.new()
    lock_text.name = "LockText"
    lock_text.text = "Lv." + str(data.unlock_level)
    lock_text.add_theme_font_size_override("font_size", 10)
    lock_text.add_theme_color_override("font_color", Color(0.6, 0.6, 0.6))
    lock_text.position = Vector2(6, 20)
    lock.add_child(lock_text)
    
    # Key hint (below slot)
    var key_hint = Label.new()
    key_hint.name = "KeyHint"
    key_hint.text = data.key.substr(0, 4)  # Truncate
    key_hint.add_theme_font_size_override("font_size", 8)
    key_hint.add_theme_color_override("font_color", Color(0.5, 0.5, 0.5))
    key_hint.position = Vector2(2, 36)
    slot.add_child(key_hint)
    
    return slot

# =============================================================================
# UPDATES
# =============================================================================

func _on_level_up(new_level: int) -> void:
    current_level = new_level
    _update_all_abilities()
    
    # Check for new unlocks
    for ability_id in ABILITIES:
        if ABILITIES[ability_id].unlock_level == new_level:
            _play_unlock_effect(ability_id)

func _update_all_abilities() -> void:
    if player_ref and player_ref.progression:
        current_level = player_ref.progression.get_level()
    
    for ability_id in ABILITIES:
        var ability = ABILITIES[ability_id]
        var slot = ability_nodes.get(ability_id)
        if not slot:
            continue
        
        var is_unlocked = current_level >= ability.unlock_level
        var lock_overlay = slot.get_node("LockOverlay")
        lock_overlay.visible = not is_unlocked

func _update_cooldowns() -> void:
    # Ground pound cooldown
    if ability_nodes.has("ground_pound") and player_ref:
        var cooldown = player_ref.get_ground_pound_cooldown() if player_ref.has_method("get_ground_pound_cooldown") else 0.0
        var max_cooldown = 3.0  # Match PlayerGroundPound.COOLDOWN
        var slot = ability_nodes["ground_pound"]
        var overlay = slot.get_node("CooldownOverlay")
        
        if cooldown > 0:
            var percent = cooldown / max_cooldown
            overlay.size.y = 32 * percent
            overlay.position.y = 2 + 32 * (1 - percent)
        else:
            overlay.size.y = 0

func _play_unlock_effect(ability_id: String) -> void:
    var slot = ability_nodes.get(ability_id)
    if not slot:
        return
    
    # Flash effect
    var tween = create_tween()
    tween.tween_property(slot, "modulate", Color(2, 2, 2, 1), 0.1)
    tween.tween_property(slot, "modulate", Color.WHITE, 0.3)
    
    # Create "UNLOCKED!" popup
    var popup = Label.new()
    popup.text = "UNLOCKED!"
    popup.add_theme_font_size_override("font_size", 12)
    popup.add_theme_color_override("font_color", Color(0.3, 1.0, 0.5))
    popup.global_position = slot.global_position + Vector2(-10, -25)
    get_tree().current_scene.add_child(popup)
    
    var popup_tween = create_tween()
    popup_tween.tween_property(popup, "global_position:y", popup.global_position.y - 20, 0.8)
    popup_tween.parallel().tween_property(popup, "modulate:a", 0.0, 0.8).set_delay(0.3)
    popup_tween.tween_callback(popup.queue_free)
```
  </action>
  <verify>Files exist in ui/hud/</verify>
  <done>Ability bar component with lock/cooldown displays</done>
</task>

<task type="auto">
  <name>Task 2: Integrate Ability Bar into HUD</name>
  <files>ui/hud/game_hud.tscn</files>
  <action>
1. In game_hud.tscn:
   - Instance ability_bar.tscn as child
   - Position at bottom-center of screen
   - Anchor: bottom-center preset
   - Offset Y: -50 (above bottom edge)

Layout should look like:
```
┌─────────────────────────────────┐
│ [Health ████████░░]             │
│ Lv.3 [EXP ██████░░]             │
│                                 │
│            [1][2][3]            │  <- Combo (when active)
│                                 │
│                                 │
│         [C]  [G]                │  <- Ability bar (bottom)
│        Hold  Spec               │     with key hints
└─────────────────────────────────┘
```
  </action>
  <verify>Run game, ability bar visible at bottom</verify>
  <done>Ability bar in HUD</done>
</task>

<task type="auto">
  <name>Task 3: Add Ability Unlock Celebration</name>
  <files>autoloads/effects_manager.gd</files>
  <action>
Add special effect when abilities unlock (on reaching required level):

```gdscript
func _ready() -> void:
    # ... existing ...
    Events.player_leveled_up.connect(_check_ability_unlock)

func _check_ability_unlock(new_level: int) -> void:
    # Ground Pound unlocks at level 5
    if new_level == 5:
        _show_ability_unlock_popup("Ground Pound", "Press Special Attack!")

func _show_ability_unlock_popup(ability_name: String, hint: String) -> void:
    # Create centered popup
    var popup = Control.new()
    popup.anchors_preset = Control.PRESET_CENTER
    popup.z_index = 200
    
    var bg = ColorRect.new()
    bg.size = Vector2(200, 60)
    bg.position = Vector2(-100, -30)
    bg.color = Color(0.1, 0.1, 0.15, 0.95)
    popup.add_child(bg)
    
    var title = Label.new()
    title.text = "NEW ABILITY!"
    title.add_theme_font_size_override("font_size", 12)
    title.add_theme_color_override("font_color", Color(1, 0.9, 0.3))
    title.position = Vector2(-45, -25)
    popup.add_child(title)
    
    var name_label = Label.new()
    name_label.text = ability_name
    name_label.add_theme_font_size_override("font_size", 16)
    name_label.add_theme_color_override("font_color", Color(0.5, 0.9, 1.0))
    name_label.position = Vector2(-50, -5)
    popup.add_child(name_label)
    
    var hint_label = Label.new()
    hint_label.text = hint
    hint_label.add_theme_font_size_override("font_size", 10)
    hint_label.add_theme_color_override("font_color", Color(0.7, 0.7, 0.7))
    hint_label.position = Vector2(-70, 15)
    popup.add_child(hint_label)
    
    get_tree().current_scene.add_child(popup)
    
    # Animate in and out
    popup.modulate.a = 0
    popup.scale = Vector2(0.5, 0.5)
    
    var tween = create_tween()
    tween.tween_property(popup, "modulate:a", 1.0, 0.3)
    tween.parallel().tween_property(popup, "scale", Vector2.ONE, 0.3).set_ease(Tween.EASE_OUT)
    tween.tween_interval(2.0)
    tween.tween_property(popup, "modulate:a", 0.0, 0.3)
    tween.tween_callback(popup.queue_free)
    
    # Brief pause for impact
    Engine.time_scale = 0.3
    await get_tree().create_timer(0.15).timeout
    Engine.time_scale = 1.0
```
  </action>
  <verify>Reaching level 5 shows "NEW ABILITY: Ground Pound" popup</verify>
  <done>Ability unlock celebration effect</done>
</task>

</tasks>

<verification>
1. Run game
2. Ability bar visible at bottom
3. Charge Attack (C) - should be unlocked (no gray overlay)
4. Ground Pound (G) - should show "Lv.5" lock
5. Reach level 5:
   - "NEW ABILITY!" popup appears
   - Ground Pound slot unlocks (gray removed)
6. Use Ground Pound → cooldown overlay fills from bottom
7. Wait 3s → cooldown clears
</verification>

<success_criteria>
- Ability bar clearly shows available abilities
- Locked abilities show level requirement
- Cooldowns display as visual overlay
- Unlock celebration is noticeable
</success_criteria>

<output>
After completion, create `.planning/phases/10-special-abilities/10-03-SUMMARY.md`
</output>
