---
phase: 09-exp-levelup
plan: 03
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - ui/hud/exp_bar.gd (NEW)
  - ui/hud/exp_bar.tscn (NEW)
  - ui/hud/game_hud.tscn
  - ui/hud/game_hud.gd
autonomous: true

must_haves:
  truths:
    - "EXP bar visible in HUD"
    - "EXP bar fills as player gains EXP"
    - "Level number displayed"
  artifacts:
    - path: "ui/hud/exp_bar.tscn"
      provides: "EXP bar UI element"
    - path: "ui/hud/exp_bar.gd"
      provides: "EXP display logic"
  key_links:
    - from: "exp_bar.gd"
      to: "Events.exp_gained"
      via: "signal connection"
---

<objective>
Add EXP bar and level display to the game HUD.

Purpose: Let player see progression at a glance
Output: EXP bar that fills with progress, level number displayed
</objective>

<context>
@ui/hud/game_hud.gd (existing HUD)
@ui/hud/game_hud.tscn (HUD scene)
@ui/hud/health_bar.gd (reference for bar style)
@autoloads/events.gd (exp_gained, player_leveled_up signals)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create EXP Bar Component</name>
  <files>ui/hud/exp_bar.gd, ui/hud/exp_bar.tscn</files>
  <action>
Create EXP bar similar to health bar but thinner and positioned below:

**exp_bar.tscn structure:**
```
ExpBar (Control) [size: 100x12]
├── Background (ColorRect) [dark gray]
├── Fill (ColorRect) [purple/blue gradient feel]
├── Border (ColorRect) [outline]
└── LevelLabel (Label) - "Lv.1" positioned to left
```

**exp_bar.gd:**
```gdscript
extends Control
class_name ExpBar
## Displays player EXP progress and current level

@onready var background: ColorRect = $Background
@onready var fill: ColorRect = $Fill
@onready var level_label: Label = $LevelLabel

const BAR_WIDTH: float = 80.0
const BAR_HEIGHT: float = 6.0

const BG_COLOR: Color = Color(0.15, 0.1, 0.2, 0.8)
const FILL_COLOR: Color = Color(0.5, 0.3, 0.9, 1.0)  # Purple
const FILL_COLOR_FULL: Color = Color(0.7, 0.5, 1.0, 1.0)  # Lighter when full

var current_exp: int = 0
var exp_to_next: int = 100
var current_level: int = 1

var fill_tween: Tween

func _ready() -> void:
    # Setup bar visuals
    background.color = BG_COLOR
    background.size = Vector2(BAR_WIDTH, BAR_HEIGHT)
    
    fill.color = FILL_COLOR
    fill.size = Vector2(0, BAR_HEIGHT)
    fill.position = Vector2(0, 0)
    
    level_label.text = "Lv.1"
    level_label.add_theme_font_size_override("font_size", 10)
    level_label.position = Vector2(-25, -2)
    
    # Connect to events
    Events.exp_gained.connect(_on_exp_gained)
    Events.player_leveled_up.connect(_on_level_up)
    
    _update_display()

func _on_exp_gained(amount: int, level: int, exp_progress: int, exp_needed: int) -> void:
    current_level = level
    current_exp = exp_progress
    exp_to_next = exp_needed
    _animate_fill()

func _on_level_up(new_level: int) -> void:
    current_level = new_level
    level_label.text = "Lv." + str(current_level)
    
    # Flash effect on level up
    _flash_bar()
    
    # Reset fill for new level (will refill with remaining exp)
    fill.size.x = 0

func _animate_fill() -> void:
    if fill_tween:
        fill_tween.kill()
    
    var target_width = BAR_WIDTH * (float(current_exp) / float(exp_to_next)) if exp_to_next > 0 else BAR_WIDTH
    target_width = clampf(target_width, 0, BAR_WIDTH)
    
    fill_tween = create_tween()
    fill_tween.tween_property(fill, "size:x", target_width, 0.3).set_ease(Tween.EASE_OUT)
    
    # Briefly brighten on gain
    fill.color = FILL_COLOR_FULL
    fill_tween.parallel().tween_property(fill, "color", FILL_COLOR, 0.3)

func _flash_bar() -> void:
    var original_color = fill.color
    fill.color = Color(1, 1, 1, 1)
    var tween = create_tween()
    tween.tween_property(fill, "color", FILL_COLOR, 0.2)

func _update_display() -> void:
    level_label.text = "Lv." + str(current_level)
    var fill_percent = float(current_exp) / float(exp_to_next) if exp_to_next > 0 else 0
    fill.size.x = BAR_WIDTH * fill_percent

func set_exp(current: int, to_next: int, level: int) -> void:
    current_exp = current
    exp_to_next = to_next
    current_level = level
    _update_display()
```
  </action>
  <verify>Files exist in ui/hud/</verify>
  <done>EXP bar component with level display</done>
</task>

<task type="auto">
  <name>Task 2: Integrate EXP Bar into Game HUD</name>
  <files>ui/hud/game_hud.tscn, ui/hud/game_hud.gd</files>
  <action>
1. In game_hud.tscn:
   - Instance exp_bar.tscn as child of GameHUD
   - Position below health bar (offset Y: ~25 from health bar)
   - Anchor: top-left (same as health bar)
   - Margins: left 35 (to account for "Lv.X" label), top 25

2. Layout should look like:
```
┌─────────────────────────────┐
│ [Health Bar ████████░░░]   │  <- y: 8
│ Lv.3 [EXP ██████░░░░░░]    │  <- y: 22
│                             │
│            [1] [2] [3]      │  <- Combo counter (if active)
│                             │
└─────────────────────────────┘
```

3. In game_hud.gd, add reference (optional):
```gdscript
@onready var exp_bar: ExpBar = $ExpBar
```

No additional code needed if signals are global.
  </action>
  <verify>Run game, EXP bar visible below health bar</verify>
  <done>EXP bar integrated into HUD</done>
</task>

<task type="auto">
  <name>Task 3: EXP Gain Floating Numbers</name>
  <files>autoloads/effects_manager.gd</files>
  <action>
Add floating "+X EXP" text when gaining experience:

```gdscript
func _ready() -> void:
    # ... existing connections ...
    Events.exp_gained.connect(_on_exp_gained)

func _on_exp_gained(amount: int, _level: int, _current: int, _to_next: int) -> void:
    var player = get_tree().get_first_node_in_group("player")
    if not player:
        return
    
    # Create floating EXP text
    _create_exp_popup(player.global_position, amount)

func _create_exp_popup(pos: Vector2, amount: int) -> void:
    var label = Label.new()
    label.text = "+" + str(amount) + " EXP"
    label.add_theme_font_size_override("font_size", 10)
    label.add_theme_color_override("font_color", Color(0.7, 0.5, 1.0))  # Purple
    label.add_theme_color_override("font_outline_color", Color(0.2, 0.1, 0.3))
    label.add_theme_constant_override("outline_size", 1)
    label.global_position = pos + Vector2(-15, -20)
    label.z_index = 90
    
    get_tree().current_scene.add_child(label)
    
    # Animate float up and fade
    var tween = create_tween()
    tween.set_parallel(true)
    tween.tween_property(label, "global_position:y", label.global_position.y - 25, 0.8)
    tween.tween_property(label, "modulate:a", 0.0, 0.8).set_delay(0.3)
    tween.chain().tween_callback(label.queue_free)
```

This creates a purple "+25 EXP" text that floats up when killing enemies.
  </action>
  <verify>Kill enemy, see purple "+X EXP" float up</verify>
  <done>EXP gain visual feedback</done>
</task>

</tasks>

<verification>
1. Run game with F5
2. Check HUD shows:
   - Health bar (red)
   - EXP bar below (purple) with "Lv.1"
3. Kill enemy:
   - "+X EXP" floats up (purple text)
   - EXP bar fills smoothly
4. Level up:
   - "Lv.2" updates
   - Bar resets and refills with overflow exp
</verification>

<success_criteria>
- EXP bar visible and positioned correctly
- Level number displays and updates
- Bar animates smoothly on EXP gain
- Floating EXP numbers appear on kill
</success_criteria>

<output>
After completion, create `.planning/phases/09-exp-levelup/09-03-SUMMARY.md`
</output>
