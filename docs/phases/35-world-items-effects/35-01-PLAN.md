---
phase: 35-world-items-effects
plan: 01
type: execute
wave: 3
depends_on: ["32-01"]
files_modified:
  - characters/npcs/shop_npc.tscn
  - characters/npcs/shop_npc.gd
  - ui/ring_menu/ring_item.tscn
  - ui/ring_menu/ring_item.gd
  - ui/shop/shop_ui.gd
  - autoloads/item_database.gd
  - autoloads/equipment_database.gd
autonomous: true

must_haves:
  truths:
    - "Nutkin displays as a pixel art sprite instead of code-built polygon squirrel"
    - "Item icons in the ring menu display as pixel art instead of colored squares"
    - "Equipment icons in the ring menu display as pixel art instead of colored squares"
    - "Shop UI item rows show pixel art icons instead of colored swatches"
  artifacts:
    - path: "characters/npcs/shop_npc.tscn"
      provides: "Nutkin with sprite-based idle animation"
      contains: "AnimatedSprite2D"
    - path: "ui/ring_menu/ring_item.gd"
      provides: "Ring item with texture-based icon"
      contains: "TextureRect"
  key_links:
    - from: "ui/ring_menu/ring_item.gd"
      to: "autoloads/item_database.gd"
      via: "item.icon_texture or item.icon_path for loading sprites"
    - from: "ui/shop/shop_ui.gd"
      to: "art/generated/items/*.png"
      via: "TextureRect replacing ColorRect swatch"
---

<objective>
Replace Nutkin NPC's code-built polygon squirrel with an AnimatedSprite2D, and replace all item/equipment ColorRect icon swatches in the ring menu and shop UI with actual pixel art textures.

Purpose: The ring menu and shop are the main inventory interfaces. Replacing colored squares with item art makes the game feel polished and professional.
Output: Nutkin is a sprite, all item/equipment icons are pixel art throughout the UI.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@characters/npcs/shop_npc.gd
@ui/ring_menu/ring_item.gd
@ui/shop/shop_ui.gd
@autoloads/item_database.gd
@autoloads/equipment_database.gd
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace Nutkin NPC polygon squirrel with AnimatedSprite2D</name>
  <files>
    characters/npcs/shop_npc.tscn
    characters/npcs/shop_npc.gd
  </files>
  <action>
  Nutkin is currently built entirely in code via `_create_squirrel_visual()` — 8 Polygon2D child nodes (body, tail, belly, eyes, nose, ears). This all gets replaced.

  **In shop_npc.tscn:**
  1. Add `AnimatedSprite2D` named `Sprite2D` as first child of the Area2D
  2. Create SpriteFrames:
     - `idle` — `art/generated/npcs/nutkin_idle.png`
     - `wave` — `art/generated/npcs/nutkin_wave.png`
  3. Set `centered = true`
  4. Keep existing CollisionShape2D (RectangleShape2D 24x24) — adjust if sprite is larger

  **In shop_npc.gd:**
  1. **Remove the entire `_create_squirrel_visual()` function** and its call from `_ready()`
     This removes all the Polygon2D creation code (body, tail, belly, eyes, nose, ears, labels)
  2. Add `@onready var sprite: AnimatedSprite2D = $Sprite2D`
  3. In `_ready()`: `sprite.play("idle")`
  4. Keep the bob animation but change from `position.y` to `sprite.position.y` (bob the sprite, not the whole Area2D)
  5. **Keep the labels** — `NameLabel` ("Nutkin") and `PromptLabel` ("[E] Shop") should still be created in code BUT now positioned relative to the sprite instead of the old polygon arrangement
  6. When player approaches (interaction highlight): play `sprite.play("wave")`
  7. When player leaves proximity: `sprite.play("idle")`
  </action>
  <verify>
  - Run game, go to Neighborhood — Nutkin shows as pixel art squirrel
  - Approach Nutkin — wave animation plays, "[E] Shop" label appears
  - Walk away — returns to idle
  - `grep "Polygon2D" characters/npcs/shop_npc.gd` returns zero matches
  - `grep "_create_squirrel_visual" characters/npcs/shop_npc.gd` returns zero matches
  </verify>
  <done>Nutkin displays as animated sprite with idle/wave states, all code-built Polygon2D squirrel parts removed</done>
</task>

<task type="auto">
  <name>Task 2: Replace item/equipment icons in ring menu and shop with pixel art</name>
  <files>
    ui/ring_menu/ring_item.tscn
    ui/ring_menu/ring_item.gd
    ui/shop/shop_ui.gd
    autoloads/item_database.gd
    autoloads/equipment_database.gd
  </files>
  <action>
  Items and equipment currently use `ColorRect` swatches with a single color. Replace with `TextureRect` showing actual pixel art.

  **Step 1: Add icon paths to database definitions**

  In `autoloads/item_database.gd`, add an `icon` path to each item in the `ITEMS` dictionary:
  ```gdscript
  "health_potion": {
      "name": "Health Potion",
      "color": Color(0.3, 0.95, 0.4),
      "icon": "res://art/generated/items/health_potion.png",
      # ... rest of properties
  }
  ```

  Map each item to its generated art file:
  - health_potion → `items/health_potion.png`
  - mega_potion → `items/mega_potion.png`
  - full_heal → `items/full_heal.png`
  - antidote → `items/antidote.png`
  - power_treat → `items/power_treat.png`
  - speed_treat → `items/speed_treat.png`
  - tough_treat → `items/tough_treat.png`
  - guard_snack → `items/guard_snack.png`
  - revival_bone → `items/revival_bone.png`
  - energy_treat → `items/energy_treat.png`
  - smoke_bomb → `items/smoke_bomb.png`
  - acorn → `items/acorn.png`
  - bird_seed → `items/bird_seed.png`

  In `autoloads/equipment_database.gd`, add `icon` path to each equipment:
  ```gdscript
  "basic_collar": {
      "name": "Basic Collar",
      "icon": "res://art/generated/equipment/basic_collar.png",
      # ... rest
  }
  ```

  Map all 15 equipment items to their `equipment/*.png` files.

  NOTE: Some item filenames in `art/generated/items/` may not have `_preview` suffix for the actual sprite — use the non-preview version. If a file doesn't exist (check `ls art/generated/items/`), fall back to the colored square.

  **Step 2: Replace ring menu icon ColorRect with TextureRect**

  In `ui/ring_menu/ring_item.tscn`:
  1. Replace the `ColorRect` node named `Icon` (24x24) with a `TextureRect` named `Icon`
  2. Set size to 24x24, `stretch_mode = STRETCH_KEEP_ASPECT_CENTERED`

  In `ui/ring_menu/ring_item.gd`:
  1. Change icon reference type from ColorRect to TextureRect
  2. In the function that sets up the item display, instead of:
     ```gdscript
     icon.color = item_data.get("color", Color.WHITE)
     ```
     Do:
     ```gdscript
     var icon_path = item_data.get("icon", "")
     if icon_path and ResourceLoader.exists(icon_path):
         icon.texture = load(icon_path)
     else:
         # Fallback: create a ColorRect-style solid color (backward compat)
         icon.texture = null
         icon.modulate = item_data.get("color", Color.WHITE)
     ```

  **Step 3: Replace shop UI swatch with TextureRect**

  In `ui/shop/shop_ui.gd`, find `_create_item_row()`:
  1. Replace the 6x6 `ColorRect` swatch creation with a 10x10 `TextureRect`
  2. Load the icon texture:
     ```gdscript
     var swatch = TextureRect.new()
     swatch.custom_minimum_size = Vector2(10, 10)
     swatch.size = Vector2(10, 10)
     swatch.position = Vector2(2, 2)
     swatch.stretch_mode = TextureRect.STRETCH_KEEP_ASPECT_CENTERED
     var icon_path = item.get("icon", "")
     if icon_path and ResourceLoader.exists(icon_path):
         swatch.texture = load(icon_path)
     else:
         swatch.modulate = item.get("color", Color.WHITE)
     ```
  3. Slightly increase row height if 10px icon needs more room (was 14px, might need 16px)
  </action>
  <verify>
  - Open ring menu — item icons show pixel art instead of colored squares
  - Switch to equipment ring — equipment icons show pixel art
  - Open shop — item rows show pixel art icons next to names
  - Items without icons (if any) still show a colored fallback
  - Grep ring_item.gd for `ColorRect` — zero matches (or only in comments)
  </verify>
  <done>All item and equipment icons display as pixel art in ring menu (24x24 TextureRect) and shop UI (10x10 TextureRect), with ColorRect fallback for missing icons</done>
</task>

</tasks>

<verification>
1. Nutkin NPC is a pixel art squirrel (not multi-polygon code art)
2. Ring menu items show pixel art icons
3. Ring menu equipment shows pixel art icons
4. Shop buy/sell tabs show pixel art icons
5. No ColorRect icon swatches visible in any UI (ring menu or shop)
</verification>

<success_criteria>
- WRLD-01: Nutkin displays as animated sprite (idle + wave)
- WRLD-02: All item/equipment icons are pixel art in ring menu and shop
- Fallback handling for any missing icon art
- Zero code-built polygon shapes for Nutkin
</success_criteria>

<output>
After completion, create `.planning/phases/35-world-items-effects/35-01-SUMMARY.md`
</output>
