---
phase: 25-smart-items
plan: 02
type: execute
wave: 2
depends_on: ["25-01"]
files_modified:
  - autoloads/auto_bot.gd
autonomous: true

must_haves:
  truths:
    - "Bot revives knocked-out companions using revival_bone"
    - "Bot equips best available gear per slot by comparing stat totals"
    - "Bot periodically checks for equipment upgrades (not every frame)"
    - "Bot prioritizes reviving companions over other non-combat item usage"
  artifacts:
    - path: "autoloads/auto_bot.gd"
      provides: "Companion revival and equipment optimization logic"
      contains: "_try_revive_companion, _optimize_equipment"
  key_links:
    - from: "autoloads/auto_bot.gd"
      to: "GameManager.party_manager"
      via: "knocked_out dict check and revive_companion() call"
      pattern: "party_manager\\.(knocked_out|revive_companion)"
    - from: "autoloads/auto_bot.gd"
      to: "GameManager.equipment_manager"
      via: "equip(), get_equipped(), equipment_inventory, has_equipment"
      pattern: "equipment_manager\\.(equip|get_equipped|equipment_inventory)"
    - from: "autoloads/auto_bot.gd"
      to: "EquipmentDatabase"
      via: "get_equipment() for stat comparison"
      pattern: "EquipmentDatabase\\.get_equipment"
---

<objective>
Add companion revival (using revival_bone when companions are knocked out) and equipment optimization (auto-equip best gear per slot by comparing stat totals) to the AutoBot.

Purpose: The bot should keep its party alive and always wear the strongest available equipment, completing the "full inventory usage" goal.
Output: Modified auto_bot.gd with revival and equipment optimization logic integrated into the Phase 16 systems update loop.
</objective>

<execution_context>
@~/.config/Claude/get-shit-done/workflows/execute-plan.md
@~/.config/Claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/25-smart-items/25-01-SUMMARY.md

@autoloads/auto_bot.gd
@systems/party/party_manager.gd
@systems/equipment/equipment_manager.gd
@systems/equipment/equipment_database.gd
@systems/inventory/inventory.gd
</context>

<tasks>

<task type="auto">
  <name>Task 1: Companion Revival with Revival Bone</name>
  <files>autoloads/auto_bot.gd</files>
  <action>
Add companion revival logic that detects knocked-out companions and uses revival_bone to revive them.

**New constant** (in CONFIGURATION section):
```gdscript
const REVIVAL_CHECK_INTERVAL: float = 5.0  # Check for knocked-out companions every 5s
```

**New state variables** (in STATE section):
```gdscript
var revival_check_timer: float = 3.0  # First check after 3 seconds
```

**New function `_try_revive_companion()`**:
```gdscript
func _try_revive_companion() -> void:
    # Only revive when safe (no nearby enemies)
    if nearby_enemy_count > 0:
        return
    
    if not GameManager.inventory or not GameManager.party_manager:
        return
    
    # Check if any companions are knocked out
    var knocked_out = GameManager.party_manager.knocked_out
    if knocked_out.is_empty():
        return
    
    # Check if we have revival bone
    if not GameManager.inventory.has_item("revival_bone"):
        return
    
    # Find first knocked-out companion and revive
    for companion_id in knocked_out:
        if GameManager.inventory.use_item("revival_bone"):
            GameManager.party_manager.revive_companion(companion_id, 0.5)
            print("[AutoBot] Used revival_bone to revive %s" % companion_id)
            return
```

**Important note about revival_bone's use_item()**: The `inventory.use_item()` for REVIVE effect type currently has placeholder logic in `inventory.gd` (lines 148-154) — it just returns true without calling `party_manager.revive_companion()`. The bot must call BOTH `use_item()` (to consume the item) AND `party_manager.revive_companion()` (to actually revive). The `use_item()` handles item removal + sound, the `revive_companion()` handles the actual game logic.

**Call site in `_update_phase16_systems()`**: Add the timer update and revival check. Place BEFORE the companion cycling section, right after the healing/buff logic:
```gdscript
# Check for companion revival
revival_check_timer -= delta
if revival_check_timer <= 0:
    revival_check_timer = REVIVAL_CHECK_INTERVAL
    _try_revive_companion()
```

Also update the timer in the state variable decrements (alongside `companion_cycle_timer` and `ring_menu_test_timer`).
  </action>
  <verify>
Search auto_bot.gd for `_try_revive_companion` — function must exist.
Search for `revival_bone` — must appear in revival logic.
Search for `revive_companion` — must call party_manager.revive_companion().
Search for `REVIVAL_CHECK_INTERVAL` — constant must exist.
Search for `revival_check_timer` — timer variable must exist and be decremented.
  </verify>
  <done>
Bot checks every 5s for knocked-out companions. When safe (no enemies nearby), uses revival_bone to revive first knocked-out companion at 50% HP. Properly calls both use_item (consume item) and revive_companion (game logic).
  </done>
</task>

<task type="auto">
  <name>Task 2: Equipment Optimization — Auto-Equip Best Gear</name>
  <files>autoloads/auto_bot.gd</files>
  <action>
Add equipment optimization logic that periodically checks if better gear is available in the equipment inventory and equips it.

**New constants** (in CONFIGURATION section):
```gdscript
const EQUIP_CHECK_INTERVAL: float = 30.0  # Check equipment every 30s
```

**New state variables** (in STATE section):
```gdscript
var equip_check_timer: float = 10.0  # First equipment check after 10 seconds
```

**New function `_optimize_equipment()`**:
```gdscript
func _optimize_equipment() -> void:
    if not GameManager.equipment_manager:
        return
    
    var em = GameManager.equipment_manager
    
    # Check each slot for upgrades
    for slot in EquipmentDatabase.Slot.values():
        var current_id = em.get_equipped(slot)
        var current_score = _get_equipment_score(current_id)
        
        # Check all unequipped equipment that fits this slot
        var best_id = current_id
        var best_score = current_score
        
        for equip_id in em.equipment_inventory:
            var equip_data = EquipmentDatabase.get_equipment(equip_id)
            if equip_data.is_empty():
                continue
            if equip_data.slot != slot:
                continue
            
            var score = _get_equipment_score(equip_id)
            if score > best_score:
                best_score = score
                best_id = equip_id
        
        # Equip if better option found
        if best_id != current_id and best_id != "":
            em.equip(best_id)
            print("[AutoBot] Equipped %s (score: %.0f > %.0f)" % [best_id, best_score, current_score])
```

**New helper function `_get_equipment_score(equip_id: String) -> float`**:
```gdscript
func _get_equipment_score(equip_id: String) -> float:
    if equip_id == "":
        return 0.0
    
    var equip_data = EquipmentDatabase.get_equipment(equip_id)
    if equip_data.is_empty():
        return 0.0
    
    var score: float = 0.0
    var stats = equip_data.get("stats", {})
    
    # Weight each stat type (attack and HP most valuable for bot)
    for stat_type in stats:
        var value = stats[stat_type]
        match stat_type:
            EquipmentDatabase.StatType.ATTACK_DAMAGE:
                score += value * 3.0    # Attack is king for bot (kills faster = less damage taken)
            EquipmentDatabase.StatType.MAX_HEALTH:
                score += value * 1.5    # HP is survival
            EquipmentDatabase.StatType.DEFENSE:
                score += value * 2.0    # Defense percentage is strong
            EquipmentDatabase.StatType.MOVE_SPEED:
                score += value * 1.0    # Speed helps kiting
            EquipmentDatabase.StatType.GUARD_REGEN:
                score += value * 1.5    # Guard regen for blocking bot
            EquipmentDatabase.StatType.EXP_BONUS:
                score += value * 0.5    # EXP is nice but not survival
    
    return score
```

This scoring system means:
- Raccoon Crown (15 HP + 5 ATK) = 15×1.5 + 5×3.0 = 37.5
- Guard Helmet (10 DEF + 5 Guard) = 10×2.0 + 5×1.5 = 27.5
- Rat King's Collar (8 ATK + 5 Guard) = 8×3.0 + 5×1.5 = 31.5
- Crow Feather Coat (10 SPD + 10 DEF) = 10×1.0 + 10×2.0 = 30.0

**Call site in `_update_phase16_systems()`**: Add equipment check with timer:
```gdscript
# Optimize equipment periodically (when safe)
equip_check_timer -= delta
if equip_check_timer <= 0 and nearby_enemy_count == 0:
    equip_check_timer = EQUIP_CHECK_INTERVAL
    _optimize_equipment()
```

Place this AFTER the companion revival check and BEFORE the ring menu test section.
  </action>
  <verify>
Search auto_bot.gd for `_optimize_equipment` — function must exist.
Search for `_get_equipment_score` — scoring function must exist.
Search for `EQUIP_CHECK_INTERVAL` — constant must exist.
Search for `equip_check_timer` — timer must exist and be decremented.
Verify score weights: ATTACK_DAMAGE = 3.0, MAX_HEALTH = 1.5, DEFENSE = 2.0, MOVE_SPEED = 1.0, GUARD_REGEN = 1.5, EXP_BONUS = 0.5.
Verify `em.equip(best_id)` is called when upgrade found.
  </verify>
  <done>
Bot checks equipment every 30s when safe. For each of 5 slots, compares currently equipped item's weighted stat score against all unequipped alternatives. Equips upgrades automatically. Scoring favors attack (3x) > defense (2x) > HP/guard (1.5x) > speed (1x) > EXP (0.5x).
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `grep -n "_try_revive_companion\|_optimize_equipment\|_get_equipment_score" autoloads/auto_bot.gd` — all 3 functions exist
2. `grep -n "REVIVAL_CHECK_INTERVAL\|EQUIP_CHECK_INTERVAL" autoloads/auto_bot.gd` — both constants exist
3. `grep -n "revival_bone\|revive_companion" autoloads/auto_bot.gd` — revival_bone usage and party_manager call exist
4. `grep -n "equipment_inventory\|EquipmentDatabase.get_equipment\|em.equip" autoloads/auto_bot.gd` — equipment optimization logic exists
5. `grep -n "ATTACK_DAMAGE.*3.0\|MAX_HEALTH.*1.5\|DEFENSE.*2.0" autoloads/auto_bot.gd` — stat weights exist
6. Godot project opens without parse errors
</verification>

<success_criteria>
- Bot revives knocked-out companions with revival_bone when safe (no enemies)
- Bot checks equipment every 30s and equips highest-scoring gear per slot
- Equipment scoring uses weighted stat formula (ATK 3x, DEF 2x, HP 1.5x, Guard 1.5x, SPD 1x, EXP 0.5x)
- Revival check runs every 5s on a timer (not every frame)
- Bot calls both use_item() and revive_companion() for proper revival
- Equipment optimization iterates all 5 slots and all unequipped inventory
</success_criteria>

<output>
After completion, create `.planning/phases/25-smart-items/25-02-SUMMARY.md`
</output>
