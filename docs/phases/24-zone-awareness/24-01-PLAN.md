---
phase: 24-zone-awareness
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - autoloads/auto_bot.gd
autonomous: true

must_haves:
  truths:
    - "Bot boundary avoidance uses actual zone size from BaseZone.zone_size, not hardcoded 800x600"
    - "Bot generates patrol points proportional to current zone dimensions"
    - "Bot works correctly in Neighborhood (800x600), Backyard (384x216), and Sewers (1152x648)"
  artifacts:
    - path: "autoloads/auto_bot.gd"
      provides: "Dynamic zone boundary detection and zone-aware patrol"
      contains: "current_zone_size"
  key_links:
    - from: "autoloads/auto_bot.gd"
      to: "world/zones/base_zone.gd"
      via: "Reading zone_size from player's ancestor BaseZone node"
      pattern: "zone_size"
---

<objective>
Replace hardcoded 800x600 ZONE_SIZE constant with dynamic zone boundary detection, and generate zone-appropriate patrol points instead of Neighborhood-only hardcoded positions.

Purpose: The bot currently confines itself to an 800x600 box regardless of zone. This breaks in Backyard (384x216 — bot exits bounds) and Sewers (1152x648 — bot trapped in corner). Dynamic detection means the bot automatically adapts to any zone.

Output: auto_bot.gd with dynamic zone size detection and zone-proportional patrol point generation.
</objective>

<execution_context>
@~/.config/Claude/get-shit-done/workflows/execute-plan.md
@~/.config/Claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

Key source files:
@autoloads/auto_bot.gd — The bot (1251 lines). Lines 61, 544-562, 837-893 are the targets.
@world/zones/base_zone.gd — BaseZone has `@export var zone_size: Vector2` at line 11. Player gets camera limits from `Rect2(Vector2.ZERO, zone_size)` at line 94.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace hardcoded ZONE_SIZE with dynamic zone detection</name>
  <files>autoloads/auto_bot.gd</files>
  <action>
  **In the CONFIGURATION section (lines ~57-61):**
  - KEEP `const ZONE_PADDING: float = 40.0` (line 58)
  - REMOVE `const ZONE_SIZE: Vector2 = Vector2(800, 600)` (line 61)
  - ADD a fallback constant: `const DEFAULT_ZONE_SIZE: Vector2 = Vector2(800, 600)`

  **In the STATE section (lines ~84-160), add new zone tracking state:**
  ```gdscript
  # Zone awareness
  var current_zone_size: Vector2 = Vector2(800, 600)
  var current_zone_ref: Node = null  # Cached BaseZone reference
  var _zone_size_detected: bool = false
  ```

  **Add a new function `_update_zone_awareness()` in the HELPERS section (after line ~898):**
  ```gdscript
  func _update_zone_awareness() -> void:
      # Only re-detect when zone ref is lost (zone transition) or not yet detected
      if _zone_size_detected and is_instance_valid(current_zone_ref):
          return
      
      if player_ref == null:
          return
      
      # Walk up the player's ancestor tree to find BaseZone
      var node = player_ref.get_parent()
      while node != null:
          if node is BaseZone:
              current_zone_ref = node
              current_zone_size = node.zone_size
              _zone_size_detected = true
              print("[AutoBot] Zone detected: %s (size: %s)" % [node.zone_id, current_zone_size])
              return
          node = node.get_parent()
      
      # Fallback: read camera limits from player if BaseZone not found
      if player_ref.has_node("Camera2D"):
          var cam = player_ref.get_node("Camera2D")
          var w = cam.limit_right - cam.limit_left
          var h = cam.limit_bottom - cam.limit_top
          if w > 0 and h > 0:
              current_zone_size = Vector2(w, h)
              _zone_size_detected = true
              print("[AutoBot] Zone size from camera: %s" % current_zone_size)
              return
      
      # Ultimate fallback
      current_zone_size = DEFAULT_ZONE_SIZE
      _zone_size_detected = true
      print("[AutoBot] Using default zone size: %s" % current_zone_size)
  ```

  **Call `_update_zone_awareness()` in `_physics_process()` — add right after `_update_health_status()` call (line ~217):**
  ```gdscript
  # Update zone awareness  
  _update_zone_awareness()
  ```

  **Reset detection on player ref change — in `_ensure_player_reference()` (line ~284), add after finding new player:**
  ```gdscript
  _zone_size_detected = false  # Re-detect zone on new player
  ```

  **Update `_apply_boundary_avoidance()` (line 544) to use `current_zone_size` instead of `ZONE_SIZE`:**
  Replace every `ZONE_SIZE.x` with `current_zone_size.x` and every `ZONE_SIZE.y` with `current_zone_size.y`.
  Specifically lines 554 and 559:
  - `elif pos.x > ZONE_SIZE.x - ZONE_PADDING:` → `elif pos.x > current_zone_size.x - ZONE_PADDING:`
  - `elif pos.y > ZONE_SIZE.y - ZONE_PADDING:` → `elif pos.y > current_zone_size.y - ZONE_PADDING:`
  </action>
  <verify>
  - Search auto_bot.gd for "ZONE_SIZE" — should only find `DEFAULT_ZONE_SIZE` (no bare `ZONE_SIZE` references)
  - Search for `current_zone_size` — should appear in state section, `_update_zone_awareness()`, and `_apply_boundary_avoidance()`
  - The Godot project should launch without errors (`godot --headless --quit` or open in editor)
  </verify>
  <done>
  - `const ZONE_SIZE` removed, replaced by `var current_zone_size` populated dynamically
  - `_apply_boundary_avoidance()` uses `current_zone_size` not `ZONE_SIZE`
  - Zone detection walks player ancestor tree to find BaseZone.zone_size
  - Camera limit fallback exists for edge cases
  - Detection resets on player reference change (zone transitions)
  </done>
</task>

<task type="auto">
  <name>Task 2: Replace hardcoded patrol points with dynamic zone-proportional generation</name>
  <files>autoloads/auto_bot.gd</files>
  <action>
  **Replace the hardcoded patrol_points array in `_pick_wander_direction()` (lines 868-875)** with dynamic generation based on `current_zone_size`:

  Replace this block:
  ```gdscript
  # Otherwise, use patrol pattern across zone
  var patrol_points = [
      Vector2(150, 200),  # Near Momi's house
      Vector2(400, 200),  # Top center  
      Vector2(650, 200),  # Top right
      Vector2(150, 480),  # Park area
      Vector2(400, 400),  # Center
      Vector2(600, 500),  # Near stores
  ]
  ```

  With this dynamic generation:
  ```gdscript
  # Generate patrol points proportional to current zone
  var patrol_points = _generate_patrol_points()
  ```

  **Add new function `_generate_patrol_points()` in the HELPERS section:**
  ```gdscript
  func _generate_patrol_points() -> Array[Vector2]:
      var zs = current_zone_size
      var pad = ZONE_PADDING * 2  # Stay well inside boundaries
      var points: Array[Vector2] = []
      
      # Generate a grid of patrol points covering the zone
      # 3 columns x 2 rows = 6 points, proportional to zone size
      var cols = 3
      var rows = 2
      for row in range(rows):
          for col in range(cols):
              var x = pad + (zs.x - pad * 2) * (float(col) / float(cols - 1)) if cols > 1 else zs.x / 2.0
              var y = pad + (zs.y - pad * 2) * (float(row) / float(rows - 1)) if rows > 1 else zs.y / 2.0
              points.append(Vector2(x, y))
      
      # Add center point
      points.append(Vector2(zs.x / 2.0, zs.y / 2.0))
      
      return points
  ```

  This generates 7 patrol points (6 grid + center) proportional to any zone size:
  - Neighborhood (800x600): ~(80,80), (400,80), (720,80), (80,520), (400,520), (720,520), (400,300)
  - Backyard (384x216): ~(80,80), (192,80), (304,80), (80,136), (192,136), (304,136), (192,108)
  - Sewers (1152x648): ~(80,80), (576,80), (1072,80), (80,568), (576,568), (1072,568), (576,324)

  **Important:** Do NOT change the rest of `_pick_wander_direction()` logic — the enemy hunting (lines 843-865) and the patrol point selection + navigation (lines 877-893) remain unchanged. Only the patrol_points array source changes.
  </action>
  <verify>
  - Search auto_bot.gd for hardcoded patrol points like `Vector2(150, 200)` — should find NONE
  - Search for `_generate_patrol_points` — should exist as a function
  - The patrol points should scale with zone size (verify by reading the function)
  </verify>
  <done>
  - Hardcoded Neighborhood-only patrol points removed
  - `_generate_patrol_points()` generates proportional patrol grid for any zone
  - Bot patrols the full extent of Backyard (384x216) and Sewers (1152x648)
  - Neighborhood behavior unchanged (similar point distribution)
  </done>
</task>

</tasks>

<verification>
1. `grep -n "ZONE_SIZE" autoloads/auto_bot.gd` — only `DEFAULT_ZONE_SIZE` references remain
2. `grep -n "current_zone_size" autoloads/auto_bot.gd` — appears in state, detection, boundary avoidance
3. `grep -n "Vector2(150, 200)\|Vector2(400, 200)\|Vector2(650, 200)" autoloads/auto_bot.gd` — no hardcoded points
4. `grep -n "_generate_patrol_points\|_update_zone_awareness" autoloads/auto_bot.gd` — both functions exist
5. Run game, enter Neighborhood — bot uses 800x600 bounds (same as before)
6. Run game, enter Backyard — bot uses 384x216 bounds (not going off-screen)
7. Run game, enter Sewers — bot uses 1152x648 bounds (explores full zone)
</verification>

<success_criteria>
- Bot dynamically reads zone_size from BaseZone ancestor node
- Boundary avoidance works correctly for all 4 zone sizes (test, neighborhood, backyard, sewers)
- Patrol points scale proportionally — no Neighborhood-specific hardcoded coords
- Detection resets on zone transition (player ref change)
- Fallback to camera limits → default 800x600 if BaseZone not found
</success_criteria>

<output>
After completion, create `.planning/phases/24-zone-awareness/24-01-SUMMARY.md`
</output>
