---
phase: 22-v13-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - systems/shop/shop_catalog.gd
  - characters/enemies/states/alpha_summon.gd
  - characters/enemies/states/crow_swarm_summon.gd
  - components/health/health_component.gd
  - .planning/phases/17-new-enemies/17-VERIFICATION.md
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Mini-boss loot items (raccoon_crown, crow_feather_coat, rat_king_collar) can be sold at shop"
    - "No runtime stutter when Alpha Raccoon or Crow Matriarch summon minions"
    - "Poison visual intensifies (deeper green) when multiple poison sources overlap"
    - "Phase 17 has formal verification documentation"
  artifacts:
    - path: "systems/shop/shop_catalog.gd"
      provides: "Mini-boss loot pricing in SHOP_EQUIPMENT"
      contains: "raccoon_crown"
    - path: "characters/enemies/states/alpha_summon.gd"
      provides: "Preloaded raccoon scene"
      contains: "preload"
    - path: "characters/enemies/states/crow_swarm_summon.gd"
      provides: "Preloaded crow scene"
      contains: "preload"
    - path: "components/health/health_component.gd"
      provides: "Poison stack tracking with visual escalation"
      contains: "poison_stack_count"
    - path: ".planning/phases/17-new-enemies/17-VERIFICATION.md"
      provides: "Phase 17 formal verification"
  key_links:
    - from: "systems/shop/shop_catalog.gd"
      to: "ui/shop/shop_ui.gd"
      via: "get_sell_price() returns valid price for mini-boss items"
      pattern: "raccoon_crown.*\\d+"
---

<objective>
Close all low-severity tech debt items from the v1.3 milestone audit: shop sell catalog gap, load/preload inconsistency, poison visual stacking, and missing Phase 17 verification doc.

Purpose: Clean up minor quality issues before starting the next milestone. All fixes are small (2-6 lines each) except poison stacking which is a focused refactor.

Output: 4 source files updated + 1 verification doc created
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/v1.3-MILESTONE-AUDIT.md
@systems/shop/shop_catalog.gd
@characters/enemies/states/alpha_summon.gd
@characters/enemies/states/crow_swarm_summon.gd
@components/health/health_component.gd
@.planning/phases/17-new-enemies/17-01-SUMMARY.md
@.planning/phases/17-new-enemies/17-02-SUMMARY.md
@.planning/phases/17-new-enemies/17-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add mini-boss loot to shop catalog + fix preload</name>
  <files>systems/shop/shop_catalog.gd, characters/enemies/states/alpha_summon.gd, characters/enemies/states/crow_swarm_summon.gd</files>
  <action>
  Three quick fixes (all trivial line changes):

  **Fix A — Shop sell catalog** (systems/shop/shop_catalog.gd):
  Add 3 entries to the `SHOP_EQUIPMENT` dictionary (after line 40, before the closing `}`):
  ```gdscript
  "raccoon_crown": 200,
  "crow_feather_coat": 250,
  "rat_king_collar": 220,
  ```
  These are sell-only — do NOT add them to `DEFAULT_EQUIPMENT_STOCK` (which controls shop buy inventory). This means the shop won't stock them for purchase, but players CAN sell them at 50% value (100, 125, 110 coins respectively).

  **Fix B — Alpha Raccoon preload** (characters/enemies/states/alpha_summon.gd):
  1. Add a const at the top of the file (after line 8, with the other constants):
     ```gdscript
     const RACCOON_SCENE = preload("res://characters/enemies/raccoon.tscn")
     ```
  2. Replace line 62 `var raccoon_scene = load("res://characters/enemies/raccoon.tscn")` with:
     ```gdscript
     var raccoon_scene = RACCOON_SCENE
     ```

  **Fix C — Crow Matriarch preload** (characters/enemies/states/crow_swarm_summon.gd):
  1. Add a const at the top of the file (after line 10, with the other constants):
     ```gdscript
     const CROW_SCENE = preload("res://characters/enemies/crow.tscn")
     ```
  2. Replace line 62 `var crow_scene = load("res://characters/enemies/crow.tscn")` with:
     ```gdscript
     var crow_scene = CROW_SCENE
     ```

  This matches the pattern already used in rat_king.gd: `const SEWER_RAT_SCENE = preload("res://characters/enemies/sewer_rat.tscn")`
  </action>
  <verify>
  1. Grep shop_catalog.gd for "raccoon_crown" — should appear in SHOP_EQUIPMENT
  2. Grep shop_catalog.gd for DEFAULT_EQUIPMENT_STOCK — should NOT contain raccoon_crown (sell-only)
  3. Grep alpha_summon.gd for "preload" — should find the const
  4. Grep alpha_summon.gd for 'load("res://' — should NOT appear (replaced with const)
  5. Grep crow_swarm_summon.gd for "preload" — should find the const
  6. Grep crow_swarm_summon.gd for 'load("res://' — should NOT appear (replaced with const)
  </verify>
  <done>Mini-boss loot sellable at 50% value. Summon states use preload constants eliminating runtime stutter.</done>
</task>

<task type="auto">
  <name>Task 2: Refactor poison visual stacking in HealthComponent</name>
  <files>components/health/health_component.gd</files>
  <action>
  Refactor the poison system to track stack count and escalate the green tint visually.

  **Current behavior:** apply_poison() overwrites poison_damage and poison_remaining. Visual tint only applied once (static Color(0.7, 1.0, 0.7)).

  **New behavior:** Track a stack counter. Each new apply_poison() increments the counter. Visual tint deepens with more stacks. When poison clears, reset everything.

  **Changes to health_component.gd:**

  1. **Add stack counter** (after line 52, in STATE section):
     ```gdscript
     var poison_stack_count: int = 0
     ```

  2. **Modify apply_poison()** (lines 149-162):
     Replace the entire function with:
     ```gdscript
     func apply_poison(damage_per_tick: int, duration: float) -> void:
         # Stack: use highest damage, refresh duration, track count
         poison_damage = maxi(poison_damage, damage_per_tick)
         poison_remaining = maxf(poison_remaining, duration)
         _poison_tick_timer = 0.0
         poison_stack_count += 1

         if not is_poisoned:
             is_poisoned = true
             poison_started.emit()

         # Escalate visual — deeper green with more stacks
         _update_poison_visual()
     ```

  3. **Add _update_poison_visual() helper** (after the modified apply_poison, before clear_poison):
     ```gdscript
     func _update_poison_visual() -> void:
         var parent = get_parent()
         if not parent:
             return
         var sprite = parent.get_node_or_null("Sprite2D")
         if not sprite:
             return
         # Deeper green per stack: 0.7 -> 0.55 -> 0.4 -> 0.3 (clamped)
         var green_intensity = clampf(0.7 - (poison_stack_count - 1) * 0.15, 0.3, 0.7)
         sprite.modulate = Color(green_intensity, 1.0, green_intensity)
     ```

  4. **Update clear_poison()** (lines 166-177):
     Add `poison_stack_count = 0` reset (after line 170, with the other resets):
     ```gdscript
     func clear_poison() -> void:
         is_poisoned = false
         poison_damage = 0
         poison_remaining = 0.0
         _poison_tick_timer = 0.0
         poison_stack_count = 0
         poison_ended.emit()
         # Restore sprite modulate
         var parent = get_parent()
         if parent:
             var sprite = parent.get_node_or_null("Sprite2D")
             if sprite:
                 sprite.modulate = Color.WHITE
     ```

  **Design rationale:**
  - `maxi(poison_damage)` — strongest poison wins (not additive, which could be OP)
  - `maxf(poison_remaining)` — longest duration wins (prevents short poison canceling long)
  - Stack count is purely visual — deepening green signals danger without changing damage math
  - Clamped at 0.3 to keep sprite visible (not pure green)
  </action>
  <verify>
  1. Read health_component.gd and confirm:
     - poison_stack_count variable exists in STATE section
     - apply_poison() increments poison_stack_count and calls _update_poison_visual()
     - _update_poison_visual() calculates green_intensity based on stack count
     - clear_poison() resets poison_stack_count to 0
  2. Verify the visual math: 1 stack = 0.7 (light green), 2 stacks = 0.55, 3 stacks = 0.4, 4+ stacks = 0.3 (deep green)
  </verify>
  <done>Poison visual escalates with stack count — 1 source = light green, 2+ sources = progressively deeper green. Strongest damage and longest duration are preserved. Full reset on clear.</done>
</task>

<task type="auto">
  <name>Task 3: Create Phase 17 VERIFICATION.md</name>
  <files>.planning/phases/17-new-enemies/17-VERIFICATION.md</files>
  <action>
  Create a formal verification document for Phase 17 (New Enemy Types) based on the existing 3 plan SUMMARYs. This phase was verified in practice but lacked a formal doc.

  Read the three SUMMARYs:
  - .planning/phases/17-new-enemies/17-01-SUMMARY.md (Stray Cat)
  - .planning/phases/17-new-enemies/17-02-SUMMARY.md (Sewer Rat)
  - .planning/phases/17-new-enemies/17-03-SUMMARY.md (Shadow Creature)

  Create `.planning/phases/17-new-enemies/17-VERIFICATION.md` following the same format used by 18-VERIFICATION.md, 19-VERIFICATION.md, and 20-VERIFICATION.md. Include:

  1. **Frontmatter**: phase, verified date, status (pass), must-haves count
  2. **Must-haves verification table**: Derive from Phase 17 deliverables in ROADMAP.md:
     - Stray Cat with stealth/pounce/retreat states
     - Sewer Rat with swarm behavior and poison bite DoT
     - Shadow Creature with phase shift, ranged bolt, teleport
     - Poison DoT system on HealthComponent (reusable)
     - Projectile system (shadow bolt)
     - Unique drop tables per enemy type
     - All enemies spawnable in appropriate zones
  3. **Verification method**: Note this was retroactively verified from existing SUMMARYs during v1.3 audit

  Mark all must-haves as PASS (they were confirmed working during Phases 18-20 execution).
  </action>
  <verify>
  Confirm file exists at .planning/phases/17-new-enemies/17-VERIFICATION.md with:
  - Proper frontmatter
  - All must-haves listed and marked PASS
  - Note about retroactive verification
  </verify>
  <done>Phase 17 has formal VERIFICATION.md matching the format of Phases 18-20.</done>
</task>

</tasks>

<verification>
1. Shop: `ShopCatalog.get_sell_price("raccoon_crown")` would return 100 (200 * 0.5)
2. Preload: No `load("res://` calls remain in alpha_summon.gd or crow_swarm_summon.gd
3. Poison: health_component.gd has poison_stack_count variable, _update_poison_visual() method
4. Docs: 17-VERIFICATION.md exists with all must-haves PASS
</verification>

<success_criteria>
- All 3 mini-boss items sellable in shop at 50% value
- Both summon states use preload() constants (no runtime load)
- Poison visual deepens with 2+ concurrent poison sources
- Phase 17 has formal verification doc
- All v1.3 tech debt items from milestone audit resolved
</success_criteria>

<output>
After completion, create `.planning/phases/22-v13-polish/22-01-SUMMARY.md`
</output>
