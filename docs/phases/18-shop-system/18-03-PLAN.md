---
phase: 18-shop-system
plan: 03
type: execute
wave: 3
depends_on: ["18-02"]
files_modified:
  - ui/shop/shop_ui.gd
  - systems/shop/shop_catalog.gd
  - autoloads/events.gd
  - world/zones/neighborhood.gd
autonomous: true

must_haves:
  truths:
    - "Player can sell items from inventory back to the shop for 50% of buy price"
    - "Player can sell equipment from equipment inventory back to the shop for 50% of buy price"
    - "Sold items are removed from inventory and coins are added"
    - "Shop restocks items when the player re-enters the neighborhood zone"
    - "Player can see sell prices next to their inventory items in sell tab"
  artifacts:
    - path: "ui/shop/shop_ui.gd"
      provides: "Complete shop UI with sell tab and restock"
      contains: "_sell_selected"
    - path: "systems/shop/shop_catalog.gd"
      provides: "Stock tracking with restock on zone entry"
      contains: "restock"
  key_links:
    - from: "ui/shop/shop_ui.gd"
      to: "GameManager.inventory.remove_item"
      via: "sell transaction"
      pattern: "GameManager\\.inventory\\.remove_item"
    - from: "ui/shop/shop_ui.gd"
      to: "GameManager.add_coins"
      via: "sell proceeds"
      pattern: "GameManager\\.add_coins"
    - from: "systems/shop/shop_catalog.gd"
      to: "Events.zone_entered"
      via: "restock on zone re-entry"
      pattern: "Events\\.zone_entered\\.connect"
---

<objective>
Add the sell tab to the shop UI and implement the restock mechanic for the shop inventory.

Purpose: Completes the shop loop — players can now both spend and recover coins via selling. Restock ensures the shop refreshes its stock, giving reason to revisit. This is the final piece to make the shop a functional economy loop.

Output: Working sell tab in shop UI, restock on zone re-entry, complete shop system.
</objective>

<execution_context>
@~/.config/Claude/get-shit-done/workflows/execute-plan.md
@~/.config/Claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-shop-system/18-01-SUMMARY.md
@.planning/phases/18-shop-system/18-02-SUMMARY.md
@ui/shop/shop_ui.gd
@systems/shop/shop_catalog.gd
@autoloads/events.gd
@autoloads/game_manager.gd
@systems/inventory/inventory.gd
@systems/equipment/equipment_manager.gd
@world/zones/neighborhood.gd
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement sell tab in shop UI</name>
  <files>
    ui/shop/shop_ui.gd
  </files>
  <action>
**Update `ui/shop/shop_ui.gd` to add sell functionality:**

**1. Replace the SELL tab placeholder with real sell logic:**

When `current_tab == 1` (SELL):
- **Items category (current_category == 0):** Populate `current_list` from player's inventory items.
  - Call `GameManager.inventory.get_all_items()` to get player's items
  - For each item, add `"sell_price"` key using `ShopCatalog.get_sell_price(item.id)`
  - Only show items that have a sell price (exist in ShopCatalog)
  - Show quantity owned next to each

- **Equipment category (current_category == 1):** Populate from player's unequipped equipment inventory.
  - Iterate `GameManager.equipment_manager.equipment_inventory` keys
  - For each equipment_id, get data from EquipmentDatabase and add `"sell_price"` from ShopCatalog
  - Do NOT list currently equipped items (only unequipped from `equipment_inventory`)
  - Show "Equipped" label for items in `equipped` dict (these can't be sold — player must unequip first via ring menu)

**2. Update detail pane for sell mode:**
- Show item name, description, and **sell price** (not buy price)
- Sell price in gold color
- Action prompt: "[Z] Sell" if item is sellable
- For empty inventory: show "Nothing to sell!" centered in list area

**3. Update `_sell_selected()` function:**
- Get selected item from current_list
- If item (consumable):
  - Call `GameManager.inventory.remove_item(item.id, 1)` — sells 1 at a time
  - Call `GameManager.add_coins(sell_price)`
- If equipment (from equipment_inventory):
  - Call `GameManager.equipment_manager.remove_equipment(item.id)`
  - Call `GameManager.add_coins(sell_price)`
- Play "health_pickup" sfx
- Flash detail pane gold briefly (coin gain feedback)
- Print "[Shop] Sold: {item_name} for {sell_price} coins"
- Refresh the sell list (re-populate from updated inventory)
- If list becomes empty after sell, show "Nothing to sell!"
- Clamp selected_index if list shrank

**4. Update input handling:**
- Z key or attack action on SELL tab calls `_sell_selected()` instead of `_buy_selected()`

**5. Update row display for sell mode:**
- Color swatch: item color
- Name: item name
- Price column: shows sell_price in gold (not buy_price)
- Quantity: "x{qty}" for items, "x1" for equipment
- For equipment: if sold, row disappears on refresh

**6. Sell feedback animations:**
- Success: Brief gold flash on item row + coin count pulses up
- Gold "+{amount}" floating text near coin display (tween up and fade out, 0.6s)
  </action>
  <verify>
    Run the game. Open shop. Press Right to switch to SELL tab. Verify player's owned items appear with sell prices. Select an item, press Z — verify item removed from inventory, coins added (check coin counter). Switch to Equipment category — verify unequipped equipment shows. Sell equipment — verify removed and coins added. Verify empty state when nothing left to sell.
  </verify>
  <done>
    Sell tab fully functional. Player can sell inventory items and unequipped equipment for 50% of buy price. Feedback animations work. Empty state handled.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add restock mechanic on zone re-entry</name>
  <files>
    systems/shop/shop_catalog.gd
    autoloads/events.gd
    world/zones/neighborhood.gd
  </files>
  <action>
**1. Add stock tracking to `systems/shop/shop_catalog.gd`:**

The shop catalog currently has static prices. Add dynamic stock tracking:

```
## Current stock levels: {item_id: quantity_available}
var shop_stock: Dictionary = {}

## Default stock levels (reset on restock)
const DEFAULT_ITEM_STOCK: Dictionary = {
    "acorn": 10,
    "bird_seed": 15,
    "health_potion": 5,
    "mega_potion": 3,
    "full_heal": 1,
    "power_treat": 3,
    "speed_treat": 3,
    "tough_treat": 3,
    "guard_snack": 5,
    "revival_bone": 2,
}

## Equipment stock: each piece available once per restock
const DEFAULT_EQUIPMENT_STOCK: Dictionary = {
    # All equipment IDs with stock of 1 each
    "basic_collar": 1,
    "spiked_collar": 1,
    "lucky_collar": 1,
    "training_harness": 1,
    "tactical_harness": 1,
    "padded_harness": 1,
    "retractable_leash": 1,
    "chain_leash": 1,
    "bungee_leash": 1,
    "raincoat": 1,
    "sweater": 1,
    "leather_jacket": 1,
    "baseball_cap": 1,
    "bandana": 1,
    "guard_helmet": 1,
}
```

**In `_ready()`:** Call `restock()` to initialize stock.

**restock() function:**
- Reset `shop_stock` to copies of DEFAULT_ITEM_STOCK + DEFAULT_EQUIPMENT_STOCK
- For equipment the player already owns: don't restock (check `GameManager.equipment_manager.has_equipment(id)`)
- Print "[ShopCatalog] Shop restocked!"

**get_stock(item_id: String) -> int:** Returns current stock for an item.

**reduce_stock(item_id: String) -> void:** Decrements stock by 1. Called by ShopUI after purchase.

**Update `get_all_shop_items()` and `get_all_shop_equipment()`:**
- Add `"stock"` key to each returned dictionary
- Only return items with stock > 0

**2. Update shop_ui.gd to use stock:**

In `_buy_selected()`:
- After successful purchase, call `ShopCatalog.reduce_stock(item.id)`
- Refresh list after purchase (items with 0 stock disappear)

In `_update_rows()` for BUY tab:
- Show stock count next to price: e.g., "25g (x5)" meaning 25 gold, 5 in stock
- Stock 0 items don't appear (filtered by get_all_shop_items/equipment)

**3. Connect restock to zone entry:**

In ShopCatalog `_ready()`:
- Connect `Events.zone_entered` to `_on_zone_entered`

```gdscript
func _on_zone_entered(zone_name: String) -> void:
    if zone_name == "neighborhood":
        restock()
```

This means every time the player enters the neighborhood zone, the shop restocks. This includes:
- Loading a save (which loads neighborhood)
- Transitioning from backyard back to neighborhood
- Starting a new game

**4. Add zone_entered signal for neighborhood restock awareness:**
No changes needed to `neighborhood.gd` — the base_zone already emits `Events.zone_entered.emit(zone_id)` in `_ready()`, and neighborhood sets `zone_id = "neighborhood"` in `_setup_zone()`. The ShopCatalog autoload connects to this signal.

Remove the temporary debug print from `_setup_zone()` in `neighborhood.gd` if it wasn't already removed in Plan 02.
  </action>
  <verify>
    Run the game. Open shop — verify items show stock counts. Buy an item — verify stock decreases. Buy until stock is 0 — verify item disappears from list. Exit to backyard (zone transition), return to neighborhood — verify shop has restocked (items back at default levels). Verify equipment already owned doesn't restock. Check console for "[ShopCatalog] Shop restocked!" on zone entry.
  </verify>
  <done>
    Shop has stock tracking. Items have limited stock per restock cycle. Shop restocks when player re-enters the neighborhood zone. Equipment already owned doesn't restock. Buy/sell flow complete.
  </done>
</task>

</tasks>

<verification>
- [ ] SELL tab shows player's inventory items with sell prices
- [ ] SELL tab Equipment category shows unequipped equipment only
- [ ] Selling removes item from inventory and adds coins
- [ ] Selling equipment removes from equipment_inventory and adds coins
- [ ] Sell price is 50% of buy price (rounded down)
- [ ] Empty sell list shows "Nothing to sell!" message
- [ ] Shop items have stock counts displayed
- [ ] Purchasing reduces stock
- [ ] Items with 0 stock disappear from buy list
- [ ] Re-entering neighborhood zone restocks the shop
- [ ] Already-owned equipment doesn't restock
- [ ] Gold "+amount" floating text on sell
- [ ] Coin display updates in real-time during buy/sell
</verification>

<success_criteria>
Complete shop economy loop: player can buy items (coins → items), sell items (items → coins), and the shop restocks on zone re-entry. Stock tracking prevents infinite buying in a single visit.
</success_criteria>

<output>
After completion, create `.planning/phases/18-shop-system/18-03-SUMMARY.md`
</output>
